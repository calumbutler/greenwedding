// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../core/Accessor","../../core/Collection","../../core/lang","../../core/Evented","../../core/HandleRegistry","../../core/watchUtils","./ListItem","../../support/Action"],function(i,t,e,n,s,a,r,l){var o={ready:"ready",disabled:"disabled"},h={map:"map",view:"view",layers:"layers",listItems:"list-items"},d={hide:"hide",hideChildren:"hide-children"},c=i.createSubclass([n],{declaredClass:"esri.widgets.LayerList.LayerListViewModel",constructor:function(){this._actionsOpenMap={},this._itemOpenMap={},this._handles=new s;var i=a.watch(this,"view",function(i){if(this._handles.remove(h.layers),this._resetMapItems(i),i){var t=a.init(i,"map",function(){this._resetMapItems(i)}.bind(this)),e=i.allLayerViews.on("change",function(){this._compileList(i)}.bind(this)),n=a.init(this,"createActionsFunction",function(){this._compileList(i)}.bind(this));this._handles.add([t,e,n],h.layers)}}.bind(this));this._handles.add(i,h.view)},destroy:function(){this._handles.destroy(),this._handles=null,this.view=null,this.operationalItems.removeAll()},properties:{createActionsFunction:{},operationalItems:{value:new t,type:t.ofType(r),readOnly:!0},state:{dependsOn:["view.ready"],readOnly:!0,value:o.disabled,get:function(){return this.get("view.ready")?o.ready:o.disabled}},view:{}},triggerAction:function(i){i&&this.emit("trigger-action",{action:i})},_resetMapItems:function(i){this._actionsOpenMap={},this._itemOpenMap={},this._createMapHandles(i),this._compileList(i)},_createMapHandles:function(i){this._handles.remove(h.map);var t=i&&i.get("map.allLayers");if(t){var e=t.on("change",function(){this._compileList(i)}.bind(this));this._handles.add(e,h.map)}},_findLayerView:function(i){var t,e=this.get("view.allLayerViews");return e&&(t=e.find(function(t){return t.layer===i})),t},_compileList:function(i){var t=i&&i.get("map.layers");this._handles.remove(h.listItems);var e=[];t&&t.forEach(function(t){var n=this._findLayerView(t),s=t.listMode;if(s!==d.hide){var r=s===d.hideChildren,l=this._createListItems(n,t,r);e.unshift(l)}var o=a.watch(t,"listMode",function(){this._compileList(i)}.bind(this));this._handles.add(o,h.listItems)},this),this.operationalItems.removeAll(),this.operationalItems.addMany(e)},_isLayerUpdating:function(i){var t=!1;return"loading"===i?t=!0:"failed"===i&&(t=!1),t},_isLayerWithinScaleRange:function(i,t){if("number"!=typeof t||!i||!i.maxScale&&!i.minScale)return!0;var e=i.maxScale,n=i.minScale,s=n>0&&t>=n||e>0&&e>=t?!1:!0;return s},_normalizeChildLayers:function(i,t){return t||!i?[]:i.hasOwnProperty("sublayers")?i.sublayers||[]:i.hasOwnProperty("layers")?i.layers||[]:[]},_watchItemProperties:function(i,t){var e=a.init(i,"actionsOpen",function(i){this._actionsOpenMap[t.id]=i}.bind(this)),n=a.init(i,"open",function(i){this._itemOpenMap[t.id]=i}.bind(this)),s=a.init(i,"visible",function(i){t.visible=i});this._handles.add([s,n,e],h.listItems)},_watchLayerProperties:function(i,t,e){var n=a.init(e,"loadError",function(t){i.error=t||null}),s=a.init(e,"title",function(t){i.title=t||""});if(t){var r=a.init(t,"updating",function(t){i.updating=t});this._handles.add(r,h.listItems)}else{var l=a.init(e,"loadStatus",function(t){i.updating=this._isLayerUpdating(t)}.bind(this));this._handles.add(l,h.listItems)}var o=a.init(e,"visible",function(t){i.visible=t}),d=a.init(e,"visibilityMode",function(t){i.visibilityMode=t});this._handles.add([d,n,s,o],h.listItems)},_setupListItem:function(i,t,e,n){if(this._watchItemProperties(i,e),this._watchLayerProperties(i,t,e),"function"==typeof this.createActionsFunction){var s={item:i},r=this.createActionsFunction.call(null,s);r&&r.length&&(i.actionsSections=r)}var l=this._normalizeChildLayers(e,n);l.forEach(function(t){var e=this._findLayerView(t),s=this._createListItems(e,t,n);i.children.unshift(s)},this);var o=a.init(this,"view.stationary",function(){i.visibleAtCurrentScale=this._isLayerWithinScaleRange(e,this.get("view.scale"))}.bind(this));this._handles.add(o,h.listItems)},_createListItems:function(i,t,e){var n=!!this._actionsOpenMap[t.id],s=t.loadError,a=t.title||"",l=!!this._itemOpenMap[t.id],o=i?i.updating:t.loadStatus?this._isLayerUpdating(t.loadStatus):!1,h=t.visible,d=t.visibilityMode,c=this._isLayerWithinScaleRange(t,this.get("view.scale")),u=new r({actionsOpen:n,actionSections:[],children:[],error:s,open:l,title:a,updating:o,visible:h,visibleAtCurrentScale:c,visibilityMode:d});return t.always?t.always(function(){this._setupListItem(u,i,t,e)}.bind(this)):this._setupListItem(u,i,t,e),u}});return c});