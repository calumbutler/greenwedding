// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../core/Accessor","../../core/Error","../../core/HandleRegistry","../../core/lang","../../core/urlUtils","../../core/promiseList","../../core/promiseUtils","../../core/watchUtils","../../request","../../tasks/support/StatisticDefinition","../../tasks/support/Query","../../tasks/QueryTask","dojo/_base/lang","dojo/promise/all","dojo/i18n!dojo/cldr/nls/number"],function(t,e,r,i,a,n,s,o,l,d,c,f,h,u,m){var y={apostrophe:/\'/g,hrefAttributes:/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,token:/(\{([^\{\r\n]+)\})/g},_={apostrophe:"&apos;",ltr:"&lrm;"},p="relationships/",g={attachments:"attachments",fields:"fields",media:"media",text:"text"},b={"short-date":"(datePattern: 'M/d/y', selector: 'date')","short-date-le":"(datePattern: 'd/M/y', selector: 'date')","long-month-day-year":"(datePattern: 'MMMM d, y', selector: 'date')","day-short-month-year":"(datePattern: 'd MMM y', selector: 'date')","long-date":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","short-date-short-time":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-le-short-time":"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-short-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","short-date-le-short-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')","short-date-long-time":"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-le-long-time":"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-long-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')","short-date-le-long-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')","long-month-year":"(datePattern: 'MMMM y', selector: 'date')","short-month-year":"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"};return t.createSubclass({declaredClass:"esri.widgets.Popup.PopupRendererViewModel",properties:{content:{readOnly:!0},contentEnabled:!0,contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new r},initialize:function(){this._handles.add([o.init(this,"graphic",function(t){this._updateGraphic(t,this.contentEnabled)}.bind(this)),o.init(this,"contentEnabled",function(t){this._updateGraphic(this.graphic,t)}.bind(this))])},destroy:function(){this._handles.destroy(),this._handles=null,this._clearRelatedInfo(),this._cancelPromises(),this.graphic=null,this._set("title",null),this._set("content",null),this._set("waitingForContent",null)},content:null,contentEnabled:!0,contentTypes:g,formattedAttributes:null,graphic:null,title:"",waitingForContent:!1,_handles:null,_contentPromise:null,_contentPromiseLookup:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedRecordsLayerPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_dateFormats:b,_addValuesToHref:function(t,e,r,a){return e=this._trimString(e),i.substitute((e?0!==e.indexOf("${"):1)?a:r,t)},_cancelPromises:function(){this._contentPromiseLookup&&(Object.keys(this._contentPromiseLookup).forEach(function(t){this._contentPromiseLookup[t].cancel()},this),this._contentPromiseLookup=null),this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null),this._relatedRecordsQueryPromises.forEach(function(t){t.cancel()}),this._relatedRecordsQueryPromises.length=0,this._relatedRecordsLayerPromises.length&&(this._relatedRecordsLayerPromises.forEach(function(t){t.cancel()}),this._relatedRecordsLayerPromises.length=0),this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedLayersInfo=null,this._relatedInfo=null},_compileContent:function(t,r){var i=t.content;if("function"==typeof i&&(i=i.call(null,{graphic:t.graphic}),i&&i.nodeName))return i;if("string"==typeof i)return this._compileText(t,{type:g.text,text:i}).text;if(Array.isArray(i))return i.map(function(e,i){switch(e.type){case g.attachments:return this._proxyAttachments(e,r&&r[i]);case g.fields:return e;case g.media:return this._compileMedia(t,e);case g.text:return this._compileText(t,e)}},this);if(i)try{throw new e(this.declaredClass+"::invalid content type.")}catch(a){console.warn(a.stack)}},_compileMedia:function(t,e){var r,a,n=h.clone(e),s=n.mediaInfos,o=t.attributes,l=t.layer,d=this.formattedAttributes.global,c=t.substOptions;return s&&(r=[],s.forEach(function(e){a=0;var n=e.value;switch(e.type){case"image":var s=n.sourceURL;s=s&&this._trimString(i.substitute(o,this._fixTokens(s,l))),a=!!s;break;case"pie-chart":case"line-chart":case"column-chart":case"bar-chart":var f,u=n.normalizeField;n.fields=n.fields.map(function(t){return f=this._getLayerFieldInfo(l,t),f?f.name:t},this),u&&(f=this._getLayerFieldInfo(l,u),n.normalizeField=f?f.name:u),a=n.fields.some(function(t){return i.isDefined(o[t])||-1!==t.indexOf(p)&&this._relatedInfo},this);break;default:return}if(a){e=h.clone(e),n=e.value;var m=e.title?this._processFieldsInLinks(this._fixTokens(e.title,l),o):"",y=e.caption?this._processFieldsInLinks(this._fixTokens(e.caption,l),o):"";if(e.title=m?this._trimString(i.substitute(d,m,c)):"",e.caption=y?this._trimString(i.substitute(d,y,c)):"","image"===e.type)n.sourceURL=i.substitute(o,this._fixTokens(n.sourceURL,l)),n.linkURL&&(n.linkURL=this._trimString(i.substitute(o,this._fixTokens(n.linkURL,l))));else{var _,g=t.template,b=g&&g.fieldInfos;n.fields.forEach(function(t,e){if(-1!==t.indexOf(p)){var r=this._getRelatedChartInfos(l,b,t,n,o,c);Array.isArray(r)?n.fields=r:n.fields[e]=r}else{var i=o[t];i=void 0===i?null:i,_=o[n.normalizeField]||0,i&&_&&(i/=_);var a=b&&this._getFieldInfo(b,t);n.fields[e]={y:i,tooltip:(a&&a.label||t)+":"+this._formatValue(i,{fieldInfos:b,fieldName:t,layer:l,substOptions:c,preventPlacesFormatting:!!_})}}},this)}r.push(e)}},this)),n.mediaInfos=r,n},_compileText:function(t,e){var r=h.clone(e);if(r&&r.text){var a=t.layer,n=t.attributes,s=this.formattedAttributes.global,o=t.substOptions,l=this._processFieldsInLinks(this._fixTokens(r.text,a),n);r.text=this._trimString(i.substitute(s,l,o))}return r},_compileTitle:function(t){var e="",r=t.title,a=t.layer,n=t.attributes,s=t.substOptions,o=this.formattedAttributes.global;if(r&&("function"==typeof r&&(r=r.call(null,{graphic:t.graphic})),"string"==typeof r)){var l=-1!==r.indexOf("{"+p);if(!l){var d=this._processFieldsInLinks(this._fixTokens(r,a),n);e=this._trimString(i.substitute(o,d,s))}}return e},_createGraphicInfo:function(t,e){var r=t.getEffectivePopupTemplate(),i=r&&r.title,a=r&&r.content,n=t.layer,s=n&&n._getDateOpts&&n._getDateOpts().properties,o=h.clone(t.attributes)||{},l={dateFormat:{properties:s,formatter:"DateFormat"+b["short-date-short-time"]}};return{graphic:t,template:r,title:i,content:a,contentEnabled:e,layer:n,attributes:o,properties:s,substOptions:l}},_fixTokens:function(t,e){return t.replace(y.token,function(t,r,i){var a=this._getLayerFieldInfo(e,i);return a?"{"+a.name+"}":r}.bind(this))},_encodeAttributes:function(t){var e=h.clone(t)||{};return Object.keys(e).forEach(function(t){var r=e[t];if("string"==typeof r){var i=encodeURIComponent(r).replace(y.apostrophe,_.apostrophe);e[t]=i}}),e},_formatAttributesToFieldInfos:function(t,e,r,i,a){t.forEach(function(n){var s=n.fieldName,o=this._getLayerFieldInfo(e,s);o&&(s=n.fieldName=o.name);var l=a[s];if(a[s]=this._formatValue(l,{fieldInfos:t,fieldName:s,layer:e,substOptions:r}),i&&n.format&&n.format.dateFormat){var d=i.indexOf(s);d>-1&&i.splice(d,1)}},this)},_formatAttributes:function(t,e,r,a,n,s){var o=h.clone(n);if(this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(t){var e=this._relatedInfo[t],r=this._relatedLayersInfo[t];e&&(e.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,r,n,o)),e.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,r,n,o)))},this),t&&this._formatAttributesToFieldInfos(t,e,r,a,o),e){var l=e.typeIdField;Object.keys(n).forEach(function(t){if(-1===t.indexOf(p)){var r=n[t];if(i.isDefined(r)){var a=this._getDomainName(e,s,t,r);if(i.isDefined(a))o[t]=a;else if(t===l){var d=this._getTypeName(e,s,r);i.isDefined(d)&&(o[t]=d)}}}},this)}return o},_formatValue:function(t,e){var r=e.fieldInfos,a=e.fieldName,n=e.substOptions,s=r&&this._getFieldInfo(r,a),o=h.clone(s),l=e.preventPlacesFormatting,d=this._getLayerFieldInfo(e.layer,a);if(d&&"date"===d.type){var c=o.format||{};c.dateFormat=c.dateFormat||"short-date-short-time",o.format=c}var f=o&&o.format,u="number"==typeof t&&n.dateFormat.properties&&-1===n.dateFormat.properties.indexOf(a)&&(!f||!f.dateFormat);if(!i.isDefined(t)||!o||!i.isDefined(f))return u?this._forceLTR(t):t;var y="",_=[],p=f.hasOwnProperty("places")||f.hasOwnProperty("digitSeparator"),g=f.hasOwnProperty("digitSeparator")?f.digitSeparator:!0;if(p)y="NumberFormat",i.isDefined(f.places)&&(!l||f.places>0)&&(_.push("places: "+Number(f.places)),y+="("+_.join(",")+")");else{if(!f.dateFormat)return u?this._forceLTR(t):t;y="DateFormat"+b[f.dateFormat]||b["short-date-short-time"]}var I=i.substitute({myKey:t},"{myKey:"+y+"}",n)||"";return p&&!g&&m.group&&(I=I.replace(new RegExp("\\"+m.group,"g"),"")),u?this._forceLTR(I):I},_forceLTR:function(t){return _.ltr+t},_getDomainName:function(t,e,r,i){var a=t.getDomain&&t.getDomain(r,{feature:e});return a&&a.codedValues?a.getName(i):null},_getFieldInfo:function(t,e){for(var r,i=e.toLowerCase(),a=0;a<t.length;a++){var n=t[a];if(n.fieldName&&n.fieldName.toLowerCase()===i){r=n;break}}return r},_getLayerFieldInfo:function(t,e){return t&&t.getField?t.getField(e):null},_getTypeName:function(t,e){var r=t.getType&&t.getType(e);return r&&r.name},_processFieldsInLinks:function(t,e){var r=this._encodeAttributes(e);return t&&(t=t.replace(y.hrefAttributes,function(t,i){return this._addValuesToHref(t,i,e,r)}.bind(this))),t},_proxyAttachments:function(t,r){var i=h.clone(t);if(r&&!(r instanceof e)&&r.attachmentInfos&&r.attachmentInfos.length){var n=r.attachmentInfos.map(function(t){return t.url=a.addProxy(t.url),t},this);i.attachmentInfos=n}return i},_queryAttachments:function(t){var e=t.layer,r=t.attributes,i=e&&e.objectIdField,a=r&&i&&r[i];return i&&e.hasAttachments&&a?this._queryAttachmentInfos(e,a):void 0},_queryAttachmentInfos:function(t,e){var r=t.url+"/"+t.layerId+"/"+e+"/attachments",i=t.token||"";return l(r,{query:{f:"json",token:i},callbackParamName:"callback"}).then(function(t){var a=t.data,n=a.attachmentInfos;return n.forEach(function(t){t.url=r+"/"+t.id,i&&(t.url+="?token="+i),t.objectId=e}),a})},_queryContent:function(t){var r=t.template,i=r&&r.content;if(!i||"string"==typeof i||"function"==typeof i)return s.resolve();if(!Array.isArray(i))return s.reject(new e(this.declaredClass+"::Invalid content type."));var a={};return i.forEach(function(e,r){e.type===g.attachments&&(a[r]=this._queryAttachments(t))},this),0===Object.keys(a).length?s.resolve():(this._contentPromiseLookup=a,n(a).always(function(t){return this._contentPromiseLookup=null,t}.bind(this)))},_trimString:function(t){return(t||"").trim()},_updateContent:function(t){if(t.contentEnabled){var e=this._queryContent(t).then(function(e){this._set("content",this._compileContent(t,e))}.bind(this),function(t){console.log(this.declaredClass+"::error loading template",t)}.bind(this)).always(function(){this._contentPromise=null}.bind(this));return this._contentPromise=e,e}return s.resolve()},_createFormattedAttributes:function(t){var e=t.graphic,r=t.attributes,i=t.layer,a=t.template,n=a&&a.fieldInfos,s=t.substOptions,o=t.properties,l={global:this._formatAttributes(n,i,s,o,r,e),content:[]},d=a&&a.content;return Array.isArray(d)&&d.forEach(function(t,a){t.type===g.fields&&t.fieldInfos&&(l.content[a]=this._formatAttributes(t.fieldInfos,i,s,o,r,e))},this),l},_updateGraphic:function(t,e){if(this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),t)){this._set("waitingForContent",!0);var r=this._createGraphicInfo(t,e),i=this._checkForRelatedRecords(r).then(function(){return this._set("formattedAttributes",this._createFormattedAttributes(r)),this._set("title",this._compileTitle(r)),this._updateContent(r)}.bind(this)).always(function(){this._relatedRecordsPromise=null,this._relatedRecordsLayerPromises.length=0,this._relatedRecordsQueryPromises.length=0,this._set("waitingForContent",!1)}.bind(this));this._relatedRecordsPromise=i}},_getAllFieldInfos:function(t){var e=[],r=t.template,i=r&&r.fieldInfos,a=t.contentEnabled;if(i&&(e=e.concat(i)),a){var n=r&&r.content;Array.isArray(n)&&n.forEach(function(t){var r=t&&t.fieldInfos;e=e.concat(r)},this)}return e},_checkForRelatedRecords:function(t){var e=this._getAllFieldInfos(t),r=e.filter(function(t){return t&&t.fieldName&&-1!==t.fieldName.indexOf(p)},this);return t.layer&&r&&r.length>0?this._getRelatedRecords({graphic:t.graphic,fieldsInfo:r}):s.resolve()},_relatedFeaturesAttributes:function(t,e,r,i){Object.keys(i.attributes).forEach(function(a){if("esriRelCardinalityOneToOne"===t.relation.cardinality){var n=this._toRelatedFieldName([t.relation.id,a]);e[n]=r[n]=i.attributes[a]}},this)},_relatedStatsAttributes:function(t,e,r,i){Object.keys(i.attributes).forEach(function(a){var n=this._toRelatedFieldName([t.relation.id,a]);e[n]=r[n]=i.attributes[a]},this)},_getRelatedChartInfos:function(t,e,r,i,a,n){var s,o,l,d,c,f,h,u;return s=[],u=this._fromRelatedFieldName(r),f=u[0],o=this._relatedInfo[f],h=this._relatedLayersInfo[f],o&&o.relatedFeatures.forEach(function(o){var l,f=o.attributes;Object.keys(f).forEach(function(o){if(o===u[1]){if(l={},c=f[o],i.normalizeField&&(d=-1!==i.normalizeField.indexOf(p)?f[this._fromRelatedFieldName(i.normalizeField)[1]]:a[i.normalizeField]),c&&d&&(c/=d),i.tooltipField)if(-1!==i.tooltipField.indexOf(p)){var h=this._fromRelatedFieldName(i.tooltipField)[1],m=f[h];l.tooltip=m+": "+this._formatValue(c,{fieldInfos:e,fieldName:m,layer:t,substOptions:n,preventPlacesFormatting:!!d})}else{var y=this._getLayerFieldInfo(t,r);y&&(r=y.name),l.tooltip=r+": "+this._formatValue(c,{fieldInfos:e,fieldName:i.tooltipField,layer:t,substOptions:n,preventPlacesFormatting:!!d})}else l.tooltip=c;l.y=c,s.push(l)}},this)},this),l="esriRelCardinalityOneToMany"===h.relation.cardinality||"esriRelCardinalityManyToMany"===h.relation.cardinality?s:s[0]},_getRelatedRecords:function(t){var e=t.graphic;return this._relatedLayersInfo?this._queryRelatedLayers(e).then(function(t){return this._setRelatedRecords(t),t}.bind(this)):this._getRelatedLayersInfo(t).then(function(t){return Object.keys(t).forEach(function(e){t[e]&&(this._relatedLayersInfo[e].relatedLayerInfo=t[e].data)},this),this._queryRelatedLayers(e).then(function(t){return this._setRelatedRecords(t),t}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(t){var e,r=t.graphic,i=t.fieldsInfo,a={};return e=r.layer,this._relatedLayersInfo||(this._relatedLayersInfo={}),i.forEach(function(t){var r,i,a,n,s;if(r=this._fromRelatedFieldName(t.fieldName),i=r[0],a=r[1],i){if(!this._relatedLayersInfo[i]){var o=e&&e.relationships;o&&o.some(function(t){return t.id==i?(s=t,!0):void 0}),s&&(this._relatedLayersInfo[i]={relation:s,relatedFields:[],outStatistics:[]})}this._relatedLayersInfo[i]&&(this._relatedLayersInfo[i].relatedFields.push(a),t.statisticType&&(n=new d({statisticType:t.statisticType,onStatisticField:a,outStatisticFieldName:a}),this._relatedLayersInfo[i].outStatistics.push(n)))}},this),Object.keys(this._relatedLayersInfo).forEach(function(t){var r,i;this._relatedLayersInfo[t]&&(r=this._relatedLayersInfo[t].relation,i=e.url+"/"+r.relatedTableId,this._relatedLayersInfo[t].relatedLayerUrl=i,a[t]=l(i,{query:{f:"json"},callbackParamName:"callback"}))},this),Object.keys(a).forEach(function(t){this._relatedRecordsLayerPromises.push(a[t])},this),u(a)},_queryRelatedLayers:function(t){var e={};return Object.keys(this._relatedLayersInfo).forEach(function(r){e[r]=this._queryRelatedLayer({graphic:t,relatedInfo:this._relatedLayersInfo[r]})},this),u(e)},_queryRelatedLayer:function(t){var e,r,i,a,n,s,o,l,d,h,m,y,_,p;return e=t.graphic,r=e.layer,i=r.layerId,y=t.relatedInfo,a=y.relatedLayerInfo,_=y.relatedLayerUrl,p=y.relation,a&&a.relationships&&a.relationships.some(function(t){return t.relatedTableId===parseInt(i,10)?(n=t,!0):void 0}),n&&(a.fields.some(function(t){if(t.name===n.keyField){var e=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];return s=-1!==e.indexOf(t.type)?"number":"string",!0}}),h="string"===s?n.keyField+"='"+e.attributes[p.keyField]+"'":n.keyField+"="+e.attributes[p.keyField],o=new c({where:h,outFields:y.relatedFields}),y.outStatistics&&y.outStatistics.length>0&&a.supportsStatistics&&(m=new c({where:o.where,outFields:o.outFields,outStatistics:y.outStatistics})),l=new f({url:_}),d=[l.execute(o)],m&&d.push(l.execute(m))),this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(d),u(d)},_setRelatedRecords:function(t){this._relatedInfo=[],Object.keys(t).forEach(function(e){if(t[e]){var r=t[e];this._relatedInfo[e]={relatedFeatures:r[0].features},i.isDefined(r[1])&&(this._relatedInfo[e].relatedStatsFeatures=r[1].features)}},this)},_fromRelatedFieldName:function(t){var e=-1!==t.indexOf(p);return e?t.split("/").slice(1):[]},_toRelatedFieldName:function(t){return t&&t.length>0?p+t[0]+"/"+t[1]:""}})});