// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../Color","./ColorPicker/colorUtils","./ColorPicker/HexPalette","./Widgette","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/on","dojo/query","dojo/i18n!./ColorPicker/nls/ColorPicker","dojo/text!./ColorPicker/templates/ColorPicker.html","dojo/NodeList-dom"],function(t,e,o,s,r,i,a,l,n,c,h,d,u,_){var p=null,g=13,C={root:"esri-color-picker",container:"esri-container",header:"esri-header",footer:"esri-footer",middle:"esri-middle",swatch:"esri-swatch",swatchRow:"esri-swatch-row",swatchEmpty:"esri-swatch-empty",swatchPreview:"esri-swatch-preview",swatchTransparencyBackground:"esri-swatch-transparency-background",palette:"esri-palette",paletteOptions:"esri-palette-options",paletteToggle:"esri-palette-toggle",label:"esri-label",hexInput:"esri-hex-input",recent:"esri-recent",suggested:"esri-suggested",selected:"esri-selected",disabled:"esri-disabled",section:"esri-section",transparencySlider:"esri-transparency-slider",ticks:"esri-color-picker-ticks",alt:"esri-alt",hidden:"esri-hidden"},w=s.createSubclass([r,i],{declaredClass:"esri.widgets.ColorPicker",templateString:_,labels:u,baseClass:C.root,css:C,constructor:function(t){t=t||{},this._brightsPalette=new o({colors:t.palette}),this._pastelsPalette=new o({colors:this._toPastels(this._brightsPalette.colors)}),this._activePalette=this._brightsPalette,this._swatches={}},buildRendering:function(){this.inherited(arguments),this._createPalettes(),this.required||(this._noColorSwatchNode=n.create("div",{className:C.swatch+" "+C.swatchEmpty},this.dap_hexInput,"after")),l.toggle(this.dap_transparencySection,C.hidden,!this.showTransparencySlider),l.toggle(this.dap_recentColorSection,C.hidden,!this.showRecentColors),l.toggle(this.dap_suggestedColorSection,C.hidden,!this.showSuggestedColors)},postCreate:function(){this.inherited(arguments),this._addListeners(),this._selectColor()},_activePalette:null,_brightsPalette:null,_pastelsPalette:null,_swatches:null,_noColorSwatchNode:null,_previousColor:null,color:null,_getColorAttr:function(){var e=this._get("color");return e===p?p:new t(e)},_setColorAttr:function(o,s){if(o=o||p,s=s||void 0===s,!this.required){if(o===p)return this._set("color",p),this._previousColor=p,this._disableTransparencySlider(),this._clearSelection(),this._updateHexInput(p),this._updatePreviewSwatch(o),l.add(this._noColorSwatchNode,C.selected),void(s&&this.emit("color-change",{color:p}));this._enableTransparencySlider(),l.remove(this._noColorSwatchNode,C.selected)}var r,i=e.normalizeColor(o),a=this._previousColor;if(a){if(e.equal(a,i))return;var n=this._findColorSwatch(a);n&&(l.remove(n,C.selected),c.set(n,"borderColor",""))}r=new t(i),this._set("color",r),this._previousColor=i,this.dap_transparencySlider.value=1-r.a,this._updatePreviewSwatch(r),this._checkSelection(),this._updateHexInput(r),this.trackColors&&this._addRecentColor(r.toHex()),s&&this.emit("color-change",{color:new t(r)})},colorsPerRow:g,_setColorsPerRowAttr:function(t){var e=t>0?t:g;this._set("colorsPerRow",e)},_setPaletteAttr:function(t){var e=this._activePalette===this._brightsPalette;this._brightsPalette.colors=t,this._pastelsPalette.colors=this._toPastels(this._brightsPalette.colors),this._activePalette=e?this._brightsPalette:this._pastelsPalette,this._createPalettes(),this._togglePalette(!e)},recentColors:[],_getRecentColorsAttr:function(){return this._get("recentColors").map(function(t){return e.normalizeColor(t)})},_setRecentColorsAttr:function(t){var o=t||[];this.showRecentColors&&(o=o.map(function(t){return e.normalizeColor(t).toHex()})),this._set("recentColors",o),0===o.length?this._clearRecentSwatches():this._renderRecentSwatches()},required:!1,showRecentColors:!0,showSuggestedColors:!1,showTransparencySlider:!0,suggestedColors:null,_getSuggestedColorsAttr:function(){return this._get("suggestedColors").map(function(t){return e.normalizeColor(t)})},_setSuggestedColorsAttr:function(t){if(this.showSuggestedColors){this._clearSuggestedSwatches();var o=t||[];o=o.map(function(t){return e.normalizeColor(t).toHex()}),this._set("suggestedColors",o),o.length>0&&this._renderSuggestedSwatches()}},trackColors:!0,addRecentColor:function(t){t&&t!==p&&this._addRecentColor(e.normalizeColor(t).toHex())},saveRecentColors:function(t){localStorage.setItem(t,JSON.stringify(this.get("recentColors")))},loadRecentColors:function(t){this.set("recentColors",JSON.parse(localStorage.getItem(t)))},_toPastels:function(e){var o=new t([238,238,238]);return e.map(function(e){return t.blendColors(new t(e),o,.2)})},_createSwatch:function(t){var e=t.className,o=t.hexColor||"transparent",s=t.paletteNode;return n.create("span",{className:e,style:{backgroundColor:o}},s)},_createSwatches:function(t,e){var o;e.colors.forEach(function(e,s){var r;s%this.colorsPerRow===0&&(o=n.create("div",{className:C.swatchRow},t)),r=this._createSwatch({className:C.swatch,hexColor:e,paletteNode:o}),this._swatches[e]=r},this)},_selectColor:function(){this.set("color",this.required?this.color||this._activePalette.colors[0]:this.color)},_setColorWithCurrentAlpha:function(t){t!==p&&this.color!==p&&(t=e.normalizeColor(t),t.a=this.color.a),this.set("color",t)},_updatePreviewSwatch:function(t){var o,s=this.dap_previewSwatch,r=!0;return t===p?(l.add(s,C.swatchEmpty),void c.set(s,{backgroundColor:"",borderColor:""})):(o=e.getContrastingColor(t),l.remove(s,C.swatchEmpty),void c.set(s,{backgroundColor:t.toCss(r),borderColor:o.toCss(r)}))},_showBrights:function(){l.remove(this.dap_paletteContainer,C.alt),this._activePalette=this._brightsPalette},_showPastels:function(){l.add(this.dap_paletteContainer,C.alt),this._activePalette=this._pastelsPalette},_setColorFromSwatch:function(t){var e=c.get(t,"backgroundColor");this._setColorWithCurrentAlpha(e)},_checkSelection:function(){var t=this.get("color");this._activePalette.contains(t)?this._highlightColor(t):this._clearSelection()},_addListeners:function(){var t="."+C.swatch;this.own(h(this.dap_paletteContainer,h.selector(t,"click"),function(t){this._setColorFromSwatch(t.target)}.bind(this)),h(this.dap_recentColorPalette,h.selector(t,"click"),function(t){this._setColorFromSwatch(t.target)}.bind(this)),h(this.dap_suggestedColorPalette,h.selector(t,"click"),function(t){this._setColorFromSwatch(t.target)}.bind(this))),this.required||this.own(h(this._noColorSwatchNode,"click",function(){this.set("color",p)}.bind(this)));var o=this.dap_hexInput;h(o,"blur",function(){var t=e.normalizeHex(o.value);return e.isShorthandHex(t)?void this._setColorWithCurrentAlpha(t):void this._updateHexInput(this.color)}.bind(this)),h(o,"change",function(){var t=e.normalizeHex(o.value);e.isLonghandHex(t)&&this.color.toHex()!==t&&this._setColorWithCurrentAlpha(t)}.bind(this)),h(this.dap_transparencySlider,"change, input",function(t){var o,s=this.get("color");s!==p&&(o=e.normalizeColor(s),o.a=1-t.target.value,this._updatePreviewSwatch(o),this._updateHexInput(o),this.set("color",o))}.bind(this)),h(this.dap_paletteToggle,a,function(t){var e="true"===t.target.getAttribute("aria-pressed");this._togglePalette(!e)}.bind(this))},_togglePalette:function(t){this.dap_paletteToggle.setAttribute("aria-pressed",t),t?this._showPastels():this._showBrights(),this._checkSelection()},_createPalettes:function(){this._swatches={},n.empty(this.dap_primaryPalette),n.empty(this.dap_secondaryPalette),this._createSwatches(this.dap_primaryPalette,this._brightsPalette),this._createSwatches(this.dap_secondaryPalette,this._pastelsPalette)},_updateHexInput:function(t){this.dap_hexInput.value=t===p?"":t.toHex()},_addRecentColor:function(t){if(t){var e=this.recentColors,o=e.indexOf(t);o>-1&&e.splice(o,1),e.unshift(t),e.length>this.colorsPerRow&&e.pop(),this._renderRecentSwatches()}},_renderRecentSwatches:function(){if(this.recentColors){var t="."+C.recent+"."+C.swatch,e=d(t,this.dap_recentColorPalette);this.recentColors.forEach(function(t,o){if(o<this.colorsPerRow){if(o+1>e.length){var s=this._createSwatch({hexColor:t,className:C.swatch+" "+C.recent,paletteNode:this.dap_recentColorPalette});e.push(s)}c.set(e[o],"backgroundColor",t)}},this)}},_renderSuggestedSwatches:function(){if(this.suggestedColors){var t="."+C.suggested+"."+C.swatch,e=d(t,this.dap_recentColorPalette);this.suggestedColors.forEach(function(t,o){if(o<this.colorsPerRow){if(o+1>e.length){var s=this._createSwatch({hexColor:t,className:C.swatch+" "+C.suggested,paletteNode:this.dap_suggestedColorPalette});e.push(s)}c.set(e[o],"backgroundColor",t)}},this)}},_clearRecentSwatches:function(){n.empty(this.dap_recentColorPalette)},_clearSuggestedSwatches:function(){n.empty(this.dap_suggestedColorPalette)},_clearSelection:function(){d("."+C.selected,this.dap_paletteContainer).removeClass(C.selected)},_highlightColor:function(t){var o,s=this._findColorSwatch(t);s&&(t=e.normalizeColor(t),o=e.getContrastingColor(t),l.add(s,C.selected),c.set(s,"borderColor",o.toHex()))},_findColorSwatch:function(t){var o,s=this._activePalette.colors,r=e.toHex(t);return s.indexOf(r)>-1&&(o=this._swatches[r]),o},_enableTransparencySlider:function(){this.dap_transparencySlider.disabled=!1},_disableTransparencySlider:function(){this.dap_transparencySlider.disabled=!0}});return w});