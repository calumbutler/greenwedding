// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../config","../../core/Accessor","../../core/Evented","../../core/promiseUtils","../../core/colorUtils","../../core/watchUtils","dojo/_base/lang","dojo/Deferred","require","dojo/store/Memory","dojo/_base/array","../../layers/support/RasterFunction","../../geometry/Point","dojo/i18n!./nls/RasterSymbologyEditor"],function(e,t,r,a,n,i,o,s,l,u,d,c,y,h){var f=t.createSubclass([r],{properties:{layer:{},layerView:{},stretchTypes:{}},bandComboPresets:[{bandDefinitionKeyword:"LandsatTM",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]},{LandWater:[7,5,4]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"Landsat 8",presets:[{NaturalColor:[4,3,2]},{ColorInfrared:[5,4,3]},{Landuse:[5,4,2]},{LandWater:[7,6,5]},{Vegetation:[6,5,4]},{ShallowBathymetric:[3,2,1]}]},{bandDefinitionKeyword:"IKONOS",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"QuickBird",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"Pleiades",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"GeoEye",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"OrbView",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"LandsatMSS",presets:[{ColorInfrared:[4,3,2]}]},{bandDefinitionKeyword:"SPOT6",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"FORMOSTAT",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"SPOT1",presets:[{ColorInfrared:[1,2,3]},{Vegetation:[2,3,4]}]},{bandDefinitionKeyword:"WorldView",presets:[{NaturalColor:[5,3,2]},{ColorInfrared:[7,5,3]},{Landuse:[7,5,2]},{LandWater:[8,7,6]},{Vegetation:[7,6,5]},{ShallowBathymetric:[3,2,1]}]},{bandDefinitionKeyword:"RapidEye",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[5,3,2]},{Landuse:[5,3,1]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"DMCii",presets:[{ColorInfrared:[1,2,3]}]}],_cachedKeyProperties:[],stretchTypes:[{name:"none",filterType:0,id:1},{name:"minMax",filterType:5,id:2},{name:"percentClip",filterType:6,id:3},{name:"standardDeviation",filterType:3,id:4}],declaredClass:"esri.widgets.RasterSymbologyEditor.RasterSymbologyEditorViewModel",constructor:function(e){o.mixin(this,e)},getSymbologyTypes:function(){var e=["none","stretch"];return this.layer.bandCount>=3&&e.push("rgb"),("esriImageServiceDataTypeVector-UV"===this.layer.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.layer.serviceDataType)&&e.push("vectorField"),this.layer.hasRasterAttributeTable&&1===this.layer.bandCount&&e.push("uniqueValue"),e},isStretchColorRampApplicable:function(e){return 0!==e||this.layer.pixelType&&"u8"===this.layer.pixelType.toLowerCase()?!0:void 0},_validateRRule:function(){},_getDefaultSymbologyType:function(){if(this.layer&&this.layer.renderingRule&&this.layer.renderingRule.functionName){var e=this.layer.renderingRule,t=e.functionName,r=e.functionArguments;return"extractband"===t.toLowerCase()||"stretch"===t.toLowerCase()&&this.layer.bandCount&&1===this.layer.bandCount||"colormap"===t.toLowerCase()&&r&&r.colorRamp&&this.layer.bandCount&&1===this.layer.bandCount?"stretch":this.layer.bandCount>=3&&"stretch"===t.toLowerCase()?"rgb":"none"}return"none"},_getRenderingRuleArguments:function(e){if(this.layer&&this.layer.renderingRule&&e){var t=this.layer.renderingRule;return t.functionName&&t.functionName.toLowerCase()===e?t.functionArguments:t.functionArguments&&t.functionArguments.Raster&&t.functionArguments.Raster.functionName&&t.functionArguments.Raster.functionName===e?t.functionArguments.Raster.functionArguments:null}},getDefaultRenderParameters:function(){var e={},t=this.layer;if(this.layer){var r,a=this._getRenderingRuleArguments("stretch")||{},n=this._getRenderingRuleArguments("colormap")||{},i={};return e.symbologyType=this._getDefaultSymbologyType(),e.stretchType=a.stretchType||(this.layer.pixelType&&"u8"!==this.layer.pixelType.toLowerCase()?2:1),e.minPercent=a.MinPercent||2,e.maxPercent=a.MaxPercent||2,e.numberOfStandardDeviations=a.NumberOfStandardDeviations||2,e.gamma=a.Gamma||1.1,e.dra=a.DRA||!0,e.colorRamp=n.colorRamp||"none",t.bandIds&&(e.bandIds=t.bandIds),t.hasRasterAttributeTable&&t.rasterAttributeTable&&t.rasterAttributeTable.features&&t.rasterAttributeTable.features.length&&t.rasterAttributeTable.features[0].attributes.Red&&t.rasterAttributeTable.features[0].attributes.Green&&t.rasterAttributeTable.features[0].attributes.Blue&&(i.id="uniqueValueColorRamp_default",i.type="multipart",i.colorRamps=[],d.forEach(t.rasterAttributeTable.features,function(e){r=e.attributes,i.colorRamps.push({fromColor:[r.Red,r.Green,r.Blue],toColor:[r.Red,r.Green,r.Blue]})}),e.uniqueValuesColorRamp=i,e.uniqueValuesField=t.rasterAttributeTable.features[0].attributes.Value?"Value":null),e.selectedBand=0,e}},getUniqueValueFields:function(){if(this.layer.hasRasterAttributeTable&&this.layer.rasterAttributeTable&&this.layer.rasterAttributeTable.fields&&this.layer.rasterAttributeTable.fields.length){var e=[];return d.forEach(this.layer.rasterAttributeTable.fields,function(t){"esriFieldTypeOID"!==t.type&&e.push(t)},this),e}},layer:null,destroy:function(){},_emitError:function(e){this.emit("rendering-rule-error",{error:e})},getBandData:function(){if(this.layer){var e,t,r=new s,a=this.layer.bandCount,n=this.layer.id,i=this._cachedKeyProperties[n];if(!i&&a>1){var l=this.layer.fetchKeyProperties();l.then(o.hitch(this,function(a){this._cachedKeyProperties[n]=a,e=this._createBandLists(),t=this._getBandCombinationPresets(),r.resolve({presets:t,lists:e})}))}else e=this._createBandLists(),t=this._getBandCombinationPresets(),r.resolve({lists:e,presets:t});return r}},_getBandCombinationPresets:function(){var e=this.layer.id,t=this._cachedKeyProperties[e];if(t){var r;return d.some(this.bandComboPresets,function(e){return e.bandDefinitionKeyword===t.BandDefinitionKeyword?(r=e.presets,!0):void 0}),r?r:void 0}},_validateProps:function(e){return null===e.stretchType||void 0===e.stretchType?!1:6===e.stretchType&&(isNaN(e.minPercent)||isNaN(e.maxPercent))?!1:3===e.stretchType&&isNaN(e.numberOfStandardDeviations)?!1:((!e.noData||isNaN(e.noData))&&(e.noData=0),this.props=e,!0)},_clearRendering:function(){this.layer.bandIds=null,this.layer.noData=null,this.layer.renderingRule=null},_applyStretchSingleBand:function(e){if(this._validateProps(e)){this.layer.noData=e.noData,this.layer.bandIds=null;var t=this._getStretchRasterFunctionArguments(e,1);if(this.layer.bandCount>1){var r={BandIDs:[e.selectedBand]},a=new c;a.functionArguments=r,a.functionName="ExtractBand",t.Raster=a}var n=new c;if(n.functionName="Stretch",n.functionArguments=t,e.colorRampName&&"none"!==e.colorRampName){var i=new c;i.functionName="Colormap",i.functionArguments={colorRamp:e.colorRampName,Raster:n},this.layer.renderingRule=i}else this.layer.renderingRule=n}},_applyStretchRgb:function(e){if(this._validateProps(e)){this.layer.noData=e.noData,this.layer.bandIds=e.bandIds;var t=this._getStretchRasterFunctionArguments(e,3),r=new c;r.functionName="Stretch",r.functionArguments=t,this.layer.renderingRule=r}},_getStretchRasterFunctionArguments:function(e,t){var r={DRA:e.dra,StretchType:e.stretchType,useGamma:!0};return 0!==e.stretchType&&(r.MinPercent=e.minPercent,r.MaxPercent=e.maxPercent,1===t?r.Gamma=[e.gamma]:3===t&&(r.Gamma=[e.gamma,e.gamma,e.gamma]),r.NumberOfStandardDeviations=e.numberOfStandardDeviations),r},_applyUniqueValueColormap:function(e){var t=new c;t.functionName="Colormap",t.functionArguments={},t.functionArguments.Colormap=this._getColormap(e.uniqueValuesSymbolData),t.variableName="Raster",this.layer.noData=e.noData,this.layer.renderingRule=t},getUniqueValueGridData:function(e,t){if(this.layer.hasRasterAttributeTable&&this.layer.rasterAttributeTable&&e&&t){var r,a,n,i,o,s=this.layer.rasterAttributeTable.features,l=e.colorRamps?e.colorRamps.length:1,u=new Array(l),c=0,y=[],h=this._sortFeatures(s,t);return d.forEach(u,function(e,t){u[t]={},u[t].start=c,u[t].end=c+1/l,c=u[t].end}),d.forEach(h,function(t,s){i=(s+.5)/h.length,d.forEach(u,function(s,l){i>=s.start&&i<s.end&&(o=(i-s.start)/(s.end-s.start),u.length>1?(r=e.colorRamps[l].fromColor,a=e.colorRamps[l].toColor):(r=e.fromColor,a=e.toColor),n=this._interpolateLab(r,a,o),y.push({esriRasterSymbologyEditorUniqueValueSymbol:this._validateRgbLimits(n),esriRasterSymbologyEditorUniqueValueValue:t.value,pixelValues:t.pixelValues,id:l+1}))},this)},this),y}},_sortFeatures:function(e,t){if(e&&t){e=o.clone(e);var r=[];return e.sort(function(e,r){return"string"==typeof e.attributes[t]?e.attributes[t]<r.attributes[t]?-1:1:e.attributes[t]-r.attributes[t]}),d.forEach(e,function(a,n){n>0&&a.attributes[t]===e[n-1].attributes[t]?r[r.length-1].pixelValues.push(a.attributes.Value):r.push({value:a.attributes[t],pixelValues:[a.attributes.Value]})}),r}},_getColormap:function(e){var t=[];return d.forEach(e,function(e){d.forEach(e.pixelValues,function(r){t.push([r,e.esriRasterSymbologyEditorUniqueValueSymbol.r,e.esriRasterSymbologyEditorUniqueValueSymbol.g,e.esriRasterSymbologyEditorUniqueValueSymbol.b])})}),t},updateRendering:function(e){e.symbologyType&&("none"===e.symbologyType?this._clearRendering():"stretch"===e.symbologyType?this._applyStretchSingleBand(e):"rgb"===e.symbologyType?this._applyStretchRgb(e):"uniqueValue"===e.symbologyType&&this._applyUniqueValueColormap(e))},_createBandLists:function(){if(this.layer){var e,t,r=this.layer.id,a=this.layer.bandCount,n=this._cachedKeyProperties[r],i=this.layer.bandIds||[0,1,2],o=[],s=["red","green","blue"];return n&&n.BandProperties&&n.BandProperties.length>0&&(e=n.BandProperties),d.forEach(i,function(r,n){3===r&&(t=!0),e&&e[0].hasOwnProperty("BandName")?o.push(this._getBandIdList(a,e,this._getBandIndex(e,s[n]),t)):o.push(this._getBandIdList(a,e,r,t))},this),this._cachedKeyProperties[r]=n,o}},_getBandIndex:function(e,t){if(!this.layer||!e)return 0;var r;for(r=0;r<e.length;r++)if(e[r]&&e[r].hasOwnProperty("BandName")&&e[r].BandName.toLowerCase()===t)return r;return 0},_getBandIdList:function(e,t,r,a){if(this.layer){var n=[],i={},o=!1;t&&e===t.length&&(o=!0),a&&(i.selected=!0,i.name="None",i.index=100,n.push(i));var s;for(s=0;e>s;s++){var l=s,u=s;l=o&&t[s]&&t[s].BandName?t[s].BandName:h.bandPrefix+"_"+(s+1),i={},r!==s||a||(i.selected=!0),i.name=l+"",i.index=u,n.push(i)}return n}},_interpolateLab:function(e,t,r){e={r:e[0],g:e[1],b:e[2]},t={r:t[0],g:t[1],b:t[2]};var a,i=n.toLAB(e),o=n.toLAB(t);return a={l:i.l*(1-r)+r*o.l,a:i.a*(1-r)+r*o.a,b:i.b*(1-r)+r*o.b},n.toRGB(a)},_validateRgbLimits:function(e){var t=[e.r,e.g,e.b];return d.forEach(t,function(e,r){t[r]<0?t[r]=0:t[r]>255&&(t[r]=255),t[r]=Math.floor(t[r])}),{r:t[0],g:t[1],b:t[2]}}});return f});