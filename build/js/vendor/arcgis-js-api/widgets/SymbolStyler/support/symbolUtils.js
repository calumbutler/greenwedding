// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/Deferred","dojo/dom-construct","dojo/on","dojo/_base/lang","dojox/gfx","dojox/gfx/matrix","../../Legend/support/swatchUtils","../../../core/screenUtils","../../../core/promiseUtils","../../../symbols/support/Symbol3DOutline"],function(e,t,i,r,n,o,u,l,s,c,a,f){function d(e,t){e[t]||(e[t]={})}function h(e,t){return e.indexOf(t)>-1}function m(e){return P(e)}function p(e){return e&&"Icon"===e.type}function y(e){return e&&"Object"===e.type}function g(e){return e&&"Line"===e.type}function v(e){return e&&"Path"===e.type}function b(e){return e&&"Extrude"===e.type}function w(e){return e&&"Fill"===e.type}function x(e){return e&&"Text"===e.type}function z(e){return E(e,"simple-line","2d")}function S(e){return E(e,"simple-marker","2d")}function O(e){return E(e,"simple-fill","2d")}function j(e){return E(e,"picture-marker","2d")}function k(e){return E(e,"fill","2d")}function F(e){return S(e)&&"path"===e.style}function P(e){return h(e.type,"3d")}function L(e){return e.symbolLayers.getItemAt(0)}function T(e,t){return E(e,"marker",t)||E(e,"point",t)}function I(e){return m(e)&&b(L(e))}function D(e){return m(e)&&x(L(e))}function E(e,t,i){var r=e&&e.type,n=h(r,t+"-symbol");return i?n&&("3d"===i?P(e):!P(e)):n}function M(e,t){return E(e,"line",t)}function N(e,t){return E(e,"fill",t)}function U(e){return e&&"string"==typeof e.style}function A(e){return m(e)?!1:U(e)&&h(Me,e.style)}function B(e){return m(e)?C(e):q(e)}function C(e){var t=L(e);return w(t)||p(t)&&Oe(t)?{color:t.outline.color,size:c.pt2px(t.outline.size)}:g(t)||v(t)?{color:t.material&&t.material.color,size:c.pt2px(t.size)}:null}function q(e){return z(e)?{color:e.color,size:e.width}:k(e)||S(e)?{color:e.get("outline.color"),size:e.get("outline.width")}:null}function R(e,t){!isNaN(t)&&e&&(m(e)?V(e,t):G(e,t))}function V(e,t){var i=L(e);p(i)||w(i)?(d(i,"outline"),i.outline.size=c.px2pt(t)):g(i)?(d(i,"size"),i.size=c.px2pt(t)):v(i)&&(d(i,"size"),i.size=t)}function G(e,t){z(e)?e.width=t:me(e)&&(e.outline.width=t)}function W(e,t){t&&e&&!P(e)&&(t=B(e).color?t:"none",z(e)?e.style=t:me(e)&&(e.outline.style=t))}function _(e,t){e&&!isNaN(t)&&(m(e)?H(e,t):K(e,t))}function H(e,t){var i=L(e);p(i)||x(i)?i.size=c.px2pt(t):y(i)?J(i,t):b(i)&&(i.size=t)}function J(e,t){var i=e.width,r=e.height,n=e.depth,o=Math.max(i,r,n),u=t/o;e.set({width:i*u,height:r*u,depth:n*u})}function K(e,t){var i=e.width,r=t;if(i!==r)if(j(e)){var n=e.url,o=re({dimensions:e,targetDimension:"width",targetSize:r});if(e.height=o.height,e.width=o.width,!n||"http://"===n||!h(n,"http://")&&!h(n,"data:"))return;if(e.xoffset||e.yoffset){var u=e.width/i;e.xoffset=Math.round(e.xoffset*u),e.yoffset=Math.round(e.yoffset*u)}}else e.size=r}function Q(e){if(!m(e))return S(e)?e.size:j(e)?X(e):void 0;var t=L(e);return p(t)||x(t)?c.pt2px(t.size):y(t)?X(t):b(t)?t.size:void 0}function X(e){return Math.max(e.width,e.height,e.depth)}function Y(e,t){m(e)?ge(e,{color:t}):e.color=t}function Z(e){return m(e)?$(e):ee(e)}function $(e){return L(e).get("material.color")}function ee(e){return e.color}function te(e,t){if(m(e)){var i=L(e);return g(i)||v(i)?void ge(e,{color:t}):(d(i,"outline"),void(i.outline.color=t))}B(e).color=t}function ie(e,t,i){return void 0===i&&(i=24),s.getSwatchInfo(e,i).then(function(i){var r=i.swatch,n=i.sizes[0],a=i.sizes[1],f=u.createSurface(t,n,a);try{if(null==r)throw"no shape descriptors!";r.forEach(function(t){var i=f.createGroup();t.forEach(function(e){var t=e.shape,r=e.fill,n=e.stroke;if(t){var o="text"===t.type;o&&!t.text&&(t.text=Ne),"image"===t.type&&t.src&&"data:"!==t.src.substr(0,5)&&(t.src+=(h(t.src,"?")?"&":"?")+"legend=1");var u=i.createShape(t).setFill(r).setStroke(n?n:{width:0});o&&u.setFont(e.font)}});var r=i.getBoundingBox(),u=r.width,d=r.height,m=-(r.x+u/2),p=-(r.y+d/2),y=f.getDimensions(),g={dx:m+y.width/2,dy:p+y.height/2},v=!1;if((F(e)||s.isVolumetricSymbol(e))&&0!==r.width&&0!==r.height){var b=r.width/r.height,w=1,x=1,z=F(e)?c.pt2px(e.size):n>a?n:a;isNaN(z)||(b>1?(w=z/r.width,x=z/b/r.height):(x=z/r.height,w=z*b/r.width)),i.applyTransform(l.scaleAt(w,x,{x:y.width/2,y:y.height/2})),v=!0}if(!v&&(u>n||d>a)){var S=u/n>d/a,O=S?u:d,j=S?n:a,k=(j-5)/O;o.mixin(g,{xx:k,yy:k})}i.applyTransform(g)})}catch(d){f.clear(),f.destroy()}return f})}function re(e){var t=e.dimensions,i="height"===e.targetDimension?"height":"width",r=e.targetSize;return"height"===i?{height:r,width:t.width/t.height*r}:{height:t.height/t.width*r,width:r}}function ne(e){var t=new i,o=r.create("img"),u=n(o,"load",function(){return 0===o.width&&0===o.height?void t.reject("image has both width and height of 0"):void t.resolve({width:o.width,height:o.height})}),l=n(o,"error",function(e){t.reject("error ocurred while loading image",e)});return o.src=e,t.promise.always(function(){u.remove(),l.remove(),r.destroy(o)}),t.promise}function oe(e){m(e.symbol)?ue(e):le(e)}function ue(e){_(e.symbol,e.size)}function le(e){_(e.symbol,e.size)}function se(e){m(e.symbol)?ce(e):ae(e)}function ce(e){Y(e.symbol,e.color)}function ae(e){Y(e.symbol,e.color)}function fe(e){m(e.symbol)?de(e):he(e)}function de(e){te(e.symbol,e.color),R(e.symbol,e.size)}function he(e){te(e.symbol,e.color),W(e.symbol,e.pattern),R(e.symbol,e.size)}function me(e){return e&&e.outline}function pe(e){if(m(e))return!1;var t=void 0;return t=me(e)?e.outline.color:e.color,ye(t)}function ye(e){return e&&e.r>246&&e.g>246&&e.b>246}function ge(e,t){var i=L(e);return t.color?void(i.material=o.mixin({},i.material,t)):void(i.material=void 0)}function ve(e){O(e)&&("none"!==e.style||"solid"!==e.style)&&(e.style="solid")}function be(e,t){return void 0===t&&(t=[]),m(e)?ze(e,t):xe(e,t)}function we(e){var t=["circle","square","diamond"];return h(t,e.style)}function xe(e,t){var i=e.type,r=["simple-marker-symbol","picture-marker-symbol"],n=["simple-marker-symbol","simple-fill-symbol"],o=["simple-marker-symbol","simple-line-symbol","simple-fill-symbol"],u=M(e),l=N(e);return{shape:{state:h(t,"shape")||u||l?"excluded":h(r,i)?"enabled":"disabled"},fill:{state:h(t,"fill")||u?"excluded":n[0]===i&&we(e)||n[1]===i?"enabled":"disabled"},outline:{state:h(t,"outline")?"excluded":h(o,i)?"enabled":"disabled"}}}function ze(e,t){var i=L(e),r=i.type,n=["Icon","Object"],o=["Icon","Object","Fill","Extrude","Text"],u=["Icon","Fill","Line","Path"];return{shape:{state:h(t,"shape")||!h(n,r)?"excluded":"enabled"},fill:{state:h(t,"fill")||!h(o,r)?"excluded":Se(i)?"disabled":"enabled"},outline:{state:h(t,"outline")||!h(u,r)?"excluded":Oe(i)||Se(i)?"enabled":"disabled"}}}function Se(e){return p(e)&&h(Me,e.get("resource.primitive"))}function Oe(e){return p(e)?e.outline&&!e.get("resource.href"):!1}function je(e){if(m(e)){var t=L(e).type;if("Extrude"===t||"Object"===t)return"meters"}return"pixels"}function ke(e){if(m(e)){var t=L(e).type;if("Path"===t)return"meters"}return"pixels"}function Fe(e){if(m(e)){if(T(e)){var t=L(e);return y(t)?"web-style:volumetric":p(t)?"web-style:flat":"web-style"}return"web-style"}return"symbol-set"}function Pe(e){var t=L(e).type;return"Object"===t||"Path"===t||"Extrude"===t?"volumetric":"flat"}function Le(e){if(m(e)){var t=L(e);if(p(t)&&(t.outline||(t.outline=new f.Symbol3DOutline({color:void 0,size:0})),void 0===t.size))return t.computeSize().then(function(i){return t.size=i[0],e});if(y(t)&&void 0===t.width&&void 0===t.height&&void 0===t.depth)return t.computeSize().then(function(i){return t.set({width:i[0],height:i[1],depth:i[2]}),e})}return a.resolve(e)}function Te(e,t){if(m(e)&&m(t)){var i=L(e),r=L(t);return p(i)&&y(r)&&!!i.resource.href&&!r.resource.href&&!!r.resource.primitive}return j(e)&&S(t)}function Ie(e,t){if(m(e)&&m(t)){var i=L(e),r=L(t);return p(i)&&p(r)&&!i.resource.href&&!r.resource.href&&!h(Me,i.resource.primitive)&&h(Me,r.resource.primitive)}return Ee(e,t)}function De(e,t){return m(e)&&m(t)?Ie(t,e):Ee(t,e)}function Ee(e,t){return S(e)&&S(t)&&!A(e)&&A(t)}var Me=["x","cross"],Ne="Aa";t.is3d=P,t.getSymbolLayer=L,t.isPoint=T,t.hasExtrudeSymbolLayer=I,t.hasTextSymbolLayer=D,t.isLine=M,t.isPolygon=N,t.hasPureOutlineStyle=A,t.getOutline=B,t.setOutlineWidth=R,t.setOutlineStyle=W,t.setSize=_,t.getMarkerLength=Q,t.setFillColor=Y,t.getFillColor=Z,t.setOutlineColor=te,t.renderOnSurface=ie,t.preserveAspectRatio=re,t.testImageUrl=ne,t.updateShape=oe,t.updateFill=se,t.updateOutline=fe,t.blendsIntoBackground=pe,t.updateMaterial=ge,t.ensureSupportedSimpleFillSymbolStyle=ve,t.getApplicableTabs=be,t.getSizeUnit=je,t.getOutlineUnit=ke,t.getSymbolSource=Fe,t.getDimensionality=Pe,t.ensureProps=Le,t.switchedFromRasterToVectorSymbol=Te,t.switchedToPureOutline=Ie,t.switchedFromPureOutline=De,t.switchedSmsStyleToPureOutline=Ee});