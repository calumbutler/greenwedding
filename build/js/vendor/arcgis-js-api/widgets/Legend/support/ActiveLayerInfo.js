// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../Color","../../../request","../../../renderers/SimpleRenderer","../../../renderers/ClassBreaksRenderer","../../../renderers/UniqueValueRenderer","../../../core/Accessor","../../../core/HandleRegistry","../../../core/Logger","../../../core/arrayUtils","../../../core/promiseUtils","../../../../esri/layers/support/ExportImageParameters","./colorRampUtils","./sizeRampUtils","./swatchUtils","dojo/_base/lang"],function(e,t,n,l,i,s,r,a,o,u,h,c,f,d,y){var m="https://utility.arcgis.com/sharing/tools/legend",g=a.getLogger("esri.widgets.Legend.support.ActiveLayerInfo");return s.createSubclass({declaredClass:"esri.widgets.Legend.support.ActiveLayerInfo",constructor:function(){this._legendResponse=null,this._handles=new r;var e=this.watch("tearingDown",function(){this.destroy()}.bind(this));this._handles.add(e,"tearingDown-watcher")},getDefaults:function(){return{legendElements:[]}},destroy:function(){this._handles.destroy(),this._handles=null,this._legendResponse=null},properties:{layer:null,legendElements:{type:Array},ready:!1,tearingDown:!1,title:null,scale:null,updating:!1,version:{value:0,readOnly:!0,dependsOn:["updating"],get:function(){return this._get("version")+1}},_hasColorRamp:!1,_hasOpacityRamp:!1,_hasSizeRamp:!1},buildLegendElementsForRenderer:function(){this._getRendererLegendElements(this.layer.renderer).then(function(e){this.updating=!0,this.ready=!1,this.legendElements=e,this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){g.warn("error while building legend for layer!",e)}).always(function(){this.updating=!1}.bind(this))},buildLegendElementsForTools:function(){this.layer.sublayers?this._constructLegendElementsForSublayers():this._getLegendLayers().then(function(e){this.updating=!0,this.ready=!1,this.legendElements=[],e.forEach(function(e){var t=this._generateSymbolTableElementForLegendLayer(e);t&&t.infos.length&&this.legendElements.push(t)},this),this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){g.warn("Request to server for legend has failed!",e)}).always(function(){this.updating=!1}.bind(this))},_getLegendLayers:function(e){var t=e&&e.hasDynamicLayers,n=this._legendResponse;if(!t&&n)return u.resolve(n);var l=t?e.dynamicLayers:null;return this._legendRequest(l).then(function(e){var t=e.data.layers;return this._legendResponse=t,t}.bind(this))},_legendRequest:function(e){var n=this.layer,l=n.url.replace(/(\/)+$/,""),i={f:"json",dynamicLayers:e};if(n.version>=10.01){var s=l.indexOf("?");s>-1?l=l.substring(0,s)+"/legend"+l.substring(s):l+="/legend",n.token&&(l+="?token="+n.token)}else{var r=l.toLowerCase().indexOf("/rest/"),a=l.substring(0,r)+l.substring(r+5,l.length);l=m+"?soapUrl="+window.escape(a)+"&returnbytes=true"}return t(l,{query:i,callbackParamName:"callback"})},_constructLegendElementsForSublayers:function(){this.updating=!0,this.ready=!1,this.legendElements=[],this._handles.remove("sublayers-watcher");var e=new h({layer:this.layer});this._getLegendLayers(e).then(function(e){var t={};e.forEach(function(e){t[e.layerId]=e}),this.legendElements=this._generateLegendElementsForSublayers(this.layer.sublayers,t,this.layer.opacity),this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){g.warn("Request to server for legend has failed!",e)}).always(function(){e.destroy(),this.updating=!1}.bind(this))},_generateLegendElementsForSublayers:function(e,t,n){var l=[];return this._handles.add(e.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),e.forEach(function(e){var i=e.watch("renderer, opacity, title, visible",this._constructLegendElementsForSublayers.bind(this));if(this._handles.add(i,"sublayers-watcher"),e.visible&&e.legendEnabled){var s=e&&null!=e.opacity?e.opacity:null,r=null!=s?s*n:n,a=this._generateSymbolTableElementForSublayer(e,t,r);a&&a.infos.length&&l.unshift(a)}},this),l},_generateSymbolTableElementForSublayer:function(e,t,n){var l=t[e.id];if(!l&&e.sublayers){var i=this._generateLegendElementsForSublayers(e.sublayers,t,n);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendLayer(l,e,n)},_generateSymbolTableElementForLegendLayer:function(e,t,n){if(e){var l=e.layerName,i=t&&t.renderer;if(i){var s=t&&t.title?t.title:this._getRendererTitle(i,t);s&&(l&&(s.title=l),l=s)}var r={type:"symbol-table",title:l,infos:[]};if(e.legend&&this._isLegendLayerInScale(e,t)){var a=t?this._sanitizeLegendForSublayer(e.legend,t):e.legend;r.infos=a.map(function(t){var l=t.url;if(t.imageData&&t.imageData.length>0)l="data:image/png;base64,"+t.imageData;else{if(0===l.indexOf("http"))return null;l=this.layer.url+"/"+e.layerId+"/images/"+l;var i=this.layer.token;i&&(l+="?token="+i)}return{label:t.label,src:l,opacity:n,width:t.width,height:t.height}},this).filter(function(e){return!!e})}return r.infos.length?r:null}},_sanitizeLegendForSublayer:function(e,t){if(this.layer.version<10.1||0===e.length)return e;var n,l,i=t.renderer,s=e.some(function(e){return e.values});return s&&e.some(function(e,t){return e.values||(n=t,l=e,l.label||(l.label="others")),null!=l}),i?"uniqueValue"===i.type?l&&(e.splice(n,1),e.push(l)):"classBreaks"===i.type&&(l&&e.splice(n,1),e.reverse(),l&&e.push(l)):l&&(e.splice(n,1),e.push(l)),e},_isLegendLayerInScale:function(e,t){var n,l,i=t||this.layer,s=!0;return!i.minScale&&0!==i.minScale||!i.maxScale&&0!==i.maxScale?(0===e.minScale&&i.tileInfo&&(n=i.tileInfo.lods[0].scale),0===e.maxScale&&i.tileInfo&&(l=i.tileInfo.lods[i.tileInfo.lods.length-1].scale)):(n=Math.min(i.minScale,e.minScale)||i.minScale||e.minScale,l=Math.max(i.maxScale,e.maxScale)),(n>0&&n<this.scale||l>this.scale)&&(s=!1),s},_getRendererLegendElements:function(e,t,s){return this._loadRenderer(e,s).then(function(r){this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1;var a=this._getVisualVariableLegendElements(r,t,s)||[],o={type:"symbol-table",title:t&&t.title?t.title:this._getRendererTitle(r,t),infos:[]},h=e.isInstanceOf(n),c=e.isInstanceOf(l),f=e.isInstanceOf(i),d=h||c||f;if(f)r.uniqueValueInfos.forEach(function(e){e.symbol&&o.infos.push({label:e.label||e.value,value:e.value,symbol:e.symbol})},this);else if(c){var y=this._isUnclassedRenderer(r),m=!y||!this._hasSizeRamp;m&&(r.classBreakInfos.forEach(function(e){e.symbol&&o.infos.unshift({label:e.label||(y?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})}),y&&(o.title=null))}else h&&r.symbol&&o.infos.push({label:r.label,symbol:r.symbol});var g=!1;if(d){var p=r.defaultLabel,b=r.defaultSymbol;b&&!y&&(o.infos.push({label:p||"others",symbol:b}),g=!0)}g||y&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:r.defaultLabel,symbol:r.defaultSymbol}]}),r=null,o.infos.length&&a.unshift(o);var v=[];return a.forEach(function(e){e.infos.forEach(function(e){e.symbol&&v.push(this._buildSwatchInfo(e))},this)},this),u.eachAlways(v).then(function(){return a})}.bind(this))},_buildSwatchInfo:function(e){return d.getSwatchInfo(e.symbol,e.size).then(function(t){return e.swatchInfo=t,e}).otherwise(function(){return e.swatchInfo=null,e})},_getVisualVariableLegendElements:function(e,t,i){var s=e.visualVariables,r=[],a=[],o=[],u=null!=i?i:this.layer.opacity,h=null,d=null;if(!s)return null;if(s.forEach(function(e){"color"===e.type?r.push(e):"size"===e.type?a.push(e):"opacity"===e.type&&o.push(e)}),s=[],Array.prototype.push.apply(s,r),Array.prototype.push.apply(s,a),Array.prototype.push.apply(s,o),0===r.length&&e.isInstanceOf(l)&&e.classBreakInfos&&1===e.classBreakInfos.length){var y=e.classBreakInfos[0];h=y&&y.symbol}if(0===r.length&&e.isInstanceOf(n)&&(h=e.symbol),h){if(h.type.indexOf("3d")>-1){var m=h.symbolLayers.getItemAt(0);m.get("material.color")&&(d=m.material.color)}else h.url||(d=h.color);d&&(d=d.toRgba())}return s.map(function(n){if(!n.legendOptions||n.legendOptions.showLegend!==!1){var l,i=t?t.title:this._getRampTitle(n,this.layer),s=c.getRampBorderColor(e),r=c.getRampOverlayColor(u);return"color"===n.type?(l={type:"color-ramp",title:i,borderColor:s,overlayColor:r,infos:c.getRampStops(e,n)},this._hasColorRamp||(this._hasColorRamp=null!=l.infos&&l.infos.length)):"size"===n.type?(l={type:"size-ramp",title:i,infos:f.getRampStops(e,n,this._getMedianColor(e),this.scale)},this._hasSizeRamp||(this._hasSizeRamp=null!=l.infos&&l.infos.length)):"opacity"===n.type&&(l={type:"opacity-ramp",title:i,borderColor:s,overlayColor:r,infos:c.getRampStops(e,n,d)},this._hasOpacityRamp||(this._hasOpacityRamp=null!=l.infos&&l.infos.length)),l.infos&&l}},this).filter(function(e){return!!e})},_loadRenderer:function(e,t){var s=e.isInstanceOf(n),r=e.isInstanceOf(l),a=e.isInstanceOf(i),o=s||r||a,h=[];if(!o)return g.warn("Renderer not supported!"),u.reject();e=e.clone();var c=this._getMedianColor(e),f=null!=t?t:this.layer.opacity;if(r||a){var d=e.classBreakInfos||e.uniqueValueInfos;d.forEach(function(e){h.push(this._fetchSymbol(e.symbol,c,f).then(function(t){e.symbol=t}).otherwise(function(){e.symbol=null}))},this)}return h.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:c,f).then(function(t){s?e.symbol=t:e.defaultSymbol=t}).otherwise(function(){s?e.symbol=null:e.defaultSymbol=null})),u.eachAlways(h).then(function(){return e})},_fetchSymbol:function(e,t,n){return e?"web-style-symbol"===e.type?e.fetchSymbol().then(function(e){return this._getAppliedCloneSymbol(e,t,n)}.bind(this)).otherwise(function(){return g.warn("Fetching web-style-symbol failed!"),u.reject()}):u.resolve(this._getAppliedCloneSymbol(e,t,n)):u.reject()},_getMedianColor:function(e){var t,n,l,i;if(!e.visualVariables)return null;if(i=o.find(e.visualVariables,function(e){return"color"===e.type}),!i)return null;if(i.colors)t=i.minDataValue,n=i.maxDataValue;else if(i.stops){if(1===i.stops.length)return i.stops[0].color;t=i.stops[0].value,n=i.stops[i.stops.length-1].value}return null!=t&&null!=n?(l=t+(n-t)/2,e.getColor(l,{colorInfo:i})):void 0},_getAppliedCloneSymbol:function(t,n,l){if(!t)return t;var i,s,r=t.clone(),a=r.type,o=a.indexOf("3d")>-1;if(n&&(i=new e(n.toRgba()),o?this._applyColorTo3dSymbol(r,i):r.color=i),"simple-line-symbol"===a||"text-symbol"===a){if(!r.color)return;s=r.color.toRgba(),s[3]=s[3]*l,r.color=s}else"simple-marker-symbol"===a||"simple-fill-symbol"===a?(r.color&&(s=r.color.toRgba(),s[3]=s[3]*l,r.color=s),r.outline&&r.outline.color&&(s=r.outline.color.toRgba(),s[3]=s[3]*l,r.outline.color=s)):o&&this._applyColorTo3dSymbol(r,null,l);return r},_applyColorTo3dSymbol:function(e,t,n){e.symbolLayers.forEach(function(e){if(e&&(t&&(e.material||(e.material={}),e.material.color=t),null!=n)){var l;e.material&&e.material.color&&(l=e.material.color.toRgba(),l[3]=l[3]*n,e.material.color=l),e.outline&&e.outline.color&&(l=e.outline.color.toRgba(),l[3]=l[3]*n,e.outline.color=l)}})},_getRampTitle:function(e,t){var n,l=e.field,i=e.normalizationField,s=!1,r=!1,a=!1;if(l=y.isFunction(l)?null:l,i=y.isFunction(i)?null:i,e.legendOptions&&e.legendOptions.title)n=e.legendOptions.title;else if(e.valueExpressionTitle)n=e.valueExpressionTitle;else{if(t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables)for(var o=t.renderer.authoringInfo.visualVariables,u=0;u<o.length;u++){var h=o[u];if("colorInfo"===h.type){if("ratio"===h.style){s=!0;break}if("percent"===h.style){r=!0;break}if("percentTotal"===h.style){a=!0;break}}}n={field:l&&this._getFieldAlias(l,t),normField:i&&this._getFieldAlias(i,t),ratio:s,ratioPercent:r,ratioPercentTotal:a}}return n},_getRendererTitle:function(e,t){if(e.legendOptions&&e.legendOptions.title)return e.legendOptions.title;if(e.valueExpressionTitle)return e.valueExpressionTitle;var n,i,s,r=this.layer,a=e.field;return e instanceof l&&(n=e.normalizationField,i="percent-of-total"===e.normalizationType),a=y.isFunction(a)?null:a,n=y.isFunction(n)?null:n,(a||n)&&(s={field:t?a:a&&this._getFieldAlias(a,r),normField:t?n:n&&this._getFieldAlias(n,r),normByPct:i}),s},_getFieldAlias:function(e,t){var n,l,i,s=t.popupTemplate,r=s&&s.fieldInfos,a=y.isFunction(e)?null:t.getField&&t.getField(e);return r&&r.some(function(t){return e===t.fieldName?(l=t,!0):void 0}),i=l||a,i&&(n=l&&l.label||a&&a.alias||i.name||i.fieldName),n},_isUnclassedRenderer:function(e){var t=!1,n=e.visualVariables,i=e.isInstanceOf(l)&&e.classBreakInfos&&1===e.classBreakInfos.length;return i&&n&&(t=e.field?n.some(function(t){return!(!t||e.field!==t.field||e.normalizationField!=t.normalizationField)}):!!n.length),t}})});