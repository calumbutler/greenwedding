// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","./Widget","./support/widget","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/HandleRegistry","./LayerList/LayerListViewModel","../core/watchUtils"],function(e,t,i,n,r,s,o,l,a,c,d,u){var p={base:"esri-layer-list esri-widget",noItems:"esri-layer-list__no-items",list:"esri-layer-list__list",listRoot:"esri-layer-list__list--root",listExclusive:"esri-layer-list__list--exclusive",listInherited:"esri-layer-list__list--inherited",listIndependent:"esri-layer-list__list--independent",item:"esri-layer-list__item",itemError:"esri-layer-list__item--error",itemInvisibleAtScale:"esri-layer-list__item--invisible-at-scale",itemUpdating:"esri-layer-list__item--updating",itemChildren:"esri-layer-list__item--has-children",itemContainer:"esri-layer-list__item-container",actionsMenu:"esri-layer-list__item-actions-menu",actionsMenuItem:"esri-layer-list__item-actions-menu-item",actions:"esri-layer-list__item-actions",actionsList:"esri-layer-list__item-actions-list",action:"esri-layer-list__item-action",actionIcon:"esri-layer-list__item-action-icon",actionImage:"esri-layer-list__item-action-image",actionTitle:"esri-layer-list__item-action-title",label:"esri-layer-list__item-label",errorMessage:"esri-layer-list__item-error-message",title:"esri-layer-list__item-title",toggleVisible:"esri-layer-list__item-toggle",toggleVisibleIcon:"esri-layer-list__item-toggle-icon",childToggle:"esri-layer-list__child-toggle",childOpened:"esri-layer-list__child-toggle-icon--opened",childClosed:"esri-layer-list__child-toggle-icon--closed",childClosed_RTL:"esri-layer-list__child-toggle-icon--closed-rtl",disabled:"esri-disabled",iconClose:"esri-icon-close",iconEllipses:"esri-icon-handle-horizontal",iconVisible:"esri-icon-visible",iconInvisible:"esri-icon-non-visible",iconRadioSelected:"esri-icon-radio-checked",iconRadioUnselected:"esri-icon-radio-unchecked",iconNoticeTriangle:"esri-icon-notice-triangle",iconChildrenOpen:"esri-icon-down-arrow",iconDownArrow:"esri-icon-down-arrow",iconRightArrow:"esri-icon-right-triangle-arrow",iconLeftArrow:"esri-icon-left-triangle-arrow"},y={actions:"actions",actionSection:"action-section",items:"items"},_={exclusive:"exclusive",inherited:"inherited",independent:"independent"},h=e.toUrl("./LayerList/images/default-action.svg"),g=function(e){function t(){e.call(this),this._handleRegistry=new c,this.createActionsFunction=null,this.view=null,this.viewModel=new d}return i(t,e),t.prototype.postInitialize=function(){var e=this,t=this.operationalItems;this.own(u.on(this,"operationalItems","change",function(){return e._itemsChanged(t)}))},t.prototype.destroy=function(){this._handleRegistry.destroy(),this._handleRegistry=null},t.prototype.render=function(){var e=this,t=this._getItems(),i=0===t.length?o.jsxFactory.createElement("div",{"class":p.noItems},a.noItemsToDisplay):o.jsxFactory.createElement("ul",{"class":o.join(p.list,p.listRoot,p.listIndependent),role:"tree"},t.map(function(t,i){return e._renderItem(t,null)})),n=(r={},r[p.disabled]="disabled"===this.viewModel.state,r);return o.jsxFactory.createElement("div",{"class":p.base,classes:n},i);var r},t.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter(function(t){return e.errorsVisible||!t.error})},t.prototype._renderItem=function(e,t){var i=this,n=this.id,r=n+"_"+e.uid,s=r+"_actions",c=!!e.children.length,d=!!e.error,u=d?a.layerError:"",y=e.visibilityMode,h=e.children&&e.children.toArray(),g=_.exclusive,m=_.inherited,v=(S={},S[p.listExclusive]=y===g,S[p.listInherited]=y===m,S[p.listIndependent]=y!==m&&y!==g,S),b=(O={},O[p.itemChildren]=c,O[p.itemError]=!!u,O[p.itemUpdating]=e.updating&&!t,O[p.itemInvisibleAtScale]=!e.visibleAtCurrentScale,O),f=this._countActions(e.actionsSections),A=f?this._renderActionMenuItem(e.actionsSections):null,x=(R={},R[p.iconEllipses]=!e.actionsOpen,R[p.iconClose]=e.actionsOpen,R),I=f>1?o.jsxFactory.createElement("div",{key:e.uid+"__actions-menu-toggle","data-item":e,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,"class":p.actionsMenuItem,tabindex:"0",role:"button","aria-controls":s,"aria-expanded":e.actionsOpen?"true":"false",title:e.actionsOpen?l.close:l.open},o.jsxFactory.createElement("span",{"aria-hidden":"true",classes:x})):null,E=f?o.jsxFactory.createElement("div",{key:e.uid+"__actions-menu","class":p.actionsMenu},A,I):null,w=f>1?this._renderActionsSections(e,e.actionsSections,s):null,k=c?o.jsxFactory.createElement("ul",{key:e.uid+"__child-list","class":p.list,classes:v,id:r,role:y===g?"radiogroup":"group",hidden:e.open?null:!0},h.map(function(t,n){return i._renderItem(t,e)})):null,C=c?o.jsxFactory.createElement("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:r+"__toggle-children","class":p.childToggle,tabindex:"0",role:"button","aria-expanded":e.open?"true":"false","aria-controls":r,title:e.open?l.collapse:l.expand},o.jsxFactory.createElement("span",{"aria-hidden":"true","class":o.join(p.childClosed,p.iconRightArrow)}),o.jsxFactory.createElement("span",{"aria-hidden":"true","class":o.join(p.childOpened,p.iconDownArrow)}),o.jsxFactory.createElement("span",{"aria-hidden":"true","class":o.join(p.childClosed_RTL,p.iconLeftArrow)})):null,j=this._createLabelNode(e,t),F=d?o.jsxFactory.createElement("div",{key:e.uid+"__error","class":p.errorMessage,role:"alert"},o.jsxFactory.createElement("span",{"aria-hidden":"true","class":p.iconNoticeTriangle}),o.jsxFactory.createElement("span",null,u)):null;return o.jsxFactory.createElement("li",{key:e.uid+"__list-item","class":p.item,classes:b,role:"treeitem"},o.jsxFactory.createElement("div",{key:e.uid+"__list-item-container","class":p.itemContainer},C,j,E),F,w,k);var S,O,R},t.prototype._createLabelNode=function(e,t){var i=_.exclusive,n=_.inherited,r=t&&t.visibilityMode,s=(y={},y[p.iconRadioSelected]=r===i&&e.visible,y[p.iconRadioUnselected]=r===i&&!e.visible,y[p.iconVisible]=r!==i&&e.visible,y[p.iconInvisible]=r!==i&&!e.visible,y),c=r===i?"radio":"checkbox",d=e.visible?"true":"false",u=o.jsxFactory.createElement("span",{"class":p.title},e.title||a.untitledLayer);return r===n?o.jsxFactory.createElement("span",{key:e.uid+"__label","class":p.label,title:e.visibleAtCurrentScale?"":a.layerInvisibleAtScale},u):o.jsxFactory.createElement("span",{key:e.uid+"__label",onclick:this._labelClick,onkeydown:this._labelClick,"data-item":e,"data-parent-visibility":r,"class":p.label,tabindex:"0","aria-checked":d,role:c,title:e.visibleAtCurrentScale?e.visible?l.visibility.hide:l.visibility.show:a.layerInvisibleAtScale},o.jsxFactory.createElement("span",{"class":p.toggleVisible},o.jsxFactory.createElement("span",{"class":p.toggleVisibleIcon},o.jsxFactory.createElement("span",{"aria-hidden":"true",classes:s}))),u);var y},t.prototype._renderActionMenuItem=function(e){var t=e.getItemAt(0),i=t&&t.getItemAt(0);if(i){var n=this._getActionImageStyles(i),r=(s={},s[i.className]=i.className,s[p.actionImage]=n["background-image"],s);return o.jsxFactory.createElement("div",{key:i.uid+"__action-menu-item",bind:this,"data-action":i,onclick:this._triggerAction,onkeydown:this._triggerAction,"class":p.actionsMenuItem,role:"button",tabindex:"0",title:i.title},o.jsxFactory.createElement("span",{classes:r,styles:n}))}var s},t.prototype._watchActionSectionChanges=function(e,t){var i=this,n=y.actionSection+t;this._handleRegistry.add(e.on("change",this.scheduleRender.bind(this)),n),e.forEach(function(e){return i._renderOnActionChanges(e,t)})},t.prototype._renderOnActionChanges=function(e,t){var i=this,n=y.actions+t;this._handleRegistry.add([u.init(e,"className, image, id, title, visible",function(){return i.scheduleRender()})],n)},t.prototype._renderOnItemChanges=function(e){var t=this,i=e.uid,n=y.items+i;this._handleRegistry.add([u.init(e,"actionsOpen, visible, open, updating, title, visibleAtCurrentScale, error, visibilityMode",function(){return t.scheduleRender()}),e.actionsSections.on("change",function(){return t.scheduleRender()}),e.children.on("change",function(){return t.scheduleRender()})],n),e.children.forEach(function(e){return t._renderOnItemChanges(e)}),e.actionsSections.forEach(function(e){return t._watchActionSectionChanges(e,i)})},t.prototype._itemsChanged=function(e){var t=this;this._handleRegistry.removeAll(),e.forEach(function(e){return t._renderOnItemChanges(e)}),this.scheduleRender()},t.prototype._renderActionsSections=function(e,t,i){var n=this,r=t.toArray(),s=r.map(function(t){return o.jsxFactory.createElement("ul",{key:e.uid+"__actions-list","class":p.actionsList},n._renderActionSection(t))});return o.jsxFactory.createElement("div",{key:e.uid+"__actions-section",id:i,"class":p.actions,hidden:e.actionsOpen?null:!0},s)},t.prototype._renderActionSection=function(e){var t=this,i=e&&e.toArray();return i.map(function(e){return t._renderAction(e)})},t.prototype._renderAction=function(e){var t=this._getActionImageStyles(e),i=(n={},n[e.className]=e.className,n[p.actionImage]=t["background-image"],n);return o.jsxFactory.createElement("li",{key:e.uid+"__action",bind:this,"data-action":e,onclick:this._triggerAction,onkeydown:this._triggerAction,"class":p.action,tabindex:"0",role:"button",title:e.title},o.jsxFactory.createElement("span",{"aria-hidden":"true","class":p.actionIcon,classes:i,styles:t}),o.jsxFactory.createElement("span",{"class":p.actionTitle},e.title));var n},t.prototype._countActions=function(e){return e.reduce(function(e,t){return e+t.length},0)},t.prototype._getActionImageStyles=function(e){var t=e.image||null;return e.className||t||(t=h),{"background-image":t?'url("'+t+'")':null}},t.prototype._toggleActionsOpen=function(e){var t=e.currentTarget,i=t["data-item"];i.actionsOpen=!i.actionsOpen},t.prototype._triggerAction=function(e){var t=e.currentTarget,i=t["data-action"];this.triggerAction(i)},t.prototype._labelClick=function(e){var t=e.currentTarget,i=t.getAttribute("data-parent-visibility"),n=t["data-item"];i===_.exclusive&&n.visible||(n.visible=!n.visible)},t.prototype._toggleChildrenClick=function(e){var t=e.currentTarget,i=t["data-item"];i.open=!i.open},n([r.aliasOf("viewModel.createActionsFunction"),o.renderable()],t.prototype,"createActionsFunction",void 0),n([r.property(),o.renderable()],t.prototype,"errorsVisible",void 0),n([r.aliasOf("viewModel.operationalItems"),o.renderable()],t.prototype,"operationalItems",void 0),n([r.aliasOf("viewModel.view"),o.renderable()],t.prototype,"view",void 0),n([o.vmEvent("trigger-action"),r.property({type:d}),o.renderable("viewModel.state")],t.prototype,"viewModel",void 0),n([r.aliasOf("viewModel.triggerAction")],t.prototype,"triggerAction",void 0),n([o.accessibleHandler()],t.prototype,"_toggleActionsOpen",null),n([o.accessibleHandler()],t.prototype,"_triggerAction",null),n([o.accessibleHandler()],t.prototype,"_labelClick",null),n([o.accessibleHandler()],t.prototype,"_toggleChildrenClick",null),t=n([r.subclass("esri.widgets.LayerList")],t)}(r.declared(s));return g});