// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./tsSupport/declareExtendsHelper","./tsSupport/decorateHelper","dojo/aspect","./accessorSupport/decorators","./accessorSupport/ensureType","./Accessor","./ArrayPool","./Evented","./ObjectPool","./Scheduler","./lang"],function(t,e,i,r,n,s,o,h,a,c,l,f,u){function p(t){return t&&t.isInstanceOf&&t.isInstanceOf(B)?!0:!1}function g(t){return t?p(t)?t.toArray():t.length?Array.prototype.slice.apply(t):[]:[]}function m(t){return t&&t.length?t[0]:void 0}function v(t,e,i,r){for(var n=Math.min(t.length-i,e.length-r),s=0;n>s&&t[i+s]===e[r+s];)s++;return s}function d(t,e,i,r){e&&e.forEach(function(e,n,s){t.push(e),d(t,i.call(r,e,n,s),i,r)})}function _(){return h}var y=(function(){function t(){}return t}(),function(){function t(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1}return t.prototype.preventDefault=function(){this.cancellable&&(this.defaultPrevented=!0)},t.prototype.reset=function(t){this.defaultPrevented=!1,this.item=t},t}()),C=function(){},A=new l(y,function(){this.item=null,this.target=null}),b=new Set,x=new Set,E=new Set,O=new Map,w=0,B=function(t){function e(e){t.call(this,e),this._boundDispatch=this._dispatchColChange.bind(this),this._chgListeners=[],this._notifications=null,this._timer=null,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:w++})}return i(e,t),e.ofType=function(t){if(!t)return e;if(O.has(t))return O.get(t);var i=e.createSubclass({declaredClass:"esri.core.Collection<"+t.prototype.declaredClass+">"});return Object.defineProperty(i.prototype,"itemType",{value:t}),O.set(t,i),i},e.prototype.normalizeCtorArgs=function(t){return t?Array.isArray(t)||p(t)?{items:t}:t:{}},Object.defineProperty(e.prototype,"items",{get:function(){return this._items},set:function(t){this._emitBeforeChanges()||(this._splice.apply(this,[0,this.length].concat(g(t))),this._emitAfterChanges())},enumerable:!0,configurable:!0}),e.prototype.on=function(t,e){var i;if(Array.isArray(t)?i=t:t.indexOf(",")>-1&&(i=t.split(/\s*,\s*/)),i){for(var r=[],s=0,o=i;s<o.length;s++){var h=o[s];r.push(this.on(h,e))}return r.remove=function(){for(var t=0;t<r.length;t++)r[t].remove()},r}if("change"===t){var a=this._chgListeners,c={removed:!1,callback:e};return a.push(c),this._notifications&&this._notifications.push({listeners:a.slice(),items:this._items.slice(),changes:[]}),{remove:function(){this.remove=C,c.removed=!0,a.splice(a.indexOf(c),1)}}}return n.after(this,"on"+t,e,!0)},e.prototype.hasEventListener=function(t){return"change"===t?this._chgListeners.length>0:this.inherited(arguments)},e.prototype.add=function(t,e){if(this._emitBeforeChanges())return this;var i=this.getNextIndex(e);return this._splice(i,0,t),this._emitAfterChanges(),this},e.prototype.addMany=function(t,e){if(void 0===e&&(e=this._items.length),this._emitBeforeChanges())return this;var i=this.getNextIndex(e);return this._splice.apply(this,[i,0].concat(g(t))),this._emitAfterChanges(),this},e.prototype.removeAll=function(){if(!this.length||this._emitBeforeChanges())return[];var t=this._splice(0,this.length)||[];return this._emitAfterChanges(),t},e.prototype.clone=function(){return this._createNewInstance({items:this._items.map(u.clone)})},e.prototype.concat=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var i=t.map(g);return this._createNewInstance({items:(r=this._items).concat.apply(r,i)});var r},e.prototype.drain=function(t,e){if(this.length&&!this._emitBeforeChanges()){for(var i=this._splice(0,this.length),r=0,n=i.length;n>r;r++)t.call(e,i[r],r,i);this._emitAfterChanges()}},e.prototype.every=function(t,e){return this._items.every(t,e)},e.prototype.filter=function(t,e){var i;return i=2===arguments.length?this._items.filter(t,e):this._items.filter(t),this._createNewInstance({items:i})},e.prototype.find=function(t,e){if("function"!=typeof t)throw new TypeError(t+" is not a function");for(var i=this._items,r=0,n=i.length;n>r;r++){var s=i[r];if(t.call(e,s,r,i))return s}},e.prototype.findIndex=function(t,e){if("function"!=typeof t)throw new TypeError(t+" is not a function");for(var i=this._items,r=0,n=i.length;n>r;r++){var s=i[r];if(t.call(e,s,r,i))return r}return-1},e.prototype.flatten=function(t,i){var r=[];return d(r,this,t,i),new e(r)},e.prototype.forEach=function(t,e){for(var i=this._items,r=function(i,r,n){t.call(e,i,r,n)},n=0,s=i.length;s>n;n++)r(i[n],n,i)},e.prototype.getItemAt=function(t){return this._items[t]},e.prototype.getNextIndex=function(t){var e=this.length;return t=null==t?e:t,0>t?t=0:t>e&&(t=e),t},e.prototype.includes=function(t,e){return void 0===e&&(e=0),arguments.length?-1!==this._items.indexOf(t,e):!1},e.prototype.indexOf=function(t,e){return void 0===e&&(e=0),this._items.indexOf(t,e)},e.prototype.join=function(t){return void 0===t&&(t=","),this._items.join(t)},e.prototype.lastIndexOf=function(t,e){return void 0===e&&(e=this.length-1),this._items.lastIndexOf(t,e)},e.prototype.map=function(t,i){var r=this._items.map(t,i);return new e({items:r})},e.prototype.reorder=function(t,e){void 0===e&&(e=this.length-1);var i=this.indexOf(t);if(-1!==i){if(0>e?e=0:e>=this.length&&(e=this.length-1),i!==e){if(this._emitBeforeChanges())return t;this._splice(i,1),this._splice(e,0,t),this._emitAfterChanges()}return t}},e.prototype.pop=function(){if(this.length&&!this._emitBeforeChanges()){var t=m(this._splice(this.length-1,1));return this._emitAfterChanges(),t}},e.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this._emitBeforeChanges()?this.length:(this._splice.apply(this,[this.length,0].concat(t)),this._emitAfterChanges(),this.length)},e.prototype.reduce=function(t,e){var i=this._items;return 2===arguments.length?i.reduce(t,e):i.reduce(t)},e.prototype.reduceRight=function(t,e){var i=this._items;return 2===arguments.length?i.reduceRight(t,e):i.reduceRight(t)},e.prototype.remove=function(t){return this.removeAt(this.indexOf(t))},e.prototype.removeAt=function(t){if(!(0>t||t>=this.length||this._emitBeforeChanges())){var e=m(this._splice(t,1));return this._emitAfterChanges(),e}},e.prototype.removeMany=function(t){if(!t||!t.length||this._emitBeforeChanges())return[];for(var e=p(t)?t.toArray():t,i=this._items,r=[],n=0,s=e.length;s>n;n++){var o=e[n],h=i.indexOf(o);if(h>-1){var a=1+v(e,i,n+1,h+1),c=this._splice(h,a);c&&c.length>0&&r.push.apply(r,c),n+=a-1}}return this._emitAfterChanges(),r},e.prototype.reverse=function(){if(this._emitBeforeChanges())return this;var t=this._splice(0,this.length);return t&&(t.reverse(),this._splice.apply(this,[0,0].concat(t))),this._emitAfterChanges(),this},e.prototype.shift=function(){if(this.length&&!this._emitBeforeChanges()){var t=m(this._splice(0,1));return this._emitAfterChanges(),t}},e.prototype.slice=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=this.length),this._createNewInstance({items:this._items.slice(t,e)})},e.prototype.some=function(t,e){return this._items.some(t,e)},e.prototype.sort=function(t){if(!this.length||this._emitBeforeChanges())return this;var e=this._splice(0,this.length);return arguments.length?e.sort(t):e.sort(),this._splice.apply(this,[0,0].concat(e)),this},e.prototype.splice=function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];if(this._emitBeforeChanges())return[];var n=this._splice.apply(this,[t,e].concat(i))||[];return this._emitAfterChanges(),n},e.prototype.toArray=function(){return this._items.slice()},e.prototype.toJSON=function(){return this.toArray()},e.prototype.toLocaleString=function(){return this._items.toLocaleString()},e.prototype.toString=function(){return this._items.toString()},e.prototype.unshift=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this._emitBeforeChanges()?this.length:(this._splice.apply(this,[0,0].concat(t)),this._emitAfterChanges(),this.length)},e.prototype._createNewInstance=function(t){return new this.constructor(t)},e.prototype._splice=function(t,e){for(var i=this,r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var s,h,a,c=this._items,l=this.constructor.prototype.itemType;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=f.schedule(this._boundDispatch)),e){if(a=c.splice(t,e),this.hasEventListener("before-remove")){s=A.acquire(),s.target=this,s.cancellable=!0;for(var u=0,p=a.length;p>u;u++)h=a[u],s.reset(h),this.emit("before-remove",s),s.defaultPrevented&&(a.splice(u,1),c.splice(t,0,h),t+=1,u-=1,p-=1);A.release(s)}if(this.length=this._items.length,this.hasEventListener("after-remove")){s=A.acquire(),s.target=this,s.cancellable=!1;for(var u=0,p=a.length;p>u;u++)s.reset(a[u]),this.emit("after-remove",s);A.release(s)}this._notifyChangeEvent(null,a)}if(r&&r.length){if(l&&(r=r.map(o.ensureType.bind(null,l))),this.hasEventListener("before-add")){var g=A.acquire();g.target=this,g.cancellable=!0,r=r.filter(function(t){return g.reset(t),i.emit("before-add",g),!g.defaultPrevented}),A.release(g)}if(c.splice.apply(c,[t,0].concat(r)),this.length=this._items.length,this.hasEventListener("after-add")){s=A.acquire(),s.target=this,s.cancellable=!1;for(var m=0,v=r;m<v.length;m++)h=v[m],s.reset(h),this.emit("after-add",s);A.release(s)}this._notifyChangeEvent(r,null)}return a},e.prototype._emitBeforeChanges=function(){var t=!1;if(this.hasEventListener("before-changes")){var e=A.acquire();e.target=this,e.cancellable=!0,this.emit("before-changes",e),t=e.defaultPrevented,A.release(e)}return t},e.prototype._emitAfterChanges=function(){if(this.hasEventListener("after-changes")){var t=A.acquire();t.target=this,t.cancellable=!1,this.emit("after-changes",t),A.release(t)}},e.prototype._notifyChangeEvent=function(t,e){this.hasEventListener("change")&&this._notifications[this._notifications.length-1].changes.push({added:t,removed:e})},e.prototype._dispatchColChange=function(){if(this._timer&&(this._timer.remove(),this._timer=null),this._notifications){var t=this._notifications;this._notifications=null;for(var e=function(t){var e=t.changes;b.clear(),x.clear(),E.clear();for(var r=0,n=e;r<n.length;r++){var s=n[r],o=s.added,h=s.removed;if(o)if(0===E.size&&0===x.size)for(var c=0,l=o;c<l.length;c++){var f=l[c];b.add(f)}else for(var u=0,p=o;u<p.length;u++){var f=p[u];x.has(f)?(E.add(f),x["delete"](f)):E.has(f)||b.add(f)}if(h)if(0===E.size&&0===b.size)for(var g=0,m=h;g<m.length;g++){var f=m[g];x.add(f)}else for(var v=0,d=h;v<d.length;v++){var f=d[v];b.has(f)?b["delete"](f):(E["delete"](f),x.add(f))}}var _=a.acquire();b.forEach(function(t){_.push(t)});var y=a.acquire();x.forEach(function(t){y.push(t)});var C=i._items,A=t.items,O=a.acquire();if(E.forEach(function(t){A.indexOf(t)!==C.indexOf(t)&&O.push(t)}),t.listeners&&(_.length||y.length||O.length))for(var w={target:i,added:_,removed:y,moved:O},B=t.listeners,L=0,I=B.length;I>L;L++){var S=t.listeners[L];S.removed||S.callback.call(i,w)}a.release(_),a.release(y),a.release(O)},i=this,r=0,n=t;r<n.length;r++){var s=n[r];e(s)}}},e.isCollection=p,r([s.property()],e.prototype,"length",void 0),r([s.property()],e.prototype,"items",null),e=r([s.subclass("esri.core.Collection")],e)}(s.declared(_(),c));return B});