// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/has","../ObjectPool","../ArrayPool","../Scheduler","../lang","./Cache","./OldValues","./Property","./once","./ensureType","./introspect","./chainWatch"],function(t,i,e,s,r,n,a,h,l,o,c,u){var p=t("dojo-debug-messages"),f=Object.prototype.hasOwnProperty,d=0,y=function(t){return Object.create(void 0===t?null:t)},g=new i(function(){this.fn=null,this.isExecuting=!1,this.removed=!1},function(){this.fn=null}),v=new i(function(){this.oldValue=null,this.callbacks=null},function(){this.oldValue=null,this.callbacks=e.release(this.callbacks),this.callbacks=null}),b=function(t){this.uid="propertoire_"+d++,this.obj=t,this.properties=Object.create(c.getProperties(t)),this.cache=new n,this.watchers=y(),this.bindings=y(),this.defaults=null,this.access=y(),this._notificationsPool=new i(function(){},function(){}),this.notifications=this._notificationsPool.acquire(),this.cursors={}};return b.prototype={obj:null,properties:null,notifyHdls:null,cache:null,watchers:null,bindings:null,initialized:!1,notifications:null,ctorArgs:null,timer:null,_boundDispatch:null,initialize:function(){this.initialized=!0,this.notifyHdls=c.installPropertyNotifiers(this.obj),this.dispatch()},destroy:function(){this.notifyHdls&&this.notifyHdls.forEach(function(t){return t.remove()},this),this.timer&&this.timer.remove();var t=this.watchers;Object.getOwnPropertyNames(t).forEach(function(i){t[i].callbacks.forEach(function(t){t.removed=!0})});var i=this.cursors;Object.getOwnPropertyNames(i).forEach(function(t){var e=i[t];if(e){for(;e.length>0;)e.pop().moveBackward(this,t);i[t]=null}},this),this.cache.destroy(),this.defaults&&this.defaults.destroy(),this.obj=null,this.timer=null,this.notifyHdls=null,this.properties=null,this.cache=null,this.watchers=null,this.bindings=null,this.notifications=null,this.defaults=null,this.access=null},getFromCache:function(t){var i=this.cache,e=this.defaults,s=this.properties[t];return i.has(t)?i.get(t):e&&e.has(t)?e.get(t):s.value},get:function(t,i){var e=this.cache,s=this.defaults;if(e){if(e.has(t)&&!e.isDirty(t))return e.get(t);var r,n=this.obj,a=this._defineProperty(t),h=a.getter,l=a.getterArity;if(e.has(t))!i&&this.propertyWillChange(t),r=e.get(t),h&&(r=l?h.call(n,r):h.call(n)),e.set(t,r),this.propertyHasChanged(t,r);else{if(!h)return s&&s.has(t)?s.get(t):a.value;!i&&this.propertyWillChange(t),r=l?h.call(n,a.value):h.call(n),e.set(t,r),this.propertyHasChanged(t,r)}return r}},set:function(t,i){var e=this._defineProperty(t),s=e.getter,r=e.setter,n=e.setterArity,a=this.obj,h=this.cache;this.propertyWillChange(t),this.propertyInvalidated(t),i=o(i,e.type),r?(i=2===n?r.call(a,i,this.getFromCache(t)):r.call(a,i),void 0===i&&s||(h.set(t,i),this.propertyHasChanged(t,i))):(h.set(t,i),this.propertyHasChanged(t,i))},setDefault:function(t,i){var e=this.defaults;e||(this.defaults=e=new n);var s=this._defineProperty(t,!0),r=s.getter,a=s.setter,h=s.getterArity,l=s.setterArity,c=this.obj,u=this.cache.has(t);i=o(i,s.type),u&&e.set(t,i),u||(a&&(i=2===l?a.call(c,i,e.get(t)):a.call(c,i),r&&(i=h?r.call(c,void 0):r.call(c))),this.initialized||e.set(t,i),this.propertyWillChange(t),e.set(t,i),this.propertyHasChanged(t,i))},hasBindings:function(t){var i=this.bindings[t];return null!=i&&i.length>0},hasWatchers:function(t){var i=this.watchers[t];return null!=i&&i.callbacks.length>0},bind:function(t,i){var e=this.bindings[t];return e?e.push(i):(this._defineProperty(t,!0),this.bindings[t]=e=[i]),{remove:l(function(){e.splice(e.indexOf(i),1)})}},propertyInvalidated:function(t){var i=this.cursors[t];i&&i.forEach(function(i){i.propertyInvalidated(this,t)},this)},propertyCommitted:function(t){var i=this.cursors[t];i&&i.forEach(function(i){i.propertyCommitted(this,t)},this)},addCursor:function(t,i){var e=this.cursors[t];e||(this.cursors[t]=e=[]),e.push(i)},removeCursor:function(t,i){var e=this.cursors[t];this.cursors[t]&&(e.splice(e.indexOf(i),1),0===e.length&&(this.cursors[t]=null))},propertyDependencyMayChange:function(t,i){this._propertyWillChange(t),this.propertyInvalidated(t)},propertyWillChange:function(t){var i,e,s=this.properties[t],r=s.chain;if(r)for(i=0,e=r.length;e>i;i++)this._propertyWillChange(r[i]);this._propertyWillChange(t)},_propertyWillChange:function(t){var i=this.cache,r=this.bindings[t],n=this.watchers[t],a=n&&n.callbacks,h=n&&n.oldValues,l=this.notifications[t],o=a&&a.length>0,c=this.initialized&&!this.timer,u=null;if(r)for(var p=0,f=r.length;f>p;p++)r[p]();o&&(l||(l=this.notifications[t]=e.acquire(),n.isDirty=!0),n.isDirty&&(n.isDirty=!1,u=v.acquire(),u.oldValue=this.get(t,!0),u.callbacks=e.copy(a),l.push(u),h&&(i.set(t,h.add(this.obj[t])),i.setDirty(t))),c&&(this._boundDispatch||(this._boundDispatch=this.dispatch.bind(this)),this.timer=s.schedule(this._boundDispatch))),i.setDirty(t)},propertyHasChanged:function(t,i){if(this.hasBindings(t))for(var e=this.bindings[t],s=0,r=e.length;r>s;s++)e[s](i);this.propertyCommitted(t,i)},internalGet:function(t){return this.get(t,!0)},watch:function(t,i){var s,r=this.obj,n=this.properties,h=this.watchers[t];if(Array.isArray(t)?s=t:t.indexOf(",")>-1&&(s=t.split(/\s*,\s*/)),s){for(var o=e.acquire(),c=0;t=s[c++];)o.push(this.watch(t,i));return{handles:o,remove:l(function(){for(var t=0,i=o.length;i>t;t++)o[t].remove();e.release(o)})}}if(t.indexOf(".")>-1)return u(r,t,i);var p=g.acquire();return p.fn=i,h?(h.isDirty=!0,h.callbacks.push(p)):(this._defineProperty(t),this.get(t,!0),this.watchers[t]=h={isDirty:!0,callbacks:[p]},n[t].copy&&(h.oldValues=new a(n[t].copy))),{remove:l(function(){p.removed=!0,h.callbacks.splice(h.callbacks.indexOf(p),1)})}},dispatch:function(){this.timer=null;var t,i,s,n,a,h,l,o,c=this.obj,u=this.notifications,p=this.watchers;this.notifications=this._notificationsPool.acquire();var f=e.acquire();for(i in u)if(n=u[i]){for(u[i]=null,f.length=0,l=this.get(i),o=p[i].oldValues,a=0;s=n[a];a++){if(!r.equals(s.oldValue,l))for(h=0;t=s.callbacks[h];h++)t.isExecuting||t.removed||-1!==f.indexOf(t)||(f.push(t),t.isExecuting=!0,t.fn.call(c,l,s.oldValue,i,c),t.isExecuting=!1);v.release(s)}o&&o.reset(),e.release(n)}this._notificationsPool.release(u),e.release(f)},_defineProperty:function(t,i){var e,s=this.obj,r=this.properties,n=r[t],a=!1;if(n)return n;var l=c.getPropertyOwner(s,t);return l&&(n=c(l).mixin.properties[t]),n||(f.call(this.obj,t)&&(e=this.obj[t],delete this.obj[t],a=!0),i?n=c.defineProperty(this.obj,t):(p&&console.debug("[%s] defining dynamic property '%s'",s.declaredClass,t),n=new h(t,{value:c.getPropertyOwnerValue(s,t)}),Object.defineProperty(s,t,n.getDescriptor())),a&&this.cache.set(t,e)),r[t]=n,n}},b});