// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../core/declare","../core/Accessor","../core/JSONSupport","../core/kebabDictionary","../core/screenUtils","../core/lang","../core/Error","dojo/_base/lang","../Color","./support/arcadeUtils"],function(e,t,i,a,o,s,r,n,l,c){var u="size",p="color",f="opacity",h="rotation",y=a({sizeInfo:u,colorInfo:p,transparencyInfo:f,rotationInfo:h}),v=a({widthAndDepth:"width-and-depth"}),m=a({classedSize:"classed-size",classedColor:"classed-color",univariateColorSize:"univariate-color-size"}),d=a({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),_=a({percentTotal:"percent-of-total"}),S=Math.PI,b=e([t,i],{declaredClass:"esri.renderer.Renderer",properties:{authoringInfo:{value:null,json:{read:function(e,t){return e&&(e=s.clone(e),e.type&&(e.type=m.fromJSON(e.type)),e.classificationMethod&&(e.classificationMethod=d.fromJSON(e.classificationMethod)),e.visualVariables&&e.visualVariables.forEach(function(e){e.type&&(e.type=y.fromJSON(e.type)),e.style&&(e.style=_.fromJSON(e.style))})),e},write:function(e,t){e&&(e=s.clone(e),e.type&&(e.type=m.toJSON(e.type)),e.classificationMethod&&(e.classificationMethod=d.toJSON(e.classificationMethod)),e.visualVariables&&e.visualVariables.forEach(function(e){e.type&&(e.type=y.toJSON(e.type)),e.style&&(e.style=_.toJSON(e.style))})),t.authoringInfo=e}}},requiredFields:{dependsOn:["visualVariables"],get:function(){var e=Object.create(null);return this.collectRequiredFields(e),Object.keys(e)}},type:{readOnly:!0,json:{readable:!1,writeAlways:!0}},visualVariables:{json:{readFrom:["visualVariables","rotationType","rotationExpression"],read:function(e,t){return this._readVariables(e,t)},write:function(e,t,i){var a=[];e.forEach(function(e,t){e.type===u?a.push(this._writeSizeInfo(e,i,t)):e.type===p?a.push(this._writeColorInfo(e,i,t)):e.type===f?a.push(this._writeOpacityInfo(e,i,t)):e.type===h&&a.push(this._writeRotationInfo(e,i,t))},this),t.visualVariables=a}}}},constructor:function(){this._cache={}},_rotationRE:/^\[([^\]]+)\]$/i,_meterIn:{inches:39.3701,feet:3.28084,yards:1.09361,miles:621371e-9,"nautical-miles":539957e-9,millimeters:1e3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},_viewScaleRE:/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,_visualVariablesSetter:function(e){var t=this._cache;this.visualVariables&&this.visualVariables.forEach(function(e,i){t.hasOwnProperty(i)&&(t[i]=null)},this);var i=e&&e.some(function(e){return!!e.target});i&&e.sort(function(e,t){var i;return i=e.target===t.target?0:e.target?1:-1}),e&&e.forEach(function(e,i){e.type===p?t[i]=this._processColorInfo(e):e.type===f?t[i]=this._processOpacityInfo(e):e.type===u?t[i]=this._processSizeInfo(e):e.type===h&&(t[i]=this._processRotationInfo(e))},this),this._set("visualVariables",e)},getSymbol:function(e,t){},getVisualVariableValues:function(e,t){var i,a=this.visualVariables;return a&&(i=a.map(function(i){var a,o=i.type,s=o+"Info";switch(t=n.mixin({},t),t[s]=i,o){case u:a=this.getSize(e,t);break;case p:a=this.getColor(e,t);break;case f:a=this.getOpacity(e,t);break;case h:a=this.getRotationAngle(e,t)}return{variable:i,value:a}},this).filter(function(e){return null!=e.value},this)),i},hasVisualVariables:function(e,t){return e?!!this.getVisualVariablesForType(e,t):!!(this.getVisualVariablesForType(u,t)||this.getVisualVariablesForType(p,t)||this.getVisualVariablesForType(f,t)||this.getVisualVariablesForType(h,t))},getVisualVariablesForType:function(e,t){var i,a=this.visualVariables;return a&&(i=a.filter(function(i){return i.type===e&&("string"==typeof t?i.target===t:t===!1?!i.target:!0)}),i&&0===i.length&&(i=void 0)),i},getSize:function(e,t){var i=this._getVarInfo(t&&t.sizeInfo,u),a=i.variable,o=this._cache[i.cacheKey],s=null;if(a){var r=a.minSize,n=a.maxSize,l="object"==typeof r&&r?this._getSize(e,r,o&&o.minSize,t):r,c="object"==typeof n&&n?this._getSize(e,n,o&&o.maxSize,t):n;s=this._getSize(e,a,o&&o.root,t,[l,c])}return s},getSizeRangeAtScale:function(e,t){var i,a=this._getVarInfo(e,u),o=this._cache[a.cacheKey],s={scale:t};if(e=a.variable,e&&t){var r=e.minSize,n=e.maxSize,l="object"==typeof r&&r?this._getSize({},r,o&&o.minSize,s):r,c="object"==typeof n&&n?this._getSize({},n,o&&o.maxSize,s):n;(null!=l||null!=c)&&(i={minSize:l,maxSize:c})}return i},getColor:function(e,t){var i=this._getVarInfo(t&&t.colorInfo,p);return this._getColorComponent(e,i.variable,this._cache[i.cacheKey],t)},getOpacity:function(e,t){var i=this._getVarInfo(t&&t.opacityInfo,f);return this._getColorComponent(e,i.variable,this._cache[i.cacheKey],t,!0)},getRotationAngle:function(e,t){var i=this._getVarInfo(t&&t.rotationInfo,h),a=i.variable,o=this._cache[i.cacheKey],s="arithmetic"===a.rotationType,r=a.field,l=o&&o.compiledFunc,u=e.attributes,p=0;return(r||l)&&(l?p=c.executeFunction(l,c.createExecContext(e,c.getView(t))):n.isFunction(r)?p=r.apply(this,arguments):u&&(p=u[r]||0),p="number"!=typeof p||isNaN(p)?null:(p+(s?-90:0))*(s?-1:1)),p},collectRequiredFields:function(e){var t=[];this.visualVariables&&(t=t.concat(this.visualVariables)),t.forEach(function(t){t&&t.field&&(e[t.field]=!0),t&&t.normalizationField&&(e[t.normalizationField]=!0)})},_getVarInfo:function(e,t){var i;if(e&&e.type===t&&this.visualVariables)i=this.visualVariables.indexOf(e),e=this.visualVariables[i];else if(this.visualVariables){var a=this.getVisualVariablesForType(t);e=a&&a[0],i=this.visualVariables.indexOf(e)}return{variable:e,cacheKey:i}},_readSizeInfo:function(e){return e.axis&&(e.axis=v.fromJSON(e.axis)),e},_readColorInfo:function(e){return e&&(e.colors&&e.colors.forEach(function(t,i){n.isArray(t)?e.colors[i]=l.fromJSON(t):e.colors[i]=new l(t)}),e.stops&&e.stops.forEach(function(t,i){t.color&&n.isArray(t.color)?e.stops[i].color=l.fromJSON(t.color):t.color&&(e.stops[i].color=new l(t.color))})),e},_readOpacityInfo:function(e){var t;return e&&(t=n.mixin({},e),t.transparencyValues&&(t.opacityValues=t.transparencyValues.map(function(e){return 1-e/100}),delete t.transparencyValues),t.stops&&(t.stops=t.stops.map(function(e){return e=n.mixin({},e),e.opacity=1-e.transparency/100,delete e.transparency,e}))),t},_readVariables:function(e,t){e&&(e=e.map(function(e){return e=s.clone(e),e.type=y.fromJSON(e.type),e.type===u?e=this._readSizeInfo(e):e.type===p?e=this._readColorInfo(e):e.type===f&&(e=this._readOpacityInfo(e)),e},this));var i=t.rotationType,a=t.rotationExpression;if(a){var o={type:h,rotationType:i},r=a.match(this._rotationRE);r&&r[1]&&(o.field=r[1],e||(e=[]),e.push(o))}return e},_createCache:function(e){var t=e&&e.valueExpression,i=c.createSyntaxTree(t),a=c.createFunction(i),o=!(!e||!e.expression)||this._viewScaleRE.test(t);return{ipData:this._interpolateData(e),hasExpr:!!t,compiledFunc:a,isScaleDriven:o}},_processColorInfo:function(e){return e&&(e.colors&&e.colors.forEach(function(t,i){t instanceof l||(e.colors[i]=new l(t))}),e.stops&&e.stops.forEach(function(t,i){!t.color||t.color instanceof l||(e.stops[i].color=new l(t.color))}),this._sortStops(e.stops)),this._createCache(e)},_processOpacityInfo:function(e){return this._sortStops(e&&e.stops),this._createCache(e)},_processSizeInfo:function(e){return e.stops&&Array.isArray(e.stops)?e.stops=this._processSizeInfoStops(e.stops):(e.minSize=e.minSize&&this._processSizeInfoSize(e.minSize),e.maxSize=e.maxSize&&this._processSizeInfoSize(e.maxSize)),{root:this._createCache(e),minSize:this._createCache(e.minSize),maxSize:this._createCache(e.maxSize)}},_processSizeInfoSize:function(e){return"object"==typeof e?e.stops=this._processSizeInfoStops(e.stops):e=o.toPt(e),e},_processSizeInfoStops:function(e){return e&&Array.isArray(e)&&(e.forEach(function(e){e.size=o.toPt(e.size)}),this._sortStops(e)),e},_sortStops:function(e){e&&Array.isArray(e)&&e.sort(function(e,t){return e.value-t.value})},_processRotationInfo:function(e){return this._createCache(e)},_getSize:function(e,t,i,a,o){var s=e.attributes,r=t.field,l=t.stops,u=0,p=i&&i.hasExpr,f=i&&i.compiledFunc,h=i&&i.ipData,y=i&&i.isScaleDriven,v="number"==typeof e,m=v?e:null;if(r||y||p){var d,_=a&&a.scale,b=o?o[0]:t.minSize,g=o?o[1]:t.maxSize,V=t.minDataValue,x=t.maxDataValue,z=t.valueUnit||"unknown",O=t.valueRepresentation,I=t.scaleBy,C=t.normalizationField,w=s?parseFloat(s[C]):void 0,E=a&&a.shape;if(y?m=null==_?this._getAverageValue(t):_:"number"!=typeof m&&(p?m=c.executeFunction(f,c.createExecContext(e,c.getView(a))):n.isFunction(r)?m=r.apply(this,arguments):s&&(m=s[r])),null==m||C&&!v&&(isNaN(w)||0===w))return null;if(isNaN(w)||v||(m/=w),l){var N,F,J=this._lookupData(m,h),D=J[0],T=J[1];D===T?u=l[D].size:(N=l[D].size,F=l[T].size,u=N+(F-N)*J[2])}else if(null!=b&&null!=g&&null!=V&&null!=x)if(V>=m)u=b;else if(m>=x)u=g;else if(d=(m-V)/(x-V),"area"===I&&E){var A="circle"===E,M=A?S*Math.pow(b/2,2):b*b,j=A?S*Math.pow(g/2,2):g*g,R=M+d*(j-M);u=A?2*Math.sqrt(R/S):Math.sqrt(R)}else u=b+d*(g-b);else if("unknown"===z)null!=b&&null!=V?(b&&V?(d=m/V,u="circle"===E?2*Math.sqrt(d*Math.pow(b/2,2)):"square"===E||"diamond"===E||"image"===E?Math.sqrt(d*Math.pow(b,2)):d*b):u=m+(b||V),u=b>u?b:u,null!=g&&u>g&&(u=g)):u=m;else{var k=(a&&a.resolution?a.resolution:1)*this._meterIn[z];"area"===O?(u=Math.sqrt(m/S)/k,u*=2):(u=m/k,("radius"===O||"distance"===O)&&(u*=2)),null!=b&&b>u&&(u=b),null!=g&&u>g&&(u=g)}}else t&&(u=l&&l[0]&&l[0].size,null==u&&(u=t.minSize));return u=isNaN(u)?0:u},_getAverageValue:function(e){var t,i,a=e.stops;return a?(t=a[0].value,i=a[a.length-1].value):(t=e.minDataValue||0,i=e.maxDataValue||0),(t+i)/2},_getColorComponent:function(e,t,i,a,o,s){var r,l=e.attributes,u=t&&t.field,p="number"==typeof e,f=p?e:null,h=i&&i.hasExpr,y=i&&i.compiledFunc,v=i&&i.ipData;if(u||h){var m=t.normalizationField,d=l?parseFloat(l[m]):void 0;"number"!=typeof f&&(h?f=c.executeFunction(y,c.createExecContext(e,c.getView(a))):n.isFunction(u)?f=u.apply(this,arguments):l&&(f=l[u])),null==f||m&&!p&&(isNaN(d)||0===d)||(isNaN(d)||p||(f/=d),r=o?this._getOpacity(f,t,v):this._getColor(f,t,v))}else if(t){var _=t.stops;o?(r=_&&_[0]&&_[0].opacity,null==r&&(r=t.opacityValues&&t.opacityValues[0])):r=_&&_[0]&&_[0].color||t.colors&&t.colors[0]}return s&&(s.data=f,s.value=r),s||r},_interpolateData:function(e){var t;if(e)if(e.colors||e.opacityValues){var i,a=(e.colors||e.opacityValues).length,o=e.minDataValue,s=(e.maxDataValue-o)/(a-1);for(t=[],i=0;a>i;i++)t[i]=o+i*s}else e.stops&&(t=e.stops.map(function(e){return e.value}));return t},_getOpacity:function(e,t,i){var a,o=this._lookupData(e,i);if(t=t||this.opacityInfo,o){var s,r,n=o[0],l=o[1];n===l?a=this._getOpacValue(t,n):(s=this._getOpacValue(t,n),r=this._getOpacValue(t,l),a=s+(r-s)*o[2])}return a},_getOpacValue:function(e,t){return e.opacityValues?e.opacityValues[t]:e.stops[t].opacity},_getColor:function(e,t,i){var a,o=this._lookupData(e,i);if(t=t||this.colorInfo,o){var s=o[0],r=o[1];a=s===r?this._getColorObj(t,s):l.blendColors(this._getColorObj(t,s),this._getColorObj(t,r),o[2]),a=new l(a)}return a},_getColorObj:function(e,t){return e.colors?e.colors[t]:e.stops[t].color},_lookupData:function(e,t){var i;if(t){var a=0,o=t.length-1;t.some(function(t,i){return t>e?(o=i,!0):(a=i,!1)}),i=[a,o,(e-t[a])/(t[o]-t[a])]}return i},_processForContext:function(e,t,i){t&&"web-scene"===t.origin?(t.messages&&(e.expression&&t.messages.push(new r("property:unsupported",e.type+"VisualVariable.expression is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:i+".expression",context:t})),e.valueExpression&&t.messages.push(new r("property:unsupported",e.type+"VisualVariable.valueExpression is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:i+".valueExpression",context:t})),e.valueExpressionTitle&&t.messages.push(new r("property:unsupported",e.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:i+".valueExpressionTitle",context:t}))),delete e.expression,delete e.valueExpression,delete e.valueExpressionTitle):e.type===u&&this._convertExpressionToArcade(e)},_writeRotationInfo:function(e,t,i){return e&&(e=n.mixin({},e),this._processForContext(e,t,"visualVariables["+i+"]"),e.type=y.toJSON(e.type),e=s.fixJson(e,!0)),e},_convertExpressionToArcade:function(e){e&&e.expression&&(e.valueExpression="$view.scale")},_writeSizeInfo:function(e,t,i){if(e){e=n.mixin({},e),this._processForContext(e,t,"string"==typeof i?i:"visualVariables["+i+"]");var a=e.minSize,o=e.maxSize;a&&(e.minSize="number"==typeof a?a:this._writeSizeInfo(a,t,"visualVariables["+i+"].minSize")),o&&(e.maxSize="number"==typeof o?o:this._writeSizeInfo(o,t,"visualVariables["+i+"].maxSize"));var r=e.legendOptions,l=e.type,c=e.axis;e.type=y.toJSON(l),c&&(e.axis=v.toJSON(c)),r&&(e.legendOptions=n.mixin({},r),r=r.customValues,r&&(e.legendOptions.customValues=r.slice(0))),e.stops&&(e.stops=e.stops.map(function(e){return e=n.mixin({},e),null===e.label&&delete e.label,e})),e=s.fixJson(e,!0)}return e},_writeColorInfo:function(e,t,i){return e&&(e=n.mixin({},e),this._processForContext(e,t,"visualVariables["+i+"]"),e.type=y.toJSON(e.type),e.colors&&(e.colors=e.colors.map(function(e){return l.toJSON(e)})),e.stops&&(e.stops=e.stops.map(function(e){return e=n.mixin({},e),e.color&&(e.color=l.toJSON(e.color)),null===e.label&&delete e.label,e})),e.legendOptions&&(e.legendOptions=n.mixin({},e.legendOptions)),e=s.fixJson(e,!0)),e},_writeOpacityInfo:function(e,t,i){var a;return e&&(a=n.mixin({},e),this._processForContext(a,t,"visualVariables["+i+"]"),a.type=y.toJSON(a.type),a.opacityValues&&(a.transparencyValues=a.opacityValues.map(function(e){return 100*(1-e)}),delete a.opacityValues),a.stops&&(a.stops=a.stops.map(function(e){return e=n.mixin({},e),e.transparency=100*(1-e.opacity),delete e.opacity,null===e.label&&delete e.label,e})),a.legendOptions&&(a.legendOptions=n.mixin({},a.legendOptions)),a=s.fixJson(a,!0)),a}});return b});