// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/Deferred","../../config","../Polyline","../Polygon","./webMercatorUtils","./spatialReferenceUtils","./jsonUtils"],function(e,n,r,t,i,o,a,s){function f(e,n){return Math.ceil((e-n)/(2*n))}function u(e,n){var r,t,i,o=e.paths||e.rings,a=o.length;for(r=0;a>r;r++){var s=o[r];for(i=s.length,t=0;i>t;t++){var f=e.getPoint(r,t);e.setPoint(r,t,f.clone().offset(n,0))}}return e}function c(n,r){if(!(n instanceof t||n instanceof i)){var o="_straightLineDensify: the input geometry is neither polyline nor polygon";throw console.error(o),new Error(o)}var a,s=n instanceof t,f=s?n.paths:n.rings,u=[];return e.forEach(f,function(e){u.push(a=[]),a.push([e[0][0],e[0][1]]);var n,t,i,o,s,f,c,l,h,p,g,v;for(s=0;s<e.length-1;s++){if(n=e[s][0],t=e[s][1],i=e[s+1][0],o=e[s+1][1],c=Math.sqrt((i-n)*(i-n)+(o-t)*(o-t)),l=(o-t)/c,h=(i-n)/c,p=c/r,p>1){for(f=1;p-1>=f;f++){var m=f*r;g=h*m+n,v=l*m+t,a.push([g,v])}var x=(c+Math.floor(p-1)*r)/2;g=h*x+n,v=l*x+t,a.push([g,v])}a.push([i,o])}}),s?new t({paths:u,spatialReference:n.spatialReference}):new i({rings:u,spatialReference:n.spatialReference})}function l(e,n,r){var t=1e6;if(n){var i=c(e,t);e=o.webMercatorToGeographic(i,!0)}return r&&(e=u(e,r)),e}function h(e,n,r){var t,i=e.x||e[0];return i>n?(t=f(i,n),e.x?e=e.clone().offset(t*(-2*n),0):e[0]=i+t*(-2*n)):r>i&&(t=f(i,r),e.x?e=e.clone().offset(t*(-2*r),0):e[0]=i+t*(-2*r)),e}function p(n,r){var t=-1;return e.forEach(r.cutIndexes,function(i,o){var a=r.geometries[o],s=a.rings||a.paths;e.forEach(s,function(n,r){e.some(n,function(e){if(e[0]<180)return!0;var t,i,o=0,s=n.length;for(t=0;s>t;t++)i=n[t][0],o=i>o?i:o;o=Number(o.toFixed(9));var u,c=f(o,180),l=-360*c,h=n.length;for(u=0;h>u;u++){var p=a.getPoint(r,u);a.setPoint(r,u,p.clone().offset(l,0))}return!0})}),i===t?a.rings?e.forEach(a.rings,function(e){n[i]=n[i].addRing(e)}):e.forEach(a.paths,function(e){n[i]=n[i].addPath(e)}):(t=i,n[i]=a)}),n}function g(c,g){var v=new n;g=g||r.geometryService;var m,x,d,y,w,M,E,R,b=[],P=[],_=0;e.forEach(c,function(n){if(!n)return void b.push(n);if(m||(m=n.spatialReference,x=a.getInfo(m),d=m.isWebMercator,y=d?20037508.342788905:180,w=d?-20037508.342788905:-180,M=d?102100:4326,E=new t({paths:[[[y,w],[y,y]]],spatialReference:{wkid:M}}),R=new t({paths:[[[w,w],[w,y]]],spatialReference:{wkid:M}})),!x)return void b.push(n);var r=s.fromJSON(n.toJSON()),o=n.extent;if("point"===n.type)b.push(h(r,y,w));else if("multipoint"===n.type)r.points=e.map(r.points,function(e){return h(e,y,w)}),b.push(r);else if("extent"===n.type){var c=o.clone()._normalize(null,null,x);b.push(c.rings?new i(c):c)}else if(o){var p=f(o.xmin,w),g=p*(2*y);r=0===g?r:u(r,g),o=o.clone().offset(g,0),o.intersects(E)&&o.xmax!==y?(_=o.xmax>_?o.xmax:_,r=l(r,d),P.push(r),b.push("cut")):o.intersects(R)&&o.xmin!==w?(_=o.xmax*(2*y)>_?o.xmax*(2*y):_,r=l(r,d,360),P.push(r),b.push("cut")):b.push(r)}else b.push(r)});for(var j=new t,z=f(_,y),k=-90,C=z;z>0;){var D=-180+360*z;j.addPath([[D,k],[D,-1*k]]),k=-1*k,z--}return P.length>0&&C>0?g?g.cut(P,j,function(n){P=p(P,n);var r=[];e.forEach(b,function(e,n){if("cut"===e){var t=P.shift();c[n].rings&&c[n].rings.length>1&&t.rings.length>=c[n].rings.length?(b[n]="simplify",r.push(t)):b[n]=d===!0?o.geographicToWebMercator(t):t}}),r.length>0?g.simplify(r,function(n){e.forEach(b,function(e,r){"simplify"===e&&(b[r]=d===!0?o.geographicToWebMercator(n.shift()):n.shift())}),v.resolve(b)},function(e){v.reject(e)}):v.resolve(b)},function(e){v.reject(e)}):v.reject(new Error("esri.geometry.normalizeCentralMeridian: 'geometryService' argument is missing.")):(e.forEach(b,function(e,n){if("cut"===e){var r=P.shift();b[n]=d===!0?o.geographicToWebMercator(r):r}}),v.resolve(b)),v.promise}function v(e){if(!e)return null;var n=e.extent;if(!n)return null;var r=e.spatialReference&&a.getInfo(e.spatialReference);if(!r)return n;var t=r.valid[0],i=r.valid[1],o=2*i,s=n.width,f=n.xmax,u=n.xmin;if("extent"===e.type||0===s||i>=s||s>o||t>f||u>i)return n;var c;switch(e.type){case"polygon":if(!(e.rings.length>1))return n;c=m(e.rings);break;case"polyline":if(!(e.paths.length>1))return n;c=m(e.paths);break;case"multipoint":c=e.points}for(var l=Math.min,h=Math.max,p=n.clone(),g=0;g<c.length;g++){var v=c[g][0];0>v?(v+=i,u=h(v,u)):(v-=i,f=l(v,f))}return p.xmin=f,p.xmax=u,p.width<s?(p.xmin-=i,p.xmax-=i,p):n}function m(e){for(var n=[],r=0,t=0,i=Math.min,o=Math.max,a=0;a<e.length;a++){for(var s=e[a],f=null,u=0;u<s.length;u++)f=s[u],n.push(f),0===u?(r=f[0],t=r):(r=i(r,f[0]),t=o(t,f[0]));f&&n.push([(r+t)/2,0])}return n}var x={normalizeCentralMeridian:g,_foldCutResults:p,_prepareGeometryForCut:l,_offsetMagnitude:f,_pointNormalization:h,_updatePolyGeometry:u,_straightLineDensify:c,getDenormalizedExtent:v};return x});