// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","dojo/_base/array","dojo/_base/config","dojo/Deferred","dojo/_base/lang","dojo/_base/url","dojo/request","dojo/io-query","dojo/when","./kernel","./config","./core/sniff","./core/lang","./core/urlUtils","./core/deferredUtils","./core/promiseUtils","dojo/has!host-browser?dojo/io/script","dojo/has!host-browser?dojo/io/iframe","dojo/has!host-browser?dojo/dom-construct"],function(e,r,n,t,o,s,i,a,l,u,d,c,f,p,h,g,m,w,v){function b(e,r,n){if(n)return g.reject(o.mixin(new Error,{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var s=a.objectToQuery(e.content);s&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+s);var i=new Image;e.allowImageDataAccess&&(e.withCredentials?i.crossOrigin="use-credentials":r&&(i.crossOrigin="anonymous"));var l=!1,u=new t(function(e){l=!0,i.onload=i.onerror=i.onabort=null,i.src=""}),d=function(e){i.onload=i.onerror=i.onabort=null,l||u.reject(e)};return i.onload=function(){i.onload=i.onerror=i.onabort=null,l||u.resolve(this)},i.onerror=d,i.onabort=d,i.alt="",i.src=e.url,u.promise}function _(e){return e=new s(e),(e.host+(e.port?":"+e.port:"")).toLowerCase()}function k(e,s,l){var d,h=!!e.useProxy,g=e.method||"auto";d=e.crossOrigin,e=o.mixin({},e),e._ssl&&(e.url=e.url.replace(/^http:/i,"https:"));var _=e.content,k=e.url,C=s&&e.form;d=f.isDefined(d)?d:q.useCors,e.load=function(e){var r;return e&&(e.error?(r=o.mixin(new Error,e.error),r.log=n.isDebug):"error"===e.status&&(r=o.mixin(new Error,e),r.log=n.isDebug),r&&!f.isDefined(r.httpCode)&&(r.httpCode=r.code)),r||e},e.error=function(e,r){return r&&r.xhr&&r.xhr.abort(),e instanceof Error||(e=o.mixin(new Error,e)),e.log=n.isDebug,e},e._token&&(e.content=e.content||{},e.content.token=e._token);var D,O=0;k&&(D=a.objectToQuery(_),O=D.length+k.length+1,c("esri-url-encodes-apostrophe")&&(O=D.replace(/'/g,"%27").length+k.length+1)),e.timeout=f.isDefined(e.timeout)?e.timeout:q.timeout,e.handleAs=e.handleAs||"json";try{var y,x,j=d&&p.canUseXhr(e.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),U=p.hasSameOrigin(e.urlObj,p.appUrl)||j,S="post"===g||s||O>q.maxUrlLength?!0:!1,L=U||-1===e.handleAs.indexOf("json")||!e.callbackParamName||s?!1:!0,P=p.getProxyRule(e.url)||q.forceProxy||h||("image"!==e.handleAs||e.allowImageDataAccess)&&(!L||S)&&!U?!0:!1;if(s&&!c("esri-file-upload")&&!P&&j&&(P=!0),(c("host-browser")||c("host-webworker"))&&P)if(y=p.getProxyUrl(k,d),x=y.path,y._xo&&(j=!0),!S&&x.length+1+O>q.maxUrlLength&&(S=!0),e.url=x+"?"+k,S)e.content=o.mixin(y.query||{},_);else{var T=a.objectToQuery(o.mixin(y.query||{},_));T&&(e.url+=(-1===k.indexOf("?")?"?":"&")+T),e.content=null}if((c("host-browser")||c("host-webworker"))&&L&&!S)return!f.isDefined(e.isAsync)&&c("ff")<4&&(e.isAsync=!0),m.get(A?A(e):e);var R=e.headers;if(!c("host-browser")&&!c("host-webworker")||R&&R.hasOwnProperty("X-Requested-With")||(R=e.headers=R||{},R["X-Requested-With"]=null),c("host-browser")&&s){var W,I,X,F,N,Q=e.callbackParamName||"callback.html",B=e.callbackElementName||"textarea",H=C.elements?C.elements.length:0;if(_=e.content)for(W in _)if(X=_[W],f.isDefined(X)){for(I=null,F=0;H>F;F++)if(N=C.elements[F],N.name===W){I=N;break}I?I.value=X:l?C.append(W,X):C.appendChild(v.create("input",{type:"hidden",name:W,value:X}))}c("esri-file-upload")?(r.forEach(C.elements,function(e){e.name===Q&&C.removeChild(e)}),e.contentType=!1,e.postData=l?C:new FormData(C),delete e.form):(C.enctype="multipart/form-data",c("ie")<9&&(C.encoding="multipart/form-data"),C.method="post",r.some(C.elements,function(e){return e.name===Q})||C.appendChild(v.create("input",{type:"hidden",name:Q,value:B})),(-1!==k.toLowerCase().indexOf("addattachment")||-1!==k.toLowerCase().indexOf("updateattachment"))&&(e.url=k+(-1===k.indexOf("?")?"?":"&")+Q+"="+B,P&&(e.url=x+"?"+e.url)),delete e.content)}if(j&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===q.useCors){var M=P?x:k,$=p.getCorsConfig(M);if($&&$.hasOwnProperty("withCredentials"))$.withCredentials&&(e.withCredentials=!0);else if(u.id){var z=u.id.findServerInfo(M);z&&z.webTierAuth&&(e.withCredentials=!0)}}return e=A?A(e):e,"image"===e.handleAs?b(e,j,S):S?(e.data=e.content,c("host-browser")&&s&&!c("esri-file-upload")?w.send(e):(!P&&c("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+E++),i.post(e.url,e))):(e.query=e.content,i.get(e.url,e))}catch(G){var J=new t;return J.reject(e.error(G)),J}}function C(e){var r=q.corsStatus,n=p.getCorsConfig(e,!0);return n>-1&&q.corsEnabledServers.splice(n,1),r[_(e)]=1,n}function D(e){var r=q.corsStatus;try{var n=_(e.url);if(q.corsDetection&&q.useCors&&c("esri-cors")&&e.url&&-1!==e.url.toLowerCase().indexOf("/rest/services")&&!p.hasSameOrigin(e.urlObj,p.appUrl)&&!p.canUseXhr(e.urlObj)){if(r[n])return r[n];var o=new t;r[n]=o.promise;var s=e.url.substring(0,e.url.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info";return i.get(s,{query:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null},timeout:1e3*q.corsDetectionTimeout}).then(function(r){r?(p.canUseXhr(e.url)||q.corsEnabledServers.push(n),o.resolve()):o.reject()},function(e){o.reject()}),o.promise}}catch(a){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function O(e){A=e}function y(t,s,a,l){function d(e){if(e._pendingDfd=k(a,D,b),!e._pendingDfd){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs;var t=new Error("Deferred object is missing");return t.log=n.isDebug,e.reject(t),void(e._pendingDfd=null)}var s=!!e._pendingDfd.response,i=e._pendingDfd.response||e._pendingDfd;i.then(function(r){var t=s?r.data:r,i=s?r.getHeader.bind(r):S,a=null;if(e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,t&&(t.error?(a=o.mixin(new Error,t.error),a.log=n.isDebug):"error"===t.status&&(a=o.mixin(new Error,t),a.log=n.isDebug),a&&!f.isDefined(a.httpCode)&&(a.httpCode=a.code),a))throw a;e.resolve({data:t,url:l.url,requestOptions:l.requestOptions,getHeader:i}),e._pendingDfd=null}).then(null,function(n){var t,o,s;if(n&&(t=n.code,o=n.subcode,s=n.messageCode,s=s&&s.toUpperCase()),n&&403==t&&(4==o||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!a._ssl)return a._ssl=a._sslFromServer=!0,void y(e,!0,a,l)}else if(n&&415==n.status){if(C(a.url),!a._err415)return a._err415=1,void y(e,!0,a,l)}else if(u.id&&-1!==r.indexOf(u.id._errorCodes,t)&&!u.id._isPublic(a.url)&&!g&&(403!=t||-1===r.indexOf(U,s)&&(!f.isDefined(o)||2==o&&a._token)))return void x(e,a,l,n);e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,e.reject(n),e._pendingDfd=null})}var h=a.form,g=a.disableIdentityLookup,m=a._preLookup,w=!1;if(c("esri-workers")&&q.useWorkers!==!1)if(a.useWorkers===!0||q.useWorkers===!0)w=!0;else if(a.workerOptions){var v=a.workerOptions;(v.callback||v.worker&&v.worker.worker instanceof Worker)&&(w=!0)}var b=h&&c("esri-file-upload")&&h instanceof FormData,D=h&&(h.elements?r.some(h.elements,function(e){return"file"===e.type}):b),O=-1!==a.url.toLowerCase().indexOf("token=")||a.content&&a.content.token||D&&r.some(h.elements,function(e){return"token"===e.name})?1:0;if(!s){t.then(function(e){if((/\/sharing\/rest\/accounts\/self/i.test(a.url)||/\/sharing\/rest\/portals\/self/i.test(a.url))&&!O&&!a._token&&e.user&&e.user.username){var r=q.corsEnabledServers,n=p.getCorsConfig(a.url,!0),t={host:_(a.url),withCredentials:!0};if(-1===n)r.push(t);else{var o=r[n];"object"==typeof o?o.withCredentials=!0:r.splice(n,1,t)}}var s=a._credential;if(s){var i,l=u.id.findServerInfo(s.server),d=l&&l.owningSystemUrl;d&&(d=d.replace(/\/?$/,"/sharing"),i=u.id.findCredential(d,s.userId),i&&-1===u.id._getIdenticalSvcIdx(d,i)&&i.resources.splice(0,0,d))}return e}).always(function(e){delete a._credential,e&&(e.ssl=!!a._ssl)});var j=a.load,A=a.error;j&&t.then(function(e){var r=t._pendingDfd,n=r&&r.ioArgs,o=n&&n.args;return j.call(o,e,n)}),A&&t.then(null,function(e){var r=t._pendingDfd,n=r&&r.ioArgs,o=n&&n.args;return A.call(o,e,n)})}if(u.id&&!O&&!a._token&&!u.id._isPublic(a.url)&&(!g||m)){var E=u.id.findCredential(a.url);E&&(a._token=E.token,a._ssl=E.ssl)}return w?a.workerOptions&&a.workerOptions.worker?(i=a.workerOptions.worker,d(t)):e(["./workers/RequestClient"],function(e){if(a.workerOptions){var r=a.workerOptions;i=e.getClient(r.callback,r.cbFunction)}else i=e.getClient();d(t)}):d(t),t.promise}function x(e,r,n,t){e._pendingDfd=u.id.getCredential(r.url,{token:r._token,error:t}),e._pendingDfd.then(function(t){r._token=t.token,r._credential=t,r._ssl=r._sslFromServer||t.ssl,y(e,!0,r,n)}).then(null,function(r){e.reject(r),e._pendingDfd=null})}function j(e,r){"string"!=typeof e&&console.error("esri/request: the first parameter should be a url string");var n=o.mixin({},r),t={url:e,requestOptions:o.mixin({},r)};if(n.content=n.query,delete n.query,n.preventCache=!!n.cacheBust,delete n.cacheBust,n.handleAs=n.responseType,delete n.responseType,"array-buffer"===n.handleAs&&(n.handleAs="arraybuffer"),"image"===n.handleAs){if(c("host-webworker")||c("host-node"))return g.reject(o.mixin(new Error,{message:"The responseType 'image' is not supported in Web Workers or Node environment."}));n.preventCache&&(n.content=n.content||{},n.content["request.preventCache"]=Date.now()),n.method="auto"}n.url=p.normalize(e),"file"!==p.appUrl.scheme&&(n.url=p.makeAbsolute(n.url)),n.urlObj=new s(n.url);var i=h.makeDeferredCancellingPending();return l(D(n)).always(function(){y(i,!1,n,t)}),i.promise}var A,q=d.request,U=["COM_0056","COM_0057"],E=0,S=function(){return null};return j._makeRequest=k,j._processRequest=y,j._disableCors=C,j._detectCors=D,j.setRequestPreCallback=O,j});