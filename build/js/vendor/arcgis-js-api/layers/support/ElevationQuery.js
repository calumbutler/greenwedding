// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/promise/all","dojo/_base/lang","../../core/promiseUtils","../../core/Error","../../geometry/Point","../../geometry/Multipoint","../../geometry/Polyline","../../geometry/support/webMercatorUtils","../../geometry/support/scaleUtils","./ElevationTile"],function(e,t,o,n,r,i,l,a,u,s,c,f){var p=function(){function e(){}return e.prototype.queryAll=function(e,t,o){var l=this;if(!e.length)return r.reject(new i("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from"));var a=y.fromGeometry(t),u=!1;return o&&o.returnSampleInfo||(u=!0),o=n.mixin(o,{returnSampleInfo:!0,demResolution:"auto"}),e=e.slice(),this.query(e[e.length-1],a,o).then(function(t){return l._queryAllNext(e,t,o)}).then(function(e){return e.geometry=e.geometry["export"](),u&&delete e.sampleInfo,e})},e.prototype._queryAllNext=function(e,t,o){var n=this,i=e.pop();if(t.geometry.coordinates.forEach(function(e,o){t.sampleInfo[o].demResolution>=0&&!t.sampleInfo[o].source&&(t.sampleInfo[o].source=i)}),!e.length)return r.resolve(t);for(var l=t.geometry.coordinates,a=[],u=[],s=0;s<l.length;s++)t.sampleInfo[s].demResolution<0&&(a.push(l[s]),u.push(s));if(0===a.length)return r.resolve(t);var c=t.geometry.clone(a);return this.query(e[e.length-1],c,o).then(function(r){return u.forEach(function(e,o){l[e].z=r.geometry.coordinates[o].z,t.sampleInfo[e].demResolution=r.sampleInfo[o].demResolution}),n._queryAllNext(e,t,o)})},e.prototype.query=function(e,t,o){var l=this;if(!e)return r.reject(new i("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from"));if(!t||!(t instanceof y)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)return r.reject(new i("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation"));o=n.mixin({noDataValue:0,demResolution:"auto",maximumAutoTileRequests:20,returnSampleInfo:!1},o);var a={layer:e,geometry:null,options:o,outsideExtentTile:null,outSpatialReference:t.spatialReference};return r.resolve().then(function(){return e.load()}).then(function(){return l._createGeometryDescriptor(a,t)}).then(function(){return l._selectTiles(a)}).then(function(){return l._populateElevationTiles(a)}).then(function(){return l._sampleGeometryWithElevation(a)}).then(function(){return l._createQueryResult(a)})},e.prototype._createQueryResult=function(e){var t;t=e.outSpatialReference.equals(e.geometry.spatialReference)?e.geometry:e.geometry.project(e.outSpatialReference);var o={geometry:t["export"](),noDataValue:e.options.noDataValue};return e.options.returnSampleInfo&&(o.sampleInfo=this._extractSampleInfo(e)),e.geometry.coordinates.forEach(function(e){e.tile=null,e.elevationTile=null}),o},e.prototype._createGeometryDescriptor=function(e,t){var o,n=e.layer.tileInfo.spatialReference;return(o=t instanceof y?t.project(n):s.project(t,n))?(e.geometry=y.fromGeometry(o),r.resolve()):r.reject(new i("elevation-query:spatial-reference-mismatch","Cannot query elevation in '"+t.spatialReference.wkid+"' on an elevation service in '"+n.wkid+"'"))},e.prototype._selectTiles=function(e){var t=e.options.demResolution;return this._preselectOutsideLayerExtent(e),"number"==typeof t?this._selectTilesClosestResolution(e):"finest-contiguous"===t?this._selectTilesFinestContiguous(e):"auto"===t?this._selectTilesAuto(e):r.reject(new i("elevation-query:invalid-dem-resolution","Invalid dem resolution value '"+t+'\', expected a number, "finest-contiguous" or "auto"'))},e.prototype._preselectOutsideLayerExtent=function(e){var t=new f.ElevationTile(null);t.sample=function(t,o){return e.options.noDataValue},e.outsideExtentTile=t;var o=e.layer.fullExtent;e.geometry.coordinates.forEach(function(e){var n=e.x,r=e.y;(n<o.xmin||n>o.xmax||r<o.ymin||r>o.ymax)&&(e.elevationTile=t)})},e.prototype._selectTilesClosestResolution=function(e){var t=e.layer.tileInfo,o=this._findNearestDemResolutionLevel(t,e.options.demResolution);return e.geometry.coordinates.forEach(function(e){e.tile=t.tileAt(o,e.x,e.y)}),r.resolve()},e.prototype._findNearestDemResolutionLevel=function(e,t){for(var o=c.getUnitValueForSR(e.spatialReference),n=t/o,r=e.lods[0],i=1;i<e.lods.length;i++){var l=e.lods[i];Math.abs(l.resolution-n)<Math.abs(r.resolution-n)&&(r=l)}return r.level},e.prototype._selectTilesFinestContiguous=function(e){return this._selectTilesFinestContiguousAt(e,e.layer.tileInfo.lods.length-1)},e.prototype._selectTilesFinestContiguousAt=function(e,t){var n=this,i=e.layer,l=e.geometry;if(0>t)return l.coordinates.forEach(function(e){return e.tile=null}),r.resolve();var a=i.tilemapCache,u=i.tileInfo,s=u.lods[t];l.coordinates.forEach(function(e){e.tile=u.tileAt(s.level,e.x,e.y)});var c,f=this._selectTilesToFetch(l.coordinates);return c=a?o(f.map(function(e){return a.fetchAvailability(e.level,e.row,e.col)})):this._populateElevationTiles(e).then(function(){return l.coordinates.some(function(e){return!e.elevationTile})?(l.coordinates.filter(function(t){return t.elevationTile!==e.outsideExtentTile}).forEach(function(e){return e.elevationTile=null}),r.reject()):void 0}),c.then(function(){return l}).otherwise(function(){return n._selectTilesFinestContiguousAt(e,t-1)})},e.prototype._populateElevationTiles=function(e){var t=e.options.noDataValue,o=this._selectTilesToFetch(e.geometry.coordinates),n={},i=o.map(function(o){return e.layer.fetchTile(o.level,o.row,o.col,t).then(function(e){return n[o.id]=new f.ElevationTile(o,e)})});return r.eachAlways(i).then(function(){e.geometry.coordinates.forEach(function(e){!e.elevationTile&&e.tile&&(e.elevationTile=n[e.tile.id])})})},e.prototype._selectTilesToFetch=function(e){var t={},o=[];return e.forEach(function(e){var n=e.tile;e.elevationTile||!e.tile||t[n.id]||(t[n.id]=n,o.push(n))}),o},e.prototype._selectTilesAuto=function(e){var t=e.geometry.coordinates;this._selectTilesAutoFinest(e),this._reduceTilesForMaximumRequests(e);var n=e.layer.tilemapCache;if(n){var r=this._selectTilesToFetch(t),i={},l=r.map(function(e){var t={id:null,level:0,row:0,col:0,extent:[0,0,0,0]};return n.fetchAvailabilityUpsample(e.level,e.row,e.col,t).then(function(){return i[e.id]=t}).otherwise(function(){})});return o(l).then(function(){return t.forEach(function(e){return e.tile=i[e.tile.id]})})}return this._selectTilesAutoPrefetchUpsample(e)},e.prototype._reduceTilesForMaximumRequests=function(e){var t=e.geometry.coordinates,o=e.layer.tileInfo,n=0,r={},i=function(e){e.id in r?r[e.id]++:(r[e.id]=1,n++)},l=function(e){var t=r[e.id];1===t?(delete r[e.id],n--):r[e.id]=t-1};t.forEach(function(e){e.tile&&!e.elevationTile&&i(e.tile)});for(var a=!0;a;){a=!1;for(var u=0;u<t.length;u++){var s=t[u];if(!s.elevationTile||s.tile){if(n<=e.options.maximumAutoTileRequests)return;l(s.tile),o.upsampleTile(s.tile)&&(a=!0),i(s.tile)}}if(!a)break}},e.prototype._selectTilesAutoFinest=function(e){var t=e.geometry.coordinates,o=e.layer.tileInfo,n=o.lods[o.lods.length-1].level;t.forEach(function(e){return e.tile=o.tileAt(n,e.x,e.y)})},e.prototype._selectTilesAutoPrefetchUpsample=function(e){var t=this,o=e.geometry.coordinates,n=e.layer.tileInfo;return this._populateElevationTiles(e).then(function(){var r=!1;return o.forEach(function(e){!e.elevationTile&&e.tile&&(n.upsampleTile(e.tile)?r=!0:e.tile=null)}),r?t._selectTilesAutoPrefetchUpsample(e):void 0})},e.prototype._sampleGeometryWithElevation=function(e){e.geometry.coordinates.forEach(function(t){var o=t.elevationTile,n=e.options.noDataValue;if(o){var r=o.sample(t.x,t.y);void 0!==r?n=r:t.elevationTile=null}t.z=n})},e.prototype._extractSampleInfo=function(e){var t=e.layer.tileInfo,o=c.getUnitValueForSR(t.spatialReference);return e.geometry.coordinates.map(function(n){var r=-1;if(n.elevationTile&&n.elevationTile!==e.outsideExtentTile){var i=t.lodAt(n.elevationTile.tile.level);r=i.resolution*o}return{demResolution:r}})},e}();t.ElevationQuery=p;var y=function(){function e(){}return e.prototype["export"]=function(){return this._exporter(this.coordinates,this.spatialReference)},e.prototype.clone=function(t){var o=this,n=new e;return n.geometry=this.geometry,n.spatialReference=this.spatialReference,n.coordinates=t||this.coordinates.map(function(e){return o._cloneCoordinate(e)}),n._exporter=this._exporter,n},e.prototype.project=function(e){var t=this;if(this.spatialReference.equals(e))return this.clone();if(s.canProject(this.spatialReference,e)){var o=e.isWGS84?s.xyToLngLat:s.lngLatToXY,n=[0,0],r=this.coordinates.map(function(e){var r=t._cloneCoordinate(e);return o(r.x,r.y,!1,n),r.x=n[0],r.y=n[1],r}),i=this.clone(r);return i.spatialReference=e,i}return null},e.prototype._cloneCoordinate=function(e){return{x:e.x,y:e.y,z:e.z,tile:null,elevationTile:null}},e.fromGeometry=function(t){var o=new e;if(o.geometry=t,o.spatialReference=t.spatialReference,t instanceof e)o.coordinates=t.coordinates.map(function(e){return o._cloneCoordinate(e)}),o._exporter=function(e,o){var n=t.clone(e);return n.spatialReference=o,n};else switch(t.type){case"point":var n=t;o.coordinates=[{x:n.x,y:n.y}],o._exporter=function(e,t){return new l(e[0].x,e[0].y,e[0].z,t)};break;case"multipoint":var r=t;o.coordinates=r.points.map(function(e){return{x:e[0],y:e[1]}}),o._exporter=function(e,t){return new a(e.map(function(e){return[e.x,e.y,e.z]}),t)};break;case"polyline":var i=t,s=[],c=[],f=0;i.paths.forEach(function(e){c.push([f,f+e.length]),f+=e.length,s.push.apply(s,e.map(function(e){return{x:e[0],y:e[1]}}))}),o.coordinates=s,o._exporter=function(e,t){var o=e.map(function(e){return[e.x,e.y,e.z]}),n=c.map(function(e){return o.slice(e[0],e[1])});return new u(n,t)}}return o},e}();t.GeometryDescriptor=y,Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=p});