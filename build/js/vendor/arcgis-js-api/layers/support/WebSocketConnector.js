// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/io-query","dojo/Deferred","../../core/Accessor","../../core/Evented","../../core/Promise"],function(t,e,n,s,o,i){var c={STATUS_CONNECTED:0,STATUS_DISCONNECTED:1,STATUS_CONNECTING:2,STATUS_RECONNECTING:3,STATUS_DISCONNECTING:4},r=s.createSubclass([o,i],{declareSubclass:"esri.layers.support.WebSocketConnector",constructor:function(t){this.watch("maxReconnectAttempts",function(t){t<this._reconnectAttempts&&this.disconnect()}.bind(this)),this._status=c.STATUS_DISCONNECTED},normalizeCtorArgs:function(t){return t=t||{},"string"==typeof t?t={socketUrls:[t]}:Array.isArray(t)&&(t={socketUrls:t}),t},getDefaults:function(e){var n=this.inherited(arguments);return t.mixin(n||{},{socketUrls:[]})},initialize:function(){var t=null;if(this.socketUrls.length||(t=new Error("No urls passed to WebSocketConnector. No live connection possible")),"WebSocket"in window||(t=new Error("The browser does not support Web Sockets. No live connection possible")),t){var e=new n;this.addResolvingPromise(e.promise),e.reject(t)}},_reconnectAttempts:0,_reconnectTimeoutId:null,_socket:null,properties:{connectionInfo:{get:function(){return{socketUrls:this.socketUrls,queryParams:this.queryParams}}},maxReconnectAttempts:{set:function(t){var e=t;(!t||0>t)&&(e=10),this._set("maxReconnectAttempts",e)}},currentSocketUrl:null,socketUrls:null,status:{get:function(){return this._status}}},connect:function(){if(this._socket&&this._status!==c.STATUS_DISCONNECTED&&this._status!==c.STATUS_RECONNECTING)return void console.log("Already connected. No need to do anything");var e=this._makeCurrentUrl();this._status===c.STATUS_RECONNECTING&&this.emit("attempt-reconnect",{url:e,count:this._reconnectAttempts});var n=new WebSocket(e);this._status===c.STATUS_DISCONNECTED&&(this._status=c.STATUS_CONNECTING,this.notifyChange("status")),n.onopen=t.hitch(this,this._handleSocketOpen),n.onclose=t.hitch(this,this._handleSocketClose),n.onmessage=t.hitch(this,this._handleSocketMessage),this._socket=n},disconnect:function(){this._status=c.STATUS_DISCONNECTED,this.notifyChange("status"),clearTimeout(this._reconnectTimeoutId),this._socket&&this._socket.close(),this.emit("disconnect",{willReconnect:!1,message:"Connection closed from client"})},send:function(t){"object"==typeof t&&(t=JSON.stringify(t)),this._socket.send(t)},_attemptReconnect:function(){var t,e;return this._reconnectTimeoutId&&(clearTimeout(this._reconnectTimeoutId),this._reconnectTimeoutId=null),this._status!==c.STATUS_RECONNECTING&&this.layerSource&&this.connectionInfo.queryParams&&this.connectionInfo.queryParams.token&&1===this._reconnectAttempts?(this._status=c.STATUS_RECONNECTING,this.notifyChange("status"),this.layerSource.getWebSocketToken().then(function(t){this._attemptReconnect()}.bind(this),function(t){this._status=c.STATUS_DISCONNECTED,this.notifyChange("status"),this.emit("disconnect",{error:new Error("Could not get websocket token from service"),willReconnect:!1})}.bind(this)),null):(this._socket=null,this._status=c.STATUS_RECONNECTING,this.notifyChange("status"),e=this._randomIntFromInterval(0,1e3),t=1e3*this._reconnectAttempts+e,void(this._reconnectTimeoutId=setTimeout(function(){this.connect()}.bind(this),t)))},_makeCurrentUrl:function(){var t,n,s,o=this.connectionInfo.queryParams,i=this.connectionInfo.socketUrls;return 1!==i.length&&this.currentSocketUrl?(t=i.indexOf(this.currentSocketUrl),n=t>=i.length-1?0:t+1,s=i[n]):s=i[0],this.currentSocketUrl=s,o&&(s+="?"+e.objectToQuery(o)),s},_handleSocketOpen:function(){this._status=c.STATUS_CONNECTED,this.notifyChange("status"),this._reconnectAttempts=0,this.emit("connect")},_handleSocketClose:function(t){var e,n=!0,s=this._status===c.STATUS_CONNECTED,o=null;s||this._status===c.STATUS_RECONNECTING||this._status===c.STATUS_CONNECTING?(t.code&&(e="Connection failed: ",1001===t.code?(e+=t.reason||"Service is going away.",n=!1):4400===t.code?(e+=t.reason||"Invalid url parameters. Check filter properties.",n=!1):4404===t.code?(e+="Service not found",n=!1):(4401===t.code||4403===t.code)&&(e+="Not authorized",n=!1)),n&&(this._reconnectAttempts+=1,this._reconnectAttempts>this.maxReconnectAttempts&&(e="Maximum reconnect attempts exceeded",n=!1,s=!0)),this._status=c.STATUS_DISCONNECTED,this.notifyChange("status"),s&&(e&&(o=new Error(e)),this.emit("disconnect",{error:o,willReconnect:n})),n?this._attemptReconnect():this._socket=null):this._socket=null},_handleSocketMessage:function(t){this.emit("message",t.data)},_randomIntFromInterval:function(t,e){return Math.floor(Math.random()*(e-t+1)+t)}});return t.mixin(r,c),r});