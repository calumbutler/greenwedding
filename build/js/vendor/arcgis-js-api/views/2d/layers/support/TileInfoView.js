// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./LODInfo","./TileKey","./TileSpan","./TileCoverage"],function(t,o,e,r,n,i){var l=function(){function t(t,o,e,r,n,i,l,s){this.x=t,this.ymin=o,this.ymax=e,this.invM=r,this.leftAdjust=n,this.rightAdjust=i,this.leftBound=l,this.rightBound=s}return t.create=function(o,e){o[1]>e[1]&&(c=[e,o],o=c[0],e=c[1]);var r=o[0],n=o[1],i=e[0],l=e[1],s=i-r,a=l-n,u=0!==a?s/a:0,f=(Math.ceil(n)-n)*u,h=(Math.floor(n)-n)*u;return new t(r,Math.floor(n),Math.ceil(l),u,0>s?f:h,0>s?h:f,0>s?i:r,0>s?r:i);var c},t.prototype.incrRow=function(){this.x+=this.invM},t.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},t.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},t}(),s=[[0,0],[0,0],[0,0],[0,0]],a=function(){function t(t,o){var r=this;this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var n=t.lods.slice();n.sort(function(t,o){return o.scale-t.scale});var i=this._lodInfos=n.map(function(r){return e.create(t,r,o)});n.forEach(function(t,o){r._infoByLevel[t.level]=i[o],r._infoByScale[t.scale]=i[o],r.scales[o]=t.scale},this),this._wrap=t.spatialReference.isWrappable}return t.prototype.getTileTopLeft=function(t,o){var e=this._infoByLevel[o.level];return e?e.getTileTopLeft(t,o):t},t.prototype.getTileBottomRight=function(t,o){var e=this._infoByLevel[o.level];return e?e.getTileBottomRight(t,o):t},t.prototype.getTileResolution=function(t){var o=this._infoByLevel[t.level];return o?o.resolution:-1},t.prototype.getTileParentId=function(t){var o=r.from(t),e=this._infoByLevel[o.level],n=this._lodInfos.indexOf(e)-1;if(0>n)return null;var i=this._lodInfos[n];return this.getTileIdAtParent(i,o)},t.prototype.getTileIdAtParent=function(t,o){var e=r.from(o),n=this._infoByLevel[e.level];if(t.resolution<n.resolution)throw new Error("Cannot calculate parent tile. destination LOD's resolution "+t.resolution+" is not a parent resolution of "+n.resolution);if(t.resolution===n.resolution)return e.id;var i=Math.floor(e.col*n.resolution/t.resolution+.01),l=Math.floor(e.row*n.resolution/t.resolution+.01);return r.getId(t.level,l,i,e.world)},t.prototype.getTileCoverage=function(t){var o,e,r,a=this.getClosestInfoForScale(t.scale),u=this._wrap,f=+(1/0),h=-(1/0),c=[];s[0][0]=s[0][1]=s[1][1]=s[3][0]=0,s[1][0]=s[2][0]=t.size[0],s[2][1]=s[3][1]=t.size[1];for(var v=s.map(function(o){return t.toMap(o,o),o[0]=a.getColumnForX(o[0]),o[1]=a.getRowForY(o[1]),o}),m=[],p=3,g=0;4>g;g++)if(v[g][1]!==v[p][1]){var d=l.create(v[g],v[p]);f=Math.min(d.ymin,f),h=Math.max(d.ymax,h),void 0===m[d.ymin]&&(m[d.ymin]=[]),m[d.ymin].push(d),p=g}else p=g;if(null==f||null==h||h-f>100)return null;var y=[];for(o=f;h>o;){null!=m[o]&&(y=y.concat(m[o])),e=+(1/0),r=-(1/0);for(var g=y.length-1;g>=0;g--){var d=y[g];e=Math.min(e,d.getLeftCol()),r=Math.max(r,d.getRightCol())}if(e=Math.floor(e),r=Math.floor(r),o>=a.first[1]&&o<=a.last[1])if(u)if(a.size[0]<a.worldSize[0])for(var g=Math.floor(e/a.worldSize[0]),w=Math.floor(r/a.worldSize[0]);w>=g;g++)c.push(new n(o,Math.max(a.getFirstColumnForWorld(g),e),Math.min(a.getLastColumnForWorld(g),r)));else c.push(new n(o,e,r));else e>a.last[0]||r<a.first[0]||(e=Math.max(e,a.first[0]),r=Math.min(r,a.last[0]),c.push(new n(o,e,r)));o+=1;for(var g=y.length-1;g>=0;g--){var d=y[g];d.ymax>=o?d.incrRow():y.splice(g,1)}}return new i(a,c)},t.prototype.intersects=function(t,o){var e=r.from(o),n=this._infoByLevel[e.level],i=t.lodInfo;if(i.resolution>n.resolution){var l=r.fromId(this.getTileIdAtParent(i,e)),s=i.denormalizeCol(l.col,l.world);return t.spans.some(function(t){return t.row===l.row&&t.colFrom<=s&&t.colTo>=s})}if(i.resolution<n.resolution){var a=t.spans.reduce(function(t,o){return t[0]=Math.min(t[0],o.row),t[1]=Math.max(t[1],o.row),t[2]=Math.min(t[2],o.colFrom),t[3]=Math.max(t[3],o.colTo),t},[+(1/0),-(1/0),+(1/0),-(1/0)]),u=a[0],f=a[1],h=a[2],c=a[3],v=n.denormalizeCol(e.col,e.world),m=i.getColumnForX(n.getXForColumn(v)),p=i.getRowForY(n.getYForRow(e.row)),g=i.getColumnForX(n.getXForColumn(v+1))-1,d=i.getRowForY(n.getYForRow(e.row+1))-1;return!(m>c||h>g||p>f||u>d)}var y=i.denormalizeCol(e.col,e.world);return t.spans.some(function(t){return t.row===e.row&&t.colFrom<=y&&t.colTo>=y})},t.prototype.getClosestInfoForScale=function(t){var o=this.scales;return this._infoByScale[t]?this._infoByScale[t]:(t=o.reduce(function(o,e,r,n){return Math.abs(e-t)<Math.abs(o-t)?e:o},o[0]),this._infoByScale[t])},t}();return a});