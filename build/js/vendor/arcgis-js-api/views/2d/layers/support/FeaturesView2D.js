// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/accessorSupport/decorators","../../../../core/Collection","../../../../core/HandleRegistry","../../../../core/promiseUtils","../../../../core/Error","../../../../renderers/support/renderingInfoUtils","../../../../Graphic","../../../layers/GraphicsView","../../engine/graphics/GFXSurface","../../engine/graphics/GFXGroup","../../engine/graphics/GFXObject","../../../../layers/graphics/QueryEngine"],function(e,r,t,i,n,o,s,a,c,h,u,p,d,l,y,g){var _=function(e){function r(){for(var r=this,t=[],i=0;i<arguments.length;i++)t[i-0]=arguments[i];e.apply(this,t),this._handles=new s,this._backgroundGroup=new l,this._frontGroup=new l,this._frontObjects=new Map,this._backgroundObjects=new Map,this._queryEngine=new g,this._scale=0,this.container=new d,this.layer=null,this.container.addChild(this._backgroundGroup),this.container.addChild(this._frontGroup),this.watch("graphics",function(){return r._reset()}),this.watch("renderer",function(){return r._resymbolize()}),this.watch("layer",function(){return r._setObjectId()}),this.watch("mapView.scale, mapView.stationary",function(){return r._applyScale()})}return t(r,e),r.prototype.queryGraphics=function(){return this._queryEngine?this._queryEngine.queryFeatures():this._rejectQuery()},r.prototype.queryFeatures=function(e){return this._queryEngine?this._queryEngine.queryFeatures(e):this._rejectQuery()},r.prototype.queryObjectIds=function(e){return this._queryEngine?this._queryEngine.queryObjectIds(e):this._rejectQuery()},r.prototype.queryFeatureCount=function(e){return this._queryEngine?this._queryEngine.queryFeatureCount(e):this._rejectQuery()},r.prototype.queryExtent=function(e){return this._queryEngine?this._queryEngine.queryExtent(e):this._rejectQuery()},r.prototype.hitTest=function(e,r){var t=this.container.hitTest(e,r);return t?a.resolve(t.graphic):null},r.prototype._reset=function(){var e=this;this._handles.remove("graphics"),this.graphics&&(this.graphics.forEach(this._add,this),this._queryEngine.features=this.graphics,this._handles.add(this.graphics.on("change",function(r){return e._graphicsChangeHandler(r)}),"graphics"))},r.prototype._applyScale=function(){var e=this.get("mapView.scale"),r=this.get("mapView.stationary");e!==this._scale&&r&&(this._scale=e,this._resymbolize())},r.prototype._resymbolize=function(){var e=this;this.graphics&&this.graphics.forEach(function(r){return e._resymbolizeGraphic(r)})},r.prototype._add=function(e){if(!this._frontObjects.has(e)){var r=h.getRenderingInfo(e,{renderer:this.renderer,viewingMode:"map",scale:this.mapView.state.scale,resolution:this.mapView.state.resolution});if(r){var t=new y;t.graphic=e,t.renderingInfo=r,this._frontObjects.set(e,t),this._frontGroup.addChild(t);var i=r.renderer&&r.renderer.backgroundFillSymbol;if(i&&t.isPolygonMarkerSymbol){var n=new y;n.graphic=e,null!=r.outlineSize?n.renderingInfo={symbol:i,size:[r.outlineSize,r.outlineSize,r.outlineSize]}:n.renderingInfo={symbol:i},this._backgroundObjects.set(e,n),this._backgroundGroup.addChild(n)}}}},r.prototype._remove=function(e){var r=this._frontObjects.get(e);if(r&&(this._frontObjects["delete"](e),this._frontGroup.removeChild(r),this._backgroundObjects.has(e))){var t=this._backgroundObjects.get(e);this._backgroundObjects["delete"](e),this._backgroundGroup.removeChild(t)}},r.prototype._resymbolizeGraphic=function(e){var r=h.getRenderingInfo(e,{renderer:this.renderer,viewingMode:"map",scale:this.mapView.state.scale,resolution:this.mapView.state.resolution}),t=this._frontObjects.get(e);t.renderingInfo=r;var i=r.renderer&&r.renderer.backgroundFillSymbol,n=this._backgroundObjects.get(e);i&&t.isPolygonMarkerSymbol?(n||(n=new y,n.graphic=e,this._backgroundObjects.set(e,n),this._backgroundGroup.addChild(n)),null!=r.outlineSize?n.renderingInfo={symbol:i,size:[r.outlineSize,r.outlineSize,r.outlineSize]}:n.renderingInfo={symbol:i}):!i&&n&&(this._backgroundObjects["delete"](e),this._backgroundGroup.removeChild(n))},r.prototype._setObjectId=function(){this._queryEngine.objectIdField=this.layer.objectIdField},r.prototype._rejectQuery=function(){return a.reject(new c("GraphicsLayerView2D","Not ready to execute query"))},r.prototype._graphicsChangeHandler=function(e){for(var r=e.added,t=e.removed,i=0,n=r;i<n.length;i++){var o=n[i];this._add(o)}for(var s=0,a=t;s<a.length;s++){var o=a[s];this._remove(o)}},i([n.property()],r.prototype,"container",void 0),i([n.property(),n.cast(o.ofType(u))],r.prototype,"graphics",void 0),i([n.property()],r.prototype,"layer",void 0),i([n.property()],r.prototype,"mapView",void 0),r=i([n.subclass("esri.views.2d.layers.support.FeaturesView2D")],r)}(n.declared(p));return _});