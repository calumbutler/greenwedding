// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../core/declare","../../../core/Accessor","../../../core/arrayUtils","../../../core/Logger","../../../core/watchUtils","../../../core/CollectionFlattener","dojo/Evented","dojo/on","../lib/glMatrix","../support/projectionUtils","../support/ResourceController","../support/PromiseLightweight","../../../geometry/support/webMercatorUtils","./TerrainRenderer","./OverlayManager","./SurfaceExtentHelper","./SurfaceTilingSchemeLogic","./terrainUtils","./TileUtils","./TerrainConst","./TileGeometryFactory","./SphericalTile","./PlanarTile","./TilemapOnlyTile","./MapTileAgent","./ElevationTileAgent","../support/PreallocArray","../../../core/ObjectPool","../support/aaBoundingRect","../support/mathUtils"],function(e,t,i,r,a,s,n,l,o,h,d,u,A,c,p,g,_,v,f,T,y,m,E,L,w,S,x,C,P,I){function R(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var B=o.vec3d,O=o.vec4d,V=o.mat4d,U=v.weakAssert,D=r.getLogger("esri.views.3d.terrain"),b=T.MAX_ROOT_TILES,M=12,q=1.2,N=80/180*Math.PI,H=T.TileUpdateTypes,j=O.create(),Q=[0,0,0],F=new Array(10),k=[null],Y={spatialReference:null,tile:null},G={spatialReference:null,extent:null},Z={spatialReference:null,extent:null,scale:0},X=[-(1/0),-(1/0),1/0,1/0],z=function(e){e.remove()},K="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA2JJREFUeNrs3d1O20AQgFFvRJInQLQBhHj/h0JVW34El1yQ2F73DVq3jTys55zrqUBbPrErZUSZ+vcOsto4AjK76Lqu1vr8+G3mPzjc3D/+eJj/Bcz/cd75R80fbu79BsAVCAQAAgABgABAACAAEAAIAAQAAgABQPOKfQAy83Ho+HnnHzXv49B4A4AAQAAgABAACAAEAAIAAYAAQAAgABAANM4+AKnZB4ifd/5R8/YB8AYAAYAAQAAgABAACAAEAAIAAYAAQAAgAGicfQBSsw8QP+/8o+btA+ANAAIAAYAAQAAgABAACAAEAAIAAYAAQADQOPsApGYfIH7e+UfN2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAXA201QdggAggH0AUrMPED8/jsPL03fns/y8fQC8AUAAIAAQAAgABAACAAGAAEAAIAAQAAgAGmcfgNTsA8TP2weImrcPgDcACAAEAAIAAYAAQAAgABAACAAEAAIAAUDj7AOQmn2A+Hn7AFHz9gHwBgABgABAACAAEAAIAAQAAgABgABgNS4cAf9pu9u3O1+m/n2aplKK/0j+TX86/tVP5+eZ3+729gFIfwWyDxA7bx8gat4+ANkJAAGAAEAAIAAQAAgABAACAAGAAEAAIABonn0AUrMPED9vHyBq3j4A3gAgABAACAAEAAIAAYAAQAAgABAA51VrdQgCAAHAsuwDkJp9gPj5vj+9vvx0PsvP2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAYAAoHH2AUjNPkD8vH2AqHn7AHgDgABAACAAEAAIAAQAAgABgABAACAAEAA0zj4AqdkHiJ+3DxA1bx8AbwAQACQ0DL0AyKuOowBwBYKUSikCIHUBAsAVCAQAAgABgABAALBy9gFIzT5A/Lx9gKj5y6trVyC8AUAAIAAQAAgAVq90Pg5N5gA2AsAVCAQAAgABgABAALB29gFIzT5A/Lx9gKj5q6+3rkB4A4AAQAAgABAACADWzB/IIHsCAsAVCARAlKlWhyAAEAAIABZjH4DU7APEz5+OH2+vT85n+fkvhztXILwBQAAgABAACAAEAGtWigBIHcBGALgCgQBAACAAyPMO9nHosxuHodZx5vB2t691HIdh/nx/Os7/Zsz/fvgXAAAA//8DAF1P1hM2ICMfAAAAAElFTkSuQmCC",W=e([t,n],{properties:{ready:{readOnly:!0,get:function(){return!!this.rootTiles}},rootTiles:{readOnly:!0},manifold:{readOnly:!0},tilingScheme:{readOnly:!0},tilingSchemeLogic:{readOnly:!0},tilingSchemeLocked:{readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"},spatialReference:{readOnly:!0,dependsOn:["tilingScheme"],aliasOf:"tilingScheme.spatialReference"},overlayManager:{value:null},wireframe:{value:!1},opacity:1,cullBackFaces:!1,renderOrder:1,skirts:!0,frontMostTransparent:!1,tileBackground:K,velvetOverground:!0,extent:{},loaded:!1},defaultTileBackground:K,constructor:function(){for(this._set("rootTiles",null),this._iteratorPool=new C(f.IteratorPreorder,function(){},!1),this._postorderIterator=new f.IteratorPostorder,this._topLevelTilemapOnlyTiles=new Array(T.TILEMAP_SIZE_EXP+1),e=0;e<this._topLevelTilemapOnlyTiles.length;e++)this._topLevelTilemapOnlyTiles[e]=new L([e-T.TILEMAP_SIZE_EXP,0,0]);this._clippingExtent=null,this._dataExtent=null,this._rootExtent=[0,0,0,0],this.notifyChange("extent"),this._elevationBounds=[0,0],this._frameUpdateLowerPrio=new x(500),this.maxTextureScale=1.2,this._stage=this._view._stage,this.visible=!1,this.suspended=!1,this._pendingUpdates=!1,this._lvPendingUpdates=!1,this._updateNextFrame=!1,this._curOverlayOpacity=1,this._curEyePos=B.create(),this._curSplitLimits=[0,0,0,0,0,0],this._curFrustumPlanes=new Array(6),this._viewProjectionMatrix=V.identity();for(var e=0;6>e;++e)this._curFrustumPlanes[e]=O.create();this.tilemapStats={tilemapRequestsSent:0,tilemapRequestsPending:0,tilemapRequestErrors:0,fullTilemaps:0,emptyTilemaps:0,tilesRequested:0,tileRequestsSent:0,tileRequestErrors:0,tilesNotPresent:0},this._layerViews=[[],[]],this._layerIndexByLayerViewId=[{},{}],this._basemapLayerViewHandles={},this._groupLayerViewHandles={},this._layerViewChangesHandle=null,this.hideSkirtsDistanceFromExtentMargin=q,this.hideSkirtsMinimumCameraTilt=N},normalizeCtorArgs:function(e,t){return this._view=e,this._set("manifold",t),"planar"===t?this.TileClass=E:this.TileClass=m,{}},initialize:function(){this._renderer=new c(this.manifold),this._renderer.loaded=this._setLoaded.bind(this),this._renderer.updateTileBackground(this.tileBackground),this._renderer.install(this._view._stage),this.overlayManager=new p(this,this._view);var e="spherical"===this.manifold?g.SurfaceExtentHelperGlobal:g.SurfaceExtentHelperLocal;this.extentHelper=new e({layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference});var t;t=this._view.defaultsFromMap?new s({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(e){return e.layers}}):this._view.map.allLayers,this._set("tilingSchemeLogic",new _({layers:t,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference})),this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0),this._updateTilingSchemeAndExtent(),this._streamDataSupplier=this._view.resourceController.registerClient(this,d.ClientType.TERRAIN),this._idleWorkers={needsUpdate:this._needsIdleUpdate,idleFrame:this._idleUpdate},this._view.resourceController.registerFrameWorker(this._frameUpdate.bind(this)),this._view.resourceController.registerIdleFrameWorker(this,this._idleWorkers),this._viewChangeListenerHandles=[],this._viewChangeUpdate=this._viewChangeUpdate.bind(this),this._viewChangeListenerHandles.push(this._view.on("resize",this._viewChangeUpdate)),this._viewChangeListenerHandles.push(a.on(this._view,"navigation","currentViewChanged",this._viewChangeUpdate)),this._viewChangeListenerHandles.push(this._view.watch("qualitySettings.tiledSurface.lodBias",this._viewChangeUpdate)),this._layerViewChangesHandle=this._view.allLayerViews.on("change",this._handleLayerViewChanges.bind(this)),this._handleLayerViewChanges({added:this._view.allLayerViews.toArray(),removed:[],moved:[]}),this._clippingChangedHandle=this._view.watch("clippingArea",this._clippingChanged.bind(this)),this._updateClippingExtent()},destroy:function(){this._removeAllTiles(),this.tilingSchemeLogic.destroy(),this._set("tilingSchemeLogic",null),this.extentHelper.destroy(),this.extentHelper=null;for(var e in this._basemapLayerViewHandles)this._unregisterTiledLayerView(e);this._view.resourceController.deregisterFrameWorker(this),this._view.resourceController.deregisterIdleFrameWorker(this),this._view.resourceController.deregisterClient(this),this._viewChangeListenerHandles.forEach(z);for(var t in this._groupLayerViewHandles)this._groupLayerViewHandles[t].forEach(z);this._layerViewChangesHandle.remove(),this._clippingChangedHandle.remove(),this.overlayManager&&(this.overlayManager.destroy(),this.overlayManager=null),this._renderer.uninstall(this._stage),this._renderer=null,this._view=null,this._stage=null,this._streamDataSupplier=null},setVisibility:function(e){e!==this.visible&&(this.visible=e,this._renderer.setVisibility(e),this.setUpdatesDisabled(!e),e&&this._viewChangeUpdate())},isVisible:function(){return this.visible&&this.ready},setUpdatesDisabled:function(e){this.suspended=e,e||this._viewChangeUpdate()},getElevation:function(e){if(!this.ready)return null;var t=T.LayerClass.ELEVATION,i=this.rootTiles[0].layerInfo[t].length;return 0===i?null:Array.isArray(e)?this._getElevation(e):h.pointToVector(e,j,this.tilingScheme.spatialReference)?this._getElevation(j):(D.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)},_getElevation:function(e){var t,i=T.LayerClass.ELEVATION,r=this.rootTiles[0].layerInfo[i].length;F.length<r&&(F.length=r);for(var a=0;a<this.rootTiles.length;a++){var s=this.rootTiles[a];if(f.isPosWithinTile(s,e))for(;s;){var n=s.layerInfo[i];for(t=0;r>t;t++)n[t].data&&(F[t]=n[t].data.samplerData);if(!s.children[0])break;var l=0;e[0]>s.children[0].extent[2]&&(l+=1),e[1]<s.children[0].extent[1]&&(l+=2),s=s.children[l]}}var o=y.elevationSampler(e[0],e[1],F);for(t=0;r>t;t++)F[t]=void 0;return o},getElevationBounds:function(){return this._elevationBounds},getScale:function(e){if(this.tilingScheme){if(!h.pointToVector(e,j,this.spatialReference))return D.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;if(this.rootTiles)for(var t=0;t<this.rootTiles.length;t++){var i=this.rootTiles[t];if(f.isPosWithinTile(i,j)){for(;i.children[0];){var r=0;j[0]>i.children[0].extent[2]&&(r+=1),j[1]<i.children[0].extent[1]&&(r+=2),i=i.children[r]}return this._getLodBiasCorrectedScale(i.lij[0])}}}return 1e100},queryVisibleScaleRange:function(e,t,i,r){var a=t?this.tilingScheme.levelAtScale(t):0,s=i?this.tilingScheme.levelAtScale(i):1/0,n=this._getLodBias();this._renderer.queryVisibleLevelRange(e,a+n,s+n,r)},_setLoaded:function(){this.loaded||(this.loaded=!0,this.emit("load"))},_updateTilingSchemeAndExtent:function(){var e=this.tilingSchemeLogic.extent,t=this.tilingSchemeLogic.tilingScheme,i=!1;e&&!P.equals(e,this._dataExtent)&&(i=!0,this._dataExtent?P.set(this._dataExtent,e):this._dataExtent=P.create(e)),t!=this.tilingScheme&&(U(t,"tiling scheme cannot be reset to undefined"),i=!0,this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",t),this._updateClippingExtent(),t&&(this._updateTiledLayers(),this._renderer.setTileSize(t.pixelSize[0]),this.overlayManager.setSpatialReference(t.spatialReference,"spherical"===this.manifold))),i&&this._updateRootTiles()},_acquireTile:function(e,t,i,r){var a=this.TileClass.Pool.acquire();return Q[0]=e,Q[1]=t,Q[2]=i,a.init(Q,r,this,this.tilingScheme),a},_releaseTile:function(e){e.dispose(),e.parent=null,e.parentSurface=null,this.TileClass.Pool.release(e)},_updateRootTiles:function(){var e=this._clippingExtent||this._dataExtent,t=this.tilingScheme;if(e&&t){var r=j,a=t.rootTilesInExtent(e,r,1/0);if(this.rootTiles){if(a.length>b)return void D.warn(W.TOO_MANY_ROOT_TILES_AFTER_CHANGE);var s=this.rootTiles.map(function(e){return e.lij}),n=i.difference(s,a,R);if(n.removed.length>0||n.added.length>0){var l=this.rootTiles.filter(function(e){var t=i.findIndex(n.removed,R.bind(null,e.lij));return t>-1?(this._purgeChildTiles(e),this._purgeTile(e),!1):!0}.bind(this));n.added.forEach(function(e){var t=this._acquireTile(0,e[1],e[2],null);l.push(t),this._loadTile(t)}.bind(this)),this._set("rootTiles",l),this._renderer.setRootTiles(this.rootTiles)}}else a.length>b&&(D.warn(W.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),a=t.rootTilesInExtent(e,r,b)),this._set("rootTiles",a.map(function(e){var t=this._acquireTile(0,e[1],e[2],null);return this._loadTile(t),t}.bind(this))),this._renderer.setRootTiles(this.rootTiles);i.equals(r,this._rootExtent)||(this._rootExtent=O.create(r),this._hasFixedExtent()||this.notifyChange("extent")),this.setVisibility(!0),this._viewChangeUpdate(),this.notifyChange("ready")}},_viewChangeUpdate:function(){this._stage&&!this.suspended&&this.tilingScheme&&this.visible&&(this._updateViewDependentParameters(),this._updateOverlayOpacity(this._curEyePos),this._updateTiles(this.rootTiles),this.overlayManager&&this.overlayManager.setOverlayDirty())},_hasVisibleSiblings:function(e){var t;Array.isArray(e)?t=e:(k[0]=e,t=k);for(var i=0;i<t.length;i++){var r=t[i],a=r.parent;if(a)for(var s=0;4>s;s++){var n=a.children[s];if(n&&n!==r&&n.visible)return!0}}return!1},_updateTiles:function(e){var t=this._iteratorPool.acquire();t.reset(e);var i,r,a=this._curSplitLimits,s=this._curFrustumPlanes,n=this._curEyePos;for(this._hasVisibleSiblings(e)?(i=this._elevationBounds[0],r=this._elevationBounds[1]):(i=1/0,r=-(1/0));!t.done;){var o=t.next();o.updateClippingStatus(this._clippingExtent);var h=o.updateVisibility(s,n),d=!0;if(h){o.updateScreenDepth(this._viewProjectionMatrix),o.renderData&&(i=Math.min(o.elevationBounds[0],i),r=Math.max(o.elevationBounds[1],r));var u=o.shouldSplit(a,n);u===H.SPLIT?(o.pendingUpdates&=~H.MERGE,o.renderData?(d=!1,o.pendingUpdates|=H.SPLIT,t.skip()):d=!1):(o.pendingUpdates&=~H.SPLIT,u===H.VSPLITMERGE&&o.updateAgents(T.LayerClass.ELEVATION),t.skip())}else t.skip();if(d&&!o.renderData){o.pendingUpdates|=H.MERGE,o.pendingUpdates&=~H.SPLIT;var A=this._iteratorPool.acquire();for(A.reset(o);!A.done;){var c=A.next();c.updateVisibility(s,n),c.visible&&c.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(A)}0!==o.pendingUpdates&&(this._pendingUpdates=!0)}this._iteratorPool.release(t),isFinite(i)&&isFinite(r)&&(this._elevationBounds[0]!==i||this._elevationBounds[1]!==r)&&(this._elevationBounds[0]=i,this._elevationBounds[1]=r,l.emit(this,"elevation-bounds-change"))},_viewParamSelector:{projectionMatrix:!0,fovX:!0,viewport:!0},_updateViewDependentParameters:function(){var e=this._view.navigation.currentCamera,t=Math.tan(.5*e.fovX),i=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,a=Math.pow(2,-this._getLodBias());this._curSplitLimits[0]=t,this._curSplitLimits[1]=r[0]/e.width*this.maxTextureScale*a,this._curSplitLimits[2]=i,this._curSplitLimits[3]=r[1]/e.height*this.maxTextureScale*a,this._curSplitLimits[4]=this.tilingScheme.getMaxLod(),this._curSplitLimits[5]=this._view.qualitySettings.tiledSurface.angledSplitBias,e.copyFrustumPlanes(this._curFrustumPlanes),V.multiply(e.projectionMatrix,e.viewMatrix,this._viewProjectionMatrix),B.set(e.eye,this._curEyePos),v.autoUpdateSkirtsVisibility(this,this._curEyePos)},_setLayerViewsUpdating:function(){for(var e=0;e<T.LayerClass.LAYER_CLASS_COUNT;e++)for(var t=this._layerViews[e],i=0;i<t.length;i++)t[i]._evaluateUpdatingState(this._pendingUpdates)},_frameUpdateTraversal:function(e){if(!this.suspended){this._frameUpdateLowerPrio.clear();var t=this._renderer.resourceCounter.numTileTexturesComposited,i=this._iteratorPool.acquire();i.reset(this.rootTiles);for(var r=!1,a=!1;!i.done&&(e.remaining()>1||!r)&&this._renderer.resourceCounter.numTileTexturesComposited-t<M;){var s=i.next();s.pendingUpdates&H.MERGE?(this._mergeTile(s),s.pendingUpdates&=~H.MERGE,r=!0,i.skip()):s.pendingUpdates&H.SPLIT?(this._splitTile(s),s.pendingUpdates&=~H.SPLIT,r=!0,i.skip()):s.pendingUpdates>0&&this._frameUpdateLowerPrio.push(s),0!==s.pendingUpdates&&(a=!0)}return this._pendingUpdates=a||!i.done,this._iteratorPool.release(i),r}},_updateTileGeometry:function(e){this._renderer._updateTileGeometry(e),Y.spatialReference=this.spatialReference,Y.tile=e,l.emit(this,"elevation-change-tile",Y)},_updateTileTexture:function(e){this._renderer.updateTileTexture(e)},_frameUpdate:function(e){if(this.rootTiles){for(var t=this._frameUpdateTraversal(e);(e.remaining()>1||!t)&&this._frameUpdateLowerPrio.length>0;){var i=this._frameUpdateLowerPrio.pop();i.pendingUpdates&H.DECODE_LERC?(this._decodeLERC(i),i.pendingUpdates&=~H.DECODE_LERC,t=!0):i.pendingUpdates&H.UPDATE_GEOMETRY?(this._renderer.updateTileGeometryNeedsUpdate(i),this._updateTileGeometry(i),t=!0,i.pendingUpdates&=~H.UPDATE_GEOMETRY):i.pendingUpdates&H.UPDATE_TEXTURE&&(this._updateTileTexture(i),i.pendingUpdates&=~H.UPDATE_TEXTURE,t=!0),0!==i.pendingUpdates&&(this._pendingUpdates=!0)}this._frameUpdateLowerPrio.length>0&&(this._pendingUpdates=!0),this._streamDataSupplier._loader.hasPendingDownloads()&&(this._pendingUpdates=!0),this._pendingUpdates!==this._lvPendingUpdates&&(this._pendingUpdates||20===++this._updateNextFrame)&&(this._setLayerViewsUpdating(),this._lvPendingUpdates=this._pendingUpdates,this._updateNextFrame=0)}},_needsIdleUpdate:function(){return this.isVisible()&&this.overlayManager&&this.overlayManager.overlaysNeedUpdate()},_idleUpdate:function(e){this.overlayManager.updateOverlay(),this._updateOverlayOpacity(this._curEyePos)},_updateClippingExtent:function(){if(!this.spatialReference)return!1;var e=[],t=null;return h.extentToBoundingRect(this._view.clippingArea,e,this.spatialReference)&&(t=e),i.equals(t,this._clippingExtent)?!1:(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),!0)},_clippingChanged:function(){this._updateClippingExtent()&&this._updateRootTiles()},_getLodBias:function(){return Math.round(this._view.qualitySettings.tiledSurface.lodBias)},_getLodBiasCorrectedScale:function(e){var t=this.tilingScheme.levels,i=I.clamp(e-this._getLodBias(),0,t.length-1);return t[i].scale},_cancelTilemapRequests:function(e){for(var t=0;t<T.LayerClass.LAYER_CLASS_COUNT;t++){var i=e.layerInfo[t];if(i)for(var r=0;r<i.length;r++){var a=i[r];a.tilemapRequest&&(a.tilemapRequest.cancel(),a.tilemapRequest=null)}}},_removeAllTiles:function(){this.rootTiles&&(this.rootTiles.forEach(function(e){this._purgeChildTiles(e),this._purgeTile(e)}.bind(this)),this._set("rootTiles",null),this.notifyChange("ready"));for(var e=0;e<this._topLevelTilemapOnlyTiles.length;e++){var t=this._topLevelTilemapOnlyTiles[e];this._cancelTilemapRequests(t)}this.setVisibility(!1)},_purgeChildTiles:function(e){var t=this._postorderIterator;for(t.reset(e);!t.done;){for(var i=t.next(),r=0;4>r;r++)i.children[r]=null;i!==e&&this._purgeTile(i)}},_purgeTile:function(e){e.unload(this._renderer),this._cancelTilemapRequests(e),e.parent=null,e.releaseLayerResources(),this._releaseTile(e)},_splitTile:function(e){var t=e.lij[0]+1,i=2*e.lij[1],r=2*e.lij[2];e.children[0]=this._createTile(t,i,r,e),e.children[1]=this._createTile(t,i,r+1,e),e.children[2]=this._createTile(t,i+1,r,e),e.children[3]=this._createTile(t,i+1,r+1,e),e.unload(this._renderer),Z.spatialReference=this.spatialReference,Z.extent=e.extent,Z.scale=this._getLodBiasCorrectedScale(t),l.emit(this,"scale-change",Z)},_createTile:function(e,t,i,r){U(r,"_createTile sanity check");var a=this._acquireTile(e,t,i,r);if(a.updateClippingStatus(this._clippingExtent),a.updateVisibility(this._curFrustumPlanes,this._curEyePos),a.visible){a.updateScreenDepth(this._viewProjectionMatrix);var s=a.shouldSplit(this._curSplitLimits,this._curEyePos);s===H.SPLIT&&(a.pendingUpdates|=H.SPLIT,this._pendingUpdates=!0)}return this._loadTile(a),a},_mergeTile:function(e){U(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._purgeChildTiles(e),Z.spatialReference=this.spatialReference,Z.extent=e.extent,Z.scale=this._getLodBiasCorrectedScale(e.lij[0]),l.emit(this,"scale-change",Z)},_loadTile:function(e){e.load(this._renderer),this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(e,e.renderData,this._curOverlayOpacity)},_decodeLERC:function(e){var t=T.LayerClass.ELEVATION,i=e.layerInfo[t];if(i)for(var r=0;r<i.length;r++){var a=i[r];if(a.pendingUpdates&=~H.DECODE_LERC,a.rawData){var s=e.createElevationDataFromLERC(a.rawData);if(a.rawData=null,s){a.data=s;var n=e.lij[0],l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){var o=l.next();o.findElevationBoundsForLayer(r,n),o.computeElevationBounds()}this._iteratorPool.release(l),e.dataArrived(r,t,s),this._updateTiles(e),G.spatialReference=this.spatialReference,G.extent=e.extent,this._emitElevationChange(G)}}}},_handleLayerViewChanges:function(e){var t=!1;e.added.forEach(function(e){var i=e.layer;if(v.isTiledLayerView(e))this._registerTiledLayer(i,e),i.loaded&&(t=!0);else if(e.supportsDraping&&this.overlayManager)this.overlayManager.registerLayerView(e);else if("IntegratedMeshLayer"===i.operationalLayerType&&!this._renderer.isStencilEnabledLayerExtent(e.uid)){var r=i.fullExtent,a=r.spatialReference,s=[r.xmin,r.ymin,r.zmin],n=[r.xmax,r.ymax,r.zmax],l=new Array(6),o=h.bufferToBuffer(s,a,0,l,this.spatialReference,0);o=o&&h.bufferToBuffer(n,a,0,l,this.spatialReference,3),o&&this._renderer.addStencilEnabledLayerExtent(e.uid,l)}}.bind(this)),e.removed.forEach(function(e){v.isTiledLayerView(e)?(t=!0,this._unregisterTiledLayerView(e.uid)):e.supportsDraping&&this.overlayManager?this.overlayManager.unregisterLayerView(e):this._renderer.isStencilEnabledLayerExtent(e.uid)&&this._renderer.removeStencilEnabledLayerExtent(e.uid)}.bind(this)),t=t||e.moved.filter(v.isTiledLayerView).length>0,t&&this._updateTiledLayers()},_registerTiledLayer:function(e,t){var i=[];i.push(t.watch("suspended",function(){this._updateTiledLayers()}.bind(this))),i.push(t.watch("fullOpacity",this._updateTileTextures.bind(this))),this._basemapLayerViewHandles[t.uid]=i},_unregisterTiledLayerView:function(e){var t=this._basemapLayerViewHandles[e];if(t){for(var i=0;i<t.length;i++)t[i].remove();delete this._basemapLayerViewHandles[e]}},_updateTiledLayers:function(){if(this.tilingScheme){var e=this._view.allLayerViews,t=[[],[]],i=T.LayerClass,r=null,a=P.create(P.NEGATIVE_INFINITY),s=function(e){var s=e.layer;if(s&&e&&!e.suspended&&v.isTiledLayerView(e)){var n=s.fullExtent;if(n){var l=v.isVectorTileLayerView(e)&&256===this.tilingScheme.pixelSize[0]?s.tileInfo256:s.tileInfo;if(!this.tilingScheme.compatibleWith(l))return void D.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");P.expand(a,n),v.isElevationLayerView(e)?t[i.ELEVATION].push(e):(e.maxDataLevel!==1/0&&(null===r||e.maxDataLevel>r)&&(r=e.maxDataLevel),t[i.MAP].push(e))}else D.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id)}}.bind(this);e.forEach(s,this);for(var n=0;n<i.LAYER_CLASS_COUNT;n++){var l=this._layerViews[n],o=t[n];o.reverse();var h=l.length!==o.length,d=o.length,u=new Array(d),A=new Array(l.length);this._layerIndexByLayerViewId[n]={};for(var c=0;d>c;c++){var p=o[c].uid;this._layerIndexByLayerViewId[n][p]=c;var g=l.indexOf(o[c]);u[c]=g,c!==g&&(h=!0),g>-1&&(A[g]=c)}if(h){if(this._layerViews[n]=o,this._topLevelTilemapOnlyTiles.forEach(function(e){e.modifyLayers(A,u,n,l)}),this.rootTiles){var _=this._postorderIterator;for(_.reset(this.rootTiles);!_.done;)_.next().modifyLayers(A,u,n,l);for(_.reset(this.rootTiles);!_.done;){var f=_.next();f.restartAgents(n),n===i.ELEVATION&&f.computeElevationBounds()}this._updateTiles(this.rootTiles)}n===i.ELEVATION&&this.tilingScheme&&(G.spatialReference=this.tilingScheme.spatialReference,G.extent=X,this._emitElevationChange(G))}}this.tilingScheme.levels.length-1<r&&(this.tilingScheme.ensureMaxLod(r),this._viewChangeUpdate())}},_emitElevationChange:function(e){l.emit(this,"elevation-change",e),W.UPDATE_OVERLAY_MANAGER_BY_ELEVATION_UPDATES_DEFAULT&&this.overlayManager.onElevationChange(e)},_getLayerExtentUnion:function(e){var t=this._view.allLayerViews,i=P.create(P.NEGATIVE_INFINITY);return t.forEach(function(t){var r=t.layer,a=t.fullExtentInViewSpatialReference||r.fullExtent;a&&!a.spatialReference.equals(e)&&(a=A.canProject(a.spatialReference,e)?A.project(a,e):null),a&&P.expand(i,a)}),P.allFinite(i)?i:null},layerViewByIndex:function(e,t){return this._layerViews[t][e]},agentTypeByLayerIndex:function(e,t){return t===T.LayerClass.ELEVATION?S:w},numLayers:function(e){return this._layerViews[e].length},numTotalLayers:function(){return this._layerViews.reduce(function(e,t){return t.length+e},0)},_updateTileTextures:function(){var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;)e.next().updateTexture();this._iteratorPool.release(e)},requestTileData:function(e,t,i){this.tilemapStats.tilesRequested++;var r=this.layerViewByIndex(t,i);if(r.layer.tilemapCache){var a=this.getTilemapTile(e),s=a.layerInfo[i][t];if(!s.tilemap){var n=new u.Promise;return n.actualTileRequestPromise=null,s.tilemapRequest||(s.tilemapRequest=this.requestTilemap(a,t,i,r)),s.tilemapRequest.then(function(){if(s.tilemapRequest=null,!n.isCancelled()){var t=this._layerIndexByLayerViewId[i][r.uid];null!=t&&(a.tileDataAvailable(e,t,i)?(n.actualTileRequestPromise=this._requestTileData(e,t,i,r),n.actualTileRequestPromise.then(function(){n.resolve()})):(this.tilemapStats.tilesNotPresent++,this._dispatchDataEvent(e,"dataMissing",i,r,{notInTilemap:!0}),n.reject()))}}.bind(this)),n}if(!a.tileDataAvailable(e,t,i)){this.tilemapStats.tilesNotPresent++,this._dispatchDataEvent(e,"dataMissing",i,r,{notInTilemap:!0});var l=new u.Promise;return l.reject(),l}}return this._requestTileData(e,t,i,r)},_requestTileData:function(e,t,i,r){this.tilemapStats.tileRequestsSent++;var a,s=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]),n=this;if(i===T.LayerClass.ELEVATION)a=this._streamDataSupplier.request(s,"binary"),a.then(function(t,a){var s=n._layerIndexByLayerViewId[i][r.uid];if(null!=s){var l=e.layerInfo[i][s];a.url=t,l.rawData=a,e.pendingUpdates|=H.DECODE_LERC,l.pendingUpdates|=H.DECODE_LERC,n._pendingUpdates=!0}else D.warn("TerrainSurface: received data from unknown layer %d %s",i,e.lij.toString())},function(t){n.tilemapStats.tileRequestErrors++,n._dispatchDataEvent(e,"dataMissing",i,r,t)});else if(v.isVectorTileLayerView(r)){var l=r.tileHandler,o=r.schemeHelper.getCompatibleLevelRowCol(e.lij);a=l.getVectorTileWithLRC(o[0],o[1],o[2],0),a.then(function(t){n._dispatchDataEvent(e,"dataArrived",i,r,t)}).otherwise(function(t){"cancel"!==t&&(n._dispatchDataEvent(e,"dataMissing",i,r,t),n.tilemapStats.tileRequestErrors++)})}else a=this._streamDataSupplier.request(s,"image"),a.then(function(t,a){n._dispatchDataEvent(e,"dataArrived",i,r,a)},function(t){n.tilemapStats.tileRequestErrors++,n._dispatchDataEvent(e,"dataMissing",i,r,t)});return a},requestTilemap:function(e,t,i,r){var a,s=new u.Promise(function(){a.cancel()}),n=e.lij[0]+T.TILEMAP_SIZE_EXP,l=e.lij[1]<<T.TILEMAP_SIZE_EXP,o=e.lij[2]<<T.TILEMAP_SIZE_EXP;this.tilemapStats.tilemapRequestsSent++,this.tilemapStats.tilemapRequestsPending++;var h=this;return a=r.layer.tilemapCache.fetchTilemap(n,l,o,{timeout:6e3}),a.then(function(a){h.tilemapStats.tilemapRequestsPending--,t=this._layerIndexByLayerViewId[i][r.uid],null!=t&&(e.layerInfo[i][t].tilemap=a),s.resolve()}.bind(this),function(){h.tilemapStats.tilemapRequestErrors++,s.resolve()}),s},getTilemapTile:function(e){var t=e.lij[0];return t>T.TILEMAP_SIZE_EXP?f.getTileNLevelsUp(e,T.TILEMAP_SIZE_EXP):this._topLevelTilemapOnlyTiles[t]},_dispatchDataEvent:function(e,t,i,r,a){var s=this._layerIndexByLayerViewId[i][r.uid];null!=s?e[t](s,i,a):D.warn("TerrainSurface: received data from unknown layer")},cancelRequest:function(e){var t=e.actualTileRequestPromise;void 0!==t?(null!==t&&this._streamDataSupplier.cancelRequest(t),e.cancel()):this._streamDataSupplier.cancelRequest(e)},_updateTileOverlayParams:function(){if(this.rootTiles){var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){var t=e.next();t.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(t,t.renderData,this._curOverlayOpacity)}this._iteratorPool.release(e),this._renderer.setNeedsRender()}},_updateOverlayOpacity:function(e){if(this.overlayManager){var t=this.overlayManager.updateOpacity(e);if(!isNaN(t)){if(t!==this._curOverlayOpacity&&this.rootTiles){var i=this._iteratorPool.acquire();for(i.reset(this.rootTiles);!i.done;){var r=i.next();r.renderData&&r.renderData.overlayTexId&&(r.renderData.overlayOpacity=t)}this._iteratorPool.release(i)}this._curOverlayOpacity=t,this._renderer.setNeedsRender()}}},getStats:function(){var e=0,t=0,i=0,r=[],a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var s=a.next();if(e++,s.renderData&&(t++,s.visible)){i++;var n=s.lij[0];r[n]=null!=r[n]?r[n]+1:1}}return this._iteratorPool.release(a),{numNodes:e,numLeaves:t,numVisible:i,numVisiblePerLevel:r}},getTile:function(e){var t=e.split("/").map(JSON.parse);if(0===t[0])return this.rootTiles.forEach(function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]?e:void 0}),null;var i,r=Math.pow(2,t[0]),a=Math.floor(t[1]/r),s=Math.floor(t[2]/r);if(this.rootTiles.some(function(e){return e.lij[1]===a&&e.lij[2]===s?(i=e,!0):!1}),i){for(var n=1<<t[0]-1;i.lij[0]<t[0];){var l=t[1]&n?2:0;if((t[2]&n)>0&&l++,!i.children[l])return console.log("Tile "+e+" doesn't exist, smallest ancestor is "+f.tile2str(i)),null;i=i.children[l],n>>=1}return U(i.lij[0]===t[0]&&i.lij[1]===t[1]&&i.lij[2]===t[2],"not the right tile?"),i}return null},hasPendingUpdates:function(){if(this._streamDataSupplier._loader.hasPendingDownloads())return!0;var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){var t=e.next();
if(t.pendingUpdates>0)return this._iteratorPool.release(e),!0}return this._iteratorPool.release(e),!1},setBorders:function(e){this._renderer.setBorders(e)},setDisableRendering:function(e){this._renderer.setDisableRendering(e)},_extentGetter:function(){return this._clippingExtent||this._rootExtent},_hasFixedExtent:function(){return!!this._clippingExtent},_wireframeSetter:function(e){this._renderer.setWireframe(e),this._set("wireframe",e),this._view._stage.setRenderParams({earlyOcclusionPixelDraw:e})},_opacitySetter:function(e){this._renderer.setOpacity(e),this._set("opacity",e)},_skirtsSetter:function(e){this._renderer.setDrawSkirts(!!e),this._set("skirts",e)},_cullBackFacesSetter:function(e){this._renderer.setCullBackFaces(e),this._set("cullBackFaces",e)},_renderOrderSetter:function(e){this._renderer.setRenderOrder(e),this._set("renderOrder",e)},_frontMostTransparentSetter:function(e){this._renderer.setFrontMostTransparent(!!e),this._set("frontMostTransparent",e)},_tileBackgroundSetter:function(e){e!==this.tileBackground&&this._renderer.updateTileBackground(e),this._set("tileBackground",e)},_velvetOvergroundSetter:function(e){e!==this.velvetOverground&&this._renderer.setVelvetOverground(e),this._set("velvetOverground",e)}});return W.TOO_MANY_ROOT_TILES_INITIALLY="Maximum number of root tiles exceeded, only a part of the map will be visible.",W.TOO_MANY_ROOT_TILES_AFTER_CHANGE="Cannot extend surface to encompass all layers because it would result in too many root tiles.",W.UPDATE_OVERLAY_MANAGER_BY_ELEVATION_UPDATES_DEFAULT=!1,W});