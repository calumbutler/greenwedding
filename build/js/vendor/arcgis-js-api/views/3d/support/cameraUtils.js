// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/_base/lang","../../../geometry/SpatialReference","../../../config","../../../geometry/Point","../../../geometry/support/webMercatorUtils","../../../Camera","../lib/glMatrix","./mathUtils","./earthUtils","./projectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical"],function(e,t,n,r,a,i,o,c,l,u,v,f){function s(e){return e.spatialReference||t.WGS84}function d(e,t){return"global"===e.viewingMode?f[t]:v[t]}function g(e,t){var n=e.renderSpatialReference,r=d(e,"headingTiltToDirectionUp"),a=I.create();if(u.pointToVector(t.position,a,n)){var i=r(a,t.heading,t.tilt);I.add(i.direction,a);var o=e.navigation.getCameraIntersectTerrain(a,i.direction,i.up);return o.fov=c.deg2rad(t.fov),o}return null}function m(e,n,a){var o=e.renderSpatialReference,l=I.set(n.viewForward,G),v=y(e,n.eye,l,n.up,X),f=s(e);return u.vectorToVector(n.eye,o,W,f)||(f=t.WGS84,u.vectorToVector(n.eye,o,W,f)),a?(a.position.x=W[0],a.position.y=W[1],a.position.z=W[2],a.position.spatialReference=f,a.heading=v.heading,a.tilt=v.tilt,a.fov=c.rad2deg(n.fov),a):new i(new r(W,f),v.heading,v.tilt,c.rad2deg(n.fov))}function p(e,t,r){var a=e.navigation.currentCamera,i=a.fovX,o=a.width/2;"global"===e.viewingMode&&null!=r&&(t*=Math.cos(c.deg2rad(r))),t/=e.renderCoordsHelper.unitInMeters;var l=n.screenDPI*U,u=l/t,v=o/u;return v/Math.tan(i/2)}function h(e,t,r){var a=e.navigation.currentCamera,i=a.fovX,o=t*Math.tan(i/2),l=a.width/2,u=l/o,v=n.screenDPI*U,f=v/u;return"global"===e.viewingMode&&(f/=Math.cos(c.deg2rad(r))),f*=e.renderCoordsHelper.unitInMeters}function T(e,t,n,r,a,i){var o=p(e,n,t.latitude);return x(e,t,o,r,a,i)}function x(e,t,n,r,a,o){var c=e.renderSpatialReference,l=w(e,r.heading,r.tilt,t,n,a),v=s(e),f=u.vectorToPoint(l.eye,c,v);return f?o?(o.position=f,o.heading=l.heading,o.tilt=l.tilt,o.fov=r.fov,o):new i(f,l.heading,l.tilt,r.fov):null}function M(e,t,n){if(u.pointToVector(t,n,e.renderSpatialReference),null==t.z){var r;if("global"===e.viewingMode)e._pickRay([0,0,0],n);else{var a=[n[0],n[1]-1,n[2]];e._pickRay(a,n)}if(!(r&&r.getMaxResult().getIntersectionPoint(n)&&0!==I.length2(n)||null==e.basemapTerrain)){var i=e.basemapTerrain.getElevation(t);null!=i&&e.renderCoordsHelper.setAltitude(i,n)}}}function y(e,t,n,r,a){return d(e,"directionToHeadingTilt")(t,n,r,a)}function C(e,t,n){return e.renderCoordsHelper.fromRenderCoords(t,F,e.spatialReference)?e.basemapTerrain&&(e.basemapTerrain.getElevation(F)||0)>F.z-1:!1}function w(t,n,a,i,o,c){var l=I.create(),v=t.renderSpatialReference;if(i&&i instanceof r?M(t,i,l):i?I.set(i,l):I.set(t.navigation.currentCamera.center,l),!(i&&i instanceof r)){var f=s(t);i=u.vectorToPoint(l,v,f)}o=Math.max(o,t.navigation.minPoiDist);var g=z(t,n,a,l,i,o,c),m=d(t,"eyeForCenterWithHeadingTilt"),p=m(l,o,g.heading,g.tilt);if(p.center=l,!(c&&c.noReset||"global"!==t.viewingMode)&&C(t,p.eye,p.tilt)){var h=t.navigation.constraints.tilt.min(o);return w(t,0,h,i,o,e.mixin({},c,{noReset:!0}))}return p}function S(e,n,o,c,v){c instanceof i&&(v=c,c={});var f,d="global"===e.viewingMode,g=e.renderSpatialReference,m=s(e),p=t.WebMercator,h=n.spatialReference||p,T=0;null!=n.zmax&&null!=n.zmin&&(f=(n.zmax+n.zmin)/2,T=n.zmax-n.zmin);var x,M,y;if(d){var C=new r(n.xmin,n.ymin,h),S=new r(n.xmax,n.ymax,h);if(C=a.project(C,p),S=a.project(S,p),null===C||null===S)return;x=new r(_.center(C.x,S.x),(S.y+C.y)/2,p),null!=f&&(x.z=f);var R=l.getGreatCircleSpanAt(x,C,S);M=R.lon,y=R.lat,_.diff(C.x,S.x)>_.range/2&&(M+=l.halfEarthCircumference),M=Math.min(M,l.halfEarthCircumference),y=Math.min(y,l.halfEarthCircumference)}else a.canProject(n,m)&&(n=a.project(n,m)),M=n.xmax-n.xmin,y=n.ymax-n.ymin,x=new r({x:n.xmin+.5*M,y:n.ymin+.5*y,z:f,spatialReference:m});var b=e.navigation.currentCamera,z=1/Math.tan(b.fovX/2),P=1/Math.tan(b.fovY/2),E=1/Math.tan(b.fov/2),D=Math.max(.5*M*z,.5*y*P,.5*T*E)/V,H=w(e,o.heading,o.tilt,x,D,c),A=u.vectorToPoint(H.eye,g,m);return A?(v||(v=new i),v.position=A,v.heading=H.heading,v.tilt=H.tilt,v.fov=e.camera.fov,v):null}function R(e,t,n,r,a){var i,o,c=e.renderSpatialReference;if(t||(n||(n=e.navigation.currentCamera),t=m(e,n,a)),n)o=u.vectorToPoint(n.center,c,s(e)),i=n.distance;else{if(o=e.toMap(e.screenCenter),!o)return null;i=l.computeCarthesianDistance(t.position,o)}n||(n=e.navigation.currentCamera);var d=Math.tan(n.fovX/2),g=Math.tan(n.fovY/2),p=2*i*d*V,h=2*i*g*V;return"global"===e.viewingMode?f.toExtent(e,o,p,h,r):v.toExtent(e,o,p,h,r)}function b(e,t){var n=e.navigation.currentCamera,r=e.engineToScreen(n.center),a=e.toScreen(t),i=r.x-a.x,o=r.y-a.y,c=Math.sqrt(i*i+o*o),l=Math.max(e.width,e.height);return c>j*l}function z(e,t,n,r,a,i,o){if(o&&o.noReset||!b(e,a)){var c=E(e,r,i,n);c=e.navigation.constraints.tilt.apply(c,i),n=P(e,r,i,c)}else t=0,n=e.navigation.constraints.tilt.min(i);return{heading:t,tilt:n}}function P(e,t,n,r){return d(e,"lookAtTiltToEyeTilt")(t,n,r)}function E(e,t,n,r){return d(e,"eyeTiltToLookAtTilt")(t,n,r)}function D(e,t){var n=e.get("basemapTerrain.tilingScheme");return n?n.levelAtScale(t):void 0}function H(e,t){var n=e.get("basemapTerrain.tilingScheme");return n?n.scaleAtLevel(t):void 0}function A(e,n,r){var a=e.renderSpatialReference;n||(n=e.navigation.currentCamera);var i,o,c=t.WGS84;return n.center?(u.vectorToVector(n.center,a,k,c),i=k[1],o=n.distance):(i=n.position.latitude,u.pointToVector(n.position,W,a),u.pointToVector(r,k,a),o=I.dist(W,k)),h(e,o,i)}var I=o.vec3d,U=39.37,V=1,j=5,W=I.create(),k=I.create(),G=I.create(),X={heading:0,tilt:0},F=new r,_=new c.Cyclical(-20037508.342788905,20037508.342788905);return{externalToInternal:g,internalToExternal:m,scaleToDistance:p,distanceToScale:h,fromExtent:S,toExtent:R,fromCenterScale:T,fromCenterDistance:x,directionToHeadingTilt:y,eyeHeadingTiltForCenterPointAtDistance:w,scaleToZoom:D,zoomToScale:H,computeScale:A}});