// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../geometry/SpatialReference","../../../geometry/Point","./mathUtils","./earthUtils","../lib/glMatrix","../webgl-engine/lib/BufferVectorMath"],function(e,n,r,t,a,i){var u=a.vec3d,f=a.mat4d,l=i.Vec3Compact,o=u.create(),c=u.create(),s=u.create(),m=r.deg2rad(1),h=r.rad2deg(1),x=new e({wkt:'      GEOCCS["Spherical geocentric",        DATUM["Not specified",          SPHEROID["Sphere",'+t.earthRadius+',0]],        PRIMEM["Greenwich",0.0,          AUTHORITY["EPSG","8901"]],        UNIT["m",1.0],        AXIS["Geocentric X",OTHER],        AXIS["Geocentric Y",EAST],        AXIS["Geocentric Z",NORTH]      ]    '}),M={SphericalRenderSpatialReference:x,vectorToVector:function(e,n,r,t){return 2===e.length?(o[0]=e[0],o[1]=e[1],o[2]=0,e=o):e===r&&(u.set(e,o),e=o),this.bufferToBuffer(e,n,0,r,t,0,1)},pointToVector:function(e,n,r){return o[0]=e.x,o[1]=e.y,o[2]=e.z||0,this.bufferToBuffer(o,e.spatialReference,0,n,r,0,1)},vectorToPoint:function(e,r,t,a){var i;return"esri.SpatialReference"===t.declaredClass?(a=t,i=new n({spatialReference:a})):(i=t,a=a||i.spatialReference),this.bufferToBuffer(e,r,0,o,a,0,1)?(i.x=o[0],i.y=o[1],i.z=o[2],i.spatialReference=a,i):null},xyzToVector:function(e,n,r,t,a,i){return o[0]=e,o[1]=n,o[2]=r,this.bufferToBuffer(o,t,0,a,i,0,1)},bufferToBuffer:function(e,n,r,t,a,i,u){u=u||1;var f,l,o=v(n),s=v(a),m=r+3*u;if(o!==s||o===R.UNKNOWN&&!n.equals(a)){if(!(o>R.UNKNOWN&&s>R.UNKNOWN))return!1;var h;if(s!==R.WGS84){var x=y[s];if(o!==R.WGS84)for(h=G[o],f=r,l=i;m>f;f+=3,l+=3)h(e,f,c,0,n.wkid),x(c,0,t,l);else for(f=r,l=i;m>f;f+=3,l+=3)x(e,f,t,l)}else for(h=G[o],f=r,l=i;m>f;f+=3,l+=3)h(e,f,t,l,n.wkid)}else if(t!==e||r!==i)for(f=r,l=i;m>f;f++,l++)t[l]=e[f];return!0},computeLinearTransformation:function(e,n,r,t){var a=v(e),i=v(t);if(a===i&&(a!==R.UNKNOWN||e.equals(t)))return f.identity(r),f.translate(r,n),!0;if(i===R.ENGINE_SPHR){var u=G[a];if(u){u(n,0,c,0,e.wkid),T(c,0,s,0);var l=m*c[0],o=m*c[1],h=Math.sin(l),x=Math.cos(l),M=Math.sin(o),N=Math.cos(o),E=r;return E[0]=-h,E[4]=-M*x,E[8]=N*x,E[12]=s[0],E[1]=x,E[5]=-M*h,E[9]=N*h,E[13]=s[1],E[2]=0,E[6]=N,E[10]=M,E[14]=s[2],E[3]=0,E[7]=0,E[11]=0,E[15]=1,!0}}else if(i===R.WEBMERC&&(a===R.WGS84||a===R.ENGINE_SPHR)){G[a](n,0,c,0,e.wkid);var S=m*c[1];d(c,0,s,0),f.identity(r),f.translate(r,s);var p=1/Math.cos(S);return f.scale(r,[p,p,1]),!0}return!1},mbsToMbs:function(e,n,r,t){var a=v(n),i=v(t);if(a===i&&(a!==R.UNKNOWN||n.equals(t)))return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],!0;if(i===R.ENGINE_SPHR){var u=G[a];if(u)return u(e,0,c,0,n.wkid),T(c,0,r,0),r[3]=e[3],!0}else if(i===R.WEBMERC&&(a===R.WGS84||a===R.ENGINE_SPHR)){G[a](e,0,c,0,n.wkid);var f=m*c[1];if(f=Math.abs(f)+Math.asin(e[3]/(N+e[2])),d(c,0,r,0),f>.9999*Math.PI)r[3]=Number.MAX_VALUE;else{var l=1/Math.cos(f);r[3]=l*e[3]}return!0}return!1},extentToBoundingBox:function(e,n,r){if(null==e)return!1;var t=!0;return o[0]=null!=e.xmin?e.xmin:0,o[1]=null!=e.ymin?e.ymin:0,o[2]=null!=e.zmin?e.zmin:0,t=t&&this.bufferToBuffer(o,e.spatialReference,0,n,r,0,1),o[0]=null!=e.xmax?e.xmax:0,o[1]=null!=e.ymax?e.ymax:0,o[2]=null!=e.zmax?e.zmax:0,t=t&&this.bufferToBuffer(o,e.spatialReference,0,n,r,3,1),null==e.xmin&&(n[0]=-(1/0)),null==e.ymin&&(n[1]=-(1/0)),null==e.zmin&&(n[2]=-(1/0)),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),t},extentToBoundingRect:function(e,n,r){if(null==e)return!1;var t=!0;return o[0]=null!=e.xmin?e.xmin:0,o[1]=null!=e.ymin?e.ymin:0,o[2]=null!=e.zmin?e.zmin:0,t=t&&this.bufferToBuffer(o,e.spatialReference,0,o,r,0,1),n[0]=o[0],n[1]=o[1],o[0]=null!=e.xmax?e.xmax:0,o[1]=null!=e.ymax?e.ymax:0,o[2]=null!=e.zmax?e.zmax:0,t=t&&this.bufferToBuffer(o,e.spatialReference,0,o,r,0,1),n[2]=o[0],n[3]=o[1],null==e.xmin&&(n[0]=-(1/0)),null==e.ymin&&(n[1]=-(1/0)),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),t},webMercator:{x2lon:function(e){return e/N},y2lat:function(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/N))},lon2x:function(e){return e*N},lat2y:function(e){var n=Math.sin(e);return N/2*Math.log((1+n)/(1-n))}}},N=t.earthRadius,R={UNKNOWN:0,ENGINE_SPHR:1,WGS84:2,WEBMERC:3},v=function(e){var n;return n=e===x?R.ENGINE_SPHR:e.isWGS84?R.WGS84:e.isWebMercator?R.WEBMERC:R.UNKNOWN},E=function(e,n,r,t){r[t++]=e[n++],r[t++]=e[n++],r[t]=e[n]},S=function(e,n,r,t){r[t++]=h*(e[n++]/N),r[t++]=h*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/N))),r[t]=e[n]},d=function(e,n,t,a){var i=.4999999*Math.PI,u=m*e[n+1];u=r.clamp(u,-i,i);var f=Math.sin(u);t[a++]=m*e[n]*N,t[a++]=N/2*Math.log((1+f)/(1-f)),t[a]=e[n+2]},T=function(e,n,r,t){var a=N+e[n+2],i=m*e[n+1],u=m*e[n],f=Math.cos(i);r[t++]=Math.cos(u)*f*a,r[t++]=Math.sin(u)*f*a,r[t]=Math.sin(i)*a},p=function(e,n,t,a){var i=l.length(e,n),u=r.asin(e[n+2]/i),f=Math.cos(u),o=(e[n+1]>0?1:-1)*r.acos(e[n]/(f*i));t[a++]=h*o,t[a++]=h*u,t[a]=i-N},y=[void 0,T,E,d],G=[void 0,p,E,S];return M});