// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","./graphics/Graphics3DLayerViewCore","./support/LayerViewUpdatingPercentage","../../layers/LayerView","../../../Graphic","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/Polyline","../../../renderers/support/renderingInfoUtils","../../../core/Collection","../../../core/HandleRegistry","../../../core/promiseUtils","../lib/glMatrix","./i3s/I3SUtil","./i3s/I3SBinaryReader","../support/PreallocArray","../support/projectionUtils","../support/aaBoundingBox"],function(e,t,r,i,n,a,o,s,d,l,u,h,p,c,g,f,v,_,y,b,A,m){function w(){return s}var D=!1,S=!1,I=!1,C=function(e){function t(){e.call(this),this._nodesAddedToStage={},this.loadedGraphics=new c,this.supportsDraping=!0,this._overlayUpdating=null,this._handles=new g}return r(t,e),t.prototype.initialize=function(){var e=this;_.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this._handles.add([this.layer.watch("renderer",function(t,r){return e._rendererChange(t,r)}),this.layer.watch("objectIdFilter",function(){return e._objectIdFilterChange()})]),this._layerViewCore=new a({owner:this,layer:this.layer,spatialIndexRequired:!1,labelingEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,verticalScaleEnabled:!0,updateSuspendResumeExtent:function(){return e._updateSuspendResumeExtent()},updateClippingExtent:function(t){return e._updateClippingExtent(t)},elevationChanged:function(t,r,i){return e._elevationChanged(t,r,i)}}),this.addResolvingPromise(this._layerViewCore.initialize()),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._createController()},t.prototype.destroy=function(){this._layerViewCore&&(this._layerViewCore.destroy(),this._layerViewCore=null),this._controller&&(this._controller.destroy(),this._controller=null),this._elevationUpdateNodes=null,this._intersectingGraphicIds=null,this._nodesAddedToStage=null,this._nodeDebugVisualizer&&(this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=null),this._handles&&(this._handles.destroy(),this._handles=null)},Object.defineProperty(t.prototype,"hasDraped",{get:function(){return this._layerViewCore.graphicsCore.hasDraped},enumerable:!0,configurable:!0}),t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=e.attributes[this._getObjectIdField()],n=function(){return r._findGraphic(e.uid)};return _.whenGraphicAttributes(this.layer,e,i,t,n)},t.prototype.getGraphicsFromStageObject=function(e,t){if(!this.loadedGraphics)return f.reject();var r=e.getMetadata().graphicId,i=this.loadedGraphics.find(function(e){return e.uid===r}),n=this._getObjectIdField();return i&&i.attributes&&i.attributes[n]?f.resolve(i):f.reject()},t.prototype.whenGraphicBounds=function(e){return this._layerViewCore.graphicsCore.whenGraphicBounds(e)},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._controller&&this._controller.updating},t.prototype.getRenderingInfo=function(e){var t=p.getRenderingInfo(e,{renderer:this.layer.renderer});if(t&&t.color){var r=t.color;r[0]=r[0]/255,r[1]=r[1]/255,r[2]=r[2]/255}return t},t.prototype._findGraphic=function(e){for(var t=0,r=Object.keys(this._nodesAddedToStage);t<r.length;t++)for(var i=r[t],n=this._nodesAddedToStage[i],a=n.bundles,o=0;o<a.length;o++)for(var s=a[o],d=0;d<s.length;d++)if(s[d].graphics.some(function(t){return t.uid===e}))return{node:this._controller.nodeIndex[i],nodeId:i,bundleNr:o,index:d};return null},t.prototype._elevationChanged=function(e,t,r){m[2]=-(1/0),m[3]=1/0;var i=m.fromRect(V,e),n=t;null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new b(10));var a=this._elevationUpdateNodes;a.clear(),this._controller&&this._controller.updateElevationChanged(i,n,a);var o=a.length;this._intersectingGraphicIds||(this._intersectingGraphicIds=new b(10));var s=this._intersectingGraphicIds;s.clear();for(var d=0;o>d;d++){var l=a.data[d],u=this._nodesAddedToStage[l.id];if(null!=u)for(var h=u.bundles,p=0;p<h.length;p++)for(var c=h[p],g=0;g<c.length;g++)for(var f=c[g].graphics,v=0;v<f.length;v++)s.push(f[v].uid)}r(this._intersectingGraphicIds.data,this._intersectingGraphicIds.length)},t.prototype._evaluateUpdatingState=function(){},t.prototype._notifySuspendedChange=function(){},t.prototype._notifyDrapedDataChange=function(){this.notifyChange("hasDraped"),this.emit("draped-data-change")},t.prototype._createController=function(){var e=this;S&&(this._nodeDebugVisualizer=_.makeNodeDebugVisualizer(this.view._stage,this.view.renderCoordsHelper,this.layer.id),window._nodeDebugVisualizer=this._nodeDebugVisualizer);var t={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:this._isBundleAlreadyAddedToStage.bind(this),isOverMemory:this._isOverMemory.bind(this),removeNodeData:this._removeNodeData.bind(this),removeFeatures:this._removeFeatures.bind(this),getAddedFeatures:this._getAddedFeatures.bind(this),getAddedNodeIDs:this._getAddedNodeIDs.bind(this),areAllBundlesLoaded:this._areAllBundlesLoaded.bind(this),wholeNodeSwitchEnabled:!0},r={traversalOptions:{initDepthFirst:!1,neighborhood:!1,perLevelTraversal:!0,allowPartialOverlaps:!1,errorMetricPreference:["distanceRangeFromDefaultCamera","screenSpaceRelative"],elevationInfo:this.layer.elevationInfo},getAllAddedFeatures:this._getAllAddedFeatures.bind(this),_nodeDebugVisualizer:this._nodeDebugVisualizer,getLoadedAttributes:this._getLoadedAttributes.bind(this),setAttributeData:this._setAttributeData.bind(this)};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})})},t.prototype._getAllAddedFeatures=function(){var e={};return this.loadedGraphics.forEach(function(t){var r=t._features,i=t._nodeId;e[i]=r}),e},t.prototype._addBundle=function(e,t,r,i,n,a,o){if(D&&console.log("_bundleLoadedCallback "+e.id+" bundleNr "+o),S&&null!=this._nodeDebugVisualizer){var s="grey",p=["grey","red","blue","yellow","magenta"];s=p[e.level]||"grey",this._nodeDebugVisualizer.show(e,this._controller.crsIndex,s)}var c=this._controller.crsIndex,g=[],f=this._getObjectIdField();if(null==this._nodesAddedToStage[e.id]&&(this._nodesAddedToStage[e.id]={bundles:[],attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null}),this._nodesAddedToStage[e.id].bundles[o]=g,null==t)return void(null!=n&&n.done());var v;if(this.layer.objectIdFilter){var _=this.layer.objectIdFilter.ids,b="include"===this.layer.objectIdFilter.method;v=function(e){var t=_.indexOf(e)>=0;return t===b}}for(var A=[],m=0;m<t.length;m++)for(var w=t[m],C=w.featureDataPositions[0],V=0;V<w.geometries.length;V++){var T=[],E=V<w.features.length?V:0,x=w.features[E],F=x||I?{}:null;if(x&&x.id){if(v&&!v(x.id))continue;F[f]=x.id}I&&(F.DBG_NODE_ID=e.id);var G=w.geometries[V],O=G.params.type,R=void 0,N=void 0;if("ArrayBufferView"===G.type){var j=i[e.geometryData[o].hrefConcat],B=G.params.vertexAttributes.position;if(null==B)continue;var P=y.valueType2TypedArrayClassMap[B.valueType];R=new P(j,B.byteOffset,B.count*B.valuesPerElement),N=B.valuesPerElement}else"Embedded"===G.type&&(R=G.params.vertexAttributes.position,N=3);var L=void 0;if("lines"===O){for(var z=[],U=0;U<R.length;U+=N)z.push([R[U]+e.mbs[0],R[U+1]+e.mbs[1]]);var M=new h(c);M.addPath(z),L=M,T.push(new d(L,null,F))}else if("points"===O)for(var U=0;U<R.length;U+=N)L=new l({x:R[U]+C[0],y:R[U+1]+C[1],z:N>2?R[U+2]+C[2]:void 0,spatialReference:c}),T.push(new d(L,null,F));else if("polygon"===O){var M=new u(c);L=M,M._outlineSegments=[];for(var k=0;k<G.params.rings.length;k++){for(var H=G.params.rings[k],q=H.start,J=[],Y=[],K=[-1,-1],Q=0;Q<H.segments.length;Q+=2){var W=H.segments[Q+0],X=H.segments[Q+1];0===W||1===W?(-1===K[0]&&(K[0]=q-H.start),K[1]=q+X-H.start):-1!==K[0]&&(Y.push(K),K=[-1,-1]);for(var U=q*N;(q+X)*N>U;U+=N)J.push([R[U]+e.mbs[0],R[U+1]+e.mbs[1]]);q+=X}-1!==K[0]&&Y.push(K),L._outlineSegments.push(Y),M.addRing(J),null!=H.inner&&console.warn("inner rings not yet supported")}T.push(new d(L,null,F))}for(var Z=0;Z<T.length;Z++){var $=T[Z];$.layer=this.layer,D&&($._features=w.features,$._nodeId=e.id)}A.push.apply(A,T),g.push({features:w.features,graphics:T})}this.loadedGraphics.addMany(A);var ee=this._nodesAddedToStage[e.id];this._setBundleAttributes(ee.bundles[o],ee.loadedAttributes,ee.attributeData),n.done()},t.prototype._areAllBundlesLoaded=function(e,t){var r=this._nodesAddedToStage[e.id];if(null==r)return!1;for(var i=function(e,t){for(var r=e.length;r--;)for(var i=e[r].features,n=i.length;n--;)if(i[n].id===t)return!0;return!1},n=0;n<e.featureData.length;n++){var a=r.bundles[n];if(null==a)return!1;if(!t&&null!=e.features)for(var o=e.featureData[n].featureRange,s=e.features.length,d=o?o[0]:0,l=o?o[1]:s-1,u=d;l>=u;u++)if(s>u&&!i(a,e.features[u].id))return!1}return!0},t.prototype._isBundleAlreadyAddedToStage=function(e,t){if(null==this._nodesAddedToStage[e.id])return{alreadyLoaded:!1,wasPartiallyHidden:!1};var r=!!this._nodesAddedToStage[e.id].bundles[t];return{alreadyLoaded:r,wasPartiallyHidden:!1}},t.prototype._isOverMemory=function(){return!1},t.prototype._removeFeatures=function(e,t){D&&console.log("_removeFeatures "+e.id+" features "+t);var r=this._nodesAddedToStage[e.id];if(null!=r){var i=r.bundles,n=[];for(var a in i)for(var o=0;o<i[a].length;o++){var s=i[a][o],d=!1;if(null!=s){for(var l in s.features)if(-1!==t.indexOf(s.features[l].id)){d=!0;break}d&&(n.push.apply(n,s.graphics),delete i[a][o])}}this.loadedGraphics.removeMany(n);for(var a=0;a<i.length;a++)for(var o=0;o<i[a].length;o++){var s=i[a][o];if(null!=s&&s.graphics.length>0)return}this._removeNodeData(e)}},t.prototype._removeNodeData=function(e){D&&console.log("_removeNodeData "+e.id);var t=this._nodesAddedToStage[e.id];if(null!=t){var r=t.bundles,i=[];for(var n in r)for(var a in r[n])i.push.apply(i,r[n][a].graphics);this.loadedGraphics.removeMany(i),delete this._nodesAddedToStage[e.id]}},t.prototype._getAddedFeatures=function(e){var t=this._nodesAddedToStage[e];if(null==t)return null;var r=t.bundles,i=[];for(var n in r)for(var a=0;a<r[n].length;a++){var o=r[n][a];i=i.concat(o.features)}return i},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)},t.prototype._getLoadedAttributes=function(e){var t=this._nodesAddedToStage[e.id];return t?t.loadedAttributes:void 0},t.prototype._setAttributeData=function(e,t,r){var i=this._nodesAddedToStage[e.id];i&&(i.loadedAttributes=t,i.attributeData=r,this._setNodeAttributes(i,t,r),this._layerViewCore.labeling.layerLabelsEnabled()&&this._layerViewCore.labeling.labelVisibilityChanged())},t.prototype._setNodeAttributes=function(e,t,r){var i=e.bundles;for(var n in i){var a=i[n];this._setBundleAttributes(a,t,r)}},t.prototype._setBundleAttributes=function(e,t,r){for(var i=0;i<e.length;i++)for(var n=e[i],a=0;a<n.graphics.length;++a){var o=n.graphics[a];if(o.attributes||(o.attributes={}),t)for(var s=0;s<t.length;++s){var d=t[s].name;o.attributes[d]=r[d][i]}}},t.prototype._updateSuspendResumeExtent=function(){if(this.layer.fullExtent){this._suspendResumeExtent||(this._suspendResumeExtent=v.vec4d.create());var e=this.layer.fullExtent;A.extentToBoundingRect(e,this._suspendResumeExtent,this.view.spatialReference)||(this._suspendResumeExtent=null)}else this._suspendResumeExtent=null;return this._suspendResumeExtent},t.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._rendererChange=function(e,t){var r=this,i=e?e.requiredFields:[],n=t?t.requiredFields:[];i.length===n.length&&i.every(function(e,t){return i[t]===n[t]})||Object.keys(this._nodesAddedToStage).forEach(function(e){r._removeNodeData({id:e})})},t.prototype._objectIdFilterChange=function(){var e=this;Object.keys(this._nodesAddedToStage).forEach(function(t){e._removeNodeData({id:t})}),this._controller&&this._controller.restartNodeLoading()},t.prototype.getStats=function(){var e=this.inherited(arguments)||{};return e.nodecount=Object.keys(this._nodesAddedToStage).length,e.featurecount=this.loadedGraphics.length,e},i([n.property()],t.prototype,"loadedGraphics",void 0),i([n.property()],t.prototype,"layer",void 0),i([n.property()],t.prototype,"view",void 0),i([n.property()],t.prototype,"hasDraped",null),i([n.property()],t.prototype,"_controller",void 0),i([n.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),i([n.property({aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),t=i([n.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],t)}(n.declared(w(),o)),V=m.create(m.POSITIVE_INFINITY);return C});