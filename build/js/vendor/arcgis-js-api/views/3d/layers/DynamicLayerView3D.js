// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../layers/LayerView","../../../geometry/Extent","../../../core/urlUtils","../../../core/promiseUtils","../../../core/HandleRegistry","../../../layers/support/ExportImageParameters","./support/projectExtentUtils","../lib/glMatrix","../webgl-engine/Stage","../webgl-engine/lib/Texture","../webgl-engine/lib/RenderGeometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/GeometryUtil","../webgl-engine/materials/Material","../webgl-engine/lib/Util"],function(e,t,a,r,i,n,s,l,o,m,d,h,g,c,u){var f=u.assert,p=l.mat4d,y=u.VertexAttrConstants,v=e.createSubclass({declaredClass:"esri.views.3d.layers.DynamicLayerView3D",supportsDraping:!0,hasDraped:!0,drawingOrder:0,_updatingOverlay:!1,_handles:null,_exportImageParameters:null,_imageVersion:null,constructor:function(){this._extents=[],this._images=[],this.fullExtentInViewSpatialReference=null,this._handles=new i},initialize:function(){this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._handles.add(this.watch("suspended",function(e){if(e)this.clear(),this.emit("draped-data-change");else for(var t=this._extents.length,a=0;t>a;a++)this.fetch(a)}.bind(this))),this._exportImageParameters=new n({layer:this.layer});var e=this.notifyChange.bind(this,"suspended");this._handles.add([this.watch("fullOpacity",this._opacityChangeHandler.bind(this)),this.layer.watch("minScale",e),this.layer.watch("maxScale",e),this._exportImageParameters.watch("version",function(e){this._imageVersion!==e&&(this._imageVersion=e,this._refetch())}.bind(this))],"layer"),this.view.resourceController.registerIdleFrameWorker(this,{idleBegin:function(){this._hasScaleRange()&&this.notifyChange("suspended")}});var t=s.toView(this).then(function(e){this.fullExtentInViewSpatialReference=e}.bind(this));t&&this.addResolvingPromise(t)},destroy:function(){this.clear(),this._handles.destroy(),this.view.resourceController.deregisterIdleFrameWorker(this),this._exportImageParameters&&(this._exportImageParameters.layer=null,this._exportImageParameters.destroy(),this._exportImageParameters=null)},getPopupData:function(e){var t=this.view.scale,a=this.layer.allSublayers.filter(function(e){var a=0===e.minScale||t<=e.minScale,r=0===e.maxScale||t>=e.maxScale;return e.popupTemplate&&e.visible&&a&&r});return a.map(function(t){var a=t.createQuery();return a.geometry=e,a.outFields=this.getTemplateOutFields(t.popupTemplate),t.queryFeatures(a).then(function(e){return e.features})},this)},getTemplateOutFields:function(e){if(!e||!e.fieldInfos)return["*"];var t=[];return e.fieldInfos.forEach(function(e){var a=e.fieldName&&e.fieldName.toLowerCase();a&&"shape"!==a&&0!==a.indexOf("relationships/")&&t.push(e.fieldName)}),t},setDrapingExtent:function(e,t,a,r){var i,n=(t[2]-t[0])/(t[3]-t[1]);i=n>1.0001?[r,r/n]:.9999>n?[r*n,r]:[r,r],this._extents[e]={extent:t,spatialReference:a,imageSize:i},this.suspended||this.fetch(e)},fetch:function(e){var i=this._extents[e],n=i.extent,s=new t(n[0],n[1],n[2],n[3],i.spatialReference);this._exportImageParameters.scale!==this.view.scale&&(this._exportImageParameters.scale=this.view.scale),this._imageVersion=this._exportImageParameters.version,this._images[e]||(this._images[e]={texture:null,material:null,rendergeometry:null,domImage:null,domImageCancelled:!1,worldExtent:n,loading:!1});var l=this._images[e];l.loading=!0,l.imageUrlPromise&&l.imageUrlPromise.cancel(),l.domImageCancelled=!0;var o={extent:s,width:i.imageSize[0],height:i.imageSize[1]};l.imageUrlPromise=r.wrapCallback(function(e){this.layer.getImageUrl(o,e)}.bind(this)),l.imageUrlPromise.then(function(t){l.imageUrlPromise=null,l.domImage||(l.domImage=new Image);var r=l.domImage;0!==t.indexOf("data:")&&a.canUseXhr(t)&&(r.crossOrigin="anonymous"),r.src=a.normalize(t),l.domImageCancelled=!1,r.onload=function(){l.domImageCancelled||(l.worldExtent=n,this._createStageObjects(e,r),0===e&&this._images[1]&&this._images[1].rendergeometry&&this._createStageObjects(1,null),l.loading=!1,this._evaluateUpdatingState(),this.emit("draped-data-change"))}.bind(this),r.onerror=function(){l.domImageCancelled||(l.loading=!1,this._clearDomImage(l),this._evaluateUpdatingState())}.bind(this),this._evaluateUpdatingState()}.bind(this))},clear:function(){for(var e in this._images)this.clearImage(e)},clearImage:function(e){var t=this._images[e];t&&(t.rendergeometry&&(this.view._stage.getTextureGraphicsRenderer().removeRenderGeometries([t.rendergeometry]),t.rendergeometry=null),t.texture&&(this.view._stage.remove(o.ModelContentType.TEXTURE,t.texture.getId()),t.texture=null),t.material&&(this.view._stage.remove(o.ModelContentType.MATERIAL,t.material.getId()),t.material=null),this._clearDomImage(t),t.loading=!1)},canResume:function(){if(!this.inherited(arguments))return!1;var e=this.layer.minScale,t=this.layer.maxScale;if(e>0||t>0){var a=this.view.scale;if(t>a||e>0&&a>e)return!1}return!0},_refetch:function(){for(var e=0;e<this._extents.length;e++)this._extents[e]&&this.fetch(e)},_drawingOrderSetter:function(e,t){if(e!==t){var a={};this._images.forEach(function(t){t&&t.material&&(t.material.setRenderPriority(e),a[t.material.getId()]=!0)}),u.objectEmpty(a)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(a),this.emit("draped-data-change"))}return e},_hasScaleRange:function(){return this.get("layer.minScale")>0||this.get("layer.maxScale")>0},_opacityChangeHandler:function(e){this._images.forEach(function(t){t&&t.material&&t.material.setParameterValues({opacity:e})}.bind(this)),this.emit("draped-data-change")},_clearDomImage:function(e){e.domImage&&(e.domImage.removeAttribute("src"),e.domImage.removeAttribute("onload"),e.domImage.removeAttribute("onerror"),e.domImage=null)},_evaluateUpdatingState:function(){this.notifyChange("updating")},isUpdating:function(){if(this._updatingOverlay)return!0;var e=!1;for(var t in this._images){var a=this._images[t];if(a.loading){e=!0;break}}return e},_createStageObjects:function(e,t){var a=this.view._stage,r=a.getTextureGraphicsRenderer(),i=this._images[e];t?(i.texture&&a.remove(o.ModelContentType.TEXTURE,i.texture.getId()),i.texture=new m(t,"dynamicMapLayer",{width:t.width,height:t.height}),a.add(o.ModelContentType.TEXTURE,i.texture)):f(i.texture),i.material?t&&i.material.setParameterValues({textureId:i.texture.getId()}):(i.material=new c({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:i.texture.getId(),receiveSSAO:!1},"dynamicMapLayer"),i.material.setRenderPriority(this.drawingOrder),a.add(o.ModelContentType.MATERIAL,i.material));var n,s=-1;if(0===e){var l=i.worldExtent,h=[[l[0],l[1],s],[l[2],l[1],s],[l[2],l[3],s],[l[0],l[3],s]];n=g.createSquareGeometry(h,!0)}else{f(1===e);var u=this._images[0].worldExtent;if(!u)return;n=_(u,i.worldExtent,s)}var y=new d(n);y.material=i.material,y.origin={vec3:[0,0,0],id:"0_0"},y.transformation=p.identity(),y.name="dynamicMapLayer",y.uniqueName="dynamicMapLayer#"+n.id,r.addRenderGeometries([y]),i.rendergeometry&&r.removeRenderGeometries([i.rendergeometry]),i.rendergeometry=y}}),_=function(){var e=new Float32Array([0,0,1]);return function(t,a,r){for(var i=[t[1]-a[1],t[3]-t[1],a[3]-t[3],123456],n=[t[0]-a[0],t[2]-t[0],a[2]-t[2],123456],s=a[2]-a[0],l=a[3]-a[1],o=n[0]>0&&n[2]>0?3:2,m=i[0]>0&&i[2]>0?3:2,d=(m+1)*(o+1),g=new Float32Array(3*d),c=new Float32Array(2*d),u=new Uint32Array(6*(m*o-1)),f=0,p=0,v=0,_=0,w=0,x=0;4>x;x++){var I=i[x];if(!(0>=I)){for(var b=0,S=0;4>S;S++){var O=n[S];0>=O||(g[p++]=a[0]+b,g[p++]=a[1]+f,g[p++]=r,c[v++]=b/s,c[v++]=f/l,3>S&&3>x&&(1!==S||1!==x)&&(u[w++]=_,u[w++]=_+1,u[w++]=_+o+1,u[w++]=_+1,u[w++]=_+o+2,u[w++]=_+o+1),_++,b+=O)}f+=I}}var R={};R[y.POSITION]={size:3,data:g},R[y.NORMAL]={size:3,data:e},R[y.UV0]={size:2,data:c};for(var P={},T=new Uint32Array(u.length),U=0;U<T.length;U++)T[U]=0;return P[y.POSITION]=u,P[y.NORMAL]=T,P[y.UV0]=u,{faces:{type:"triangle",indices:P,positionKey:y.POSITION},vertexAttr:R,id:h.getNewId().toString()}}}();return v});