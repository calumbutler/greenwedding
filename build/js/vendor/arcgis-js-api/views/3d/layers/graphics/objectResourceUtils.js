// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/_base/lang","dojo/Deferred","../../../../request","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/materials/Material","../../webgl-engine/lib/Texture","../../support/aaBoundingBox"],function(e,t,r,n,a,o,i,s,l,u,m,p,c,f){function d(e,t){if(t=t||{},t.streamDataSupplier){var r=t.streamDataSupplier.request(e,"json"),n=new a(function(){return t.streamDataSupplier.cancelRequest(r)});return r.then(function(e,r){var a=g(r,t);n.resolve(a)},function(){n.reject()}),n.promise}var i=o(e),s=new a(function(){return i.cancel()});return i.then(function(e){var r=g(e.data,t);s.resolve(r)},function(){s.reject()}),s.promise}function v(e){for(var t=e.stageResources[s.ModelContentType.GEOMETRY],r=e.geometryTransformations,n=f.create(f.NEGATIVE_INFINITY),a=[0,0,0],o=[0,0,0],i=0;i<t.length;i++)for(var l=t[i],u=0,m=l.getNumGroups();m>u;++u){var p=l.getBoundingInfo(u);I.multiplyVec3(r[i],p.getBBMin(),a),I.multiplyVec3(r[i],p.getBBMax(),o);for(var c=0;3>c;++c){if(a[c]>o[c]){var d=a[c];a[c]=o[c],o[c]=d}n[c]=Math.min(n[c],a[c]),n[c+3]=Math.max(n[c+3],o[c])}}return n}function g(e,t){var r=[],a=[],o=[],i=[],l=[],f=[],d="meshsymbol_"+e.model.name,v=e.textureDefinitions,g={};for(var B in v){var A=v[B],S=A.images[0].data;E(S,"symbol resources must have embedded texture data (at the moment)");var D=A.encoding+";base64,"+S,O="/textureDefinitions/"+B,R=new c(D,d,{noUnpackFlip:!0});l.push(R),g[O]={engineTexObj:R,transparent:"rgba"===A.channels}}for(var j=e.model.geometries,G=e.materialDefinitions,C=0;C<j.length;C++){var U=j[C];U.params.components||y(U);var q=U.params.components,N=q.length,P=U.params.faces,V=U.params.vertexAttributes,k=U.params.topology||"Indexed",F={};for(var Y in V){var _=V[Y],z=_.values;if(E(_.values,"symbol resources with external geometry bin not yet supported"),t.bakeTransformations){if("position"===Y){var H=U.transformation;z=z.slice(0),T(z,3,0,z.length,w,H)}if("normal"===Y){var K=M.create();z=z.slice(0),h(K,U.transformation),T(z,3,0,z.length,x,K)}}F[Y]={data:z,size:_.valuesPerElement}}var L=void 0,X=void 0,J=new Array(N);if("Indexed"===k){L=P.componentIndices,X={};for(var Q in P)X[Q]=P[Q].byteOffset}else"PerAttributeArray"!==k?console.warn("I3S symbol loader: unsupported topology type "+k):1!==N&&console.warn("I3S symbol loader: if topology is not Indexed, only single component geometries are supported");o.push([]);for(var W=0;W<q.length;W++){var Z=q[W],$={type:"triangle",positionKey:"position",indices:{}};if(L){var ee=N-1>W?L[W+1]-L[W]:P.position.count-L[W];for(var te in P)if("componentIndices"!==te){var re=P[te];E(re.values,"symbol resources with external geometry bin not yet supported"),$.indices[te]=new Uint32Array(re.values),X[te]+=4*ee}}else{var ne=b(F.position.data.length/F.position.size);for(var ae in F)$.indices[ae]=ne}J[W]=$;var oe=void 0;Z.texture&&(oe=g[Z.texture].engineTexObj.getId());var ie=i[Z.material]?i[Z.material][Z.texture]:null;if(!ie){var se=Z.material.substring(Z.material.lastIndexOf("/")+1),le=G[se].params;1===le.transparency&&(le.transparency=0);var ue={ambient:le.diffuse,diffuse:le.diffuse,specular:le.specular,shininess:le.shininess,opacity:1-le.transparency,transparent:le.transparency>0,textureId:oe,doubleSided:!0,cullFace:"none",flipV:!1};t.materialParamsMixin&&n.mixin(ue,t.materialParamsMixin),ie=new p(ue,d),i[Z.material]||(i[Z.material]={}),i[Z.material][Z.texture]=ie,a.push(ie)}o[C].push(ie)}var me=new u(new m(J,F),d),pe=I.create(U.transformation);t.bakeTransformations&&I.identity(pe),r.push(me),f.push(pe)}return{stageResources:(ce={},ce[s.ModelContentType.TEXTURE]=l,ce[s.ModelContentType.MATERIAL]=a,ce[s.ModelContentType.GEOMETRY]=r,ce),geometryTransformations:f,materialsByComponent:o,pivotOffset:e.model.pivotOffset};var ce}function y(e){var t=e.params;E(t.material),t.components=[{id:1,material:e.params.material,texture:e.params.texture,region:e.params.texture}],t.faces&&(t.faces.componentIndices=[t.faces.position.count])}function b(e){for(var t=new Uint32Array(e),r=0;e>r;r++)t[r]=r;return t}function x(e,t,r){var n=t[0],a=t[1],o=t[2];return e[0]=n*r[0]+a*r[3]+o*r[6],e[1]=n*r[1]+a*r[4]+o*r[7],e[2]=n*r[2]+a*r[5]+o*r[8],e}function h(e,t){var r=t[0],n=t[1],a=t[2],o=t[3],i=t[4],s=t[5],l=t[6],u=t[7],m=t[8],p=t[9],c=t[10],f=t[11],d=t[12],v=t[13],g=t[14],y=t[15],b=r*s-n*i,x=r*l-a*i,h=r*u-o*i,w=n*l-a*s,T=n*u-o*s,I=a*u-o*l,M=m*v-p*d,B=m*g-c*d,E=m*y-f*d,A=p*g-c*v,S=p*y-f*v,D=c*y-f*g,O=b*D-x*S+h*A+w*E-T*B+I*M;return O?(O=1/O,e[0]=(s*D-l*S+u*A)*O,e[1]=(l*E-i*D-u*B)*O,e[2]=(i*S-s*E+u*M)*O,e[3]=(a*S-n*D-o*A)*O,e[4]=(r*D-a*E+o*B)*O,e[5]=(n*E-r*S-o*M)*O,e[6]=(v*I-g*T+y*w)*O,e[7]=(g*h-d*I-y*x)*O,e[8]=(d*T-v*h+y*b)*O,e):null}function w(e,t,r){var n=t[0],a=t[1],o=t[2],i=r[3]*n+r[7]*a+r[11]*o+r[15]||1;return e[0]=(r[0]*n+r[4]*a+r[8]*o+r[12])/i,e[1]=(r[1]*n+r[5]*a+r[9]*o+r[13])/i,e[2]=(r[2]*n+r[6]*a+r[10]*o+r[14])/i,e}function T(e,t,r,n,a,o){var i;t||(t=3),r||(r=0),i=n?Math.min(n*t+r,e.length):e.length;for(var s=A,l=r;i>l;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],a(s,s,o),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}var I=i.mat4d,M=i.mat3d,B=i.vec3d,E=l.assert;t.fetch=d,t.computeBoundingBox=v,t.createStageResources=g;var A=B.create()});