// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/_base/lang","dojo/when","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./SignedDistanceFunctions","./FastSymbolUpdates","../../../../core/urlUtils","../../../../core/screenUtils","../../../../config","../../../../Color","../../../../geometry/Polygon","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial"],function(e,t,i,r,a,o,n,s,l,u,c,h,p,_,d,f,g,m,y,v,R,S,x,I,b){function E(e){return"cross"===e||"x"===e}function O(e){var t,i=F,r=i*N;switch("primitive:"===e.substring(0,10)&&(e=e.substring(10)),e){case j.PRIM_CIRCLE:t=c.computeSignedDistancefieldCicle(i,r);break;case j.PRIM_SQUARE:t=c.computeSignedDistancefieldSquare(i,r,!1);break;case j.PRIM_KITE:t=c.computeSignedDistancefieldSquare(i,r,!0);break;case j.PRIM_CROSS:t=c.computeSignedDistancefieldCrossAndX(i,r,!1);break;case j.PRIM_X:t=c.computeSignedDistancefieldCrossAndX(i,r,!0)}return new I(t,"sdf_"+e,{mipmap:!1,wrapClamp:!0,width:F,height:F,components:4})}var M=y.vec3d,T=y.vec4d,z=y.mat4d,U=z.identity(),D=[0,0,1],P=[0,0,0,0],A=[0,0,0],C=[1,1,1],V=["center","bottom","top","left","right","bottom-left","bottom-right","top-left","top-right"],G="circle",w=16,L=1.5,F=128,N=.5,j={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"},H=[F*N,F*N],q=function(e){function t(){e.apply(this,arguments)}return i(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=null!=e.size?_.pt2px(e.size):w;this._size=null,this._symbolTextureRatio=1,this._primitive=null;var i=this._getStageIdHint();this._isPropertyDriven("size")&&64>t&&(t=64);var r=e.resource||{primitive:G,href:void 0},a={anchorPos:this._getAnchorPos(e)};if(r.href)a.color=this._getFillColor(e,null),a.outlineColor=this._getOutlineColor(e),a.outlineSize=this._getOutlineSize(e,null),a.textureIsSignedDistanceField=!1,this._prepareImageResources(r.href,t,a,i);else{var o=r.primitive||G,n="primitive:"+o;if(this._primitive=o,a.color=this._getFillColor(e,o),a.outlineColor=this._getOutlineColor(e),a.outlineSize=this._getOutlineSize(e,o),E(o)&&0===a.outlineSize)return void this.reject();this.texture=this._context.sharedResources.textures.acquire(n,O),this._textureURI=n,a.textureIsSignedDistanceField=!0,a.textureId=this.texture.getId(),this._size=[t,t],this._symbolTextureRatio=1/N,this._createMaterialsAndAddToStage(a,this._context.stage,i),this.resolve()}},t.prototype._getOutlineDefaultSize=function(e){return E(e)?L:0},t.prototype._getOutlineSize=function(e,t){return e.outline&&null!=e.outline.size?_.pt2px(e.outline.size):this._getOutlineDefaultSize(t)},t.prototype._getOutlineColor=function(e){var t=this._getLayerOpacity();if(e.outline){if(null!=e.outline.color){var i=f.toUnitRGB(e.outline.color),r=e.outline.color.a*t;return[i[0],i[1],i[2],r]}return[0,0,0,t]}return[0,0,0,t]},t.prototype._getFillColor=function(e,t){return E(t)?P:this._getMaterialOpacityAndColor()},t.prototype._getAnchorPos=function(e){return V.indexOf(e.anchor)>-1?e.anchor:"center"},t.prototype._prepareImageResources=function(e,t,i,r){var o=this,n=function(e){if(!o.isRejected()){var a=e.params,n=a.width/a.height;t?n>1?o._size=[t,t/n]:o._size=[t*n,t]:o._size=[a.width,a.height],i.textureId=e.getId(),o._createMaterialsAndAddToStage(i,o._context.stage,r),o.resolve()}},s="data:image/svg"===e.substring(0,14),l=".svg"===e.substring(e.length-4,e.length),u=s||l;if(u){var c=e;c=p.normalize(c);var h=new Image,_=!s&&p.hasSameOrigin(c,window.location.href);s?h.src=c:_||p.canUseXhr(c)?(_||(h.crossOrigin="anonymous"),h.src=c):(d.request.proxyUrl&&(c=d.request.proxyUrl+"?"+c),h.src=c),h.onerror=function(){o.reject()},h.onload=function(){var e=h.width,i=h.height,r=1;e&&i&&(r=e/i),null!=t&&(r>1?(e=t,i=Math.round(t/r)):(i=t,e=Math.round(t*r)));var s=document.createElement("canvas");s.width=e,s.height=i;var l=s.getContext("2d");l.drawImage(h,0,0,e,i);var u=s.toDataURL();a(o._context.sharedResources.textures.acquire(u),n,function(){o.reject()}),o._textureURI=u},h.onerror=function(){console.warn("Failed to create Icon primitive"),o.reject()}}else a(this._context.sharedResources.textures.acquire(e),n,function(){o.reject()}),this._textureURI=e},t.prototype._createMaterialsAndAddToStage=function(e,t,i){this._fastUpdates=h.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&r.mixin(e,this._fastUpdates.materialParameters);var a=r.clone(e);a.occlusionTest=!1,a.shaderPolygonOffset=0,this._drapedMaterial=new b(a,i+"_iconDraped"),t.add(v.ModelContentType.MATERIAL,this._drapedMaterial),e.occlusionTest=!0,this._material=new b(e,i+"_icon"),t.add(v.ModelContentType.MATERIAL,this._material)},t.prototype.destroy=function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(v.ModelContentType.MATERIAL,this._material.getId()),this._material=null),this._drapedMaterial&&(this._context.stage.remove(v.ModelContentType.MATERIAL,this._drapedMaterial.getId()),this._drapedMaterial=null),this._textureURI&&(this._context.sharedResources.textures.release(this._textureURI),this._textureURI=null)},t.prototype._getGeometry=function(e){var t=e.geometry;return"extent"===t.type?u.placePointOnPolygon(g.fromExtent(t)):"polyline"===t.type?u.placePointOnPolyline(t):"polygon"===t.type?u.placePointOnPolygon(t):"point"===t.type?t:(this._logWarning("unsupported geometry type for icon symbol: "+t.type),null)},t.prototype._getScaleFactor=function(e){if(!this._isPropertyDriven("size"))return 1;if(e.size){for(var t=0;3>t;t++)e.size[t]&&"symbolValue"!==e.size[0]&&(e.size[t]=_.pt2px(e.size[t]));var i=this._size[0]>this._size[1]?this._size[0]:this._size[1];if("symbolValue"===e.size[0])return 1;if(isFinite(e.size[0]))return e.size[0]/i;if(isFinite(e.size[2]))return e.size[2]/i}},t.prototype.createGraphics3DGraphic=function(e,t){var i=this._getGeometry(e);if(null===i)return null;var r="graphic"+e.uid,a=this._getVertexOpacityAndColor(t),o=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(o=this._getScaleFactor(t)),o*=this._symbolTextureRatio;var n=[this._size[0]*o,this._size[1]*o],s=this._getGraphicElevationInfo(e);return s.mode===u.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(e,i,a,n,s,r,e.uid):this._createAs3DShape(e,i,a,n,s,r,e.uid)},t.prototype.layerPropertyChanged=function(e,t,i){if("opacity"===e){var r=this._getFillColor(this.symbol,this._primitive);this._drapedMaterial.setParameterValues({color:r}),this._material.setParameterValues({color:r});var a=this._getOutlineColor(this.symbol);return this._drapedMaterial.setParameterValues({outlineColor:a}),this._material.setParameterValues({outlineColor:a}),!0}if("elevationInfo"===e){var o=this._elevationInfo.mode;this._updateElevationInfo();var s=this._elevationInfo.mode,c=u.ELEV_MODES;if(o===c.ON_THE_GROUND&&s===c.ON_THE_GROUND)return!0;if(o!==s&&(o===c.ON_THE_GROUND||s===c.ON_THE_GROUND))return!1;var h=this._context.elevationProvider,p=this._context.renderCoordsHelper,_=l.perObjectElevationAligner;for(var d in t){var f=t[d],g=f._graphics[i];if(g&&g instanceof n){var m=f.graphic,y=this._getGraphicElevationInfo(m);g.elevationAligner=s===c.RELATIVE_TO_GROUND?_:null,g.elevationInfo.set(y),_(g,h,p)}}return!0}return!1},t.prototype.applyRendererDiff=function(e,t,i,r){for(var a in e.diff)switch(a){case"visualVariables":if(!h.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters),this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},t.prototype.setDrawOrder=function(e,t,i){this._drapedMaterial&&(this._drapedMaterial.setRenderPriority(e),i[this._drapedMaterial.getId()]=!0)},t.prototype._defaultElevationInfoNoZ=function(){return k},t.prototype._getGraphicElevationInfo=function(t){var i=e.prototype._getGraphicElevationInfo.call(this,t);return i.mode!==u.ELEV_MODES.RELATIVE_TO_GROUND||0!==i.offset||t.geometry.get("hasZ")||(i.offset=1/this._context.renderCoordsHelper.unitInMeters),i},t.prototype._createAs3DShape=function(e,t,i,r,a,o,s){var c=this,p=this._getFastUpdateAttrValues(e),_=p?function(e){return h.evaluateModelTransform(c._fastUpdates.materialParameters,p,e)}:null,d=S.createPointGeometry(D,null,i,r,null,X,null,p),f=new R(d,o),g=[f],m=this._context.layer.id,y=u.createStageObjectForPoint.call(this,t,g,[[this._material]],null,null,a,o,m,s,!0,_);if(null===y)return null;var v=null;a.mode===u.ELEV_MODES.RELATIVE_TO_GROUND?v=l.perObjectElevationAligner:a.mode===u.ELEV_MODES.ABSOLUTE_HEIGHT&&(v=l.perObjectVerticalDistanceToGroundAligner);var x=new n(this,y,g,null,null,v,a);if(this._fastUpdates.enabled){var I=r[0]/this._symbolTextureRatio,b=r[1]/this._symbolTextureRatio;x.getScreenSize=function(){var e=_(U);return[e[0]*I,e[5]*b]}}else{var E=r[0]/this._symbolTextureRatio,O=r[1]/this._symbolTextureRatio;x.getScreenSize=function(){return[E,O]}}return u.extendPointGraphicElevationInfo(x,t,this._context.elevationProvider),x},t.prototype._createAsOverlay=function(e,t,i,r,a,o,n){var l=this;this._drapedMaterial.setRenderPriority(this._symbolLayerOrder);var c=M.create();m.pointToVector(t,c,this._context.overlaySR),c[2]=this._getDrapedZ();var p=this._context.clippingExtent;if(p&&!u.pointInBox2D(c,p))return null;var _=this._getFastUpdateAttrValues(e),d=_?function(e){return h.evaluateModelTransform(l._fastUpdates.materialParameters,_,e)}:null,f=S.createPointGeometry(D,c,i,r,!0,null,null,_),g=new x(f);g.material=this._drapedMaterial,g.center=c,g.bsRadius=0,g.transformation=U,g.name=o,g.uniqueName=o+"#"+f.id;var y=new s(this,[g],null,null,null);if(this._fastUpdates.enabled){var v=r[0]/this._symbolTextureRatio,R=r[1]/this._symbolTextureRatio;y.getScreenSize=function(){var e=d(U);return[e[0]*v,e[5]*R]}}else{var I=r[0]/this._symbolTextureRatio,b=r[1]/this._symbolTextureRatio;y.getScreenSize=function(){return[I,b]}}return y},t.prototype._supportsShaderVisualVariables=function(){return!0},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=[e,e,e];return{modelSize:t,unitInMeters:_.px2pt(1),transformation:{anchor:A,scale:C}}},t.PRIMITIVE_SIZE=H,t.VALID_ANCHOR_STRINGS=V,t}(o),k={mode:u.ELEV_MODES.RELATIVE_TO_GROUND,offset:0},X=T.createFrom(0,0,0,1);return q});