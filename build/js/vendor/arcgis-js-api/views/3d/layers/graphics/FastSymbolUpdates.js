// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../lib/glMatrix"],function(e,a,i){function n(e){return null!==e&&void 0!==e}function t(e){return"number"==typeof e}function l(e){return"string"==typeof e}function o(e,a){e&&e.push(a),s(a)}function r(e){b&&console.warn("[FastSymbolUpdates] "+e)}function s(e){b&&console.info("[FastSymbolUpdates] "+e)}function u(e,a,i,l){var r=e.minSize,s=e.maxSize;if(e.expression)return o(l,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue)return o(l,"Could not convert size info: useSymbolValue not supported"),!1;if(n(e.field))return n(e.stops)?2===e.stops.length&&t(e.stops[0].size)&&t(e.stops[1].size)?(a.minSize[i]=e.stops[0].size,a.maxSize[i]=e.stops[1].size,a.minDataValue[i]=e.stops[0].value,a.maxDataValue[i]=e.stops[1].value,a.type[i]=1,!0):(o(l,"Could not convert size info: stops only supported with 2 elements"),!1):t(r)&&t(s)&&n(e.minDataValue)&&n(e.maxDataValue)?(a.minSize[i]=r,a.maxSize[i]=s,a.minDataValue[i]=e.minDataValue,a.maxDataValue[i]=e.maxDataValue,a.type[i]=1,!0):"unknown"===e.valueUnit?(o(l,"Could not convert size info: proportional size not supported"),!1):(o(l,"Could not convert size info: scale-dependent size not supported"),!1);if(!n(e.field)){if(e.stops&&e.stops[0]&&t(e.stops[0].size))return a.minSize[i]=e.stops[0].size,a.maxSize[i]=e.stops[0].size,a.minDataValue[i]=0,a.maxDataValue[i]=1,a.type[i]=1,!0;if(t(r))return a.minSize[i]=r,a.maxSize[i]=r,a.minDataValue[i]=0,a.maxDataValue[i]=1,a.type[i]=1,!0}return o(l,"Could not convert size info: unsupported variant of sizeInfo"),!1}function v(e,a,i){if(e.normalizationField||e.valueRepresentation)return o(i,"Could not convert size info: unsupported property"),null;a.size||(a.size={minSize:[0,0,0],maxSize:[0,0,0],minDataValue:[0,0,0],maxDataValue:[0,0,0],type:[0,0,0]});var n;switch(e.axis){case"width":return n=u(e,a.size,0,i),n?a:null;case"height":return n=u(e,a.size,2,i),n?a:null;case"depth":return n=u(e,a.size,1,i),n?a:null;case"width-and-height":return n=u(e,a.size,0,i),n&&u(e,a.size,2,i),n?a:null;case null:case void 0:case"all":return n=u(e,a.size,0,i),n=n&&u(e,a.size,1,i),n=n&&u(e,a.size,2,i),n?a:null;default:return o(i,'Could not convert size info: unknown axis "'+e.axis+'""'),null}}function d(e,a,i){for(var n=0;3>n;++n)1===e.type[n]&&(e.minSize[n]=e.minSize[n]/a.modelSize[n],e.maxSize[n]=e.maxSize[n]/a.modelSize[n],e.type[n]=2),e.minSize[n]=e.minSize[n]/a.unitInMeters,e.maxSize[n]=e.maxSize[n]/a.unitInMeters;var t;if(0!==e.type[0])t=0;else if(0!==e.type[1])t=1;else{if(0===e.type[2])return o(i,"No size axis contains a valid size or scale"),!1;t=2}for(var n=0;3>n;++n)0===e.type[n]&&(e.minSize[n]=e.minSize[t],e.maxSize[n]=e.maxSize[t],e.minDataValue[n]=e.minDataValue[t],e.maxDataValue[n]=e.maxDataValue[t],e.type[n]=e.type[t]);return!0}function c(e,a,i){e[4*a+0]=i.r/255,e[4*a+1]=i.g/255,e[4*a+2]=i.b/255,e[4*a+3]=i.a}function f(e,a,i){if(e.normalizationField)return o(i,"Could not convert color info: unsupported property"),null;if(e.stops){if(e.stops.length>8)return o(i,"Could not convert color info: too many color stops"),null;a.color={values:[],colors:[]};for(var t=e.stops,l=0;8>l;++l){var r=Math.min(l,t.length-1),s=t[r];a.color.values[l]=s.value,c(a.color.colors,l,s.color)}}else{if(!e.colors)return o(i,"Could not convert color info: missing stops or colors"),null;if(!n(e.minDataValue)||!n(e.maxDataValue))return o(i,"Could not convert color info: missing data values"),null;if(2!==e.colors.length)return o(i,"Could not convert color info: invalid colors array"),null;a.color={values:[],colors:[]},a.color.values[0]=e.minDataValue,c(a.color.colors,0,e.colors[0]),a.color.values[1]=e.maxDataValue,c(a.color.colors,1,e.colors[1]);for(var l=2;8>l;++l)a.color.values[l]=e.maxDataValue,c(a.color.colors,l,e.colors[1])}return a}function z(e,a,i){if(!e)return null;b&&(i=i||[]);var n=e.reduce(function(e,a){if(!e)return e;if(a.valueExpression)return o(i,"Could not convert visual variables: arcade expressions not supported"),null;var n=a.field;if(e.field){if(n&&n!==e.field)return o(i,"Could not convert visual variables: multiple fields in use"),null}else if(n){if(!l(n))return o(i,"Could not convert visual variables: field is not a string"),null;e.field=n}switch(a.type){case"size":return v(a,e,i);case"color":return f(a,e,i);default:return o(i,"Could not convert visual variables: unsupported type "+a.type),null}},{field:null,size:null,color:null});return n&&n.size&&!d(n.size,a,i)?null:n}function p(e){return e&&null!==e.size}function m(e,a,i){if(x)return r("State not initialized, fast updates disabled (globally disabled)"),{enabled:!1};if(!a)return r("State not initialized, fast updates disabled (no shader support)"),{enabled:!1};if(!e)return r("State not initialized, fast updates disabled (no renderer)"),{enabled:!1};var n=z(e.visualVariables,i);return n?(s("State initialized, fast updates enabled"),{enabled:!0,visualVariables:n,materialParameters:V(n,i),customTransformation:p(n)}):(r("State not initialized, fast updates disabled (conversion failed)"),{enabled:!1})}function S(e,a,i){if(!a||!e.enabled)return!1;var n=e.visualVariables,t=z(a.visualVariables,i);return t?!!n.size!=!!t.size?(r("State update failed (size enabled/disabled)"),!1):!!n.color!=!!t.color?(r("State update failed (color enabled/disabled)"),!1):n.field!==t.field?(r("State update failed (field changed)"),!1):(e.visualVariables=t,e.materialParameters=V(t,i),e.customTransformation=p(t),s("State updated"),!0):(r("State update failed (conversion failed)"),!1)}function V(e,a){var i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeMinDataValue:null,vvSizeMaxDataValue:null,vvSizeValue:null,vvAnchorValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null},n=p(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeMinDataValue=e.size.minDataValue,i.vvSizeMaxDataValue=e.size.maxDataValue):e&&n&&(i.vvSizeValue=a.transformation.scale),e&&n&&(i.vvAnchorValue=a.transformation.anchor),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),i}var b=!1,x=!1;a.convertVisualVariables=z,a.initFastSymbolUpdatesState=m,a.updateFastSymbolUpdatesState=S,a.getMaterialParams=V;var y;!function(e){function a(e,a,i){return a>e?a:e>i?i:e}function n(e,i,n){var l=e.vvSizeEnabled;if(!l)return n;if(t.identity(o),e.vvSizeEnabled){for(var s=0;3>s;++s){var u=(i[0]-e.vvSizeMinDataValue[s])/(e.vvSizeMaxDataValue[s]-e.vvSizeMinDataValue[s]);r[s]=e.vvSizeMinSize[s]+a(u,0,1)*(e.vvSizeMaxSize[s]-e.vvSizeMinSize[s])}t.scale(o,r,o)}else t.scale(o,e.vvSizeValue,o);return t.translate(o,e.vvAnchorValue,o),t.multiply(n,o,o),o}var t=i.mat4d,l=i.vec3,o=t.create(),r=l.create();e.evaluateModelTransform=n}(y||(y={})),a.evaluateModelTransform=y.evaluateModelTransform});