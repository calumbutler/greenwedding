// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./Renderer","./Camera","./Util","./gl-matrix","../materials/internal/TexOnlyGLMaterial","../../../webgl/Texture","../../../webgl/FramebufferObject","../../../webgl/VertexArrayObject","../../../webgl/BufferObject","../../../webgl/Util","../../../webgl/enums","./DefaultVertexBufferLayouts","./DefaultVertexAttributeLocations"],function(e,t,r,i,a,n,s,o,d,h,u,l,c,_,p){var f=n.vec3d,x=n.vec4d,g=n.mat4d,y=function(){function e(e,t,i,a,n,s){this._acquiredTextures={},this._clearColor=x.createFrom(0,0,0,0),this._id2origin={},this._rctx=e,this._canvas=t,this._programRep=i,this._materialRep=a,this._textureRep=n,this._modelDirtySet=s,this._renderer=new r(i,a,n,this._rctx,!0),this._renderer.setLightingData({ambient:[1,1,1,1],diffuse:[0,0,0,0],specular:[0,0,0,0],direction:[0,-1,0]})}return e.prototype.dispose=function(){for(var e in this._acquiredTextures)this._acquiredTextures[e].fbo.dispose(),this._textureRep.release(e);this._acquiredTextures=null,this._renderer.dispose(),this._renderer=null},e.prototype.addRenderGeometries=function(e){var t=this;e.forEach(function(e){null==e.origin&&(e.origin=t.getOrigin(e.center,e.bsRadius))}),this._renderer.modify(e,[])},e.prototype.removeRenderGeometries=function(e){this._renderer.modify([],e)},e.prototype.updateRenderGeometries=function(e,t){var r=e.map(function(e){return{renderGeometry:e,updateType:t}});this._renderer.modify([],[],r,{})},e.prototype.updateRenderOrder=function(e){Object.keys(e).length>0&&this._renderer.modifyRenderOrder(e)},e.prototype.setBackgroundColor=function(e){this._clearColor=e},e.prototype.isEmpty=function(){return this._renderer.isEmpty()},e.prototype.processDirtyMaterials=function(){var e=this._modelDirtySet.getDirtyMaterials();e&&this._renderer.modify([],[],[],e),this._modelDirtySet.clearDirtyMaterials()},e.prototype.draw=function(e,t){this.processDirtyMaterials();var r,i=e.id.toString(),a=this._rctx,n=a.gl;if(this._acquiredTextures[i])r=this._acquiredTextures[i].fbo;else{var s=this._textureRep.aquire(i).getGLTexture();r=d.createWithAttachments(this._rctx,s,{colorTarget:0,depthStencilTarget:0});var o=Object.keys(this._acquiredTextures).length;this._acquiredTextures[i]={texture:e,fbo:r,idx:o}}var h=t.width,u=t.height;(r.width!==h||r.height!==u)&&(r.resize(h,u),r.colorTexture.setSamplingMode(9729)),b.near=1,b.far=1e4,a.bindFramebuffer(r),a.setDepthTestEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),a.setClearColor.apply(a,this._clearColor),a.clear(n.COLOR_BUFFER_BIT),this._renderer.setPixelRatio(t.pixelRatio||1);for(var l=0;l<t.views.length;l++){var c=t.views[l];b.viewport=c.viewport,g.ortho(0,c.extent[2]-c.extent[0],0,c.extent[3]-c.extent[1],b.near,b.far,b.projectionMatrix),g.identity(b.viewMatrix),g.translate(b.viewMatrix,[-c.extent[0],-c.extent[1],0]),b.setGLViewport(this._rctx),m&&this._drawTestTexture(h,u,v[this._acquiredTextures[i].idx%v.length]),this._renderer.render(b,w)}a.setDepthTestEnabled(!0),a.setBlendFunctionSeparate(770,771,1,771),a.bindFramebuffer(null),a.setViewport(0,0,this._canvas.width,this._canvas.height)},e.prototype._drawTestTexture=function(e,t,r){var i=this._rctx,a=i.gl;if(!this._testPatternMat){for(var n=new Uint8Array(e*t*4),d=0,c=0;t>c;c++)for(var f=0;e>f;f++){var x=Math.floor(f/10),y=Math.floor(c/10);2>x||2>y||10*x>e-20||10*y>t-20?(n[d++]=255,n[d++]=255,n[d++]=255,n[d++]=255):(n[d++]=255,n[d++]=255,n[d++]=255,1&x&&1&y?n[d++]=1&f^1&c?0:255:n[d++]=1&x^1&y?0:128)}var m=new o(i,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},n);this._testPatternMat=new s(this._programRep,m,[1,1,1,1],!0,a.ALWAYS),this._testPatternBindParams={proj:g.identity(),view:g.identity(),nearFar:[-1,1],origin:[0,0,0]};var v=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,-1,1,0,0,1,1,1,0,1,1]);this._quadVAO=new h(i,p.Default3D,{geometry:_.Pos3Tex},{geometry:u.createVertex(i,35044,v)})}this._testPatternMat.setColor([r[0],r[1],r[2],1]),this._testPatternMat.bind(i,this._testPatternBindParams),this._testPatternMat.bindView(i,this._testPatternBindParams),i.bindVAO(this._quadVAO),i.drawArrays(5,0,l.vertexCount(this._quadVAO,"geometry")),this._testPatternMat.release(i)},e.prototype.getOrigin=function(e,t){var r=1e4,i=10,n=0,s=t*i/r;s>1&&(n=Math.ceil(a.logWithBase(s,2)));var o=Math.pow(2,n)*r,d=Math.round(e[0]/o),h=Math.round(e[1]/o),u=Math.round(e[2]/o),l=n+"_"+d+"_"+h+"_"+u,c=this._id2origin[l];return null==c&&(c={vec3:f.createFrom(d*o,h*o,u*o),id:l},this._id2origin[l]=c),c},e}(),m=!1,v=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],w={get:function(){return!0}},b=new i;return y});