// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["./gl-matrix"],function(t){function r(t){this.message=t}for(var a=t.vec2d,n=t.vec3d,e=t.vec4d,o=t.mat4d,i=o.create(),c=[e.createFrom(-1,-1,-1,1),e.createFrom(1,-1,-1,1),e.createFrom(1,1,-1,1),e.createFrom(-1,1,-1,1),e.createFrom(-1,-1,1,1),e.createFrom(1,-1,1,1),e.createFrom(1,1,1,1),e.createFrom(-1,1,1,1)],u=e.create(),f=new Array(8),s=0;8>s;++s)f[s]=n.create();var h=n.create(),l=n.create(),v=n.create(),M=n.create(),d=n.create(),p=n.create(),m=n.create(),g=n.create(),E=n.create(),w=n.create(),y=n.create(),I=n.create(),T=n.create(),b=n.create();r.prototype.toString=function(){return"AssertException: "+this.message};var x={EARTH_RADIUS:6378137,METER2FEET:3.28084,ECCENTRICITY_SQUARED:.0066943799901414,AssertException:r,VertexAttrConstants:{POSITION:"position",NORMAL:"normal",UV0:"uv0",AUXPOS1:"auxpos1",AUXPOS2:"auxpos2",COLOR:"color",SIZE:"size",REGION:"region"},assert:function(t,a){if(!t){var n=new Error("dummy");throw n.stack&&console.log(n.stack),new r(a)}},verify:function(t,r){t||(console.log("Verify failed: "+r),console.log(new Error("dummy").stack))},createQuadVertexUvBuffer:function(t){t=t||Float32Array;var r=new t(20);return r[0]=-1,r[1]=-1,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=-1,r[7]=0,r[8]=1,r[9]=0,r[10]=-1,r[11]=1,r[12]=0,r[13]=0,r[14]=1,r[15]=1,r[16]=1,r[17]=0,r[18]=1,r[19]=1,r},isPowerOfTwo:function(t){return 0===(t&t-1)},lerp:function(t,r,a){return t+(r-t)*a},clamp:function(t,r,a){return r>t?r:t>a?a:t},fallbackIfUndefined:function(t,r){return void 0===t?r:t},hex2rgb:function(t){t=Math.floor(t);var r=(t>>16&255)/255,a=(t>>8&255)/255,n=(255&t)/255;return[r,a,n]},rgb2hex:function(t){var r=x.clamp(Math.round(255*t[0]),0,255),a=x.clamp(Math.round(255*t[1]),0,255),n=x.clamp(Math.round(255*t[2]),0,255);return"0x"+((r<<16)+(a<<8)+n).toString(16)},dec2hex:function(t){var r=t.toString(16);return"00000000".substr(0,8-r.length)+r},deg2rad:function(t){return t/180*Math.PI},rad2deg:function(t){return 180*t/Math.PI},azimuthElevationAngle2Direction:function(t,r){var a=1.5*Math.PI-t,n=.5*Math.PI-r,e=Math.cos(a)*Math.sin(n),o=Math.cos(n),i=Math.sin(a)*Math.sin(n);return[e,o,i]},rayPlane:function(t,r,a,e){var o=n.dot(a,r);if(0===o)return!1;var i=-(n.dot(a,t)+a[3])/o;return n.add(t,n.scale(r,i,e),e),!0},raySphereClosestPositive:function(t,r,a,e){var o=n.dot(r,r),i=2*n.dot(r,t),c=n.dot(t,t)-a*a,u=i*i-4*o*c;if(0>u)return!1;var f=Math.sqrt(u),s=(-i-f)/(2*o),h=(-i+f)/(2*o);return(0>s||s>h&&h>0)&&(s=h),s>0?(n.add(t,n.scale(r,s,e),e),!0):!1},rayTriangle3D:function(t,r,a,e,o,i,c,u,f){var s=1e-5;f||(f=n.create());var h=e[c]-a[i],l=e[c+1]-a[i+1],v=e[c+2]-a[i+2],M=o[u]-a[i],d=o[u+1]-a[i+1],p=o[u+2]-a[i+2],m=r[1]*p-d*r[2],g=r[2]*M-p*r[0],E=r[0]*d-M*r[1],w=h*m+l*g+v*E;if(w>-s&&s>w)return!1;var y=1/w,I=t[0]-a[i],T=t[1]-a[i+1],b=t[2]-a[i+2];if(f[1]=y*(I*m+T*g+b*E),f[1]<0||f[1]>1)return!1;var x=T*v-l*b,C=b*h-v*I,R=I*l-h*T;return f[2]=y*(r[0]*x+r[1]*C+r[2]*R),f[2]<0||f[1]+f[2]>1?!1:(f[0]=y*(M*x+d*C+p*R),!0)},rayBoxTest:function(t,r,a,n){var e,o=(a[0]-t[0])/r[0],i=(n[0]-t[0])/r[0];o>i&&(e=o,o=i,i=e);var c=(a[1]-t[1])/r[1],u=(n[1]-t[1])/r[1];if(c>u&&(e=c,c=u,u=e),o>u||c>i)return!1;c>o&&(o=c),i>u&&(i=u);var f=(a[2]-t[2])/r[2],s=(n[2]-t[2])/r[2];return f>s&&(e=f,f=s,s=e),o>s||f>i?!1:(i>s&&(i=s),0>i?!1:!0)},rayRay2D:function(t,r,n,e,o,i){i||(i=a.create());var c=(e[o]-n[o])*(r[0]-t[0])-(e[0]-n[0])*(r[o]-t[o]),u=(e[0]-n[0])*(t[o]-n[o])-(e[o]-n[o])*(t[0]-n[0]);if(0===c)return!1;var f=u/c;return i[0]=t[0]+f*(r[0]-t[0]),i[1]=t[o]+f*(r[o]-t[o]),!0},matrix2frustum:function(t,r,a){o.multiply(r,t,i),o.inverse(i);for(var e=0;8>e;++e)o.multiplyVec4(i,c[e],u),n.set3(u[0]/u[3],u[1]/u[3],u[2]/u[3],a[e])},matrix2frustumPlanes:function(t,r,a,n){void 0===n&&(n=a,a=f),x.matrix2frustum(t,r,a),x.point2plane(a[4],a[0],a[3],n[0]),x.point2plane(a[1],a[5],a[6],n[1]),x.point2plane(a[4],a[5],a[1],n[2]),x.point2plane(a[3],a[2],a[6],n[3]),x.point2plane(a[0],a[1],a[2],n[4]),x.point2plane(a[5],a[4],a[7],n[5])},point2plane:function(t,r,a,e){n.subtract(t,r,h),n.subtract(a,r,l),n.cross(l,h,e),n.normalize(e),e[3]=-n.dot(e,t)},project:function(t,r,a,n,e){e||(e=t),u[0]=t[0],u[1]=t[1],u[2]=t[2],u[3]=1,o.multiplyVec4(r,u),e.length>2&&(e[2]=-u[2]),o.multiplyVec4(a,u),x.assert(0!==u[3]),e[0]=u[0]/u[3],e[1]=u[1]/u[3],e[2]=u[2]/u[3],e[0]=(.5*e[0]+.5)*n[2]+n[0],e[1]=(.5*e[1]+.5)*n[3]+n[1]},geodeticToGeocentricLatidude:function(t){return Math.atan((1-x.ECCENTRICITY_SQUARED)*Math.tan(t))},latLon2positionWGS84Ellipsoid:function(t,r,a,n){var e=6378137,o=e/Math.sqrt(1-x.ECCENTRICITY_SQUARED*Math.pow(Math.sin(t),2)),i=Math.cos(t);n[0]=(o+a)*Math.cos(r)*i,n[1]=(o*(1-x.ECCENTRICITY_SQUARED)+a)*Math.sin(t),n[2]=-(o+a)*Math.sin(r)*i},pos2latLon:function(t,r){var a=n.length(t);r[0]=Math.asin(x.clamp(t[1]/a,-1,1));var e=Math.cos(r[0]);r[1]=(t[2]<0?1:-1)*Math.acos(x.clamp(t[0]/(e*a),-1,1)),r[0]=x.rad2deg(r[0]),r[1]=x.rad2deg(r[1]),r[2]=a},pos2latLonWGS84Ellipsoid:function(t,r){var a=6378137,n=t[0],e=-t[2],o=t[1],i=Math.sqrt(Math.pow(a,2)*(1-x.ECCENTRICITY_SQUARED)),c=Math.sqrt((Math.pow(a,2)-Math.pow(i,2))/Math.pow(i,2)),u=Math.sqrt(Math.pow(n,2)+Math.pow(e,2)),f=Math.atan2(a*o,i*u),s=Math.atan2(e,n),h=Math.atan2(o+Math.pow(c,2)*i*Math.pow(Math.sin(f),3),u-x.ECCENTRICITY_SQUARED*a*Math.pow(Math.cos(f),3)),l=a/Math.sqrt(1-x.ECCENTRICITY_SQUARED*Math.pow(Math.sin(h),2)),v=u/Math.cos(h)-l+x.EARTH_RADIUS;r[0]=h,r[1]=s,r[2]=v},computeGlobeTransformation:function(t,r,a){var n=x.deg2rad(t[0]),e=x.deg2rad(t[1]);return x.latLon2position(n,e,v,r),o.translate(a,v),o.rotateY(a,.5*Math.PI+e),o.rotateX(a,.5*Math.PI-n),a},readUInt16:function(t,r){var a=t[r],n=t[r+1];return a+(n<<8)},readUInt32:function(t,r){var a=t[r],n=t[r+1],e=t[r+2],o=t[r+3];return a+(n<<8)+(e<<16)+(o<<24)},setIfDefined:function(t,r,a){void 0!==r[t]&&(a[t]=r[t])},array2object:function(t,r){var a,n,e={};if(void 0!==r)for(a=0,n=t.length;n>a;++a)e[r(t[a])]=t[a];else for(a=0,n=t.length;n>a;++a)e[t[a]]=t[a];return e},object2array:function(t){var r=[];for(var a in t)r.push(t[a]);return r},mergeObjects:function(t,r,a){void 0===a&&(a={});var n;if(a!==t)for(n in t)a[n]=t[n];if(a!==r)for(n in r)a[n]=r[n];return a},subtractObjects:function(t,r){var a={};for(var n in t)void 0===r[n]&&(a[n]=t[n]);return a},intersectObjects:function(t,r){var a={};for(var n in t)void 0!==r[n]&&(a[n]=t[n]);return a},getFirstObjectKey:function(t){for(var r in t)return r},getFirstObjectValue:function(t){return t[x.getFirstObjectKey(t)]},objectEmpty:function(t){for(var r in t)return!1;return!0},arraysEqual:function(t,r){if(t.length!==r.length)return!1;for(var a=0,n=t.length;n>a;++a)if(t[a]!==r[a])return!1;return!0},arrayRemove:function(t,r){var a=t.indexOf(r);return-1!==a?(t[a]=t[t.length-1],t.pop(),r):null},byteBuffer2base64image:function(t,r,a,n,e){var o=4*r;x.assert(t.length===o*a,"buffer length must match image resolution");var i=document.createElement("canvas");i.width=r,i.height=a;for(var c=i.getContext("2d"),u=c.getImageData(0,0,r,a),f=u.data,s=0;a>s;++s)for(var h=s*o,l=(a-1-s)*o,v=0;o>v;++v)f[h++]=t[l++];return c.putImageData(u,0,0),i.toDataURL(n,e)},cround:function(t){return Math.round(100*t)/100},logWithBase:function(t,r){return Math.log(t)/Math.log(r)},setMatrixTranslation:function(t,r){t[12]=r[0],t[13]=r[1],t[14]=r[2]},setMatrixTranslation3:function(t,r,a,n){t[12]=r,t[13]=a,t[14]=n},getMatrixTranslation:function(t,r){return r=r||n.create(),r[0]=t[12],r[1]=t[13],r[2]=t[14],r},createTranslationMatrix:function(t,r){return t=o.identity(t),x.setMatrixTranslation(t,r),t},fovx2fovy:function(t,r,a){return 2*Math.atan(a*Math.tan(.5*t)/r)},fovy2fovx:function(t,r,a){return 2*Math.atan(r*Math.tan(.5*t)/a)},fovx2fovd:function(t,r,a){return 2*Math.atan(Math.sqrt(r*r+a*a)*Math.tan(.5*t)/r)},fovy2fovd:function(t,r,a){return 2*Math.atan(Math.sqrt(r*r+a*a)*Math.tan(.5*t)/a)},fovd2fovx:function(t,r,a){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(r*r+a*a))},fovd2fovy:function(t,r,a){return 2*Math.atan(a*Math.tan(.5*t)/Math.sqrt(r*r+a*a))},nextHighestPowerOfTwo:function(t){--t;for(var r=1;32>r;r<<=1)t|=t>>r;return t+1},linelineDistance3D:function(t,r,a,e){var o,i,c,u,f,s,h,l,v,E=1e-4,w=M,y=d;if(w[0]=t[0]-a[0],w[1]=t[1]-a[1],w[2]=t[2]-a[2],y[0]=e[0]-a[0],y[1]=e[1]-a[1],y[2]=e[2]-a[2],Math.abs(y.x)<E&&Math.abs(y.y)<E&&Math.abs(y.z)<E)return[!1];var I=p;if(I[0]=r[0]-t[0],I[1]=r[1]-t[1],I[2]=r[2]-t[2],Math.abs(I.x)<E&&Math.abs(I.y)<E&&Math.abs(I.z)<E)return[!1];if(c=w[0]*y[0]+w[1]*y[1]+w[2]*y[2],u=y[0]*I[0]+y[1]*I[1]+y[2]*I[2],f=w[0]*I[0]+w[1]*I[1]+w[2]*I[2],s=y[0]*y[0]+y[1]*y[1]+y[2]*y[2],h=I[0]*I[0]+I[1]*I[1]+I[2]*I[2],v=h*s-u*u,Math.abs(v)<E)return[!1];l=c*u-f*s,o=l/v,i=(c+u*o)/s;var T=m,b=g;T[0]=t[0]+o*I[0],T[1]=t[1]+o*I[1],T[2]=t[2]+o*I[2],b[0]=a[0]+i*y[0],b[1]=a[1]+i*y[1],b[2]=a[2]+i*y[2];var x=n.dist(T,b);return[!0,x,T,b]},projectVectorVector2D:function(t,r,a){var e=I,o=T,i=b,c=y,u=E,f=w;e[0]=r[0]-t[0],e[1]=r[1]-t[1],e[2]=0,o[0]=a[0]-t[0],o[1]=a[1]-t[1],o[2]=0,i[0]=a[0],i[1]=a[1],i[2]=0;var s=n.dot(o,e),h=n.length(e),l=h*h,v=s/l;c[0]=e[0]*v,c[1]=e[1]*v,u[0]=t[0]+c[0],u[1]=t[1]+c[1],n.subtract(i,u,f);var M=n.length(f),d=n.length(o),p=n.length(e),m=n.length(c);return(m>d||m>p)&&(M=Number.MAX_VALUE),M}};return x.performance=window.performance||{},x.performance.now=x.performance.now||x.performance.mozNow||x.performance.msNow||x.performance.oNow||x.performance.webkitNow||function(){return(new Date).getTime()},x});