// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["./GeometryData","./BufferVectorMath","./Util","./gl-matrix"],function(r,e,a,t){function n(r,e,a,t,n){return Math.abs(c.dot(e,r))>n?!1:(c.cross(r,e,a),c.normalize(a),c.cross(a,r,t),c.normalize(t),!0)}function o(r,e,a,t,o,i,s){return n(r,e,o,i,s)||n(r,a,o,i,s)||n(r,t,o,i,s)}function i(){var e,a,t=.5,n=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],o=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],i=[0,0,1,0,1,1,0,1],s=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],l=new Array(36);for(e=0;6>e;e++)for(a=0;6>a;a++)l[6*e+a]=e;var c=new Array(36);for(e=0;6>e;e++)c[6*e+0]=0,c[6*e+1]=1,c[6*e+2]=2,c[6*e+3]=2,c[6*e+4]=3,c[6*e+5]=0;return function(e){var a;Array.isArray(e)||(e=[e,e,e]);var t=new Float32Array(24);for(a=0;8>a;a++)t[3*a]=n[a][0]*e[0],t[3*a+1]=n[a][1]*e[1],t[3*a+2]=n[a][2]*e[2];var y={};y[v.POSITION]=new Uint8Array(s),y[v.NORMAL]=new Uint8Array(l),y[v.UV0]=new Uint8Array(c);var O={};O[v.POSITION]={size:3,data:t},O[v.NORMAL]={size:3,data:new Float32Array(o)},O[v.UV0]={size:2,data:new Float32Array(i)};var d=[{type:"triangle",indices:y,positionKey:v.POSITION}];return new r(d,O)}}function s(){var e=.5,a=[[-e,0,-e],[e,0,-e],[e,0,e],[-e,0,e],[0,-e,0],[0,e,0]],t=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],n=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],o=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];return function(e){var i;Array.isArray(e)||(e=[e,e,e]);var s=new Float32Array(18);for(i=0;6>i;i++)s[3*i]=a[i][0]*e[0],s[3*i+1]=a[i][1]*e[1],s[3*i+2]=a[i][2]*e[2];var l={};l[v.POSITION]=new Uint8Array(n),l[v.NORMAL]=new Uint8Array(o);var c={};c[v.POSITION]={size:3,data:s},c[v.NORMAL]={size:3,data:new Float32Array(t)};var y=[{type:"triangle",indices:l,positionKey:v.POSITION}];return new r(y,c)}}function l(){var e=.5,a=0,t=c.createFrom(-e,a,-e),n=c.createFrom(e,a,-e),o=c.createFrom(0,a,e),i=c.createFrom(0,a+e,0),s=c.create(),l=c.create(),y=c.create(),O=c.create(),d=c.create();c.subtract(t,i,s),c.subtract(t,n,l),c.cross(s,l,y),c.normalize(y,y),c.subtract(n,i,s),c.subtract(n,o,l),c.cross(s,l,O),c.normalize(O,O),c.subtract(o,i,s),c.subtract(o,t,l),c.cross(s,l,d),c.normalize(d,d);var A=[t,n,o,i],h=[0,-1,0,y[0],y[1],y[2],O[0],O[1],O[2],d[0],d[1],d[2]],f=[0,1,2,3,1,0,3,2,1,3,0,2],I=[0,0,0,1,1,1,2,2,2,3,3,3];return function(e){var a;Array.isArray(e)||(e=[e,e,e]);var t=new Float32Array(12);for(a=0;4>a;a++)t[3*a]=A[a][0]*e[0],t[3*a+1]=A[a][1]*e[1],t[3*a+2]=A[a][2]*e[2];var n={};n[v.POSITION]=new Uint8Array(f),n[v.NORMAL]=new Uint8Array(I);var o={};o[v.POSITION]={size:3,data:t},o[v.NORMAL]={size:3,data:new Float32Array(h)};var i=[{type:"triangle",indices:n,positionKey:v.POSITION}];return new r(i,o)}}var c=t.vec3,y=t.vec3d,v=a.VertexAttrConstants,O=e.Vec3Compact,d=.99619469809,A=y.create(),h=y.create(),f={createSphereGeometry:function(e,t,n,o,i,s,l){e=e||50,o=void 0!==o?o:-Math.PI,i=void 0!==i?i:2*Math.PI,s=void 0!==s?s:.5*-Math.PI,l=void 0!==l?l:Math.PI;var y,O,d=Math.max(3,Math.floor(t)||8),A=Math.max(2,Math.floor(n)||6),h=(d+1)*(A+1),f=new Float32Array(3*h),I=new Float32Array(3*h),g=new Float32Array(2*h),u=[],w=c.create(),m=0;for(O=0;A>=O;O++){var N=[],F=O/A,P=s+F*l,M=Math.cos(P);for(y=0;d>=y;y++){var z=y/d,S=o+z*i,p=Math.cos(S)*M*e,U=Math.sin(P)*e,T=-Math.sin(S)*M*e;f[3*m]=p,f[3*m+1]=U,f[3*m+2]=T,c.set3(p,U,T,w),c.normalize(w),I[3*m]=w[0],I[3*m+1]=w[1],I[3*m+2]=w[2],g[2*m]=z,g[2*m+1]=F,N.push(m),++m}u.push(N)}var R=new Uint32Array(2*d*(A-1)*3);for(m=0,O=0;A>O;O++)for(y=0;d>y;y++){var L=u[O][y],V=u[O][y+1],G=u[O+1][y+1],x=u[O+1][y];0===O?(R[m++]=L,R[m++]=G,R[m++]=x):O===A-1?(R[m++]=L,R[m++]=V,R[m++]=G):(R[m++]=L,R[m++]=V,R[m++]=G,R[m++]=G,R[m++]=x,R[m++]=L)}a.assert(m===R.length);var K={};K[v.POSITION]=R,K[v.NORMAL]=R,K[v.UV0]=R;var b={};b[v.POSITION]={size:3,data:f},b[v.NORMAL]={size:3,data:I},b[v.UV0]={size:2,data:g};var C=[{type:"triangle",indices:K,positionKey:v.POSITION}];return new r(C,b)},createPolySphereGeometry:function(e,a,t){function n(r,a){r>a&&(r=a+(a=r,0));var t=r.toString()+"."+a.toString();if(y[t])return y[t];var n=i.length;return i.length+=3,O.add(i,3*r,i,3*a,i,n),O.scale(i,n,e/O.length(i,n)),n/=3,y[t]=n,n}var o,i,s,l=e;if(t)i=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],s=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{var c=l*(1+Math.sqrt(5))/2;i=[-l,c,0,l,c,0,-l,-c,0,l,-c,0,0,-l,c,0,l,c,0,-l,-c,0,l,-c,c,0,-l,c,0,l,-c,0,-l,-c,0,l],s=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(o=0;o<i.length;o+=3)O.scale(i,o,e/O.length(i,o));var y={};for(o=0;a>o;o++){for(var d=s.length,A=new Array(4*d),h=0;d>h;h+=3){var f=s[h],I=s[h+1],g=s[h+2],u=n(f,I),w=n(I,g),m=n(g,f),N=4*h;A[N]=f,A[N+1]=u,A[N+2]=m,A[N+3]=I,A[N+4]=w,A[N+5]=u,A[N+6]=g,A[N+7]=m,A[N+8]=w,A[N+9]=u,A[N+10]=w,A[N+11]=m}s=A,y={}}var F=new Float32Array(i);for(o=0;F>o;o+=3)O.normalize(F,o);i=new Float32Array(i);var P={};P[v.POSITION]=s,P[v.NORMAL]=s;var M={};M[v.POSITION]={size:3,data:i},M[v.NORMAL]={size:3,data:F};var z=[{type:"triangle",indices:P,positionKey:v.POSITION}];return new r(z,M)},createPointGeometry:function(e,a,t,n,o,i,s,l){var c=new Float32Array(3);c[0]=a?a[0]:0,c[1]=a?a[1]:0,c[2]=a?a[2]:0;var y=new Float32Array(3);if(y[0]=e?e[0]:0,y[1]=e?e[1]:0,y[2]=e?e[2]:1,null==s){var O=new Float32Array(2);O[0]=0,O[1]=0}else{O=new Float32Array(s.length);for(var d=0;d<s.length;d++)O[d]=s[d]}var A=new Uint8Array(4);A[0]=t?255*t[0]:255,A[1]=t?255*t[1]:255,A[2]=t?255*t[2]:255,A[3]=t&&t.length>3?255*t[3]:255;var h=new Float32Array(2);if(h[0]=null!=n&&2==n.length?n[0]:1,h[1]=null!=n&&2==n.length?n[1]:1,null!=i){var f=new Float32Array(4);f[0]=i[0],f[1]=i[1],f[2]=i[2],f[3]=i[3]}if(null!=l){var I=new Float32Array(4);I[0]=l[0],I[1]=l[1],I[2]=l[2],I[3]=l[3]}var g=new Uint32Array(1);g[0]=0;var u={};u[v.POSITION]=g,u[v.NORMAL]=g,u[v.UV0]=g,u[v.COLOR]=g,u[v.SIZE]=g,null!=i&&(u[v.AUXPOS1]=g),null!=l&&(u[v.AUXPOS2]=g);var w={};w[v.POSITION]={size:3,data:c},w[v.NORMAL]={size:3,data:y},w[v.UV0]={size:O.length,data:O},w[v.COLOR]={size:4,data:A},w[v.SIZE]={size:2,data:h},null!=i&&(w[v.AUXPOS1]={size:4,data:f}),null!=l&&(w[v.AUXPOS2]={size:4,data:I});var m=[{type:"point",indices:u,positionKey:v.POSITION}];return o?{faces:m[0],vertexAttr:w,id:r.getNewId().toString()}:new r(m,w)},createPointArrayGeometry:function(e,a){for(var t=new Float32Array(3*e.length),n=new Float32Array(a?3*e.length:3),o=new Uint32Array(e.length),i=new Uint32Array(e.length),s=0;s<e.length;s++)t[3*s]=e[s][0],t[3*s+1]=e[s][1],t[3*s+2]=e[s][2],a&&(n[3*s]=a[s][0],n[3*s+1]=a[s][1],n[3*s+2]=a[s][2]),o[s]=s,i[s]=0;a||(n[0]=0,n[1]=1,n[2]=0);var l=new Float32Array(2);l[0]=0,l[1]=0;var c={};c[v.POSITION]=o,c[v.NORMAL]=a?o:i,c[v.UV0]=i;var y={};y[v.POSITION]={size:3,data:t},y[v.NORMAL]={size:3,data:n},y[v.UV0]={size:2,data:l};var O=[{type:"point",indices:c,positionKey:v.POSITION}];return new r(O,y)},createTriangleGeometry:function(){var e=new Float32Array(9);e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=100,e[6]=100,e[7]=0,e[8]=0;var a=new Uint32Array(3);a[0]=0,a[1]=1,a[2]=2;var t=new Float32Array(3);t[0]=0,t[1]=1,t[2]=0;var n=new Uint32Array(3);n[0]=0,n[1]=0,n[2]=0;var o=new Float32Array(2);o[0]=0,o[1]=0;var i=new Uint32Array(3);i[0]=0,i[1]=0,i[2]=0;var s={};s[v.POSITION]=a,s[v.NORMAL]=n,s[v.UV0]=i;var l={};l[v.POSITION]={size:3,data:e},l[v.NORMAL]={size:3,data:t},l[v.UV0]={size:2,data:o};var c=[{type:"triangle",indices:s,positionKey:v.POSITION}];return new r(c,l)},createSquareGeometry:function(e,a){var t,n,o=new Float32Array(12);if(e)for(t=0;4>t;t++)for(n=0;3>n;n++)o[3*t+n]=e[t][n];else o[0]=-1,o[1]=-1,o[2]=0,o[3]=1,o[4]=-1,o[5]=0,o[6]=1,o[7]=1,o[8]=0,o[9]=-1,o[10]=1,o[11]=0;var i=new Uint32Array(6);i[0]=0,i[1]=1,i[2]=2,i[3]=2,i[4]=3,i[5]=0;var s=new Float32Array(3);s[0]=0,s[1]=0,s[2]=1;var l=new Uint32Array(6);for(t=0;6>t;t++)l[t]=0;var c=new Float32Array(8);c[0]=0,c[1]=0,c[2]=1,c[3]=0,c[4]=1,c[5]=1,c[6]=0,c[7]=1;var y=new Uint8Array(4);y[0]=255,y[1]=255,y[2]=255,y[3]=255;var O={};O[v.POSITION]=i,O[v.NORMAL]=l,O[v.UV0]=i,O[v.COLOR]=l;var d={};d[v.POSITION]={size:3,data:o},d[v.NORMAL]={size:3,data:s},d[v.UV0]={size:2,data:c},d[v.COLOR]={size:4,data:y};var A=[{type:"triangle",indices:O,positionKey:v.POSITION}];return a?{faces:A[0],vertexAttr:d,id:r.getNewId().toString()}:new r(A,d)},createBoxGeometry:i(),createDiamondGeometry:s(),createTetrahedronGeometry:l(),createConeGeometry:function(e,a,t,n){var o,i=0,s=a,l=e,y=c.createFrom(0,i,0),O=c.createFrom(0,i+l,0),d=c.createFrom(0,-1,0),A=c.createFrom(0,1,0);n&&(i=l,O=c.createFrom(0,0,0),y=c.createFrom(0,i,0),d=c.createFrom(0,1,0),A=c.createFrom(0,-1,0));var h=[O,y],f=[d,A],I=t+2,g=0,u=Math.sqrt(l*l+s*s);if(n)for(o=t-1;o>=0;o--)g=o*(2*Math.PI/t),w=c.createFrom(Math.cos(g)*s,i,Math.sin(g)*s),h.push(w),m=c.createFrom(l*Math.cos(g)/u,-s/u,l*Math.sin(g)/u),f.push(m);else for(o=0;t>o;o++){g=o*(2*Math.PI/t);var w=c.createFrom(Math.cos(g)*s,i,Math.sin(g)*s);h.push(w);var m=c.createFrom(l*Math.cos(g)/u,s/u,l*Math.sin(g)/u);f.push(m)}var N=new Uint32Array(2*(t+2)*3),F=new Uint32Array(2*(t+2)*3),P=0,M=0;for(o=3;o<h.length;o++)N[P++]=1,N[P++]=o-1,N[P++]=o,F[M++]=0,F[M++]=0,F[M++]=0;for(N[P++]=h.length-1,N[P++]=2,N[P++]=1,F[M++]=0,F[M++]=0,F[M++]=0,o=3;o<h.length;o++)N[P++]=o,N[P++]=o-1,N[P++]=0,F[M++]=o,F[M++]=o-1,F[M++]=1;N[P++]=0,N[P++]=2,N[P++]=h.length-1,F[M++]=1,F[M++]=2,F[M++]=f.length-1;var z=1;Array.isArray(z)||(z=[z,z,z]);var S=new Float32Array(3*I);for(o=0;I>o;o++)S[3*o]=h[o][0]*z[0],S[3*o+1]=h[o][1]*z[1],S[3*o+2]=h[o][2]*z[2];var p=new Float32Array(3*I);for(o=0;I>o;o++)p[3*o]=f[o][0],p[3*o+1]=f[o][1],p[3*o+2]=f[o][2];var U={};U[v.POSITION]=N,U[v.NORMAL]=F;var T={};T[v.POSITION]={size:3,data:S},T[v.NORMAL]={size:3,data:p};var R=[{type:"triangle",indices:U,positionKey:v.POSITION}];return new r(R,T)},createCylinderGeometry:function(e,a,t,n,o,i){n||(n=c.createFrom(1,0,0)),o||(o=c.createFrom(0,0,0));var s=void 0===i?!0:i,l=c.create();c.normalize(n,l);var y=c.create();c.scale(l,Math.abs(e),y);var O=c.create();c.scale(y,-.5,O),c.add(O,o);var d=c.createFrom(0,1,0);Math.abs(1-c.dot(l,d)<.2)&&c.set3(0,0,1,d);var A=c.create();c.cross(l,d,A),c.normalize(A),c.cross(A,l,d);var h=2*t+(s?2:0),f=t+(s?2:0),I=new Float32Array(3*h),g=new Float32Array(3*f),u=new Float32Array(2*h),w=new Uint32Array(3*t*(s?4:2)),m=new Float32Array(3*t*(s?4:2));s&&(I[3*(h-2)+0]=O[0],I[3*(h-2)+1]=O[1],I[3*(h-2)+2]=O[2],u[2*(h-2)]=0,u[2*(h-2)+1]=0,I[3*(h-1)+0]=I[3*(h-2)+0]+y[0],I[3*(h-1)+1]=I[3*(h-2)+1]+y[1],I[3*(h-1)+2]=I[3*(h-2)+2]+y[2],u[2*(h-1)]=1,u[2*(h-1)+1]=1,g[3*(f-2)+0]=-l[0],g[3*(f-2)+1]=-l[1],g[3*(f-2)+2]=-l[2],g[3*(f-1)+0]=l[0],g[3*(f-1)+1]=l[1],g[3*(f-1)+2]=l[2]);var N,F,P,M=function(r,e,a){w[r]=e,m[r]=a},z=0,S=c.create(),p=c.create();for(N=0;t>N;N++)P=N*(2*Math.PI/t),c.scale(d,Math.sin(P),S),c.scale(A,Math.cos(P),p),c.add(S,p),g[3*N+0]=S[0],g[3*N+1]=S[1],g[3*N+2]=S[2],c.scale(S,a),c.add(S,O),I[3*N+0]=S[0],I[3*N+1]=S[1],I[3*N+2]=S[2],u[2*N+0]=N/t,u[2*N+1]=0,I[3*(N+t)+0]=I[3*N+0]+y[0],I[3*(N+t)+1]=I[3*N+1]+y[1],I[3*(N+t)+2]=I[3*N+2]+y[2],u[2*(N+t)+0]=N/t,u[2*N+1]=1,F=(N+1)%t,M(z++,N,N),M(z++,N+t,N),M(z++,F,F),M(z++,F,F),M(z++,N+t,N),M(z++,F+t,F);if(s){for(N=0;t>N;N++)F=(N+1)%t,M(z++,h-2,f-2),M(z++,N,f-2),M(z++,F,f-2);for(N=0;t>N;N++)F=(N+1)%t,M(z++,N+t,f-1),M(z++,h-1,f-1),M(z++,F+t,f-1)}var U={};U[v.POSITION]=w,U[v.NORMAL]=m,U[v.UV0]=w;var T={};T[v.POSITION]={size:3,data:I},T[v.NORMAL]={size:3,data:g},T[v.UV0]={size:2,data:u};var R=[{type:"triangle",indices:U,positionKey:v.POSITION}];return new r(R,T)},createTubeGeometry:function(r,e,t,n,o){t=t||10,n=null!=n?n:!0,a.assert(r.length>1);for(var i=[[0,0,0]],s=[],l=[],c=0;t>c;c++){s.push([0,-c-1,-((c+1)%t)-1]);var y=c/t*2*Math.PI;l.push([Math.cos(y)*e,Math.sin(y)*e])}return f.createPathExtrusionGeometry(l,r,i,s,n,o)},createSquareTubeGeometry:function(r,e,t){t=t||!0,a.assert(r.length>1);var n=[],o=[[-1,-2,-3],[-3,-4,-1]],i=Math.SQRT2*e,s=[[i,i],[-i,i],[-i,-i],[i,-i]],l=[[0,1],[-1,0],[0,-1],[1,0]];return f.createPathExtrusionGeometry(s,r,n,o,t,l)},createPathExtrusionGeometry:function(e,a,t,n,i,s,l){var y,O=e.length,A=new Float32Array(a.length*O*3+(6*t.length||0)),h=new Float32Array(a.length*O+(2*t.length||0)),f=new Float32Array(a.length*O*3+(t?6:0)),I=0,g=0,u=0,w=A.length/3>65535?Uint32Array:Uint16Array,m=(a.length-1)*O*6+3*n.length*2,N=new w(m),F=new w(m),P=0,M=0,z=c.create(),S=c.create(),p=c.create(),U=c.create(),T=c.create(),R=c.create(),L=c.create(),V=c.create(),G=c.create(),x=c.create(),K=c.create(),b=c.create();for(c.set3(0,1,0,b),c.subtract(a[1],a[0],S),c.normalize(S),i?(c.add(a[0],s,K),c.normalize(K,p)):c.set3(0,0,1,p),o(S,p,b,b,R,p,d),c.set(p,U),y=0;y<t.length;y++)c.scale(R,t[y][0],G),c.scale(p,t[y][2],K),c.add(G,K),c.add(G,a[0]),A[I++]=G[0],A[I++]=G[1],A[I++]=G[2],h[u++]=0;for(f[g++]=-S[0],f[g++]=-S[1],f[g++]=-S[2],y=0;y<n.length;y++)N[P++]=n[y][0]>0?n[y][0]:-n[y][0]-1+t.length,N[P++]=n[y][1]>0?n[y][1]:-n[y][1]-1+t.length,N[P++]=n[y][2]>0?n[y][2]:-n[y][2]-1+t.length,F[M++]=0,F[M++]=0,F[M++]=0;for(var C,E=t.length,q=t.length-1,X=0;X<a.length;X++){C=!1,X>0&&(i?(c.add(a[X],s,K),c.normalize(K,p)):c.set3(0,0,1,p),c.set(S,z),c.set(z,K),X<a.length-1?(c.subtract(a[X+1],a[X],S),c.normalize(S),c.add(K,S)):C=!0,o(K,p,U,b,R,p,d),c.set(p,U)),l&&(o(S,p,U,b,V,L,d),c.set(L,T));for(var B=0;O>B;B++)if(c.scale(R,e[B][0],G),c.scale(p,e[B][1],K),c.add(G,K),l?(c.scale(V,l[B][0],x),c.scale(L,l[B][1],K),c.add(x,K),c.normalize(x),c.scale(x,-1)):c.normalize(G,x),f[g++]=x[0],f[g++]=x[1],f[g++]=x[2],c.add(G,a[X]),A[I++]=G[0],A[I++]=G[1],A[I++]=G[2],h[u++]=e[B][1],!C){var D=(B+1)%O;if(N[P++]=E+B,N[P++]=E+O+B,N[P++]=E+D,N[P++]=E+D,N[P++]=E+O+B,N[P++]=E+O+D,l){var Z;for(Z=0;6>Z;Z++)F[M++]=E-q+B}else for(Z=0;6>Z;Z++)F[M++]=N[P-6+Z]-q}E+=O}for(C=a[a.length-1],y=0;y<t.length;y++)c.scale(R,t[y][0],G),c.scale(p,t[y][1],K),c.add(G,K),c.add(G,C),A[I++]=G[0],A[I++]=G[1],A[I++]=G[2],h[u++]=0;var Q=g/3;f[g++]=S[0],f[g++]=S[1],f[g++]=S[2];var j=E-O;for(y=0;y<n.length;y++)N[P++]=n[y][0]>=0?E+n[y][0]:-n[y][0]-1+j,N[P++]=n[y][2]>=0?E+n[y][2]:-n[y][2]-1+j,N[P++]=n[y][1]>=0?E+n[y][1]:-n[y][1]-1+j,F[M++]=Q,F[M++]=Q,F[M++]=Q;var k={};k[v.POSITION]=N,k[v.NORMAL]=F;var H={};H[v.POSITION]={size:3,data:A},H.zOffset={size:1,data:h},H[v.NORMAL]={size:3,data:f};var J=[{type:"triangle",indices:k,positionKey:v.POSITION}];return new r(J,H)},createPolylineGeometry:function(e,t){a.assert(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),a.assert(3===e[0].length,"createPolylineGeometry(): malformed vertex");for(var n=new Float32Array(3*e.length),o=new Uint32Array(2*(e.length-1)),i=0,s=0,l=0;l<e.length;l++){for(var c=0;3>c;c++)n[i++]=e[l][c];l>0&&(o[s++]=l-1,o[s++]=l)}var y={},O={};y[v.POSITION]=o,O[v.POSITION]={size:3,data:n};var d=[{type:"line",indices:y,positionKey:v.POSITION}];return t?{faces:d[0],vertexAttr:O,id:r.getNewId().toString()}:new r(d,O)},addVertexColors:function(e,a,t){var n,o,i,s;if(t){var l={},c=e.getVertexAttr();for(s in c)l[s]=c[s];var y=e.getFaces();for(n=new Array(y.length),i=0;i<y.length;i++){o={};for(s in y[i].indices)o[s]=y[i].indices[s];n[i]={type:y[i].type,indices:o,positionKey:y[i].positionKey}}e=new r(n,l)}var O=a||[1,1,1,1],d=new Uint8Array(4);d[0]=255*O[0],d[1]=255*O[1],d[2]=255*O[2],d[3]=255*(O.length>3?O[3]:1);var A=e.getVertexAttr();for(A[v.COLOR]={size:4,data:d},n=e.getFaces(),i=0;i<n.length;i++){var h=n[i],f=h.indices[h.positionKey].length;o=new Uint32Array(f),h.indices[v.COLOR]=o}return e},addNormals:function(r){for(var a=r.getVertexAttr(),t=r.getFaces(),n=e.Vec3Compact.subtract,o=t.map(function(r){return r.indices.position.length/3}).reduce(function(r,e){return r+e}),i=new Float32Array(3*o),s=a.position.data,l=0,c=0;c<t.length;c++){for(var v=t[c].indices.position,O=new Uint32Array(v.length),d=0;d<v.length;d+=3){n(s,3*v[d],s,3*v[d+2],h,0),n(s,3*v[d],s,3*v[d+1],A,0),y.cross(A,h),y.normalize(A);var f=l/3;i[l++]=A[0],i[l++]=A[1],i[l++]=A[2],O[d]=f,O[d+1]=f,O[d+2]=f}t[c].indices.normal=O}a.normal={size:3,data:i}},cgToGIS:function(r){var e,a,t=r.getVertexAttr(),n=t.position.data,o=t.normal.data;if(o)for(e=0;e<o.length;e+=3)a=o[e+1],o[e+1]=-o[e+2],o[e+2]=a;if(n)for(e=0;e<n.length;e+=3)a=n[e+1],n[e+1]=-n[e+2],n[e+2]=a}};return f});