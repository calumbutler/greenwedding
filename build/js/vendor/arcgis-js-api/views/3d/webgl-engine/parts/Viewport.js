// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/has","../lib/PerformanceTimer","../lib/Camera","../lib/Util","../lib/BitSet","../lib/gl-matrix","./Visualizer"],function(e,t,r,i,s,a,n,o,u){var m=o.vec3,l=o.vec4d,d=o.mat4d,h=2e4,_=[0,0],c=d.create(),p=[l.create(),l.create(),l.create(),l.create(),l.create(),l.create()],v={get:function(e){return!0}},g=r("dojo-debug-messages"),f=function(){function e(e,t,r,a){this._content={},this._visibleContent=new n,this._frustumCullingEnabled=!0,this._maxFarNearRatio=h,this._stats={renderGeometriesTotal:0,renderGeometriesVisible:0,visualizerRenderTimer:null,viewportRenderTimer:null},this._needsRender=!0,this._rctx=a,this._gl=a.gl,this._visualizer=new u(e,t,r,this._rctx),this._camera=new s(m.createFrom(0,100,-100),m.createFrom(0,0,0)),g&&(this._stats.visualizerRenderTimer=new i(10),this._stats.viewportRenderTimer=new i(10))}return e.prototype.getCombinedStats=function(){var e={},t=this._visualizer.getCombinedStats();for(var r in t)e[r]=t[r];if(e.renderGeometriesTotal=this._stats.renderGeometriesTotal,e.renderGeometriesVisible=this._stats.renderGeometriesVisible,g&&(e.visualizerTotalRenderTime=this._stats.visualizerRenderTimer.getTotal(),e.visualizerCurrentRenderTime=this._stats.visualizerRenderTimer.getLastFiltered(),e.viewportTotalRenderTime=this._stats.viewportRenderTimer.getTotal(),e.viewportCurrentRenderTime=this._stats.viewportRenderTimer.getLastFiltered(),e.totalNumFramesRendered=this._stats.viewportRenderTimer.getNumMeasurements()),void 0!==this._gl.getUsedTextureMemory&&(e.textureMemory=this._gl.getUsedTextureMemory()),void 0!==this._gl.getUsedRenderbufferMemory&&(e.renderbufferMemory=this._gl.getUsedRenderbufferMemory()),void 0!==this._gl.getUsedVBOMemory&&(e.VBOMemory=this._gl.getUsedVBOMemory()),void 0!==this._gl.getUsedTextureMemoryStats){var i=this._gl.getUsedTextureMemoryStats();for(var s in i)e["texMem type: "+s]=i[s]}return e},e.prototype.dispose=function(){this._visualizer.dispose(),this._visualizer=null},e.prototype.setLightingData=function(e){this._visualizer.setLightingData(e)},e.prototype.getLightingData=function(){return this._visualizer.getLightingData()},e.prototype.getViewParams=function(e){var t=this._visualizer.getViewParams(e);return(!e||e.frustumCullingEnabled)&&(t.frustumCullingEnabled=this._frustumCullingEnabled),(!e||e.maxFarNearRatio)&&(t.maxFarNearRatio=this._maxFarNearRatio),t},e.prototype.setViewParams=function(e){void 0!==e.frustumCullingEnabled&&(this._frustumCullingEnabled=e.frustumCullingEnabled),void 0!==e.maxFarNearRatio&&(-1===e.maxFarNearRatio?this._maxFarNearRatio=h:this._maxFarNearRatio=e.maxFarNearRatio),this._visualizer.setViewParams(e),this._needsRender=!0},e.prototype.setRenderParams=function(e){this._visualizer.setRenderParams(e)},e.prototype.getRenderParams=function(){return this._visualizer.getRenderParams()},e.prototype.getFrustumObjects=function(){var e={};for(var t in this._content)this._visibleContent.get(this._content[t].idx)&&(e[this._content[t].name]=1);return e},e.prototype.modify=function(e,t,r,i){this._visualizer.modify(e,t,r,i),this._content=this._visualizer.getContent()},e.prototype.getContent=function(){return this._content},e.prototype.setSelectionObject=function(e,t){this._visualizer.setSelectionObject(e,t)},e.prototype.setCamera=function(e){this._camera.copyFrom(e),this._computeVisibleContentAndUpdateNearFar(),this._needsRender=!0},e.prototype.getCamera=function(){return this._camera},e.prototype.getPickRay=function(e,t,r){return this.pickRayWithBeginPoint(e,void 0,this._camera.viewMatrix,t,r)},e.prototype.pickRayWithBeginPoint=function(e,t,r,i,s){return this._visualizer.getPickRay(e,t,this._camera,r,i,s)},e.prototype.addExternalRenderer=function(e,t){return this._visualizer.addExternalRenderer(e,t)},e.prototype.removeExternalRenderer=function(e){return this._visualizer.removeExternalRenderer(e)},e.prototype.getExternalRenderers=function(){return this._visualizer.getExternalRenderers()},e.prototype.render=function(e,t){g&&this._stats.viewportRenderTimer.start();var r=this._computeVisibleContentAndUpdateNearFar();g&&this._stats.visualizerRenderTimer.start(),this._visualizer.render(this._camera,e,r,t),g&&(this._stats.visualizerRenderTimer.stop(),this._stats.viewportRenderTimer.stop())},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._visualizer.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._visualizer.needsRender()},e.prototype._computeVisibleContentAndUpdateNearFar=function(){return this._frustumCullingEnabled||this._maxFarNearRatio>0?(_[1]=0,this._computeFrustumCullingAndNearFar(this._camera.eye,this._visibleContent,_),this._maxFarNearRatio>0&&_[1]>0&&(this._camera.far=_[1],this._camera.near=Math.max(_[0],this._camera.far/this._maxFarNearRatio)),this._visibleContent):v},e.prototype._computeFrustumCullingAndNearFar=function(e,t,r){d.perspective(this._camera.fovY,this._camera.aspect,1,10,c),a.matrix2frustumPlanes(this._camera.viewMatrix,c,p),t.clearAll(),this._stats.renderGeometriesTotal=0,this._stats.renderGeometriesVisible=0;var i=-Number.MAX_VALUE,s=-Number.MAX_VALUE,n=p[0][0],o=p[0][1],u=p[0][2],m=p[0][3],l=p[1][0],h=p[1][1],_=p[1][2],v=p[1][3],g=p[2][0],f=p[2][1],R=p[2][2],y=p[2][3],b=p[3][0],x=p[3][1],T=p[3][2],z=p[3][3],C=p[4][0],F=p[4][1],N=p[4][2],M=p[4][3],w=p[5][3];for(var V in this._content){var E=this._content[V];if(this._stats.renderGeometriesTotal++,!E.material.isBackdrop){var U=E.center,P=U[0],A=U[1],G=U[2],L=E.bsRadius;if(n*P+o*A+u*G+m>L)continue;if(l*P+h*A+_*G+v>L)continue;if(g*P+f*A+R*G+y>L)continue;if(b*P+x*A+T*G+z>L)continue;var B=C*P+F*A+N*G,S=B+L,O=-B+L;S>i&&(i=S),O>s&&(s=O)}t.set(E.idx),this._stats.renderGeometriesVisible++}var j=i!==-Number.MAX_VALUE;i+=M,s+=w,this._stats.renderGeometriesVisible>0&&j&&(r[0]=.99*Math.max(1-i,2),r[1]=1.01*Math.max(10+s,r[0]+1))},e}();return f});