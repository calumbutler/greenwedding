// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./Material.xml","./internal/MaterialUtil","../../../webgl/Program","../lib/ShaderVariations","../lib/Util","../lib/gl-matrix","../lib/RenderSlot","../lib/DefaultVertexAttributeLocations","../lib/DefaultVertexBufferLayouts","../../../webgl/Util"],function(e,t,i,a,n,r,s,o,l,d,u){function v(e,t){var i=t.vvSizeEnabled;t.vvSizeEnabled?(e.setUniform3fv("vvSizeMinDataValue",t.vvSizeMinDataValue),e.setUniform3fv("vvSizeMaxDataValue",t.vvSizeMaxDataValue),e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize)):i&&e.setUniform3fv("vvSizeValue",t.vvSizeValue),i&&(e.setUniform3fv("vvAnchorValue",t.vvAnchorValue),e.setUniformMatrix4fv("vvRotationValue",t.vvRotationValue)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors))}function f(e,t){e.vvSizeEnabled=t.vvSizeEnabled,e.vvSizeMinDataValue=t.vvSizeMinDataValue,e.vvSizeMinSize=t.vvSizeMinSize,e.vvSizeMaxDataValue=t.vvSizeMaxDataValue,e.vvSizeMaxSize=t.vvSizeMaxSize,e.vvSizeValue=t.vvSizeValue,e.vvRotationValue=t.vvRotationValue,e.vvAnchorValue=t.vvAnchorValue}var c,h=r.assert,S=s.vec3,p=S.create(),g=function(e,t){i.basicMaterialConstructor(this,t),e=e||{},e.ambient=e.ambient||[.2,.2,.2],e.diffuse=e.diffuse||[.8,.8,.8],e.specular=e.specular||[0,0,0],e.shininess=e.shininess||10,e.opacity=void 0!==e.opacity?e.opacity:1,e.blendModeOneOne=e.blendModeOneOne||!1,e.inverseWindingOrder=e.inverseWindingOrder||!1,e.vertexColors=e.vertexColors||!1,e.flipV=e.flipV||!1,e.doubleSided=e.doubleSided||!1,e.cullFace=e.cullFace||void 0,e.instanced=e.instanced||!1,this.instanced=!!e.instanced,e.writeStencil=e.writeStencil||!1,e.textureId||(e.reflTextureId=void 0),e.receiveSSAO=void 0!==e.receiveSSAO?e.receiveSSAO:!0,e.vvSizeEnabled=e.vvSizeEnabled||!1,e.vvSizeMinDataValue=e.vvSizeMinDataValue||[0,0,0],e.vvSizeMinSize=e.vvSizeMinSize||[1,1,1],e.vvSizeMaxDataValue=e.vvSizeMaxDataValue||[0,0,0],e.vvSizeMaxSize=e.vvSizeMaxSize||[100,100,100],e.vvSizeValue=e.vvSizeValue||[1,1,1],e.vvAnchorValue=e.vvAnchorValue||[0,0,0],e.vvRotationValue=e.vvRotationValue||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e.vvColorEnabled=e.vvColorEnabled||!1,e.vvColorValues=e.vvColorValues||[0,0,0,0,0,0,0,0],e.vvColorColors=e.vvColorColors||[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0];var a;a=e.textureId?e.atlasRegions?"Pos3NormTexRegion":"Pos3NormTex":"Pos3Norm",e.vertexColors&&(a+="Col");var n=d[a],r=null;e.instanced&&(r=[],u.addDescriptor(r,"model",16,5126,!1,1),u.addDescriptor(r,"modelNormal",16,5126,!1,1),e.instanced.indexOf("color")>-1&&u.addDescriptor(r,"instanceColor",4,5126,!1,1),e.instanced.indexOf("featureAttribute")>-1&&u.addDescriptor(r,"instanceFeatureAttribute",4,5126,!1,1));var s=this.isVisible.bind(this);this.isVisible=function(){return s()&&e.opacity>0},this.dispose=function(){},this.getParams=function(){return e},this.getParameterValues=function(){var t={ambient:e.ambient,diffuse:e.diffuse,specular:e.specular,shininess:e.shininess,opacity:e.opacity,transparent:e.transparent,polygonOffset:e.polygonOffset,reflectivity:e.reflectivity,atlasRegions:e.atlasRegions,flipV:e.flipV,doubleSided:e.doubleSided,cullFace:e.cullFace,writeStencil:e.writeStencil,receiveSSAO:e.receiveSSAO,vvSizeEnabled:e.vvSizeEnabled,vvSizeMinDataValue:e.vvSizeMinDataValue,vvSizeMinSize:e.vvSizeMinSize,vvSizeMaxDataValue:e.vvSizeMaxDataValue,vvSizeMaxSize:e.vvSizeMaxSize,vvSizeValue:e.vvSizeValue,vvRotationValue:e.vvRotationValue,vvAnchorValue:e.vvAnchorValue,vvColorEnabled:e.vvColorEnabled,vvColorValues:e.vvColorValues,vvColorColors:e.vvColorColors};return e.textureId&&(t.textureId=e.textureId,t.initTexture=e.initTexture),t},this.setParameterValues=function(t){for(var i in t)"textureId"===i&&h(e.textureId,"Can only change texture of material that already has a texture"),e[i]=t[i];this.notifyDirty("matChanged")},this.getOutputAmount=function(e){var t=u.getStride(n)/4;return e*t},this.getVertexBufferLayout=function(){return n},this.getInstanceBufferLayout=function(){return r},this.fillInterleaved=function(e,t,a,r,s,o,l){i.fillInterleaved(e,t,a,r,n,s,o,l)},this.intersect=i.intersectTriangleGeometry,this.getGLMaterials=function(){return{color:D,depthShadowMap:T,normal:A,depth:M,highlight:C}},this.getAllTextureIds=function(){var t=[];return e.textureId&&t.push(e.textureId),e.reflTextureId&&t.push(e.reflTextureId),t}};g.paramsFromOldConstructor=function(e,t,i,a,n,r,s,o,l,d,u,v,f){return{textureId:e,transparent:t,ambient:i,diffuse:a,specular:n,shininess:r,opacity:s,polygonOffset:o,initTexture:l,reflTextureId:d,reflectivity:u,flipV:v,doubleSided:f,cullFace:void 0}};var x=function(e){return e.cullFace?"none"!==e.cullFace:e.transparent?!1:!0},m=function(e,t){var i=e.gl,a=x(t);a?(e.setFaceCullingEnabled(!0),"front"===t.cullFace&&e.setCullFace(i.FRONT)):e.setFaceCullingEnabled(!1)},b=function(e,t){var i=e.gl,a=x(t);a?(e.setFaceCullingEnabled(!1),"front"===t.cullFace&&e.setCullFace(i.BACK)):e.setFaceCullingEnabled(!0)},V=function(e,t){return e?o.TRANSPARENT_MATERIAL:t?o.STENCIL_MATERIAL:o.OPAQUE_MATERIAL},D=function(t,a,n){i.basicGLMaterialConstructor(this,t);var r=e.clone(t.getParams()),s=V(r.transparent,r.writeStencil);i.singleTextureGLMaterialConstructor(this,n,r);var o=i.aquireIfNotUndefined(r.reflTextureId,r.reflInitTexture,n);o&&(o=o.getGLTexture()),h(!(r.atlasRegions&&r.reflTextureId),"Atlas texture with reflection is not yet supported");var l=r.textureId?r.atlasRegions?"AtlasTextured":"Textured":"none";this.instanced=c&&r.instanced;var d=!!this.instanced&&this.instanced.indexOf("color")>-1;this._loadProgram=function(e,t){return a.shaderVariators.Material.getProgram([l,!!r.reflTextureId,r.vertexColors,r.flipV,r.doubleSided,!!this.instanced,d,e,t,!!r.vvSizeEnabled,!!r.vvColorEnabled])};var u=this._loadProgram(!1,r.receiveSSAO),g=this._loadProgram(!0,r.receiveSSAO),x=null,D="AtlasTextured"===l,M=this.dispose;this.dispose=function(){M(),i.releaseIfNotUndefined(r.reflTextureId,n)},this.beginSlot=function(e){return s===e},this.getProgram=function(){return x||u},this.getAllPrograms=function(){return[g,u]},this.updateParameters=function(){var e=t.getParams();r.ambient=e.ambient,r.diffuse=e.diffuse,r.specular=e.specular,r.shininess=e.shininess,r.opacity=e.opacity,r.polygonOffset=e.polygonOffset,r.reflectivity=e.reflectivity,r.flipV=e.flipV,r.doubleSided=e.doubleSided,r.cullFace=e.cullFace,r.receiveSSAO=e.receiveSSAO,f(r,e),r.vvColorEnabled=e.vvColorEnabled,r.vvColorValues=e.vvColorValues,r.vvColorColors=e.vvColorColors,r.transparent!=e.transparent&&(s=V(e.transparent),r.transparent=e.transparent),r.initTexture=e.initTexture,this.updateTexture(e.textureId),e.atlasRegions&&(r.atlasRegions=e.atlasRegions),r.blendModeOneOne=e.blendModeOneOne,r.inverseWindingOrder=e.inverseWindingOrder,u=this._loadProgram(!1,r.receiveSSAO),g=this._loadProgram(!0,r.receiveSSAO)},this.bind=function(e,t){var i=e.gl,a=t.shadowMap&&t.shadowMap.getEnableState();x=a?g:u,e.bindProgram(x),x.setUniform3fv("ambient",r.ambient),x.setUniform3fv("diffuse",r.diffuse),x.setUniform3fv("specular",r.specular),x.setUniform1f("shininess",r.shininess),x.setUniform1f("opacity",r.opacity),t.shadowMap||x.setUniform1f("depthHalfPixelSz",-1),v(x,r),this.bindTexture(e,x),D&&this.bindTextureSize(e,x),e.setBlendFunctionSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),void 0!==o&&(x.setUniform1i("reflTex",1),e.bindTexture(o,1),x.setUniform1f("reflectivity",r.reflectivity)),r.inverseWindingOrder&&e.setFrontFace(i.CW),r.transparent?(e.setBlendingEnabled(!0),r.blendModeOneOne?(e.setBlendFunction(i.ONE,i.ONE),e.setDepthWriteEnabled(!1)):e.setBlendFunctionSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)):e.setBlendingEnabled(!1),r.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(2,2)),m(e,r),e.setDepthTestEnabled(!0)},this.release=function(e,t){var i=e.gl;e.setPolygonOffsetFillEnabled(!1),b(e,r),e.setBlendingEnabled(!1),e.setBlendFunctionSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),e.setDepthWriteEnabled(!0),e.setFrontFace(i.CCW)},this.bindView=function(e,t){var a=t.shadowMap&&t.shadowMap.getEnableState();x=a?g:u;var n=t.origin;i.bindView(n,t.view,x),i.bindCamPos(n,t.viewInvTransp,x),t.shadowMap&&t.shadowMap.bindView(x,n)},this.bindInstance=function(e,t){if(x.setUniformMatrix4fv("model",t.transformation),x.setUniformMatrix4fv("modelNormal",t.transformationNormal),d&&t.instanceParameters){var i=t.instanceParameters.color;i&&(S.multiply(r.ambient,i,p),x.setUniform3fv("ambient",p),S.multiply(r.diffuse,i,p),x.setUniform3fv("diffuse",p),x.setUniform1f("opacity",r.opacity*i[3]))}},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}},M=function(t,a,n,r){i.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams());this.instanced=c&&s.instanced;var o=u.hasAttribute(t.getVertexBufferLayout(),"uv0")?(s.atlasRegions,"Textured"):"none",l=a.shaderVariators.MaterialDepth.getProgram([o,s.flipV,!!this.instanced,!!r,!!s.vvSizeEnabled]),d=V(s.transparent,s.writeStencil);i.singleTextureGLMaterialConstructor(this,n,s),this.beginSlot=function(e){return d===e},this.getProgram=function(){return l},this.updateParameters=function(){var e=t.getParams();s.initTexture=e.initTexture,s.cullFace=e.cullFace,s.inverseWindingOrder=e.inverseWindingOrder,s.flipV=e.flipV,f(s,e),this.updateTexture(e.textureId)},this.bind=function(e,t){var i=e.gl;e.bindProgram(l),l.setUniform2fv("nearFar",t.nearFar),s.inverseWindingOrder&&e.setFrontFace(i.CW),v(l,s),this.bindTexture(e,l),m(e,s),e.setDepthTestEnabled(!0)},this.release=function(e){var t=e.gl;b(e,s),s.inverseWindingOrder&&e.setFrontFace(t.CCW)},this.bindView=function(e,t){i.bindView(t.origin,t.view,l)},this.bindInstance=function(e,t){l.setUniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}},T=function(e,t,i){M.call(this,e,t,i,!0)},A=function(t,a,n){i.basicGLMaterialConstructor(this,t);var r=e.clone(t.getParams()),s=u.hasAttribute(t.getVertexBufferLayout(),"uv0")?(r.atlasRegions,"Textured"):"none";this.instanced=c&&r.instanced;var o=a.shaderVariators.MaterialNormal.getProgram([s,r.flipV,!!this.instanced,!!r.vvSizeEnabled]),l=V(r.transparent,r.writeStencil);i.singleTextureGLMaterialConstructor(this,n,r),this.beginSlot=function(e){return l===e},this.getProgram=function(){return o},this.updateParameters=function(){var e=t.getParams();r.initTexture=e.initTexture,r.cullFace=e.cullFace,r.inverseWindingOrder=e.inverseWindingOrder,r.flipV=e.flipV,f(r,e),this.updateTexture(e.textureId)},this.bind=function(e,t){var i=e.gl;e.bindProgram(o),this.bindTexture(e,o),o.setUniformMatrix4fv("viewNormal",t.viewInvTransp),v(o,r),m(e,r),r.inverseWindingOrder&&e.setFrontFace(i.CW),e.setDepthTestEnabled(!0)},this.release=function(e){var t=e.gl;b(e,r),r.inverseWindingOrder&&e.setFrontFace(t.CCW)},this.bindView=function(e,t){i.bindView(t.origin,t.view,o)},this.bindInstance=function(e,t){o.setUniformMatrix4fv("model",t.transformation),o.setUniformMatrix4fv("modelNormal",t.transformationNormal)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}},C=function(t,a,n,r){i.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams()),l=u.hasAttribute(t.getVertexBufferLayout(),"uv0")?(s.atlasRegions,"Textured"):"none";this.instanced=c&&s.instanced;var d=a.shaderVariators.MaterialHighlight.getProgram([l,s.flipV,!!this.instanced,!!s.vvSizeEnabled]),h=o.OPAQUE_MATERIAL;i.singleTextureGLMaterialConstructor(this,n,s),this.beginSlot=function(e){return h===e},this.getProgram=function(){return d},this.updateParameters=function(){var e=t.getParams();s.initTexture=e.initTexture,s.cullFace=e.cullFace,s.inverseWindingOrder=e.inverseWindingOrder,s.flipV=e.flipV,f(s,e),this.updateTexture(e.textureId)},this.bind=function(e,t){var i=e.gl;e.bindProgram(d),this.bindTexture(e,d),v(d,s),m(e,s),s.inverseWindingOrder&&e.setFrontFace(i.CW),e.setDepthTestEnabled(!0)},this.release=function(e){var t=e.gl;b(e,s),s.inverseWindingOrder&&e.setFrontFace(t.CW)},this.bindView=function(e,t){i.bindView(t.origin,t.view,d)},this.bindInstance=function(e,t){d.setUniformMatrix4fv("model",t.transformation),d.setUniformMatrix4fv("modelNormal",t.transformationNormal)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}};return g.loadShaders=function(e,i,r,s){e._parse(t),c=s.extensions.angleInstancedArrays,s.extensions.shaderTextureLOD,s.extensions.standardDerivatives;var o=new n("phong",["vsPhong","fsPhong"],null,r,i,e,s);o.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),o.addBinaryShaderSnippetSuffix("Refl","Refl",[!1,!0]),o.addDefine("Color","VERTEXCOLORS"),o.addDefine("FlipV","FLIPV"),o.addDefine("DoubleSided","DOUBLESIDED"),o.addDefine("Instanced","INSTANCED"),o.addDefine("InstColor","INSTANCEDCOLOR"),o.addDefine("ReceiveShadows","RECEIVE_SHADOWS"),o.addDefine("ReceiveSSAO","RECEIVE_SSAO"),o.addDefine("vvSize","VV_SIZE"),o.addDefine("vvColor","VV_COLOR"),r.shaderVariators.Material=o;var d=new n("depth",["vsDepth","fsDepth"],null,r,i,e,s);d.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),d.addDefine("FlipV","FLIPV"),d.addDefine("Instanced","INSTANCED"),d.addDefine("ShadowMap","BIAS_SHADOWMAP"),d.addDefine("vvSize","VV_SIZE"),r.shaderVariators.MaterialDepth=d;var u=new n("normal",["vsNormal","fsNormal"],null,r,i,e,s);u.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),u.addDefine("FlipV","FLIPV"),u.addDefine("Instanced","INSTANCED"),u.addDefine("vvSize","VV_SIZE"),r.shaderVariators.MaterialNormal=u;var v=new n("highlight",["vsNormal","fsNormal"],null,r,i,e,s);v.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),v.addDefine("FlipV","FLIPV"),v.addDefine("Instanced","INSTANCED"),v.addDefine("vvSize","VV_SIZE"),r.shaderVariators.MaterialHighlight=v;var f=new a(s,e.vsDepth,e.fsDepth,l.Default3D,["BIAS_SHADOWMAP 1"]),h=new a(s,e.vsDepthTextured,e.fsDepthTextured,l.Default3D,["BIAS_SHADOWMAP 1"]),S=new a(s,e.vsDepth,e.fsDepth,l.Default3D),p=new a(s,e.vsDepthTextured,e.fsDepthTextured,l.Default3D),g=new a(s,e.vsNormal,e.fsNormal,l.Default3D),x=new a(s,e.vsNormalTextured,e.fsNormalTextured,l.Default3D),m=new a(s,e.vsHighlight,e.fsHighlight,l.Default3D),b=new a(s,e.vsHighlightTextured,e.fsHighlightTextured,l.Default3D);r.add("depthShadowMap",f),r.add("depthTexturedShadowMap",h),r.add("depth",S),r.add("depthTextured",p),r.add("normal",g),r.add("normalTextured",x),r.add("highlight",m),r.add("highlightTextured",b),i.add("fsDepth",{source:e.fsDepth}),i.add("fsDepthTextured",{source:e.fsDepthTextured}),i.add("fsDepthShadowMap",{source:e.fsDepthShadowMap,defines:["BIAS_SHADOWMAP 1"]}),i.add("fsDepthTexturedShadowMap",{source:e.fsDepthTextured,defines:["BIAS_SHADOWMAP 1"]}),i.add("vsDepth",{source:e.vsDepth}),i.add("fsNormal",{source:e.fsNormal})},g});