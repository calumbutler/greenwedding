// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./RibbonLineMaterial.xml","./internal/MaterialUtil","../lib/Util","../lib/gl-matrix","../lib/RenderSlot","../../../webgl/Program","../lib/DefaultVertexAttributeLocations","../lib/DefaultVertexBufferLayouts","../../../webgl/Util"],function(t,e,i,n,r,o,a,s,l,f){function c(t,e,i,n,r,o){var a=t.length/3,s=t[0],l=t[1],f=t[2],c=0;n&&(s=n[0]*s+n[4]*l+n[8]*f+n[12],l=n[1]*s+n[5]*l+n[9]*f+n[13],f=n[2]*s+n[6]*l+n[10]*f+n[14]);var d=s,u=l,m=f,b=t[3],p=t[4],h=t[5];n&&(b=n[0]*b+n[4]*p+n[8]*h+n[12],p=n[1]*b+n[5]*p+n[9]*h+n[13],h=n[2]*b+n[6]*p+n[10]*h+n[14]);for(var g=0;a>g;g++){var v=3*g;a-1>g&&(b=t[v+3],p=t[v+4],h=t[v+5],n&&(b=n[0]*b+n[4]*p+n[8]*h+n[12],p=n[1]*b+n[5]*p+n[9]*h+n[13],h=n[2]*b+n[6]*p+n[10]*h+n[14])),c+=Math.sqrt((d-s)*(d-s)+(u-l)*(u-l)+(m-f)*(m-f)),r[o++]=d,r[o++]=u,r[o++]=m,r[o++]=c,r[o++]=0===g?-1.2:-1,r[o++]=s,r[o++]=l,r[o++]=f,r[o++]=b,r[o++]=p,r[o++]=h,r[o++]=e[0],r[o++]=e[1],r[o++]=e[2],r[o++]=e[3],r[o++]=i[0],r[o++]=d,r[o++]=u,r[o++]=m,r[o++]=c,r[o++]=0===g?1.2:1,r[o++]=s,r[o++]=l,r[o++]=f,r[o++]=b,r[o++]=p,r[o++]=h,r[o++]=e[0],r[o++]=e[1],r[o++]=e[2],r[o++]=e[3],r[o++]=i[0],g>0&&a-1>g&&(r[o++]=d,r[o++]=u,r[o++]=m,r[o++]=c,r[o++]=-1.2,r[o++]=s,r[o++]=l,r[o++]=f,r[o++]=b,r[o++]=p,r[o++]=h,r[o++]=e[0],r[o++]=e[1],r[o++]=e[2],r[o++]=e[3],r[o++]=i[0],r[o++]=d,r[o++]=u,r[o++]=m,r[o++]=c,r[o++]=1.2,r[o++]=s,r[o++]=l,r[o++]=f,r[o++]=b,r[o++]=p,r[o++]=h,r[o++]=e[0],r[o++]=e[1],r[o++]=e[2],r[o++]=e[3],r[o++]=i[0]),s=d,l=u,f=m,d=b,u=p,m=h}}function d(t,e,i,n){for(var r,o,a,s=t.length/3,l=0,f=t[0],c=t[1],d=t[2],u=0;s>u;u++){var m=3*u;r=f,o=c,a=d,f=t[m],c=t[m+1],d=t[m+2],e&&(f=e[0]*f+e[4]*c+e[8]*d+e[12],c=e[1]*f+e[5]*c+e[9]*d+e[13],d=e[2]*f+e[6]*c+e[10]*d+e[14]),l+=Math.sqrt((f-r)*(f-r)+(c-o)*(c-o)+(d-a)*(d-a)),i[n++]=f,i[n++]=c,i[n++]=d,i[n++]=l,i[n++]=-1,i[n++]=f,i[n++]=c,i[n++]=d,i[n++]=l,i[n++]=1}}var u=[255,255,255,255],m=[0,0,0,0],b=r.vec3d,p=r.vec2d,h=r.mat4d,g=b.create(),v=b.create(),L=b.create(),y=b.create(),w=p.create(),P=p.create(),x=b.create(),A=b.create(),R=function(t,e){i.basicMaterialConstructor(this,e);var r=n.VertexAttrConstants;t=t||{},t.color=t.color||[1,1,1,1],t.width=t.width||0,t.type=t.type||"screen",t.join=t.join||"miter",t.miterLimit="miter"===t.join?t.miterLimit||5:t.miterLimit;var o="wall"===t.type?2:4,a=2,s=l.Pos3Tex;"wall"!==t.type&&(s=[{name:"position",count:3,type:5126,offset:0,stride:64,normalized:!1},{name:"uv0",count:2,type:5126,offset:12,stride:64,normalized:!1},{name:"auxpos1",count:3,type:5126,offset:20,stride:64,normalized:!1},{name:"auxpos2",count:3,type:5126,offset:32,stride:64,normalized:!1},{name:"color",count:4,type:5126,offset:44,stride:64,normalized:!1},{name:"size",count:1,type:5126,offset:60,stride:64,normalized:!1}]),this.canBeMerged=!1,this.getParams=function(){return t},this.getParameterValues=function(){var e={color:t.color,width:t.width,type:t.type,join:t.join,polygonOffset:t.polygonOffset};return"miter"===t.join&&(e.miterLimit=t.miterLimit),e},this.setParameterValues=function(e){for(var i in e)e.hasOwnProperty(i)&&(n.assert("type"!==i,"RibbonLineMaterial: type cannot be changed after creation"),t[i]=e[i]);this.notifyDirty("matChanged")},this.dispose=function(){},this.getOutputAmount=function(t){var e=t/2+1,i=(e-2)*o+2*a;return i*f.getStride(s)/4},this.getVertexBufferLayout=function(){return s},this.fillInterleaved=function(e,i,n,o,a,s){var l=e.vertexAttr[r.POSITION].data,f=e.vertexAttr[r.COLOR]?e.vertexAttr[r.COLOR].data:u,b=e.vertexAttr[r.SIZE]?e.vertexAttr[r.SIZE].data:m,p=e.faces&&e.faces.indices&&e.faces.indices.position;p&&p.length!=2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices"),"wall"===t.type?d(l,i,a,s):c(l,f,b,i,a,s)},this.intersect=function(e,i,o,a,s,l,f){if(a.isSelection){for(var c,d,u,m,p=e.getData().getVertexAttr(r.position).position.data,R=e.getData().getVertexAttr(r.SIZE).size,E=R&&R.data[0],D=E+t.width,O=Number.MAX_VALUE,j=a.camera,M=a.point,V=0;V<p.length-5;V+=3){if(g[0]=p[V],g[1]=p[V+1],g[2]=p[V+2],h.multiplyVec3(o,g),v[0]=p[V+3],v[1]=p[V+4],v[2]=p[V+5],h.multiplyVec3(o,v),j.projectPoint(g,w),j.projectPoint(v,P),w[2]<0&&P[2]>0)b.subtract(g,v,L),d=j.frustumPlanes,u=-(b.dot(d[4],g)+d[4][3]),m=u/b.dot(L,d[4]),b.scale(L,m,L),b.add(g,L,g),j.projectPoint(g,w);else if(w[2]>0&&P[2]<0)b.subtract(v,g,L),d=j.frustumPlanes,u=-(b.dot(d[4],v)+d[4][3]),m=u/b.dot(L,d[4]),b.scale(L,m,L),b.add(v,L,v),j.projectPoint(v,P);else if(w[2]<0&&P[2]<0)continue;var S=n.projectVectorVector2D(w,P,M);O>S&&(O=S,c=V,b.set(g,x),b.set(v,A))}var U=4,I=a.p0,C=a.p1;if(D/2+U>O){var _=n.linelineDistance3D(x,A,I,C),z=Number.MAX_VALUE;if(_[0]){var T=_[2];b.subtract(T,I,y);var N=b.length(y);z=.98*N/b.dist(I,C)}f(z,y)}}},this.getGLMaterials=function(){return{color:E,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:void 0}},this.getAllTextureIds=function(){return[]}},E=function(e,n){i.basicGLMaterialConstructor(this,e);var r=t.clone(e.getParams());r.miterLimit="miter"===r.join?r.miterLimit:0,delete r.join;var a=n.get("ribbonLine_"+r.type);this.updateParameters=function(){var t=e.getParams();r.polygonOffset=t.polygonOffset,r.color=t.color,r.width=t.width,r.miterLimit="miter"===t.join?t.miterLimit:0},this.beginSlot=function(t){return t===o.TRANSPARENT_MATERIAL},this.getProgram=function(){return a},this.bind=function(t,e){t.bindProgram(a),a.setUniform4fv("eColor",r.color),a.setUniform1f("miterLimit",r.miterLimit),a.setUniform1f("nearPlane",e.nearFar[0]),"screen"===r.type?(a.setUniform2fv("screenSize",[e.viewport[2],e.viewport[3]]),a.setUniform1f("extLineWidth",r.width*e.pixelRatio)):a.setUniform1f("extLineWidth",r.width),r.polygonOffset&&(t.setPolygonOffsetFillEnabled(!0),t.setPolygonOffset(0,-4)),t.setBlendingEnabled(!0),t.setFaceCullingEnabled(!1),r.color[3]<1&&t.setDepthWriteEnabled(!1)},this.release=function(t){r.polygonOffset&&t.setPolygonOffsetFillEnabled(!1),t.setBlendingEnabled(!1),t.setDepthWriteEnabled(!0)},this.bindView=function(t,e){i.bindView(e.origin,e.view,a)},this.bindInstance=function(t,e){a.setUniformMatrix4fv("model",e.transformation)},this.getDrawMode=function(t){var e=t.gl;return e.TRIANGLE_STRIP}};return R.loadShaders=function(t,i,n,r){t._parse(e);var o=new a(r,t.vsRibbonLine,t.fsRibbonLine,s.Default3D,["SCREENSCALE"]),l=new a(r,t.vsRibbonLine,t.fsRibbonLine,s.Default3D),f=new a(r,t.vsRibbonLine,t.fsRibbonLine,s.Default3D,["WALL"]);n.add("ribbonLine_screen",o),n.add("ribbonLine_strip",l),n.add("ribbonLine_wall",f)},R});