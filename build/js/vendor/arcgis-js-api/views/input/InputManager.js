// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./keys","./recognizers","../../core/Logger"],function(e,t,r,n,i){var o=i.getLogger("esri.views.input"),a=function(){function e(e,t){this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._currentPropagation=null,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this.primaryKey=r.primaryKey,this._browserEvents=e,this._browserEvents.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers(t)}return e.prototype.installHandlers=function(e,t){var r=this;if(this._nameToGroup[e])return void o.error("There is already an InputHandler group registered under the name `"+e+"`");if(0===t.length)return void o.error("Can't register a group of zero handlers");var n={name:e,handlers:t.map(function(e,t){return{handler:e,active:!0,removed:!1,priorityIndex:0,eventCallback:null,uninstallCallback:null}})};this._nameToGroup[e]=n;for(var i=function(e){var t=n.handlers[e];a._handlers.push(t),t.handler.onInstall({updateDependencies:function(){r.updateDependencies()},emit:function(e,n){r._emitInputEvent(t.priorityIndex,e,n)},setPointerCapture:function(e,i){r._setPointerCapture(n,t,e,i)},setEventCallback:function(e){t.eventCallback=e},setUninstallCallback:function(e){t.uninstallCallback=e}})},a=this,s=n.handlers.length-1;s>=0;s--)i(s);this.updateDependencies()},e.prototype.uninstallHandlers=function(e){var t=this._nameToGroup[e];return t?(t.handlers.forEach(function(e){e.removed=!0,e.uninstallCallback()}),delete this._nameToGroup[e],void(this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers())):void o.error("There is no InputHandler group registered under the name `"+e+"`")},e.prototype.hasHandlers=function(e){return void 0!==this._nameToGroup[e]},e.prototype.updateDependencies=function(){var e=new Set,t=new Set;this._handlersPriority=[];for(var n=this._handlers.length-1;n>=0;n--){var i=this._handlers[n];i.priorityIndex=n,this._handlersPriority.push(i)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(var n=this._handlersPriority.length-1;n>=0;n--){var o=this._handlersPriority[n];o.priorityIndex=n;var a=o.handler.hasSideEffects;if(!a)for(var s=0,d=o.handler.outgoingEventTypes;s<d.length;s++){var h=d[s];if(e.has(h)){a=!0;break}}if(a)for(var l=0,p=o.handler.incomingEventMatches;l<p.length;l++){var u=p[l];e.add(u.eventType);for(var c=0,v=u.keyModifiers;c<v.length;c++){var f=v[c];r.isSystemModifier(f)||t.add(f)}}o.active=a}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this._browserEvents&&(this._browserEvents.activeEvents=this._sourceEvents)},e.prototype._onEventReceived=function(e,t){if("pointer-capture-lost"===e){var r=t;this._pointerCaptures["delete"](r["native"].pointerId)}this._updateKeyModifiers(e,t),this._emitInputEventFromSource(e,t)},e.prototype._updateKeyModifiers=function(e,t){var r=this;if(t){if("key-down"===e||"key-up"===e){var n=t,i=n.key;this._keyModifiers.has(i)&&("key-down"===e?this._activeKeyModifiers.add(i):this._activeKeyModifiers["delete"](i))}var o=t["native"],a=function(e,t){t?r._activeKeyModifiers.add(e):r._activeKeyModifiers["delete"](e)};a("Alt",!(!o||!o.altKey)),a("Ctrl",!(!o||!o.ctrlKey)),a("Shift",!(!o||!o.shiftKey)),a("Meta",!(!o||!o.metaKey)),a("Primary",this._activeKeyModifiers.has(this.primaryKey))}},e.prototype._installRecognizers=function(e){e||(e=n.defaults.map(function(e){return new e})),e.length>0&&this.installHandlers("default",e)},e.prototype._setPointerCapture=function(e,t,r,n){var i=e.name+"-"+t.priorityIndex,o=this._pointerCaptures[r.pointerId]||new Set;this._pointerCaptures[r.pointerId]=o,n?(o.add(i),1===o.size&&this._browserEvents&&this._browserEvents.setPointerCapture(r,!0)):(o["delete"](i),0===o.size&&(this._pointerCaptures["delete"](r.pointerId),this._browserEvents&&this._browserEvents.setPointerCapture(r,!1)))},e.prototype._garbageCollectRemovedHandlers=function(){this._handlers=this._handlers.filter(function(e){return!e.removed}),this.updateDependencies()},e.prototype._emitInputEventFromSource=function(e,t){this._emitInputEvent(0,e,t)},e.prototype._emitInputEvent=function(e,t,r){var n=new s(t,r);return this._currentPropagation?void this._currentPropagation.addedEvents.push(n):void this._doNewPropagation(e,n)},e.prototype._doNewPropagation=function(e,t){this._currentPropagation={events:[t],addedEvents:[],currentHandler:this._handlersPriority[e],needsHandlerGarbageCollect:!1};for(var r=this._currentPropagation;r.currentHandler;){if(r.currentHandler.removed)r.needsHandlerGarbageCollect=!0;else{var n=r.events,i=[];r.addedEvents=[];for(var o=0;o<n.length;o++){var a=n[o];r.currentHandler.active&&r.currentHandler.eventCallback(a,this._activeKeyModifiers),a.shouldStopPropagation()||i.push(a)}r.events=i.concat(r.addedEvents)}r.currentHandler=this._handlersPriority[r.currentHandler.priorityIndex+1]}r.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this._currentPropagation=null},e.prototype._compareHandlerPriority=function(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;for(var r=0,n=e.handler.incomingEventMatches;r<n.length;r++)for(var i=n[r],o=function(e){if(i.eventType!==e.eventType)return"continue";var t=i.keyModifiers.filter(function(t){return-1!==e.keyModifiers.indexOf(t)}),r=t.length===i.keyModifiers.length,n=t.length===e.keyModifiers.length;return r!==n?{value:i.keyModifiers.length>e.keyModifiers.length?-1:1}:void 0},a=0,s=t.handler.incomingEventMatches;a<s.length;a++){var d=s[a],h=o(d);if("object"==typeof h)return h.value}return e.priorityIndex>t.priorityIndex?-1:1},e.prototype._sortHandlersPriority=function(e){for(var t=[],r=0,n=e;r<n.length;r++){for(var i=n[r],o=0;o<t.length&&this._compareHandlerPriority(i,t[o])>=0;)o++;t.splice(o,0,i)}return t},e}();t.InputManager=a;var s=function(){function e(e,t){this.type=e,this.data=t,this._stopPropagation=!1,this.timestamp=Date.now()}return e.prototype.stopPropagation=function(){this._stopPropagation=!0},e.prototype.shouldStopPropagation=function(){return this._stopPropagation},e}()});