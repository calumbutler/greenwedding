// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix/mat4","../../../core/libs/gl-matrix/mat3","../../../core/libs/gl-matrix/vec4","../../../core/libs/gl-matrix/vec3","dojo/text!./shaders/solidFillShader.vs.glsl","dojo/text!./shaders/solidFillShader.fs.glsl","dojo/text!./shaders/patternFillShader.vs.glsl","dojo/text!./shaders/patternFillShader.fs.glsl","dojo/text!./shaders/fillOutlineShader.vs.glsl","dojo/text!./shaders/fillOutlineShader.fs.glsl","../../webgl/Program","../../webgl/VertexArrayObject","../GeometryUtils"],function(t,r,i,e,o,l,a,n,s,f,_,u,m,h,g){var d=1/65536,p=function(){function t(){this._outlineAttributeLocations={a_pos:0,a_offset:1,a_xnormal:2},this._fillAttributeLocations={a_pos:0},this._initialized=!1,this._viewProjMat=i.create(),this._offsetVector=l.create(),this._patternMatrix=e.create(),this._color=o.create(),this._outlineColor=o.create()}return t.prototype.render=function(t,r,o,l,a,n,s,f,_,u,m){this._initialized||this._initialize(t);var h=s.getPaintValue("fill-pattern",o),p=void 0!==h;if(!p||0!==a){var c=s.getPaintValue("fill-antialias",o)&&!p,v=m*s.getPaintValue("fill-opacity",o),x=s.getPaintValue("fill-color",o),y=!1;if(!p){var P=x[3]*v;1===P&&0===a&&(y=!0),1>P&&1===a&&(y=!0)}if(y||0!==a){var b=n.tileTransform.transform,V=512,A=n.coordRange/V,O=s.getPaintValue("fill-translate",o);if(0!==O[0]||0!==O[1]){i.copy(this._viewProjMat,n.tileTransform.transform);var M=O[0],j=O[1],F=0,U=0,w=(1<<n.key.level)/Math.pow(2,o)*A,z=s.getPaintValue("fill-translate-anchor",o);if(1===z){var C=Math.sin(g.C_DEG_TO_RAD*-l),T=Math.cos(g.C_DEG_TO_RAD*-l);F=w*(M*T-j*C),U=w*(M*C+j*T)}else F=w*M,U=w*j;this._offsetVector[0]=F,this._offsetVector[1]=U,this._offsetVector[2]=0,i.translate(this._viewProjMat,this._viewProjMat,this._offsetVector),b=this._viewProjMat}var E=this._getTrianglesVAO(t,n);if(E){if(p){if(1===a){var S=f.getMosaicItemPosition(h,!0);if(S){var L=512,B=n.coordRange/L,w=B/Math.pow(2,Math.round(o)-n.key.level)/u;e.identity(this._patternMatrix);var D=1/(S.size[0]*w),R=1/(S.size[1]*w);this._patternMatrix[0]=D,this._patternMatrix[4]=R,t.bindVAO(E),f.bind(t,9729,0),t.bindProgram(this._patternFillProgram),this._patternFillProgram.setUniformMatrix4fv("u_transformMatrix",b),this._patternFillProgram.setUniform2fv("u_normalized_origin",n.tileTransform.displayCoord),this._patternFillProgram.setUniform1f("u_depth",s.z),this._patternFillProgram.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix),this._patternFillProgram.setUniform1f("u_opacity",v),this._patternFillProgram.setUniform2f("u_pattern_tl",S.tl[0],S.tl[1]),this._patternFillProgram.setUniform2f("u_pattern_br",S.br[0],S.br[1]),this._patternFillProgram.setUniform1i("u_texture",0),t.drawElements(4,r.triangleElementCount,5125,12*r.triangleElementStart),t.bindVAO()}}}else if(y){var P=x[3]*v;this._color[0]=P*x[0],this._color[1]=P*x[1],this._color[2]=P*x[2],this._color[3]=P,t.bindVAO(E),t.bindProgram(this._solidFillProgram),this._solidFillProgram.setUniformMatrix4fv("u_transformMatrix",b),this._solidFillProgram.setUniform2fv("u_normalized_origin",n.tileTransform.displayCoord),this._solidFillProgram.setUniform1f("u_depth",s.z+d),this._solidFillProgram.setUniform4fv("u_color",this._color),t.drawElements(4,r.triangleElementCount,5125,12*r.triangleElementStart),t.bindVAO()}if(c&&r.outlineElementCount>0){if(1!==a)return;var G=s.getPaintValue("fill-outline-color",o);if(0===G[3]){if(1!==this._color[3])return;G=x}var I=.75/u,k=G[3]*v;this._outlineColor[0]=k*G[0],this._outlineColor[1]=k*G[1],this._outlineColor[2]=k*G[2],this._outlineColor[3]=k;var q=this._getOutlineVAO(t,n);if(!q)return;t.bindVAO(q),t.bindProgram(this._outlineProgram),this._outlineProgram.setUniformMatrix4fv("u_transformMatrix",b),this._outlineProgram.setUniformMatrix4fv("u_extrudeMatrix",_),this._outlineProgram.setUniform2fv("u_normalized_origin",n.tileTransform.displayCoord),this._outlineProgram.setUniform1f("u_depth",s.z),this._outlineProgram.setUniform1f("u_outline_width",I),this._outlineProgram.setUniform4fv("u_color",this._outlineColor),t.drawElements(4,r.outlineElementCount,5125,12*r.outlineElementStart),t.bindVAO()}}}}},t.prototype._initialize=function(t){if(this._initialized)return!0;var r={a_pos:0},i=new m(t,a,n,r);if(!i)return!1;var e={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]},o=new m(t,s,f,this._fillAttributeLocations);if(!o)return!1;var l=new m(t,_,u,this._outlineAttributeLocations),h={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}]};return this._solidFillProgram=i,this._patternFillProgram=o,this._trianglesVertexAttributes=e,this._outlineProgram=l,this._outlineVertexAttributes=h,this._initialized=!0,!0},t.prototype._getTrianglesVAO=function(t,r){if(r.polygonTrianglesVertexArrayObject)return r.polygonTrianglesVertexArrayObject;var i=r.polygonTrianglesVertexBuffer,e=r.polygonTrianglesIndexBuffer;return i&&e?(r.polygonTrianglesVertexArrayObject=new h(t,this._fillAttributeLocations,this._trianglesVertexAttributes,{geometry:i},e),r.polygonTrianglesVertexArrayObject):null},t.prototype._getOutlineVAO=function(t,r){if(r.polygonOutlineVertexArrayObject)return r.polygonOutlineVertexArrayObject;var i=r.polygonOutlinesVertexBuffer,e=r.polygonOutlinesIndexBuffer;return i&&e?(r.polygonOutlineVertexArrayObject=new h(t,this._outlineAttributeLocations,this._outlineVertexAttributes,{geometry:i},e),r.polygonOutlineVertexArrayObject):null},t}();return p});