// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/_base/kernel","../core/declare","dojo/_base/config","dojo/Deferred","dojo/_base/lang","dojo/dom-attr","dojo/keys","dijit/registry","dijit/Dialog","../kernel","../core/lang","../core/domUtils","./Credential","./IdentityManagerBase","dojo/i18n!./nls/identity","dojo/query","dijit/form/Button","dijit/form/Form","dijit/form/ValidationTextBox"],function(e,t,i,r,n,s,o,d,a,l,c,_,u,g,b){var v=t([g],{declaredClass:"esri.IdentityManager",constructor:function(e){n.mixin(this,e)},_dialogContent:"<div data-dojo-type='dijit.form.Form' data-dojo-props='\"class\":\"esriIdForm\"'><div class='dijitDialogPaneContentArea'><div style='padding-bottom: 5px; word-wrap: break-word;'>{info}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='esriErrorMsg' style='display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'>{invalidUser}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><table style='width: 100%;'><tr><td><label>{lblUser}</label><br/>"+'<input data-dojo-type=\'dijit.form.ValidationTextBox\' data-dojo-props=\'type:"text", "class":"esriIdUser", required:true, trim:true, style:"width: 100%;", autocapitalize:"none", autocorrect:"off", spellcheck:false\' /></td></tr><tr><td><label>{lblPwd}</label><br/><input data-dojo-type=\'dijit.form.ValidationTextBox\' data-dojo-props=\'type:"password", "class":"esriIdPwd", required:true, style:"width: 100%;"\' /></td></tr></table></div><div class=\'dijitDialogPaneActionBar\'><button data-dojo-type=\'dijit.form.Button\' data-dojo-props=\'type:"button", "class":"esriIdSubmit"\'>{lblOk}</button><button data-dojo-type=\'dijit.form.Button\' data-dojo-props=\'type:"button", "class":"esriIdCancel"\'>{lblCancel}</button></div></div>',signIn:function(e,t,n){this._nls||(this._nls=b),this._loginDialog||(this._loginDialog=this.dialog=this._createLoginDialog(),this.emit("dialog-create"));var o=this._loginDialog,d=n&&n.error,a=n&&n.token,l=new r(function(){o.onCancel()});if(o.open){var c=new Error("BUSY");return c.code="IdentityManager.1",c.log=i.isDebug,l.reject(c),l.promise}return _.hide(o.errMsg_),d&&403==d.code&&a&&(s.set(o.errMsg_,"innerHTML",this._nls.forbidden),_.show(o.errMsg_)),o.dfd_=l,o.serverInfo_=t,o.resUrl_=e,o.admin_=n&&n.isAdmin,s.set(o.resLink_,{title:e,innerHTML:"("+(this.getResourceName(e)||this._nls.lblItem)+")"}),s.set(o.serverLink_,{title:t.server,innerHTML:(-1!==t.server.toLowerCase().indexOf("arcgis.com")?"ArcGIS Online":t.server)+" "}),o.txtPwd_.set("value",""),o.show(),l.promise},_createLoginDialog:function(){var t=this._nls,r=c.substitute(t,this._dialogContent);r=c.substitute({resource:"<span class='resLink' style='word-wrap: break-word;'></span>",server:"<span class='serverLink' style='word-wrap: break-word;'></span>"},r);var n="esriIdentityDialog--visible",g=new a({title:t.title,content:r,"class":" esri-widget esriSignInDialog esriIdentityDialog",style:"width: 18em;",esriIdMgr_:this,onShow:function(){this.domNode.classList.add(n)},onHide:function(){this.domNode.classList.remove(n)},keypressed_:function(e){e.charOrCode===o.ENTER&&this.execute_()},execute_:function(){var e=this.txtUser_.get("value"),i=this.txtPwd_.get("value"),r=this.dfd_,n=this;if(this.form_.validate()&&e&&i){this.btnSubmit_.set("label",t.lblSigning);var o=l.id.findCredential(n.resUrl_,e),d=function(i){n.btnSubmit_.set("label",t.lblOk),n.btnSubmit_.set("disabled",!1),_.hide(n.errMsg_),n.hide(),a._DialogLevelManager.hide(n);var s=n.serverInfo_;n.dfd_=n.serverInfo_=n.generateDfd_=n.resUrl_=null;var d,l,g,b=o;i&&(d=i.token,l=c.isDefined(i.expires)?Number(i.expires):null,g=!!i.ssl,b?(b.userId=e,b.token=d,b.expires=l,b.validity=i.validity,b.ssl=g,b.creationTime=(new Date).getTime()):b=new u({userId:e,server:s.server,token:d,expires:l,ssl:g,isAdmin:n.admin_,validity:i.validity})),r.resolve(b)};if(o&&!o._enqueued)return void d();n.btnSubmit_.set("disabled",!0),n.generateDfd_=l.id.generateToken(this.serverInfo_,{username:e,password:i},{isAdmin:this.admin_}).then(d).then(null,function(e){n.btnSubmit_.set("disabled",!1),n.generateDfd_=null,n.btnSubmit_.set("label",t.lblOk),s.set(n.errMsg_,"innerHTML",e&&e.code?t.invalidUser:t.noAuthService),_.show(n.errMsg_)})}},cancel_:function(){g.generateDfd_&&g.generateDfd_.cancel();var e=g.dfd_,t=g.resUrl_,r=g.serverInfo_;g.btnSubmit_.set("disabled",!1),g.dfd_=g.serverInfo_=g.generateDfd_=g.resUrl_=null,_.hide(g.errMsg_),a._DialogLevelManager.hide(g),g.esriIdMgr_.emit("dialog-cancel",{resourceUrl:t,serverInfo:r});var n=new Error("ABORTED");n.code="IdentityManager.2",n.log=i.isDebug,e.reject(n)}}),b=g.domNode;return g.form_=d.byNode(e.query(".esriIdForm",b)[0]),g.txtUser_=d.byNode(e.query(".esriIdUser",b)[0]),g.txtPwd_=d.byNode(e.query(".esriIdPwd",b)[0]),g.btnSubmit_=d.byNode(e.query(".esriIdSubmit",b)[0]),g.btnCancel_=d.byNode(e.query(".esriIdCancel",b)[0]),g.resLink_=e.query(".resLink",b)[0],g.serverLink_=e.query(".serverLink",b)[0],g.errMsg_=e.query(".esriErrorMsg",b)[0],g.connect(g.txtUser_,"onKeyPress",g.keypressed_),g.connect(g.txtPwd_,"onKeyPress",g.keypressed_),g.connect(g.btnSubmit_,"onClick",g.execute_),g.connect(g.btnCancel_,"onClick",g.onCancel),g.connect(g,"onCancel",g.cancel_),g}});return v});