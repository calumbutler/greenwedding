// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/_base/window","dojo/_base/lang","dojo/_base/url","dojo/io-query","../config","./lang","./sniff","./Logger","./Error"],function(r,e,t,n,i,o,u,l,a,s,p){function f(r){var e={path:null,query:null},t=new i(r),n=r.indexOf("?");return null===t.query?e.path=r:(e.path=r.substring(0,n),e.query=o.queryToObject(t.query)),t.fragment&&(e.hash=t.fragment,null===t.query&&(e.path=e.path.substring(0,e.path.length-(t.fragment.length+1)))),e}function c(r,e){void 0===r&&(r=!1),void 0===e&&(e=!0);var t,n=K.proxyUrl;if("string"==typeof r){t=T(r);var i=x(r);i&&(n=i.proxyUrl)}else t=!!r;if(!n)throw J.warn(M),new p("urlutils:proxy-not-set",M);var o;if(t&&e&&E()){var u=z(n);q(u)&&(n=u,o=1)}var l=f(n);return l._xo=o,l}function h(r){var e,t,i=x(r);if(i){var u=v(i.proxyUrl);e=u.path,t=u.query?o.queryToObject(u.query):null}else if(K.forceProxy){var u=c();e=u.path,t=u.query}if(e){var l=f(r);r=e+"?"+l.path;var a=o.objectToQuery(n.mixin(t||{},l.query));a&&(r=r+"?"+a)}return r}function v(r){var e=r.indexOf("?");return-1!==e?(Z.path=r.slice(0,e),Z.query=r.slice(e+1)):(Z.path=r,Z.query=null),Z}function g(r){return r=v(r).path,r=I(r),r=A(r,!0),r=r.toLowerCase()}function d(r){for(var e={proxyUrl:r.proxyUrl,urlPrefix:g(r.urlPrefix)},t=K.proxyRules,n=e.urlPrefix,i=t.length,o=0;o<t.length;o++){var u=t[o].urlPrefix;if(0===n.indexOf(u)){if(n.length===u.length)return-1;i=o;break}0===u.indexOf(n)&&(i=o+1)}return t.splice(i,0,e),i}function x(r){for(var e=K.proxyRules,t=g(r),n=0;n<e.length;n++)if(0===t.indexOf(e[n].urlPrefix))return e[n]}function y(r,e){return r=U(r),e=U(e),A(r)===A(e)}function U(r){r=P(r);var e=r.indexOf("/sharing");return e>0?r.substring(0,e):r.replace(/\/+$/,"")}function m(r,e,t){void 0===t&&(t=!1);var n=X(r),i=X(e);return t||n.scheme===i.scheme?n.host.toLowerCase()===i.host.toLowerCase()&&n.port===i.port:!1}function q(r){return a("esri-phonegap")?!0:a("esri-cors")?null!=O(r):!1}function O(r,t){void 0===t&&(t=!1),"string"==typeof r&&(r=R(r)?X(r):e.appUrl);for(var n=K.corsEnabledServers||[],i=0;i<n.length;i++){var o=n[i],u=void 0;u="string"==typeof o?w(o):o.host?w(o.host):[];for(var l=0;l<u.length;l++)if(m(r,u[l]))return t?i:o}return t?-1:null}function w(r){return e.corsServersUrlCache[r]||(B(r)||k(r)?e.corsServersUrlCache[r]=[new i(b(r))]:e.corsServersUrlCache[r]=[new i("http://"+r),new i("https://"+r)]),e.corsServersUrlCache[r]}function b(r,t,n){return void 0===t&&(t=e.appBaseUrl),k(r)?n&&n.preserveProtocolRelative?r:"file"===e.appUrl.scheme?"https:"+r:e.appUrl.scheme+":"+r:B(r)?r:j("/"===r[0]?D(t):t,r)}function C(r,t){if(void 0===t&&(t=e.appBaseUrl),!R(r))return r;for(var n=P(r),i=n.toLowerCase(),o=P(t).toLowerCase().replace(/\/+$/,""),u=function(r,e,t){return t=r.indexOf(e,t),-1===t?r.length:t},l=u(i,"/",i.indexOf("//")+2),a=-1;i.slice(0,l+1)===o.slice(0,l)+"/"&&(a=l+1,l!==i.length);)l=u(i,"/",l+1);if(-1===a)return r;r=n.slice(a);var s=o.slice(a-1).replace(/[^\/]+/g,"").length;if(s>0)for(var p=0;s>p;p++)r="../"+r;else r="./"+r;return r}function P(r){return r=b(r),r=Q(r),r=W(r)}function j(){for(var r=[],e=0;e<arguments.length;e++)r[e-0]=arguments[e];if(r&&r.length){var t=[];if(R(r[0])){var n=r[0],i=n.indexOf("//");t.push(n.slice(0,i+1)),_(r[0])&&(t[0]+="/"),r[0]=n.slice(i+2)}else"/"===r[0][0]&&t.push("");for(var o=r.reduce(function(r,e){return r.concat(e.split("/"))},[]),u=0;u<o.length;u++){var l=o[u];".."===l&&t.length>0?t.pop():!l||"."===l&&0!==t.length||t.push(l)}return t.join("/")}}function S(r){if(L(r))return null;var e=r.indexOf("://");if(-1===e&&k(r))e=2;else{if(-1===e)return null;e+=3}var t=r.indexOf("/",e);return-1===t?r:r.slice(0,t)}function R(r){return k(r)||B(r)}function L(r){return"data:"===r.slice(0,5)}function k(r){return r&&"/"===r[0]&&"/"===r[1]}function B(r){return N.test(r)}function T(r){return/^\s*https:/i.test(r)||k(r)&&"https"===e.appUrl.scheme}function $(r){return V.test(r)||k(r)&&"http"===e.appUrl.scheme}function _(r){return Y.test(r)}function z(r){return k(r)?"https:"+r:r.replace(V,"https:")}function E(){return"https"===e.appUrl.scheme}function A(r,e){return void 0===e&&(e=!1),k(r)?r.slice(2):(r=r.replace(N,""),e&&r.length>1&&"/"===r[0]&&"/"===r[1]&&(r=r.slice(2)),r)}function D(r){var e=r.indexOf("//"),t=r.indexOf("/",e+2);return-1===t?r:r.slice(0,t)}function I(r){return r&&"/"===r[r.length-1]?r:r+"/"}function W(r){return r.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function Q(r){var t=u.request.httpsDomains;if(!$(r)||!E()&&!_(e.appBaseUrl))return r;var n,i=r.indexOf("/",7);return n=-1===i?r:r.slice(0,i),(l.endsWith(n,""+e.appUrl.host+(null!=e.appUrl.port?":"+e.appUrl.port:""))||t&&t.some(function(r){return l.endsWith(n,r)}))&&(r=z(r)),r}function X(r){return"string"==typeof r?new i(b(r)):(r.scheme||(r.scheme=e.appUrl.scheme),r)}function F(r,e){var t=e&&e.url&&e.url.path;return r&&t?b(r,t,{preserveProtocolRelative:!0}):r}function G(r,e){if(!r)return r;r=b(r);var t=e&&e.url&&e.url.path;return t&&(r=C(r,t)),r}var H=t.global,J=s.getLogger("esri.core.urlUtils"),K=u.request,M="esri/config: esriConfig.request.proxyUrl is not set. If making a request to a CORS-enabled\n server, please push the domain into esriConfig.request.corsEnabledServers.",N=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,V=/^\s*http:/i,Y=/^\s*file:/i;e.appUrl=new i(H.location),e.corsServersUrlCache={},e.appBaseUrl=function(){var r=e.appUrl.path,t=r.substring(0,r.lastIndexOf(r.split("/")[r.split("/").length-1])),n=e.appUrl.scheme+"://"+e.appUrl.host+(null!=e.appUrl.port?":"+e.appUrl.port:"");return""+n+t}(),e.urlToObject=f,e.getProxyUrl=c,e.addProxy=h;var Z={path:"",query:""};e.addProxyRule=d,e.getProxyRule=x,e.hasSamePortal=y,e.hasSameOrigin=m,e.canUseXhr=q,e.getCorsConfig=O,e.makeAbsolute=b,e.makeRelative=C,e.normalize=P,e.join=j,e.getOrigin=S,e.isAbsolute=R,e.isDataProtocol=L,e.isProtocolRelative=k,e.read=F,e.write=G});