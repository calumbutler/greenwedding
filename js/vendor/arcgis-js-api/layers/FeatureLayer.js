// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

//  copyright

/**
       * The copyright text as defined by the map service.
       *
       * @type {string}
       */

// We expose "copyrightText" as "copyright" in the SDK.

define(["require","dojo/_base/lang","dojo/io-query","../Graphic","../PopupTemplate","../request","../core/lang","../core/kebabDictionary","../core/MultiOriginJSONSupport","../core/sniff","../core/Collection","../core/Error","../core/Logger","../core/HandleRegistry","../core/promiseUtils","../core/requireUtils","../core/urlUtils","../geometry/Extent","../geometry/SpatialReference","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/support/jsonUtils","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/support/arcadeUtils","../renderers/support/jsonUtils","../renderers/support/styleUtils","../tasks/support/FeatureSet","../tasks/support/Query","./Layer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/ArcGISService","./graphics/sources/MemorySource","./support/Field","./support/FeatureType","./support/LabelClass","./support/arcgisLayerUrl"],function(e,r,t,i,n,s,o,a,u,l,d,c,h,f,p,y,m,b,g,v,F,w,I,S,O,x,j,_,T,E,L,P,M,q,A,C,D,R,N,k){var U=a({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",absoluteHeight:"absolute-height"}),G=a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),V="FeatureLayer",Q=h.getLogger("esri.layers.FeatureLayer"),J=function(e,r){var t=T.fromJSON(r.featureSet);return new C({layer:this,items:t&&t.features||[]})},z=L.createSubclass([P,M,q,A,u],{declaredClass:"esri.layers.FeatureLayer",viewModulePaths:{"2d":"../views/2d/layers/FeatureLayerView2D","3d":"../views/3d/layers/FeatureLayerView3D"},constructor:function(){this._handles=new f},normalizeCtorArgs:function(e,t){return"string"==typeof e?r.mixin({},{url:e},t):e},load:function(){var e,r=this.source&&(Array.isArray(this.source)||this.source.isInstanceOf&&this.source.isInstanceOf(d));e=this.portalItem&&r?p.resolve():this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]}).always(function(){return this.url&&null==this.layerId&&/FeatureServer\/*$/i.test(this.url)?this._fetchFirstLayerId().then(function(e){null!=e&&(this.layerId=e)}.bind(this)):void 0}.bind(this)).then(function(){if(!this.url&&!this._hasMemorySource())throw new c("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.createGraphicsSource().then(this._initLayerProperties.bind(this))}.bind(this)),this.addResolvingPromise(e)},_handles:null,_rndProps:["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],_visVariableProps:["field","normalizationField"],controllerModulePaths:{0:"./graphics/controllers/SnapshotController",1:{"2d":"./graphics/controllers/OnDemandController","3d":"./graphics/controllers/OnDemandController"},2:"./graphics/controllers/SelectionController",6:"./graphics/controllers/AutoController"},properties:{advancedQueryCapabilities:{json:{readFrom:["supportsStatistics","supportsAdvancedQueries"],read:function(e,r){return e||{supportsPagination:!1,supportsQueryWithDistance:!1,supportsReturningQueryExtent:!1,supportsStatistics:r.supportsStatistics,supportsOrderBy:r.supportsAdvancedQueries,supportsDistinct:r.supportsAdvancedQueries}}}},allowGeometryUpdates:{json:{read:function(e){return null==e?!0:e}}},allRenderers:{readOnly:!0,dependsOn:["loaded","renderer","fields"],get:function(){return this._getAllRenderers(this.renderer)}},capabilities:{json:{read:function(e){return e&&e.split(",").map(function(e){return e.trim()})}}},copyright:{value:null,json:{readFrom:["copyrightText"],read:function(e,r){return r.copyrightText}}},definitionExpression:{value:null,json:{origins:{service:{readable:!1}},write:function(e,r){e&&(r.layerDefinition={definitionExpression:e})}}},defaultSymbol:{json:{read:I.read}},editable:{value:!1,get:function(){return this.userIsAdmin||this._hasMemorySource()||this._get("editable")},json:{readFrom:["capabilities"],read:function(e,r){return r.capabilities&&(e=-1!==r.capabilities.toLowerCase().indexOf("editing")),!!e}}},elevationInfo:{value:null,json:{read:function(e){return e=o.clone(e),e.mode=U.fromJSON(e.mode),e},write:function(e,r){if(e&&(e.mode||e.offset||e.featureExpression)){var t={};e.mode&&(t.mode=U.toJSON(e.mode)),e.offset&&(t.offset=e.offset),e.featureExpression&&(t.featureExpression=e.featureExpression),r.layerDefinition={elevationInfo:t}}}}},fields:{value:null,type:[D]},fullExtent:{value:null,type:b,json:{readFrom:["extent"],read:function(e,r){return r.extent&&b.fromJSON(r.extent)}}},gdbVersion:null,generalizeForScale:4e3,geometryType:{json:{read:G.fromJSON}},hasAttachments:{value:!1,readOnly:!0,get:function(){return!this._hasMemorySource()&&this._get("hasAttachments")}},hasM:!1,hasZ:!1,id:{json:{origins:{service:{readable:!1},portalItem:{readable:!1}}}},isTable:{value:!1,readOnly:!0,json:{readFrom:["type"],read:function(e,r){return"Table"===r.type}}},labelsVisible:{value:!1,json:{readFrom:["showLabels"],read:function(e,r){return!!r.showLabels},write:function(e,r){e&&(r.showLabels=e)}}},labelingInfo:{value:null,json:{readFrom:["drawingInfo.labelingInfo"],read:function(e,r,t){if(e=r.drawingInfo&&r.drawingInfo.labelingInfo,!e)return null;var i,n=/\[([^\[\]]+)\]/gi,s=function(e,t){var i=this.getField(t,r.fields);return"["+(i&&i.name||t)+"]"}.bind(this);return e.map(function(e){var r=new N;return r.read(e,t),i=r.labelExpression,i&&(r.labelExpression=i.replace(n,s)),r})},write:function(e,r,t){e&&(r.layerDefinition={drawingInfo:{labelingInfo:e.map(function(e){return e.write({},t)})}})}}},layerId:{json:{origins:{service:{readFrom:["id"],read:function(e,r){return r.id}}},readable:!1}},legendEnabled:{value:!0,json:{readFrom:["showLegend"],read:function(e,r){return null!=r.showLegend?r.showLegend:!0},write:function(e,r){e||(r.showLegend=!1)}}},maxPointCountForAuto:4e3,maxRecordCountForAuto:2e3,maxRecordCount:null,maxVertexCountForAuto:25e4,minScale:{json:{readFrom:["minScale","effectiveMinScale"],read:function(e,r){return r.effectiveMinScale||e},writeTo:"layerDefinition.minScale"}},maxScale:{json:{readFrom:["maxScale","effectiveMaxScale"],read:function(e,r){return r.effectiveMaxScale||e},writeTo:"layerDefinition.maxScale"}},mode:{dependsOn:["source"],get:function(){return z.MODE_SNAPSHOT}},objectIdField:{json:{readFrom:["fields"],read:function(e,r){return e||r.fields.some(function(r){return"esriFieldTypeOID"===r.type&&(e=r.name),!!e}),e}}},operationalLayerType:"ArcGISFeatureLayer",outFields:{value:null,dependsOn:["requiredFields"],get:function(){var e=this._get("outFields"),r=this.requiredFields;return e?-1===e.indexOf("*")&&r.forEach(function(r){-1===e.indexOf(r)&&e.push(r)}):e=r,this.loaded&&(e=e.filter(function(e){return"*"===e||!!this.getField(e)},this),e=e.map(function(e){return"*"===e?e:this.getField(e).name},this)),e},set:function(e){var r=this.requiredFields;e?-1===e.indexOf("*")&&r.forEach(function(r){-1===e.indexOf(r)&&e.push(r)}):e=r,this.loaded&&(e=e.filter(function(e){return"*"===e||!!this.getField(e)},this),e=e.map(function(e){return"*"===e?e:this.getField(e).name},this)),this._set("outFields",e)}},parsedUrl:{dependsOn:["layerId"],get:function(){var e=this.url?m.urlToObject(this.url):null;return null!=this.layerId&&null!=e&&(e.path=m.join(e.path,this.layerId.toString())),e}},popupEnabled:{value:!0,json:{readFrom:["disablePopup"],read:function(e,r){return null!=r.disablePopup?!r.disablePopup:!0},write:function(e,r){e||(r.disablePopup=!0)}}},popupTemplate:{value:null,type:n,json:{readFrom:["popupInfo"],read:function(e,r){return r.popupInfo?n.fromJSON(r.popupInfo):null},write:function(e,r){e&&(r.popupInfo=e.toJSON())}}},relationships:null,renderer:{set:function(e){var r=this._getAllRenderers(e);this._fixRendererFields(r),this._set("renderer",e)},json:{readFrom:["drawingInfo.renderer","defaultSymbol","type"],read:function(e,r,t){var i;if(e=r.drawingInfo&&r.drawingInfo.renderer||void 0)e=j.read(e,r,t)||void 0,e||Q.error("Failed to create renderer",{rendererDefinition:r.drawingInfo.renderer,layer:this,context:t});else if(r.defaultSymbol)I.read(r.defaultSymbol,r,t),r.types&&r.types.length?(e=new O({defaultSymbol:i,field:r.typeIdField}),r.types.forEach(function(r){e.addUniqueValueInfo(r.id,I.read(r.symbol,r,t))})):e=new S({symbol:i});else if("Table"!==r.type){switch(r.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":i=new v;break;case"esriGeometryPolyline":i=new F;break;case"esriGeometryPolygon":i=new w}e=i&&new S({symbol:i})}return e},writeTo:"layerDefinition.drawingInfo.renderer"}},requiredFields:{dependsOn:["allRenderers"],get:function(){var e=this.timeInfo,t=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,e&&e.startTimeField,e&&e.endTimeField,this.trackIdField],i=this._rndProps,n=[];return this.allRenderers.forEach(function(e){i.forEach(function(i){t.push(r.getObject(i,!1,e))}),e.valueExpression&&(n=n.concat(x.extractFieldNames(e.valueExpression))),e.visualVariables&&e.visualVariables.forEach(function(e){this._visVariableProps.forEach(function(r){t.push(e[r])}),e.valueExpression&&(n=n.concat(x.extractFieldNames(e.valueExpression)))},this)},this),t=t.concat(n),t=t.concat(this.dataAttributes),t.filter(function(e,r,t){return!!e&&t.indexOf(e)===r&&"function"!=typeof e})}},returnM:!1,returnZ:!1,source:{json:{origins:{portalItem:{readFrom:["featureSet"],read:J},webMap:{readFrom:["featureSet"],read:J}}},cast:function(e){return e&&(Array.isArray(e)||e.isInstanceOf&&e.isInstanceOf(d))?new C({layer:this,items:e}):e},set:function(e){var r=this._get("source");r!==e&&(r&&r.isInstanceOf&&r.isInstanceOf(C)&&this._resetMemorySource(r),e&&e.isInstanceOf&&e.isInstanceOf(C)&&this._initMemorySource(e),this._set("source",e))}},supportsCoordinatesQuantization:!1,serviceDefinitionExpression:{json:{origins:{service:{readFrom:["definitionExpression"],read:function(e,r){return r.definitionExpression}}}}},spatialReference:{json:{readFrom:["extent"],read:function(e,r){return e=r.extent&&r.extent.spatialReference,e&&g.fromJSON(e)}}},title:{json:{origins:{portalItem:{readFrom:["title","name"],read:function(e,r){return r.name?this._readTitleFromName(r.name):"item-title"!==this.sublayerTitleMode?void 0:e}},service:{readFrom:["name"],read:function(e,r){return this._readTitleFromName(r.name)}}}}},sublayerTitleMode:{type:String,value:"item-title"},trackIdField:{json:{readFrom:["timeInfo.trackIdField"],read:function(e,r){return r.timeInfo.trackIdField}}},type:{value:"feature",json:{readable:!1}},typeIdField:{json:{read:function(e,r){if(e){var t=this.getField(e,r.fields);t&&(e=t.name)}return e}}},types:{json:{read:function(e,r){var t=r.editFieldsInfo,i=t&&t.creatorField,n=t&&t.editorField;return e&&e.map(function(e){return e=new R(e),this._fixTemplates(e.templates,i),this._fixTemplates(e.templates,n),e},this)}}},url:{set:function(e){var r=m.urlToObject(e),i=k.parse(r.path);if(i&&null!=i.sublayer){null==this.layerId&&(this.layerId=i.sublayer);var n=t.objectToQuery(r.query);e=i.url.path,n&&(e=e+"?"+n)}this._set("url",e)},json:{write:function(e,r){if(e&&m.isProtocolRelative(e)&&(e="https:"+e),e&&(r.url=e),null!=this.layerId){var i=m.urlToObject(e);i&&(r.url=m.join(i.path,""+this.layerId),i.query&&Object.keys(i.query)&&(r.url+="?"+t.objectToQuery(i.query)))}}}},userIsAdmin:!1,version:{json:{readFrom:["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"],read:function(e,r){return e=r.currentVersion,e||(e=r.hasOwnProperty("capabilities")||r.hasOwnProperty("drawingInfo")||r.hasOwnProperty("hasAttachments")||r.hasOwnProperty("htmlPopupType")||r.hasOwnProperty("relationships")||r.hasOwnProperty("timeInfo")||r.hasOwnProperty("typeIdField")||r.hasOwnProperty("types")?10:9.3),e}}}},createGraphicsSource:function(){if(this._hasMemorySource())return this.emit("graphics-source-create",{graphicsSource:this.source}),p.resolve(this.source);var r="FeatureLayerSource";return y.when(e,"./graphics/sources/"+r).then(function(e){return new e({layer:this})}.bind(this)).then(function(e){return this.emit("graphics-source-create",{graphicsSource:e}),e}.bind(this))},createGraphicsController:function(t){var n=this.controllerModulePaths[this.mode],s=t.layerView,o=d.ofType(i),a=this.source,u=a&&a.isInstanceOf&&a.isInstanceOf(d),l=r.mixin(t.options||{},{layer:this,layerView:s,graphics:u?a:new o});return u?p.resolve(l):("object"==typeof n&&(n=n[s.view.type]),n?y.when(e,n).then(function(e){return new e(l)}.bind(this)).then(function(e){return this.emit("graphics-controller-create",{graphicsController:e}),e}.bind(this)):p.reject(new c("Layer mode",'Module path not found for controller type: "'+this.mode+'"')))},createQuery:function(){var e=new E;return e.returnGeometry=!0,e.returnZ=this.hasZ&&this.returnZ||null,e.returnM=this.hasM&&this.returnM||null,e.outFields=this.outFields,e.where=this.definitionExpression||"1=1",e.multipatchOption="multipatch"===this.geometryType?"xyFootprint":null,e},getField:function(e,r){var t;return r=r||this.fields,r&&(e=e.toLowerCase(),r.some(function(r){return r&&r.name.toLowerCase()===e&&(t=r),!!t})),t},graphicChanged:function(e){this.emit("graphic-update",e)},queryFeatures:function(e){var r=this;if(e=e||this.createQuery(),!this.source.queryFeatures)return p.reject(new c(V,"Layer source does not support queryFeatures capability"));var t=this.popupTemplate;return this.source.queryFeatures(e).then(function(e){return e&&e.features&&e.features.forEach(function(e){e.popupTemplate=t,e.layer=r}),e})},queryObjectIds:function(e){return e=e||this.createQuery(),this.source.queryObjectIds?this.source.queryObjectIds(e):p.reject(new c(V,"Layer source does not support queryObjectIds capability"))},queryFeatureCount:function(e){return e=e||this.createQuery(),this.source.queryFeatureCount?this.source.queryFeatureCount(e):p.reject(new c(V,"Layer source does not support queryFeatureCount capability"))},queryExtent:function(e){return e=e||this.createQuery(),this.source.queryExtent?this.source.queryExtent(e):p.reject(new c(V,"Layer source does not support queryExtent capability"))},read:function(e,r){switch(r&&r.origin){case"web-map":this.inherited(arguments,[{outFields:["*"]},r]);break;case"web-scene":this.inherited(arguments,[{mode:z.MODE_SNAPSHOT,returnZ:!0,outFields:["*"]},r])}var t=e.featureCollection;if(t){var i=t.layers;i&&1===i.length&&(this.inherited(arguments,[i[0].layerDefinition,r]),this.inherited(arguments,[i[0],r]),null!=t.showLegend&&this.inherited(arguments,[{showLegend:t.showLegend},r]))}else e.layerDefinition&&this.inherited(arguments,[e.layerDefinition,r]);return this.inherited(arguments,[e,r]),this},write:function(e,r){if(r&&"web-scene"===r.origin&&r.messages){if(!this.url)return r.messages.push(new c("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' require a url to a service to be written to web scenes",{layer:this})),null;if(this.isTable)return r.messages.push(new c("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot written to web scenes",{layer:this})),null}return this.inherited(arguments)},_fetchFirstLayerId:function(){return s(this.url,{query:{f:"json"},callbackParamName:"callback",responseType:"json"}).then(function(e){return e.data&&Array.isArray(e.data.layers)&&e.data.layers.length>0?e.data.layers[0].id:void 0})},_initLayerProperties:function(e){return this.source||(this.source=e),e.url&&(this.url=e.url),e.layerDefinition&&this.read({layerDefinition:e.layerDefinition},{origin:"service",url:this.parsedUrl}),this._verifySource(),this._verifyFields(),this._fixSymbolUrls(),this._fixRendererFields(this._getAllRenderers(this.renderer)),this.useQueryTimestamp=(l("ie")||l("safari"))&&this.editable&&this.version<10.02,this.watch("token",function(){this._fixSymbolUrls()}.bind(this)),_.loadStyleRenderer(this,{origin:"service"})},_fixSymbolUrls:function(){var e=this.renderer;if(!this._hasMemorySource()&&e){var r=this.token,t=[e.symbol,e.defaultSymbol],i=e.classBreakInfos||e.uniqueValueInfos;i&&i.forEach(function(e){t.push(e.symbol)}),t.forEach(function(e){var t=e&&e.url;t&&r&&-1!==t.search(/https?\:/i)&&-1===t.indexOf("?token=")&&(e.url+="?token="+r)})}},_getAllRenderers:function(e){var r=[];if(e){var t=[e,e.trackRenderer,e.observationRenderer,e.latestObservationRenderer];t.forEach(function(e){e&&(r.push(e),e.rendererInfos&&e.rendererInfos.forEach(function(e){e.renderer&&r.push(e.renderer)}))})}return r},_fixRendererFields:function(e){var r=this.fields;e&&r&&e.forEach(function(e){this._fixFieldName(this._rndProps,e),e.visualVariables&&e.visualVariables.forEach(function(e){this._fixFieldName(this._visVariableProps,e)},this)},this)},_fixFieldName:function(e,t){e&&e.forEach(function(e){var i=r.getObject(e,!1,t),n=i&&"function"!=typeof i&&this.getField(i);n&&r.setObject(e,n.name,t)},this)},_verifyFields:function(){var e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||-1!==e.search(/\/FeatureServer\//i)||this.fields&&this.fields.some(function(e){return"geometry"===e.type})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},_fixTemplates:function(e,r){e&&e.forEach(function(e){var t=e.prototype&&e.prototype.attributes;t&&r&&delete t[r]})},_verifySource:function(){if(this._hasMemorySource()){if(this.url)throw new c("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url");var e=["geometryType","fields","objectIdField"],r=e.every(function(e){return this.hasOwnProperty(e)},this);if(!r)throw new c("feature-layer:missing-property","FeatureLayer created as feature collection requires properties: "+e.join(),{requiredProperties:e})}else{if(this.isTable)throw new c("feature-layer:source-type-not-supported","The table feature service type is not yet supported",{sourceType:"Table"});if(!this.url)throw new c("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}},_initMemorySource:function(e){e.forEach(function(e){e.layer=this}.bind(this)),this._handles.add([e.on("after-add",function(e){e.item.layer=this}.bind(this)),e.on("after-remove",function(e){e.item.layer=null}.bind(this))],"fl-source")},_resetMemorySource:function(e){e.forEach(function(e){e.layer=null}.bind(this)),this._handles.remove("fl-source")},_hasMemorySource:function(){return!(this.url||!this.source)},_readTitleFromName:function(e){var r=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?k.titleFromUrlAndName(this.url,e):e;var t=e||this.url&&k.parse(this.url).title;if(t)return"item-title-and-service-name"===this.sublayerTitleMode&&r&&(t=r+" - "+t),k.cleanTitle(t)}});return r.mixin(z,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,MODE_AUTO:6}),z});