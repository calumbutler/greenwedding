// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../core/declare","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-style","../../geometry/SpatialReference","../../geometry/Extent","../../geometry/support/webMercatorUtils","../../renderers/SimpleRenderer","../../PopupTemplate","../FeatureLayer","../Layer"],function(e,t,i,s,o,n,r,a,h,l,c,p){var y=e([p],{declaredClass:"esri.layers.mixins.FeatureCollectionLayer",constructor:function(e,i){this.pointSymbol=i&&i.pointSymbol,this.polylineSymbol=i&&i.polylineSymbol,this.polygonSymbol=i&&i.polygonSymbol,this._outSR=i&&(i.outSpatialReference||i.outSR)||new n({wkid:4326}),this._options=t.mixin({},i)},parse:function(){console.error("parse function has not been implemented")},getFeatureLayers:function(){var e=[];return this._fLayers&&(e=e.concat(this._fLayers)),e},onRefresh:function(){},onOpacityChange:function(){},refresh:function(){this.loaded&&this._map&&!this._io&&this.visible&&this._createLayer()},_createLayer:function(e){var i=this;this._fireUpdateStart();var s=this.parse(e);s.then(function(e){i._io=null,i._initLayer(e)}),s.then(null,function(e){i._io=null,e=t.mixin(new Error,e),e.message="Unable to load resource: "+i.url+" "+(e.message||""),i._fireUpdateEnd(e),i.onError(e)})},_initLayer:function(e){this.loaded&&this._removeInternalLayers(),this.name=e.name,this.description=e.description,this.snippet=e.snippet,void 0!==e.visibility?this.defaultVisibility=this.visible=!!e.visibility:this.defaultVisibility=this.visible=!0,this.featureInfos=e.featureInfos,this.fullExtent=r.fromJSON(e.lookAtExtent),this.copyright=e.author||e.copyright;var s,o=t.getObject("featureCollection.layers",!1,e);if(o&&o.length>0&&(this._fLayers=[],i.forEach(o,function(e,i){var o,n=t.getObject("featureSet.features",!1,e);n&&n.length>0&&(s=t.mixin({outFields:["*"],popupTemplate:e.popupInfo?new l(e.popupInfo):null,editable:!1},this._options),s.id&&(s.id=s.id+"_"+i),e.layerDefinition.capabilities="Query,Data",o=new c(e,s),o.geometryType&&(this["_"+o.geometryType]=o),this._fLayers.push(o))},this),0===this._fLayers.length&&delete this._fLayers),this.items=[],this._point&&(this.items=this.items.concat(this._point.graphics),this.pointSymbol)){var n=new h({symbol:this.pointSymbol});this._point.setRenderer(n)}if(this._polyline&&(this.items=this.items.concat(this._polyline.graphics),this.polylineSymbol)){var a=new h({symbol:this.polylineSymbol});this._polyline.setRenderer(a)}if(this._polygon&&(this.items=this.items.concat(this._polygon.graphics),this.polygonSymbol)){var p=new h({symbol:this.polygonSymbol});this._polygon.setRenderer(p)}this._fireUpdateEnd(),this.loaded&&(this._addInternalLayers(),this.onRefresh())},_addInternalLayers:function(){var e=this._map;this._fireUpdateStart();var t,s=e.spatialReference,o=this._outSR;if(s.wkid)t=s.isWebMercator&&o.isWebMercator||s.wkid===o.wkid;else{if(!s.wkt)return void console.log("_setMap - map has invalid spatial reference");t=s.wkt===o.wkt}if(!t)if(s.isWebMercator&&4326===o.wkid)this._converter=a.geographicToWebMercator;else{if(!o.isWebMercator||4326!==s.wkid)return void console.log("_setMap - unsupported workflow. Spatial reference of the map and layer do not match, and the conversion cannot be done on the client.");this._converter=a.webMercatorToGeographic}var n=this._fLayers;n&&n.length>0&&i.forEach(n,function(t){if(this._converter){var i,s,o=t.graphics,n=o?o.length:0;for(i=0;n>i;i++)s=o[i].geometry,s&&o[i].setGeometry(this._converter(s))}e.addLayer(t)},this),this.setVisibility(this.visible),this._fireUpdateEnd()},_removeInternalLayers:function(){var e=this._map;e&&i.forEach(this.getFeatureLayers(),e.removeLayer,e)},setScaleRange:function(e,t){this.inherited(arguments),i.forEach(this.getFeatureLayers(),function(i){i.setScaleRange(e,t)}),this._options.minScale=this.minScale,this._options.maxScale=this.maxScale},setOpacity:function(e){this.opacity!=e&&(i.forEach(this.getFeatureLayers(),function(t){t.setOpacity(e)}),this._options.opacity=e,this.opacity=e,this.onOpacityChange(e))},onVisibilityChange:function(e){this._fireUpdateStart(),i.forEach(this.getFeatureLayers(),function(t){t.setVisibility(e)}),this._fireUpdateEnd()},_setMap:function(e,t){this.inherited(arguments),this._map=e;var i=this._div=s.create("div",null,t);return o.set(i,"position","absolute"),this._addInternalLayers(),this.evaluateSuspension(),i},_unsetMap:function(e,t){this._io&&this._io.cancel(),this._extChgHandle.remove(),delete this._extChgHandle,this._removeInternalLayers();var i=this._div;i&&(t.removeChild(i),s.destroy(i)),this._div=null,this.inherited(arguments)}});return y});