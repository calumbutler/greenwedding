// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../core/lang","../core/kebabDictionary","../core/urlUtils","../geometry/Polygon","../geometry/support/scaleUtils","dojo/_base/lang","dojo/dom-construct","dojox/gfx/canvas","./Geoprocessor","./support/PrintTemplate","./support/printTaskUtils","./Task"],function(e,r,t,a,i,n,s,l,o,u,c,d){function y(e){return!(!e||!e.path)}var p={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},m=r({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),f=r({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape","A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"}),h=d.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_legendLayers:[],_legendLayerNameMap:{},properties:{_geoprocessor:{dependsOn:["url","updateDelay"],get:function(){return new o(this.url,{updateDelay:this.updateDelay})}},mode:{value:"sync"},url:{value:null,type:String},updateDelay:{value:1e3,type:Number}},execute:function(e,r){var t=this._setPrintParams(e),a="async"===this.mode?"submitJob":"execute";return this._geoprocessor[a](t,r).then(this._handleExecuteResponse)},_createOperationalLayers:function(e,r){var a,i,s,l,o=e.map,u=[],c=o.allLayers.items,d=/^https?:\/\/basemaps(dev)?\.arcgis\.com(\/b2)?\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i,y="http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer";for(a=0;a<c.length;a++)if(i=c[a],i.loaded&&i.visible)switch(l={id:i.id,title:this._legendLayerNameMap[i.id]||i.title,opacity:i.opacity,minScale:i.minScale||0,maxScale:i.maxScale||0,url:i.url&&t.normalize(i.url),token:i.token},s=i.declaredClass){case"esri.layers.ImageryLayer":var p={bandIds:i.bandIds,compressionQuality:i.compressionQuality,format:i.format,interpolation:i.interpolation};i.mosaicRule&&(p.mosaicRule=i.mosaicRule.toJSON()),i.renderingRule&&(p.renderingRule=i.renderingRule.toJSON()),u.push(n.mixin(l,p)),this._legendLayers&&this._legendLayers.push({id:i.id});break;case"esri.layers.OpenStreetMapLayer":n.mixin(l,{type:"OpenStreetMap"}),u.push(l);break;case"esri.layers.GraphicsLayer":n.mixin(l,this._createFeatureCollectionJSON(i)),u.push(l),this._legendLayers&&this._legendLayers.push({id:i.id});break;case"esri.layers.VectorTileLayer":case"esri.layers.mixins.ScaleRangeLayer":d.test(i.serviceUrl)&&(l.url=y,u.push(l));break;case"esri.layers.MapImageLayer":var m={id:i.id,subLayerIds:[]},f=[];i.allSublayers.forEach(function(e,r){e.visible&&(f.push(e.toJSON({})),m.subLayerIds.push(e.id))}),n.mixin(l,{layers:f}),u.push(l),this._legendLayers.push(m);break;case"esri.layers.WebTileLayer":var h=i.urlTemplate.replace(/\$\{/g,"{");n.mixin(l,{type:"WebTiledLayer",urlTemplate:h,credits:i.copyright}),i.subDomains&&i.subDomains.length>0&&(l.subDomains=i.subDomains),u.push(l);break;case"esri.layers.FeatureLayer":case"esri.layers.StreamLayer":var g;e.whenLayerView(i).then(function(e){return e.queryGraphics&&e.queryGraphics()||e.featuresView.graphics}).then(function(e){g=e.map(function(e){return e.geometry.hasZ=!1,e})}),n.mixin(l,this._createFeatureCollectionJSON(i,g)),u.push(l),this._legendLayers&&this._legendLayers.push({id:i.id});break;default:u.push(l)}return u},_createFeatureCollectionJSON:function(e,r){var t=e,i=c.createPolygonLayer(),s=c.createPolylineLayer(),l=c.createPointLayer(),o=c.createMultipointLayer(),u=c.createPointLayer();if(u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,"esri.layers.FeatureLayer"===t.declaredClass||"esri.layers.StreamLayer"===t.declaredClass?i.layerDefinition.name=s.layerDefinition.name=l.layerDefinition.name=o.layerDefinition.name=this._legendLayerNameMap[t.id]||t.get("arcgisProps.title")||t.title:"esri.layers.GraphicsLayer"===t.declaredClass&&(r=t.graphics.items),t.renderer&&!n.isFunction(t.get("renderer.attributeField"))){var d=t.renderer.toJSON();i.layerDefinition.drawingInfo.renderer=d,s.layerDefinition.drawingInfo.renderer=d,l.layerDefinition.drawingInfo.renderer=d,o.layerDefinition.drawingInfo.renderer=d}else delete i.layerDefinition.drawingInfo,delete s.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo;var y=t.fields;!t.renderer||y||n.isFunction(t.get("renderer.attributeField"))||("esri.renderer.ClassBreaksRenderer"===t.renderer.declaredClass?(y=[{name:t.renderer.attributeField,type:"esriFieldTypeDouble"}],t.renderer.normalizationField&&y.push({name:t.renderer.normalizationField,type:"esriFieldTypeDouble"})):"esri.renderer.UniqueValueRenderer"===t.renderer.declaredClass&&(y=[{name:t.renderer.attributeField,type:"esriFieldTypeString"}],t.renderer.attributeField2&&y.push({name:t.renderer.attributeField2,type:"esriFieldTypeString"}),t.renderer.attributeField3&&y.push({name:t.renderer.attributeField3,type:"esriFieldTypeString"}))),y&&(i.layerDefinition.fields=y,s.layerDefinition.fields=y,l.layerDefinition.fields=y,o.layerDefinition.fields=y);for(var p,m=r&&r.length,f=0;m>f;f++){var h=r[f]||r.getItemAt(f);if(h.visible!==!1&&h.geometry&&(p=h.toJSON(),!p.symbol||!p.symbol.outline||"esriCLS"!==p.symbol.outline.type)){if(p.symbol&&p.symbol.outline&&p.symbol.outline.color&&p.symbol.outline.color[3]&&(p.symbol.outline.color[3]=255),t.renderer&&!p.symbol&&(n.isFunction(t.renderer.attributeField)||t.renderer.hasVisualVariables())){var g=t.renderer,b=g.getSymbol(h);if(!b)continue;p.symbol=b.toJSON(),g.hasVisualVariables()&&c.applyVisualVariables(p.symbol,{renderer:g,graphic:h,symbol:b})}p.symbol&&(p.symbol.path?p.symbol=this._convertSvgToPictureMarkerSymbolJson(p.symbol):p.symbol.text&&delete p.attributes),"polygon"===h.geometry.type?i.featureSet.features.push(p):"polyline"===h.geometry.type?s.featureSet.features.push(p):"point"===h.geometry.type?p.symbol&&p.symbol.text?u.featureSet.features.push(p):l.featureSet.features.push(p):"multipoint"===h.geometry.type?o.featureSet.features.push(p):"extent"===h.geometry.type&&(p.geometry=a.fromExtent(h.geometry).toJSON(),i.featureSet.features.push(p))}}var S=[i,s,o,l,u].filter(function(e){return e.featureSet.features.length>0});return S.forEach(function(e){e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)},this),{id:t.id,opacity:t.opacity,minScale:t.minScale||0,maxScale:t.maxScale||0,featureCollection:{layers:S}}},_convertSvgToPictureMarkerSymbolJson:function(e){this._canvasParent||(this._canvasParent=s.create("div"),this._canvasSurface=l.createSurface(this._canvasParent,200,200));var r=this._canvasSurface.createObject(l.Path,e.path).setFill(e.color).setStroke(e.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var t=this._canvasSurface.rawNode.getContext("2d"),a=r.getBoundingBox(),i=Math.ceil(a.width+a.x),n=Math.ceil(a.height+a.y),o=t.getImageData(a.x,a.y,i,n);t.canvas.width=i,t.canvas.height=n,t.putImageData(o,0,0);var u=t.canvas.toDataURL("image/png"),c=22;return{type:"esriPMS",imageData:u.substr(c),angle:-e.angle,contentType:"image/png",height:e.size?e.size:n-a.y,width:e.size?e.size:i-a.x,xoffset:e.xoffset,yoffset:e.yoffset}},_convertSvgRenderer:function(e){var r=e.type;if("simple"===r&&y(e.symbol))return void(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol));if("uniqueValue"===r||"classBreaks"===r){var t="uniqueValue"===r?"uniqueValueInfos":"classBreakInfos",a=e[t];y(e.defaultSymbol)&&(e.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol)),a&&a.forEach(function(e){y(e)&&(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol))},this)}},_getPrintDefinition:function(e,r){var t=e.view,a=e.extent||t.extent,n=t.map,s=t.spatialReference;s&&s.isWrappable&&(a=a.clone()._normalize(!0),s=a.spatialReference);var l={mapOptions:{showAttribution:r.attributionVisible,extent:a&&a.toJSON(),spatialReference:s&&s.toJSON()},operationalLayers:this._createOperationalLayers(t,r)};return r.preserveScale&&(l.mapOptions.scale=r.outScale||i.getScale(n)),n.timeExtent&&(l.mapOptions.time=[n.timeExtent.startTime.getTime(),n.timeExtent.endTime.getTime()]),l},_handleExecuteResponse:function(e){return"sync"===this.mode?e.results[0].value:this._geoprocessor.getResultData(e.jobId,"Output_File").then(function(e){return e.value})},_setPrintParams:function(e){var r=e.template||new u;null==r.showLabels&&(r.showLabels=!0);var t,a=r.exportOptions;if(a){var i=a.width,s=a.height,l=a.dpi;t={outputSize:[i,s],dpi:l}}var o,c=r.layoutOptions;if(c){var d,y;"Miles"===c.scalebarUnit||"Kilometers"===c.scalebarUnit?(d="Kilometers",y="Miles"):("Meters"===c.scalebarUnit||"Feet"===c.scalebarUnit)&&(d="Meters",y="Feet"),o={titleText:c.titleText,authorText:c.authorText,copyrightText:c.copyrightText,customTextElements:c.customTextElements,scaleBarOptions:{metricUnit:m.toJSON(d),metricLabel:p[d],nonMetricUnit:m.toJSON(y),nonMetricLabel:p[y]}}}var h=null;c&&c.legendLayers&&(h=c.legendLayers.map(function(e){this._legendLayerNameMap[e.layerId]=e.title;var r={id:e.layerId};return e.subLayerIds&&(r.subLayerIds=e.subLayerIds),r},this));var g=this._getPrintDefinition(e,r);e.outSpatialReference&&(g.mapOptions.spatialReference=e.outSpatialReference.toJSON()),n.mixin(g,{exportOptions:t,layoutOptions:o}),n.mixin(g.layoutOptions,{legendOptions:{operationalLayers:null!=h?h:this._legendLayers}});var b=JSON.stringify(g),S={Web_Map_as_JSON:b,Format:r.format,Layout_Template:f.toJSON(r.layout)};return e.extraParameters&&n.mixin(S,e.extraParameters),S}});return h});