// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/i18n!../../nls/smartMapping","dojo/_base/lang","../../../core/lang","../statistics/summaryStatistics","../symbology/color","../../../core/numberUtils","../../support/utils","../../ClassBreaksRenderer","../../../core/promiseUtils","../../../views/SceneView","./support/utils","../support/utils"],function(e,r,a,l,o,i,t,n,s,u,c,d,p,m){function y(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return c.reject(p.createError("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var r=l.mixin({},e);return r.basemap=p.getBasemapId(r.basemap),r.layer=m.createLayerAdapter(r.layer),r.layer?!r.worldScale||r.view instanceof d?r.layer.load().then(function(){var e=r.layer.geometryType;if(r.worldScale&&"point"!==e&&"multipoint"!==e)return c.reject(p.createError("color-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers"));var a=m.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression}),l=p.verifyBasicFieldValidity(r.layer,a,"color-visual-variable:invalid-parameters");return l?c.reject(l):r}):c.reject(p.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")):c.reject(p.createError("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+F))}function v(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return c.reject(p.createError("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var r=l.mixin({},e);return r.basemap=p.getBasemapId(r.basemap),r.symbolType=r.symbolType||"2d",r.layer=m.createLayerAdapter(r.layer),r.layer?"3d-volumetric"!==r.symbolType||r.view instanceof d?r.layer.load().then(function(){var e=r.layer.geometryType,a=r.symbolType.indexOf("3d")>-1;if(a&&"point"!==e&&"multipoint"!==e)return c.reject(p.createError("color-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));var l=m.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression}),o=p.verifyBasicFieldValidity(r.layer,l,"color-continuous-renderer:invalid-parameters");return o?c.reject(o):r}):c.reject(p.createError("color-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric'")):c.reject(p.createError("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+F))}function f(e){var r=l.mixin({},e),a="3d-volumetric"===r.symbolType;delete r.symbolType,delete r.defaultSymbolEnabled;var o=r;return o.worldScale=a,o}function b(e,r,a){var l=e.colorScheme;if(l)l=t.cloneScheme(l);else{var o=t.getSchemes({theme:a||e.theme||w,basemap:e.basemap,geometryType:r,worldScale:e.worldScale,view:e.view});l=o&&o.primaryScheme}return l}function h(e,r,a){for(var l=(r-e)/(a-1),o=[e],i=1;a-2>=i;i++)o.push(e+i*l);return o.push(r),n.round(o,{strictBounds:!0})}function E(e,r,a){var l=a.layer,o=a.field,i="function"==typeof o,n=o&&!i?l.getField(o):null,u=n&&n.type===V,d=l.geometryType,m=b(a,d),y=5;if(!m)return c.reject(p.createError("color-visual-variable:insufficient-info","Unable to find color scheme"));var v=p.createColors(m.colors,y);if(v.length<y)return c.reject(p.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors"));var f=p.getDefaultDataRange(e,u,!0),E=f?h(f[0],f[1],5):p.createStopValues(e),S=[0,2,4],x=p.createColors(v,y),g={type:"color",field:o,valueExpression:a.valueExpression,normalizationField:r,stops:s.createColorStops({values:E,isDate:u,dateFormatOptions:u?s.timelineDateFormatOptions:null,colors:x,labelIndexes:S}),legendOptions:a.legendOptions};return c.resolve({basemapId:a.basemap,visualVariable:g,statistics:e,defaultValuesUsed:!!f,colorScheme:t.cloneScheme(m),authoringInfo:{visualVariables:[{type:"color",minSliderValue:e.min,maxSliderValue:e.max,theme:m.theme}]}})}function S(e,r,l,i){var n=i.layer,c=i.field,d=n.geometryType,m=null==i.defaultSymbolEnabled?!0:i.defaultSymbolEnabled,y=t.cloneScheme(e.colorScheme),v=new u({classBreakInfos:[{minValue:-T,maxValue:T,symbol:p.createSymbol(y,y.noDataColor,d,i.symbolType)}],defaultLabel:m?a.other:null,defaultSymbol:m?p.createSymbol(y,y.noDataColor,d,i.symbolType):null,field:c,normalizationType:r,normalizationField:l,valueExpression:i.valueExpression,visualVariables:[s.cloneColorVariable(e.visualVariable)],authoringInfo:o.clone(e.authoringInfo)});return{renderer:v,visualVariable:s.cloneColorVariable(e.visualVariable),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,colorScheme:t.cloneScheme(e.colorScheme),basemapId:e.basemapId}}function x(e){return y(e).then(function(e){var r,a=e.normalizationField,l=a?"field":void 0;return r=e.statistics?c.resolve(e.statistics):i({layer:e.layer,field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:l,normalizationField:a,minValue:e.minValue,maxValue:e.maxValue}),r.then(function(r){return E(r,a,e)})})}function g(e){return v(e).then(function(e){return x(f(e)).then(function(r){var a=e.normalizationField,l=a?"field":void 0;return S(r,l,a,e)})})}var V="date",w="high-to-low",T=Math.pow(2,53)-1,F=m.supportedLayerTypes.join(", ");r.createVisualVariable=x,r.createContinuousRenderer=g});