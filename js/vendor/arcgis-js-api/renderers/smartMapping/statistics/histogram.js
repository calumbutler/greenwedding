// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","../../../core/promiseUtils","./summaryStatistics","../../../tasks/support/StatisticDefinition","../../../tasks/support/GenerateRendererParameters","./support/utils","../support/utils"],function(e,r,t,a,n,i,o,s,l){function u(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return a.reject(s.createError("histogram:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var r=t.mixin({},e);return r.normalizationType=s.getNormalizationType(r),r.layer=l.createLayerAdapter(r.layer),r.layer?r.layer.load().then(function(){var e=r.layer,t=r.valueExpression||r.sqlExpression,n=r.field,i=n?e.getField(n):null,o=i?i.type===q:!1,u=!r.classificationMethod||"equal-interval"===r.classificationMethod,c=l.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression}),m=s.verifyBasicFieldValidity(e,c,"histogram:invalid-parameters");if(m)return a.reject(m);if(i){var f=s.verifyFieldType(e,i,"histogram:invalid-parameters",V);if(f)return a.reject(f);if(o){if(r.normalizationType)return a.reject(s.createError("histogram:invalid-parameters","Normalization is not allowed for date fields"));if(!u)return a.reject(s.createError("histogram:invalid-parameters","'classificationMethod' other than 'equal-interval' is not allowed for date fields"))}}else if(t){if(r.normalizationType)return a.reject(s.createError("histogram:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified"));if(!u)return a.reject(s.createError("histogram:invalid-parameters","'classificationMethod' other than 'equal-interval' is not allowed when 'valueExpression' or 'sqlExpression' is specified"))}return r}):a.reject(s.createError("histogram:invalid-parameters","'layer' must be one of these types: "+j))}function c(e,r,t){for(var a,n=(r-e)/t,i=[],o=e,s=1;t>=s;s++)a=o+n,a=Number(a.toFixed(16)),i.push([o,a]),o=a;return i}function m(e,r){var t=[],a=r.length;return r.forEach(function(r,n){var i=r[0],o=r[1],l=s.mergeWhereClauses(e+" >= "+i,e+(n===a-1?" <= ":" < ")+o);t.push("WHEN ("+l+") THEN "+(n+1))}),["CASE",t.join(" "),"ELSE 0","END"].join(" ")}function f(e,r,t){var n=e.layer;if(n.supportsSQLExpression){var o=e.numBins||S,l=c(r,t,o),u=m(e.sqlExpression,l),f="countOFExpr",p=new i({statisticType:"count",outStatisticFieldName:f,onStatisticField:"*"}),d={outStatistics:[p],groupByFieldsForStatistics:[u],orderByFields:[u],where:e.sqlWhere,sqlFormat:"standard"};return n.queryStatistics(d).then(function(e){var a={};e&&e.features&&e.features.forEach(function(e){var r=e.attributes,t=s.getCustomExprVal(r,f),n=s.getAttributeVal(r,f);0!==t&&(a[t]=n)});var n=[];return l.forEach(function(e,r){var t=(r+1).toString();n.push({minValue:e[0],maxValue:e[1],count:a.hasOwnProperty(t)?a[t]:0})}),{bins:n,minValue:r,maxValue:t}})}return a.reject(s.createError("histogram:not-supported","Layer does not support standardized SQL expression for queries"))}function p(e,r,t){var i=null!=r&&null!=t,o=i?a.resolve({min:r,max:t}):n(e);return o.then(function(r){return f(e,r.min,r.max)})}function d(e,r){var t,i=e.layer;return t="percent-of-total"===e.normalizationType?n({layer:i,field:e.field}).then(function(e){return e.sum}):a.resolve(),t.then(function(t){var a={layer:i,numBins:e.numBins,sqlExpression:r?s.msSinceUnixEpochSQL(i,e.field):s.getFieldExpr(e,t),sqlWhere:r?null:s.getSQLFilterForNormalization(e)};return p(a,e.minValue,e.maxValue)})}function h(e,r,t){var a=[],n=e.classBreakInfos,i=n[0].minValue,o=n[n.length-1].maxValue;return n.forEach(function(e){a.push([e.minValue,e.maxValue])}),{min:i,max:o,intervals:a,sqlExpr:s.getFieldExpr(t,e.normalizationTotal),excludeZerosExpr:r,normTotal:e.normalizationTotal}}function x(e,r){var t=e.layer,a=s.getSQLFilterForNormalization(e),n=e.numBins||S,i=new o({classificationDefinition:s.createCBDefn(e,n),where:s.mergeWhereClauses(a,r)});return t.generateRenderer(i).then(function(r){return h(r,a,e)})}function E(e,r,t,n){for(var i=[],o=n.length,l=0;o>l;l++){var u=s.mergeWhereClauses(t,s.mergeWhereClauses(r+" >= "+n[l][0],null!==n[l][1]?r+(l===o-1?" <= ":" < ")+n[l][1]:""));i.push(u)}return a.eachAlways(i.map(function(r){return e.queryFeatureCount(r)}))}function v(e,r){var t=e.layer,n=e.field,i=n?t.getField(n):null,o=i?i.type===q:!1,l=e.numBins||S,u=r.min,m=r.max,f=r.intervals||c(u,m,l),p=r.normTotal,d=r&&r.sqlExpr||n,h=r&&r.excludeZerosExpr;return t.hasLocalSource||o?a.reject(s.createError("histogram:not-implemented","Client-side calculation is not implemented yet")):E(t,d,h,f).then(function(e){var r=e.map(function(e,r){return{minValue:f[r][0],maxValue:f[r][1],count:e.value}});return{bins:r,minValue:u,maxValue:m,normalizationTotal:p}})}function y(e){var r=e.layer,t=e.minValue,i=e.maxValue,o=e.valueExpression||e.sqlExpression,l=r.supportsSQLExpression,u=null!=t&&null!=i,c=e.field?r.getField(e.field):null,m=c?c.type===q:!1,f=!e.classificationMethod||"equal-interval"===e.classificationMethod;return o&&!r.hasLocalSource?p(e,t,i):l&&f&&!r.hasLocalSource?d(e,m):e.normalizationType||!f?x(e).then(function(r){if(u){if(t>r.max||i<r.min)return a.reject(s.createError("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field"));var n=s.getFieldExpr(e,r.normTotal),o=s.getRangeExpr(n,t,i);return f?v(e,{min:t,max:i,sqlExpr:r.sqlExpr,excludeZerosExpr:r.excludeZerosExpr}):x(e,o).then(function(r){return v(e,r)})}return v(e,r)}):u?v(e,{min:t,max:i}):n(e).then(function(r){return r.count?v(e,{min:r.min,max:r.max}):a.reject(s.createError("histogram:insufficient-data","Either the layer has no features or none of the features have data for the field"))})}function g(e){return u(e).then(function(e){return y(e)})}var q="date",F=["integer","small-integer","single","double"],V=[].concat(F).concat(q),S=10,j=l.supportedLayerTypes.join(", ");return g});