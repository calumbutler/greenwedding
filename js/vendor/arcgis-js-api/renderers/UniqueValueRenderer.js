// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","../core/lang","../core/urlUtils","../core/Logger","../core/Error","../portal/Portal","../symbols/WebStyleSymbol","../symbols/support/jsonUtils","../symbols/support/symbolUtils","./Renderer","./support/arcadeUtils"],function(e,t,r,o,l,i,n,s,u,a,p,f,y,d,c){var m=s.getLogger("esri.renderers.UniqueValueRenderer"),h=function(e){function t(t){e.call(this),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this.type="uniqueValue",this.field=null,this.field2=null,this.field3=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.fieldDelimiter=null,this.portal=null,this.styleOrigin=null,this._set("uniqueValueInfos",[])}return r(t,e),t.prototype.writeValueExpression=function(e,t,r){r&&"web-scene"===r.origin?e&&r.messages&&r.messages.push(new u("property:unsupported",this.declaredClass+".valueExpression is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:"valueExpression",context:r})):t.valueExpression=e},t.prototype.writeValueExpressionTitle=function(e,t,r){r&&"web-scene"===r.origin?e&&r.messages&&r.messages.push(new u("property:unsupported",this.declaredClass+".valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:"valueExpressionTitle",context:r})):t.valueExpressionTitle=e},Object.defineProperty(t.prototype,"compiledFunc",{get:function(){return c.createFunction(this.valueExpression)},enumerable:!0,configurable:!0}),t.prototype.writeLegendOptions=function(e,t,r){r&&"web-scene"===r.origin?e&&r.messages&&r.messages.push(new u("property:unsupported",this.declaredClass+".legendOptions is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:"legendOptions",context:r})):t.legendOptions=i.clone(e)},Object.defineProperty(t.prototype,"defaultSymbol",{set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)},enumerable:!0,configurable:!0}),t.prototype.readDefaultSymbol=function(e,t,r){return f.read(e,t,r)},t.prototype.writeDefaultSymbol=function(e,t,r){if(!this._isDefaultSymbolDerived){var o=f.write(e,{},r);o&&(t.defaultSymbol=o)}},t.prototype.readPortal=function(e,t,r){return r.portal||a.getDefault()},t.prototype.readStyleOrigin=function(e,t,r){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){var o=n.read(t.styleUrl,r);return Object.freeze({styleUrl:o})}},t.prototype.writeStyleOrigin=function(e,t,r){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=n.write(e.styleUrl,r))},Object.defineProperty(t.prototype,"uniqueValueInfos",{set:function(e){return this.styleOrigin?void m.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e.slice(0)),void this._updateValueInfoMap())},enumerable:!0,configurable:!0}),t.prototype.readUniqueValueInfos=function(e,t,r){return Array.isArray(e)?e.map(function(e){return e=i.clone(e),e.symbol=f.read(e.symbol,t,r),e}):void 0},t.prototype.writeUniqueValueInfos=function(e,t,r){this.styleOrigin||(t.uniqueValueInfos=(this.uniqueValueInfos||[]).map(function(e){return e=i.clone(e),e.symbol&&(e.symbol=f.write(e.symbol,{},r)),e.value=e.value+"",i.fixJson(e)}))},t.prototype.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void m.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");var r;r="object"==typeof e?e:{value:e,symbol:t},this.uniqueValueInfos.push(r),this._valueInfoMap[r.value+""]=r},t.prototype.removeUniqueValueInfo=function(e){if(this.styleOrigin)return void m.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");for(var t=0;t<this.uniqueValueInfos.length;t++){var r=this.uniqueValueInfos[t];if(r.value+""==e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}},t.prototype.getUniqueValueInfo=function(e,t){var r,o=this.field,l=e.attributes;if(this.valueExpression)r=c.executeFunction(this.compiledFunc,c.createExecContext(e,c.getView(t)));else if(this.field2){var i=this.field2,n=this.field3,s=[];o&&s.push(l[o]),i&&s.push(l[i]),n&&s.push(l[n]),r=s.join(this.fieldDelimiter||"")}else r=o&&"function"==typeof o?o(e):l[o];return this._valueInfoMap[r+""]},t.prototype.getSymbol=function(e,t){var r=this.getUniqueValueInfo(e,t);return r&&r.symbol||this.defaultSymbol},t.prototype.clone=function(){var e=new t({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:i.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:i.clone(this.visualVariables),legendOptions:i.clone(this.legendOptions),authoringInfo:i.clone(this.authoringInfo)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);var r=i.clone(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(i.clone(this.styleOrigin))),Object.freeze(r)),e._set("uniqueValueInfos",r),e._updateValueInfoMap(),e},t.prototype.collectRequiredFields=function(e){this.inherited(arguments),[this.field,this.field2,this.field3].forEach(function(t){t&&(e[t]=!0)})},t.prototype.populateFromStyle=function(){var e=this;return y.fetchStyle(this.styleOrigin,{portal:this.portal}).then(function(t){var r=[];return e._valueInfoMap={},t&&t.data&&Array.isArray(t.data.items)&&t.data.items.forEach(function(o){var l=new p({styleUrl:t.styleUrl,styleName:t.styleName,portal:e.portal,name:o.name});e.defaultSymbol||o.name!==t.data.defaultItem||(e.defaultSymbol=l,e._isDefaultSymbolDerived=!0);var i={value:o.name,symbol:l};r.push(i),e._valueInfoMap[o.name]=i}),e._set("uniqueValueInfos",Object.freeze(r)),!e.defaultSymbol&&e.uniqueValueInfos.length&&(e.defaultSymbol=e.uniqueValueInfos[0].symbol,e._isDefaultSymbolDerived=!0),e})},t.prototype._updateValueInfoMap=function(){var e=this;this._valueInfoMap={},this.uniqueValueInfos.forEach(function(t){return e._valueInfoMap[t.value+""]=t})},t.fromPortalStyle=function(e,r){var o=new t(r&&r.properties);o._set("styleOrigin",Object.freeze({styleName:e})),o._set("portal",r&&r.portal||a.getDefault());var l=o.populateFromStyle();return l.otherwise(function(t){m.error("#fromPortalStyle('"+e+"'[, ...])","Failed to create unique value renderer from style name",t)}),l},t.fromStyleUrl=function(e,r){var o=new t(r&&r.properties);o._set("styleOrigin",Object.freeze({styleUrl:e}));var l=o.populateFromStyle();return l.otherwise(function(t){m.error("#fromStyleUrl('"+e+"'[, ...])","Failed to create unique value renderer from style URL",t)}),l},o([l.property()],t.prototype,"type",void 0),o([l.property({json:{readFrom:"field1",writeTo:"field1"}})],t.prototype,"field",void 0),o([l.property({json:{writable:!0}})],t.prototype,"field2",void 0),o([l.property({json:{writable:!0}})],t.prototype,"field3",void 0),o([l.property({json:{writable:!0}})],t.prototype,"valueExpression",void 0),o([l.write("valueExpression")],t.prototype,"writeValueExpression",null),o([l.property({json:{writable:!0}})],t.prototype,"valueExpressionTitle",void 0),o([l.write("valueExpressionTitle")],t.prototype,"writeValueExpressionTitle",null),o([l.property({dependsOn:["valueExpression"]})],t.prototype,"compiledFunc",null),o([l.property({json:{writable:!0}})],t.prototype,"legendOptions",void 0),o([l.write("legendOptions")],t.prototype,"writeLegendOptions",null),o([l.property({json:{writable:!0}})],t.prototype,"defaultLabel",void 0),o([l.property()],t.prototype,"defaultSymbol",null),o([l.read("defaultSymbol")],t.prototype,"readDefaultSymbol",null),o([l.write("defaultSymbol")],t.prototype,"writeDefaultSymbol",null),o([l.property({json:{writable:!0}})],t.prototype,"fieldDelimiter",void 0),o([l.property({type:a,readOnly:!0})],t.prototype,"portal",void 0),o([l.read("portal",["styleName"])],t.prototype,"readPortal",null),o([l.property({readOnly:!0,json:{writable:!0}})],t.prototype,"styleOrigin",void 0),o([l.read("styleOrigin",["styleName","styleUrl"])],t.prototype,"readStyleOrigin",null),o([l.write("styleOrigin")],t.prototype,"writeStyleOrigin",null),o([l.property()],t.prototype,"uniqueValueInfos",null),o([l.read("uniqueValueInfos")],t.prototype,"readUniqueValueInfos",null),o([l.write("uniqueValueInfos")],t.prototype,"writeUniqueValueInfos",null),o([l.property({dependsOn:["field","field2","field3"],readOnly:!0})],t.prototype,"requiredFields",void 0),t=o([l.subclass("esri.renderer.UniqueValueRenderer")],t)}(l.declared(d));return h});