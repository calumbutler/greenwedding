// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../core/accessorSupport/decorators","../core/Error","../config","../identity/IdentityManager","../request","../geometry/Extent","../core/JSONSupport","../core/Loadable","./PortalQueryParams","./PortalQueryResult","./PortalUser","../core/promiseUtils","../core/requireUtils","dojo/promise/all","dojo/_base/kernel","dojo/_base/lang"],function(t,e,r,o,p,n,i,a,s,u,l,y,d,h,c,m,f,v,P,S,g){function _(){return y}var O,b=function(e){function y(t){e.call(this),this.access=null,this.allSSL=!1,this.authMode=y.AUTH_MODE_AUTO,this.authorizedCrossOriginDomains=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!1,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultExtent=null,this.description=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=a.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1}return r(y,e),y.prototype.normalizeCtorArgs=function(t){return"string"==typeof t?{url:t}:t},y.prototype.initialize=function(){var t=this;this._esriId_credentialCreateHandle=s.on("credential-create",function(){t.loaded&&!t.credential&&t.authMode===y.AUTH_MODE_AUTO&&(t.credential=s.findCredential(t.restUrl),t.credential&&t._fetchSelf().then(function(e){t.read(e)}))})},y.prototype.destroy=function(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},y.prototype.readDefaultBasemap=function(t){if(t){var e=O.fromJSON(t);return e.portalItem={portal:this},e}return null},Object.defineProperty(y.prototype,"extraQuery",{get:function(){return this.id&&!this.canSearchPublic?" AND orgid:"+this.id:null},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"isOrganization",{get:function(){return!!this.access},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"restUrl",{get:function(){var t=this.url;if(t){var e=t.indexOf("/sharing");t=e>0?t.substring(0,e):this.url.replace(/\/+$/,""),t+="/sharing/rest"}return t},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"thumbnailUrl",{get:function(){var t=this.restUrl,e=this.thumbnail;return t&&e?this._normalizeSSL(t+"/portals/self/resources/"+e):null},enumerable:!0,configurable:!0}),y.prototype.readUser=function(t){var e=null;return t&&(e=m.fromJSON(t),e.portal=this),e},y.prototype.load=function(){var e=this,r=f.resolve().then(function(){return e.authMode===y.AUTH_MODE_IMMEDIATE?s.getCredential(e.restUrl):e.authMode===y.AUTH_MODE_AUTO?s.checkSignInStatus(e.restUrl).otherwise(function(){return null}):null}).then(function(r){return e.credential=r,v.when(t,"../Basemap")}).then(function(t){O=t}).then(function(){return e._fetchSelf()}).then(function(t){e.read(t)});return this.addResolvingPromise(r),this},y.prototype.fetchBasemaps=function(){var t=new h;return t.query=this.basemapGalleryGroupQuery,t.disableExtraQuery=!0,this.queryGroups(t).then(function(e){if(t.num=100,t.query='type:"Web Map" -type:"Web Application"',e.total){var r=e.results[0];return t.sortField=r.sortField||"name",t.sortOrder=r.sortOrder||"desc",r.queryItems(t)}return null}).then(function(t){var e;return e=t&&t.total?t.results.filter(function(t){return"Web Map"===t.type}).map(function(t){return new O({portalItem:t})}):[]})},y.prototype.fetchFeaturedGroups=function(){var t=this.featuredGroups,e=new h;if(e.num=100,e.sortField="title",t&&t.length){for(var r=[],o=0,p=t;o<p.length;o++){var n=p[o];r.push('(title:"'+n.title+'" AND owner:'+n.owner+")")}return e.query=r.join(" OR "),this.queryGroups(e).then(function(t){return t.results})}return f.resolve([])},y.getDefault=function(){return y._default||(y._default=new y),y._default},y.prototype.queryGroups=function(t){return this._queryPortal("/community/groups",t,"PortalGroup")},y.prototype.queryItems=function(t){return this._queryPortal("/search",t,"PortalItem")},y.prototype.queryUsers=function(t){return t.sortField||(t.sortField="username"),this._queryPortal("/community/users",t,"PortalUser")},y.prototype.toJSON=function(){throw new i("internal:not-yet-implemented","Portal.toJSON is not yet implemented")},y.prototype._fetchSelf=function(){var t=this.restUrl+"/portals/self";return this._request(t,{query:{culture:S.locale}})},y.prototype._queryPortal=function(e,r,o){var p=this,n=function(t){return p._request(p.restUrl+e,r.toRequestOptions(p)).then(function(e){var o=r.clone();return o.start=e.nextStart,new c({nextQueryParams:o,queryParams:r,total:e.total,results:y._resultsToTypedArray(t,{portal:p},e)})}).then(function(t){return P(t.results).always(function(){return t})})};return o?v.when(t,"./"+o).then(function(t){return n(t)}):n()},y.prototype._normalizeSSL=function(t){var e=this.allSSL||window&&"https:"===window.location.protocol;if(this.isPortal){var r=y._getLocation(t);if(this.portalHostname.toLowerCase().indexOf(r.hostname.toLowerCase())>-1&&r.port&&"80"!==r.port&&"443"!==r.port){var o=r.pathname;return 0!==o.indexOf("/")&&(o="/"+o),e?"https://"+r.hostname+(this.httpsPort&&443!==this.httpsPort?":"+this.httpsPort:"")+o+r.search:"http://"+r.hostname+(this.httpPort&&80!==this.httpPort?":"+this.httpPort:"")+o+r.search}return e?t.replace("http:","https:"):t}return e?t.replace("http:","https:"):t},y.prototype._normalizeUrl=function(t){var e=this.credential&&this.credential.token;return this._normalizeSSL(e?t+(t.indexOf("?")>-1?"&":"?")+"token="+e:t)},y.prototype._requestToTypedArray=function(e,r,o){var p=this,n=function(t){return p._request(e,r).then(function(e){var r=y._resultsToTypedArray(t,{portal:p},e);return P(r).always(function(){return r})})};return o?v.when(t,"./"+o).then(function(t){return n(t)}):n()},y.prototype._request=function(t,e){var r,o={f:"json"},p={disableIdentityLookup:this.authMode===y.AUTH_MODE_ANONYMOUS};return e&&(g.mixin(o,e.query),r=e.responseType,p.method=e.method),u(this._normalizeSSL(t),g.mixin({callbackParamName:"callback",query:o,responseType:r,timeout:0},p)).then(function(t){return t.data})},y._getLocation=function(t){var e=document.createElement("a");return e.href=t,{protocol:e.protocol,hostname:e.hostname,port:e.port,pathname:e.pathname,search:e.search,hash:e.hash,host:e.host}},y._resultsToTypedArray=function(t,e,r){var o;return r?(o=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(t||e)&&(o=o.map(function(r){var o=g.mixin(t?t.fromJSON(r):r,e);return"function"==typeof o.load&&o.load(),o}))):o=[],o},y.AUTH_MODE_ANONYMOUS="anonymous",y.AUTH_MODE_AUTO="auto",y.AUTH_MODE_IMMEDIATE="immediate",o([n.property()],y.prototype,"access",void 0),o([n.property()],y.prototype,"allSSL",void 0),o([n.property()],y.prototype,"authMode",void 0),o([n.property()],y.prototype,"authorizedCrossOriginDomains",void 0),o([n.property()],y.prototype,"basemapGalleryGroupQuery",void 0),o([n.property()],y.prototype,"bingKey",void 0),o([n.property()],y.prototype,"canListApps",void 0),o([n.property()],y.prototype,"canListData",void 0),o([n.property()],y.prototype,"canListPreProvisionedItems",void 0),o([n.property()],y.prototype,"canProvisionDirectPurchase",void 0),o([n.property()],y.prototype,"canSearchPublic",void 0),o([n.property()],y.prototype,"canShareBingPublic",void 0),o([n.property()],y.prototype,"canSharePublic",void 0),o([n.property()],y.prototype,"canSignInArcGIS",void 0),o([n.property()],y.prototype,"canSignInIDP",void 0),o([n.property()],y.prototype,"colorSetsGroupQuery",void 0),o([n.property()],y.prototype,"commentsEnabled",void 0),o([n.property({type:Date})],y.prototype,"created",void 0),o([n.property()],y.prototype,"credential",void 0),o([n.property()],y.prototype,"culture",void 0),o([n.property()],y.prototype,"customBaseUrl",void 0),o([n.property()],y.prototype,"defaultBasemap",void 0),o([n.read("defaultBasemap")],y.prototype,"readDefaultBasemap",null),o([n.property({type:l})],y.prototype,"defaultExtent",void 0),o([n.property()],y.prototype,"description",void 0),o([n.property({dependsOn:["id","canSearchPublic"],readOnly:!0})],y.prototype,"extraQuery",null),o([n.property()],y.prototype,"featuredGroups",void 0),o([n.property()],y.prototype,"featuredItemsGroupQuery",void 0),o([n.property()],y.prototype,"galleryTemplatesGroupQuery",void 0),o([n.property()],y.prototype,"livingAtlasGroupQuery",void 0),o([n.property()],y.prototype,"helpBase",void 0),o([n.property()],y.prototype,"helperServices",void 0),o([n.property()],y.prototype,"helpMap",void 0),o([n.property()],y.prototype,"homePageFeaturedContent",void 0),o([n.property()],y.prototype,"homePageFeaturedContentCount",void 0),o([n.property()],y.prototype,"httpPort",void 0),o([n.property()],y.prototype,"httpsPort",void 0),o([n.property()],y.prototype,"id",void 0),o([n.property()],y.prototype,"ipCntryCode",void 0),o([n.property({dependsOn:["access"],readOnly:!0})],y.prototype,"isOrganization",null),o([n.property()],y.prototype,"isPortal",void 0),o([n.property()],y.prototype,"layerTemplatesGroupQuery",void 0),o([n.property()],y.prototype,"maxTokenExpirationMinutes",void 0),o([n.property({type:Date})],y.prototype,"modified",void 0),o([n.property()],y.prototype,"name",void 0),o([n.property()],y.prototype,"portalHostname",void 0),o([n.property()],y.prototype,"portalMode",void 0),o([n.property()],y.prototype,"portalProperties",void 0),o([n.property()],y.prototype,"region",void 0),o([n.property({dependsOn:["url"],readOnly:!0})],y.prototype,"restUrl",null),o([n.property()],y.prototype,"rotatorPanels",void 0),o([n.property()],y.prototype,"showHomePageDescription",void 0),o([n.property()],y.prototype,"staticImagesUrl",void 0),o([n.property()],y.prototype,"stylesGroupQuery",void 0),o([n.property()],y.prototype,"supportsHostedServices",void 0),o([n.property()],y.prototype,"symbolSetsGroupQuery",void 0),o([n.property()],y.prototype,"templatesGroupQuery",void 0),o([n.property()],y.prototype,"thumbnail",void 0),o([n.property({dependsOn:["restUrl","thumbnail"],readOnly:!0})],y.prototype,"thumbnailUrl",null),o([n.property()],y.prototype,"units",void 0),o([n.property()],y.prototype,"url",void 0),o([n.property()],y.prototype,"urlKey",void 0),o([n.property()],y.prototype,"user",void 0),o([n.read("user")],y.prototype,"readUser",null),o([n.property()],y.prototype,"useStandardizedQuery",void 0),o([p(1,n.cast(h))],y.prototype,"_queryPortal",null),y=o([n.subclass("esri.portal.Portal")],y)}(n.declared(_(),d));return b});