// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/has","dojo/_base/lang","../Symbol3D","./jsonUtils","./Thumbnail","./StyleOrigin","../../core/urlUtils","../../core/promiseUtils","../../core/Error","../../request","../../portal/Portal","../../portal/PortalQueryParams"],function(e,t,r,n,l,a,s,o,u,i,y,m,f,c){function h(e,t){e=u.normalize(u.makeAbsolute(e,t));var r=e.lastIndexOf("/");return-1===r?{url:e,base:e,filename:null}:{url:e,base:e.slice(0,r),filename:e.slice(r+1)}}function b(e,t){p(e,function(e){return h(e,t).url})}function d(e,t){var r=e;r.symbolLayers&&r.symbolLayers.forEach(t)}function p(e,t){d(e,function(e){var r=e.resource;r&&r.href&&(r.href=t(r.href))})}function g(e){p(e,function(e){return/\.svg$/.test(e)?(e.slice(0,e.length-4)+".png").replace("/resource/","/resource/png/"):e})}function v(e,t){return e=n.clone(e),b(e,t),(r("ie")||r("trident"))&&g(e),a.fromJSON(e)}function w(e,t){var r=h(e,t&&t.url&&t.url.path);return O(r.url).then(function(t){return{reference:{styleUrl:e},data:t.data,base:r.base,filename:r.filename,styleUrl:e}})}function S(e,t){var r,n=t.portal||f.getDefault(),l=n.url+" - "+e;return T[l]?i.resolve(T[l]):U(e,n).then(function(e){return r=e,e.fetchData()}).then(function(t){var n={data:t,base:r.itemUrl,filename:"data",styleName:e};return T[l]=n,n})}function U(e,t){return t.load().then(function(){if(!t.stylesGroupQuery)throw new y("layer-templates:styles-group-query-missing","The styles group query needs to be configured in the portal to query styles");var e=new c({disableExtraQuery:!0,query:t.stylesGroupQuery});return t.queryGroups(e)}).then(function(t){var r=t.results;if(!r||!Array.isArray(r)||0===r.length)throw new y("layer-templates:styles-missing","The styles group does not contain any styles");var n=r[0],l=new c({disableExtraQuery:!0,query:'typekeywords:"'+e+'"'});return n.queryItems(l)}).then(function(t){var r=t.results;if(!r||!Array.isArray(r)||0===r.length)throw new y("layer-templates:style-missing","The style '${styleName}' is not part of the styles group",{styleName:e});return r[0].load()})}function N(e,t){return e.styleUrl?w(e.styleUrl,t):e.styleName?S(e.styleName,t):i.reject(new y("layer-templates:style-url-and-name-missing","Either styleUrl or styleName is required in layerDefinition"))}function j(e,t){return e.name?N(e,t).then(function(r){return q(r,e.name,t)}):i.reject(new y("layer-templates:style-symbol-reference-name-missing","Missing name in style symbol reference"))}function q(e,t,r){for(var n=e.data,a=function(n){if(n.name===t){var a=h(n.webRef,e.base);return{value:O(a.url).then(function(u){var i=v(u.data,a.base);return i&&i.isInstanceOf(l)&&(n.thumbnail&&(n.thumbnail.href?i.thumbnail=new s["default"]({url:n.thumbnail.href}):n.thumbnail.imageData&&(i.thumbnail=new s["default"]({url:"data:image/png;base64,"+n.thumbnail.imageData}))),e.styleUrl?i.styleOrigin=new o({portal:r.portal,styleUrl:e.styleUrl,name:t}):e.styleName&&(i.styleOrigin=new o({portal:r.portal,styleName:e.styleName,name:t}))),i})}}},u=0,m=n.items;u<m.length;u++){var f=m[u],c=a(f);if("object"==typeof c)return c.value}return i.reject(new y("layer-templates:symbol-name-not-found","The symbol name '${symbolName}' could not be found",{symbolName:t}))}function D(e){var t=e.data;if(!t.symbolSetUrl)return i.reject(new y("layer-templates:symbol-set-url-missing","Style does not provide symbol set URL",{style:t}));var r=h(t.symbolSetUrl,e.base);return O(r.url).then(function(e){var n=e.data;if(0===n.length||!n[0].name)throw new y("layer-templates:symbol-set-missing-data","Invalid syntax or missing data in symbol set",{style:t});for(var l={},a=0;a<n.length;a++){var s=v(n[a],r.base);l[n[a].name]=s,n[a].name===t.defaultItem&&(l.defaultSymbol=s)}return l.defaultSymbol||(l.defaultSymbol=l[n[0].name]),l})}function E(e,t){return e?v(e,t&&t.url&&t.url.path):null}function I(e){for(var t=0,r=e.typeKeywords;t<r.length;t++){var n=r[t];if(/^Esri.*Style$/.test(n))return n}}function O(e){var t={responseType:"json"};return/\.json$/.test(e)||(t.query={f:"json"}),m(u.normalize(e),t)}t.fetchStyleFromUrl=w;var T={};t.fetchStyle=N,t.fetchStyleSymbol=j,t.fetchSymbolFromStyle=q,t.fetchSymbolSet=D,t.createSymbol=E,t.styleNameFromItem=I});