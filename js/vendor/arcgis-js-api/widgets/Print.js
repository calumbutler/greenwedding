// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","./Print/PrintViewModel","../tasks/support/PrintTemplate","../core/watchUtils","./Widget","./support/widget","dojo/i18n!./Print/nls/Print"],function(e,t,i,n,a,o,r,s,l,c,d){var p={base:"esri-print esri-widget",headerTitle:"esri-print__header-title",inputText:"esri-print__input-text",layoutTabList:"esri-print__layout-tab-list",layoutTab:"esri-print__layout-tab",layoutSection:"esri-print__layout-section",mapOnlySection:"esri-print__map-only-section",scaleInput:"esri-print__scale-input",advancedOptionsButton:"esri-print__advanced-options-button",advancedOptionsButtonContainer:"esri-print__advanced-options-button-container",advancedOptionsButtonTitle:"esri-print__advanced-options-button-title",advancedOptionsButtonIconOpened:"esri-print__advanced-options-button-icon--opened",advancedOptionsButtonIconClosed:"esri-print__advanced-options-button-icon--closed",advancedOptionsButtonIconClosed_RTL:"esri-print__advanced-options-button-icon--closed-rtl",refreshButton:"esri-print__refresh-button",swapButton:"esri-print__swap-button",linkButton:"esri-print__link-button",printButton:"esri-print__export-button",formSectionContainer:"esri-print__form-section-container",advancedOptionsSection:"esri-print__advanced-options-section",advancedOptionsContainer:"esri-print__advanced-options-container",authorInfoContainer:"esri-print__author-info-container",copyrightInfoContainer:"esri-print__copyright-info-container",exportedFilesContainer:"esri-print__export-panel-container",exportedFilesTitle:"esri-print__export-title",exportedFile:"esri-print__exported-file",heightContainer:"esri-print__height-container",legendInfoContainer:"esri-print__legend-info-container",printWidgetContainer:"esri-print__container",panelContainer:"esri-print__panel-container",scaleInfoContainer:"esri-print__scale-info-container",scaleInputContainer:"esri-print__scale-input-container",sizeContainer:"esri-print__size-container",widthContainer:"esri-print__width-container",button:"esri-widget-button",disabled:"esri-disabled",hide:"esri-hidden",rotate:"esri-rotating",iconCheckMark:"esri-icon-check-mark",iconDownload:"esri-icon-download",iconError:"esri-icon-error",iconPrinter:"esri-icon-printer",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconDownArrow:"esri-icon-down-arrow",iconRefresh:"esri-icon-refresh",iconSpinner:"esri-icon-loading-indicator",iconSwap:"esri-icon-swap",iconLinked:"esri-icon-link-horizontal",iconUnlinked:"esri-icon-unlocked-link-horizontal"},h=function(e){function t(){e.call(this),this._attribution=!0,this._exportedFileNameMap={},this._layoutTabSelected=!0,this._legend=!0,this._advancedOptionsVisible=!1,this._pendingExportScroll=!1,this._selectedTemplate=new r,this._scaleEnabled=!1,this._templatesInfo=null,this._extent=null,this._viewpoint=null,this.view=null,this.viewModel=new o,this.printServiceUrl=null}return i(t,e),t.prototype.postInitialize=function(){var e=this;this.viewModel.getPrintTemplatesFromService().then(function(t){e._templatesInfo=t,e._selectedTemplate.layout=e._templatesInfo.layout.defaultValue,e._selectedTemplate.format=e._templatesInfo.format.defaultValue,"MAP_ONLY"===e._selectedTemplate.layout&&(e._layoutTabSelected=!1),e.scheduleRender()}),s.init(this.viewModel.view,"scale",function(t){e._scaleEnabled||(e._scale=t,e.scheduleRender())}),this._width=this._selectedTemplate.exportOptions.width,this._height=this._selectedTemplate.exportOptions.height},t.prototype.render=function(){var e=this,t=c.jsxFactory.createElement("div",{key:"title-section","class":p.formSectionContainer},c.jsxFactory.createElement("label",{"for":this.id+"__title"},this._layoutTabSelected?d.title:d.fileName),c.jsxFactory.createElement("input",{id:this.id+"__title",name:"title",type:"text",tabIndex:0,placeholder:this._layoutTabSelected?d.titlePlaceHolder:d.fileNamePlaceHolder,"class":p.inputText,oninput:this._updateInputValue,bind:this})),i=this.get("_templatesInfo.format.choiceList")||[],n=i.length>0?i.map(function(e){return c.jsxFactory.createElement("option",{key:e},e)}):c.jsxFactory.createElement("option",{key:"format-default-option"},d.formatDefaultOption),a=c.jsxFactory.createElement("div",{key:"file-format-section","class":p.formSectionContainer},c.jsxFactory.createElement("label",{"for":this.id+"__formats"},d.fileFormatTitle),c.jsxFactory.createElement("select",{id:this.id+"__formats",onchange:this._updateFromOption,"data-target-property":"format",bind:this},n)),o=this.get("_templatesInfo.layout.choiceList")||[],r=o.length>0?o.map(function(t){return c.jsxFactory.createElement("option",{key:t,bind:e},t)}):c.jsxFactory.createElement("option",{key:"layout-default-option"},d.layoutDefaultOption),s=c.jsxFactory.createElement("div",{key:"page-setup-section","class":p.formSectionContainer},c.jsxFactory.createElement("label",{"for":this.id+"__layouts"},d.layoutTitle),c.jsxFactory.createElement("select",{id:this.id+"__layouts",onchange:this._updateFromOption,"data-target-property":"layout",bind:this},r)),l=this._advancedOptionsVisible?c.jsxFactory.createElement("div",{"aria-labelledby":this.id+"__advancedOptions","class":p.advancedOptionsContainer},c.jsxFactory.createElement("div",{"class":c.join(p.scaleInfoContainer,p.formSectionContainer)},c.jsxFactory.createElement("input",{id:this.id+"__scaleEnabled",name:"scaleEnabled",type:"checkbox",tabIndex:0,onchange:this._toggleInputValue,bind:this}),c.jsxFactory.createElement("label",{"for":this.id+"__scaleEnabled"},d.scale),c.jsxFactory.createElement("div",{"class":p.scaleInputContainer},c.jsxFactory.createElement("input",{id:this.id+"__scale","aria-label":d.scaleLabel,type:"number",name:"scale","class":c.join(p.inputText,p.scaleInput),tabIndex:0,oninput:this._updateInputValue,disabled:!this._scaleEnabled,value:""+this._scale,bind:this}),c.jsxFactory.createElement("button",{role:"button","aria-label":d.reset,"class":c.join(p.button,p.refreshButton,p.iconRefresh),tabIndex:0,onclick:this._resetToCurrentScale,bind:this}))),c.jsxFactory.createElement("div",{"class":c.join(p.authorInfoContainer,p.formSectionContainer)},c.jsxFactory.createElement("label",{"for":this.id+"__author"},d.author),c.jsxFactory.createElement("input",{id:this.id+"__author",type:"text",name:"author","class":p.inputText,tabIndex:0,oninput:this._updateInputValue,bind:this})),c.jsxFactory.createElement("div",{"class":c.join(p.copyrightInfoContainer,p.formSectionContainer)},c.jsxFactory.createElement("label",{"for":this.id+"__copyright"},d.copyright),c.jsxFactory.createElement("input",{id:this.id+"__copyright",type:"text",name:"copyright","class":p.inputText,tabIndex:0,oninput:this._updateInputValue,bind:this})),c.jsxFactory.createElement("div",{"class":c.join(p.legendInfoContainer,p.formSectionContainer)},c.jsxFactory.createElement("input",{id:this.id+"__legend",type:"checkbox",name:"legend",tabIndex:0,checked:!0,onchange:this._toggleInputValue,bind:this}),c.jsxFactory.createElement("label",{"for":this.id+"__legend"},d.legend))):null,h=this._layoutTabSelected?c.jsxFactory.createElement("section",{id:this.id+"__layoutContent",key:"layout-content","aria-labelledby":this.id+"__layoutTab","class":p.layoutSection},c.jsxFactory.createElement("div",{key:"layout","class":p.panelContainer},t,s,this._layoutTabSelected?a:null),c.jsxFactory.createElement("div",{key:"advanced-section","class":c.join(p.panelContainer,p.advancedOptionsSection)},c.jsxFactory.createElement("button",{id:this.id+"__advancedOptions","aria-label":d.advancedOptions,"aria-expanded":this._advancedOptionsVisible?"true":"false",role:"button","class":p.advancedOptionsButton,onclick:this._showAdvancedOptions,bind:this},c.jsxFactory.createElement("div",{"class":p.advancedOptionsButtonContainer},c.jsxFactory.createElement("span",{"aria-hidden":"true","class":c.join(p.iconRightTriangleArrow,p.advancedOptionsButtonIconClosed)}),c.jsxFactory.createElement("span",{"aria-hidden":"true","class":c.join(p.iconLeftTriangleArrow,p.advancedOptionsButtonIconClosed_RTL)}),c.jsxFactory.createElement("span",{"aria-hidden":"true","class":c.join(p.iconDownArrow,p.advancedOptionsButtonIconOpened)}),c.jsxFactory.createElement("span",{"class":p.advancedOptionsButtonTitle},d.advancedOptions))),l)):c.jsxFactory.createElement("section",{id:this.id+"__mapOnlyContent","aria-labelledby":this.id+"__mapOnlyTab",key:"map-only-content","class":p.mapOnlySection},c.jsxFactory.createElement("div",{key:"mapOnly","class":p.panelContainer},t,this._layoutTabSelected?null:a,c.jsxFactory.createElement("div",{"class":c.join(p.sizeContainer,p.formSectionContainer)},c.jsxFactory.createElement("div",{"class":p.widthContainer},c.jsxFactory.createElement("label",{"for":"width"},d.width),c.jsxFactory.createElement("input",{id:this.id+"__width",type:"text",name:"width","class":p.inputText,onchange:this._updateInputValue,value:""+this._width,tabIndex:0,bind:this})),c.jsxFactory.createElement("div",{"class":p.heightContainer},c.jsxFactory.createElement("label",{"for":"height"},d.height),c.jsxFactory.createElement("input",{id:this.id+"__height",type:"text",name:"height","class":p.inputText,onchange:this._updateInputValue,value:""+this._height,tabIndex:0,bind:this})),c.jsxFactory.createElement("button",{role:"button","aria-label":d.swap,"class":c.join(p.button,p.swapButton,p.iconSwap),onclick:this._switchInput,tabIndex:0,bind:this})),c.jsxFactory.createElement("div",{key:"attribution-container","class":p.formSectionContainer},c.jsxFactory.createElement("input",{id:this.id+"__attribution",name:"attribution",type:"checkbox",onchange:this._toggleInputValue,tabIndex:0,checked:!0,bind:this}),c.jsxFactory.createElement("label",{"for":"attribution"},d.attribution)))),u=this.exportedLinks.toArray(),_=(m={},m[p.disabled]=!this._selectedTemplate.layout&&!this._selectedTemplate.format,m),y=c.jsxFactory.createElement("div",{id:this.id+"__printContainer",key:"print-widget-panel"},c.jsxFactory.createElement("div",{"class":p.printWidgetContainer},c.jsxFactory.createElement("header",{"class":p.headerTitle},d["export"]),c.jsxFactory.createElement("ul",{"class":p.layoutTabList,role:"tablist",onclick:this._toggleLayoutPanel,onkeydown:this._toggleLayoutPanel,bind:this},c.jsxFactory.createElement("li",{id:this.id+"__layoutTab","data-tab-id":"layoutTab","class":p.layoutTab,role:"tab",tabIndex:0,"aria-selected":""+this._layoutTabSelected,bind:this},d.layoutTab),c.jsxFactory.createElement("li",{id:this.id+"__mapOnlyTab","data-tab-id":"mapOnlyTab","class":p.layoutTab,role:"tab",tabIndex:0,"aria-selected":""+!this._layoutTabSelected,bind:this},d.mapOnlyTab)),h,c.jsxFactory.createElement("button",{"aria-label":d["export"],role:"button","class":p.printButton,tabIndex:0,classes:_,onclick:this._handlePrintMap,bind:this},d["export"]),c.jsxFactory.createElement("div",{id:this.id+"__exportedFilesContainer","class":p.exportedFilesContainer,afterUpdate:this._scrollExportIntoView,bind:this},c.jsxFactory.createElement("h2",{"class":p.exportedFilesTitle},d.exportText),u.length>0?null:c.jsxFactory.createElement("div",{key:"exported-section-hints"},c.jsxFactory.createElement("div",null,d.exportHint)),u.map(function(e){var t=(a={},a[p.iconSpinner]="pending"===e.state,a[p.rotate]="pending"===e.state,a[p.iconDownload]="ready"===e.state,a[p.iconError]="error"===e.state,a),i=(o={},o[p.disabled]="ready"!==e.state,o),n=""===e.url?null:e.url;return c.jsxFactory.createElement("div",{key:e.name,"class":p.exportedFile},c.jsxFactory.createElement("a",{href:n,classes:t,tabIndex:0,download:!0}),c.jsxFactory.createElement("a",{href:n,classes:i,tabIndex:0,target:"_blank"},e.name));var a,o}))));return c.jsxFactory.createElement("div",{"class":p.base},y);var m},t.prototype._configurePrintTemplate=function(){this._selectedTemplate.attributionVisible=this._attribution,this._width&&(this._selectedTemplate.exportOptions.width=this._width),this._height&&(this._selectedTemplate.exportOptions.height=this._height),this._selectedTemplate.layoutOptions={titleText:this._title||"",authorText:this._author||"",copyrightText:this._copyright||""},this._legend||(this._selectedTemplate.layoutOptions.legendLayers=[]),this.scale=this._scale,this._scaleEnabled&&(this._extent=this.viewModel.getExtent(this._viewpoint,this.scale,this.viewModel.view.size))},t.prototype._resetToCurrentScale=function(){this._scale=this.viewModel.view.scale},t.prototype._updateInputValue=function(e){var t=e.target,i="_"+t.name;this[i]=t.value},t.prototype._handlePrintMap=function(){var e=this;this._configurePrintTemplate();var t=this._title||d.untitled,i=this._selectedTemplate.format.toLowerCase().indexOf("png")>-1?"png":this._selectedTemplate.format.toLowerCase(),n=t+"."+i,a=n,o=void 0!==this._exportedFileNameMap[n];o?(this._exportedFileNameMap[n]++,a=t+"("+this._exportedFileNameMap[n]+")."+i):this._exportedFileNameMap[n]=0,this.viewModel.addExportedLinks(a);var r=this.exportedLinks.length-1;this._pendingExportScroll=!0;var s=null!=this._extent?this.viewModel.print(this._selectedTemplate,this._extent):this.viewModel.print(this._selectedTemplate);s.then(function(t){var i=e.exportedLinks.getItemAt(r);i.url=t.url,i.state="ready",e.scheduleRender()},function(){var t=e.exportedLinks.getItemAt(r);t.state="error"})},t.prototype._updateFromOption=function(e){var t=e.target,i=t.selectedOptions[0].value,n=this._selectedTemplate,a=t.getAttribute("data-target-property");n[a]=i},t.prototype._switchInput=function(){e=[this._height,this._width],this._width=e[0],this._height=e[1];var e},t.prototype._showAdvancedOptions=function(){this._advancedOptionsVisible=!this._advancedOptionsVisible},t.prototype._scrollExportIntoView=function(e){this._pendingExportScroll&&(this._pendingExportScroll=!1,e.scrollIntoView())},t.prototype._toggleInputValue=function(e){var t=e.target,i="_"+t.name;this[i]=t.checked,"_scaleEnabled"===i&&(this[i]?this._viewpoint=this.viewModel.view.viewpoint.clone():(this._resetToCurrentScale(),this._extent=null))},t.prototype._resetInputValue=function(){this._title="",this._selectedTemplate.format=this._templatesInfo.format.defaultValue},t.prototype._toggleLayoutPanel=function(e){this._resetInputValue();var t=e.target;if(this._layoutTabSelected="layoutTab"===t.getAttribute("data-tab-id"),this._layoutTabSelected){var i=this.get("_templatesInfo.layout.choiceList");this._selectedTemplate.layout=i&&i[0]}else this._selectedTemplate.layout="MAP_ONLY"},n([a.aliasOf("viewModel.view"),c.renderable()],t.prototype,"view",void 0),n([a.property({type:o})],t.prototype,"viewModel",void 0),n([a.aliasOf("viewModel.printServiceUrl")],t.prototype,"printServiceUrl",void 0),n([a.aliasOf("viewModel.scale"),c.renderable()],t.prototype,"scale",void 0),n([a.aliasOf("viewModel.exportedLinks"),c.renderable()],t.prototype,"exportedLinks",void 0),n([c.accessibleHandler()],t.prototype,"_toggleLayoutPanel",null),t=n([a.subclass("esri.widgets.Print")],t)}(a.declared(l));return h});