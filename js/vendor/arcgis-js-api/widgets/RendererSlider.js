// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["./Widgette","./DateTimeTextBox","./RendererSlider/sliderUtils","../core/numberUtils","../core/watchUtils","../renderers/support/utils","dijit/_TemplatedMixin","dijit/form/NumberTextBox","dojo/_base/array","dojo/_base/lang","dojo/dnd/move","dojo/dom-construct","dojo/dom-style","dojo/dom-class","dojo/on","dojo/text!./RendererSlider/templates/RendererSlider.html"],function(e,t,i,a,s,l,o,n,r,h,d,u,m,b,c,_){var p=e.createSubclass([o],{declaredClass:"esri.widgets.RendererSlider",templateString:_,_visibleLabels:["data","handle"],_roundedDataLabels:[],_roundedHandleLabels:[],_ratioLabels:[],_minRatioLabel:"",_maxRatioLabel:"",_sliderHeight:null,_isZoomed:!1,_minZoomLabel:"",_maxZoomLabel:"",_maximumNumberEditor:null,_minimumNumberEditor:null,_valueDifferenceByIndex:[],_currentTopValue:[],_isLTR:!0,_ctrlDown:!1,_histogramSurface:null,_css:null,_minPrecisionForSmallNumbers:3,_handles:[],properties:{loaded:!1,intermediateChanges:!0,type:null,minimum:0,maximum:100,values:[],precision:2,handles:[],handlesVisible:!0,primaryHandleIndex:null,ticksVisible:!0,labelsVisible:!0,ratioLabelsVisible:null,minLabel:null,maxLabel:null,isDate:!1},constructor:function(e,t){this._css={container:"esri-renderer-slider",slidernode:"esri-slider-node",sliderarea:"esri-slider-area",sliderarearight:"esri-slider-area-right",moveable:"esri-moveable",handler:"esri-handle",handlerSpan:"esri-handle-span",handlerContainer:"esri-handle-container",handlerLabel:"esri-handle-label",handlerLabelSpan:"esri-handle-label-span",topLabelNode:"esri-top-label-node",bottomLabelNode:"esri-bottom-label-node",topLabelNodeHover:"esri-top-label-node-hover",bottomLabelNodeHover:"esri-bottom-label-node-hover",heatmapTick:"esri-heatmap-tick",handlerTick:"esri-handler-tick",handlerTickTop:"esri-handler-tick-top",handlerTickBottom:"esri-handler-tick-bottom"},this.labelsVisible=e.labelsVisible||this._visibleLabels},startup:function(){this.inherited(arguments);var e=m.get(this._sliderArea,"height");if(this._sliderHeight=e?e:200,this._checkMinMaxDefaults(),this._isLTR=this.isLeftToRight(),!this._isLTR){var t=m.get(this._sliderNode,"padding-left")+m.get(this._sliderNode,"padding-right"),i=Math.round(m.get(this._sliderNode,"width"));this._sliderNodeWidth_RTL=t+i}this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),this._generateCtrlKeyListener(),this.watch("values",this._valuesChange),this.watch("minimum, maximum, ratioLabelsVisible",this._updateTimeout),this.loaded=!0,this.emit("load")},destroy:function(){this.inherited(arguments)},setValue:function(e,t,i){var a=this.get("values"),s=a.slice(0);"object"==typeof a[0]?s[e].value=t:s[e]=t,(this.intermediateChanges||i)&&(this.values=s),i?this.emit("stop",{values:this.get("values")}):this.emit("slide",{values:s})},_updateTimeout:function(e,t,i){this._updateSlider()},_updateSlider:function(){this._reset(),this._checkMinMaxDefaults(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),this._generateCtrlKeyListener()},_checkMinMaxDefaults:function(){var e,t,a=this.values;this.minimum===this.maximum&&a&&a.length>0&&(isNaN(a[0])?this.set({minimum:0,maximum:2*a[0].value}):this.set({minimum:0,maximum:2*a[0]})),a&&a.lenth>0&&(e=isNaN(a[0])?a[0].value:a[0],this.minimum>e&&(this.minimum=e),t=isNaN(a[a.length-1])?a[a.length-1].value:a[a.length-1],this.maximum<t&&(this.maximum=t)),this.precision=i.getCombinedPrecision(this.minimum,this.maximum)},_calculateValueFromHandlePosition:function(e){var t,i=this.get("minimum"),a=this.get("maximum"),s=this.get("precision"),l=this.get("step")||Math.pow(10,-s);return t=1>=i&&i>=-1&&1>=a&&a>=-1||s>=this._minPrecisionForSmallNumbers?(e*(a-i)+i)/l*l:parseFloat((Math.round((e*(a-i)+i)/l)*l).toFixed(s))},_generateMoveables:function(){var e,t=this._sliderNode,s=this._sliderHeight,l=this.get("minimum"),o=this.get("maximum"),n=this.get("labelsVisible"),b=this.get("ticksVisible"),c=h.hitch(this,this.setValue),_=this.get("values");this._updateMinMaxLabels(),e=r.map(_,h.hitch(this,function(_,p){var L,x,N,g,v,f,V;return"object"==typeof _&&_.hidden?null:("object"==typeof _&&(_=_.value),L=u.create("div",{style:this._getHandleStyleString(_),className:this._css.moveable},t),L.handleContainer=f=u.create("div",{className:this._css.handlerContainer},L),L.arrowSpan=g=u.create("span",{className:this._css.handlerSpan},f),L.handler=x=u.create("div",{className:this._css.handler},f),"HeatmapSlider"!==this.type&&(n===!0||"object"==typeof n&&-1!==r.indexOf(n,"handles"))&&(N=this._generateHandleLabel(L,p)),b&&this._generateHandleTicks(L,p),v=new d.constrainedMoveable(L,{handle:f,within:!0,constraints:h.hitch(this,function(){return{t:0,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s}})}),v.onMoveStart=h.hitch(this,function(t){var a,l,o,n,d,u,b,c,_=this.handles,x=r.indexOf(_,p);this._currentTopValue[p]=t.node.style.top,V=Number(t.node.style.top.replace("px","")),L.labelNode&&L.labelNode._autoPositioned&&(m.set(L.labelNode,"top","3px"),L.labelNode._autoPositioned=!1),i._autoPositionHandleLabels(this.get("moveables")),L._numberEditor&&(L._numberEditor.destroy(),L._numberEditor=null),p!==this.primaryHandleIndex?(_&&_.length>0?(a=null!==_[x-1]?_[x-1]:null,l=null!==_[x+1]?_[x+1]:null,o=e[a],n=e[l]):(o=e[p-1],n=e[p+1]),o&&n?(d=o.style.top,u=n.style.top,b=Number(d.replace("px","")),c=Number(u.replace("px","")),v.constraints=h.hitch(this,function(){return{t:c+2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-c-(s-b+4)}})):o?(d=o.style.top,b=Number(d.replace("px","")),v.constraints=h.hitch(this,function(){return{t:0,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-(s-b+2)}})):n&&(u=n.style.top,c=Number(u.replace("px","")),v.constraints=h.hitch(this,function(){return{t:c+2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-(c+2)}}))):(_&&_.length>0?(a=null!==_[x-1]?_[x-1]:null,l=null!==_[x+1]?_[x+1]:null,o=e[a],n=e[l]):(o=e[p-1],n=e[p+1]),o&&n&&(d=o.style.top,u=n.style.top,b=Number(d.replace("px","")),c=Number(u.replace("px","")),v.constraints=h.hitch(this,function(){return{t:2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-4}})))}),v.onMoved=h.hitch(this,function(t){var a,n,d,u,b,_,L,x;if(p===this.primaryHandleIndex&&(d=Number(this._currentTopValue[p].replace("px",""))-Number(t.node.style.top.replace("px","")),this._currentTopValue[p]=t.node.style.top,r.forEach(e,h.hitch(this,function(e,t){if(e){if(t===p)return;if(u=Number(e.style.top.replace("px","")),_=u-d,a=1-Number(_/s),n=this._calculateValueFromHandlePosition(a),l>n||n>o)return;m.set(e,"top",_+"px"),c(t,n,!1),e.labelNode&&(e.labelNode.spanNode.innerHTML=this.ratioLabelsVisible?this._getLabelValueFromIndex(t):this._formatValue(n.toFixed(6)))}}))),a=1-Number(t.node.style.top.replace("px",""))/s,n=this._calculateValueFromHandlePosition(a),p!==this.primaryHandleIndex&&this._ctrlDown&&(d=Number(this._currentTopValue[p].replace("px",""))-Number(t.node.style.top.replace("px","")),this._currentTopValue[p]=t.node.style.top,0===p?(u=Number(e[e.length-1].style.top.replace("px","")),b=u+d,b>s&&(b=s),0>b&&(b=0),m.set(e[e.length-1],"top",b+"px"),x=1-b/s,L=this._calculateValueFromHandlePosition(x),c(e.length-1,L,!1),e[e.length-1].labelNode&&(e[e.length-1].labelNode.spanNode.innerHTML=this._formatValue(L.toFixed(6)))):p===e.length-1&&(u=Number(e[0].style.top.replace("px","")),b=u+d,b>s&&(b=s),0>b&&(b=0),m.set(e[0],"top",b+"px"),x=1-b/s,L=this._calculateValueFromHandlePosition(x),c(0,L,!1),e[0].labelNode&&(e[0].labelNode.spanNode.innerHTML=this._formatValue(L.toFixed(6))))),c(p,n,!1),this._updateRoundedLabels(),N){var g=this._formatValue(parseFloat(this._roundValue([n,parseFloat(this._getLabelValueFromIndex(p,!0))])[0]).toFixed(this.precision));N.spanNode.innerHTML=this.ratioLabelsVisible?this._getLabelValueFromIndex(p):g}i._autoPositionHandleLabels(this.get("moveables"))}),v.onMoveStop=h.hitch(this,function(e){var t,l,o;if(o=Number(e.node.style.top.replace("px","")),o===V)return void(V=null);if(t=1-o/s,l=this._calculateValueFromHandlePosition(t),c(p,l,!0),this._updateRoundedLabels(),N){var n=a.format(parseFloat(a.round([l,parseFloat(this._getLabelValueFromIndex(p,!0))])[0]).toFixed(this.precision));N.spanNode.innerHTML=this.ratioLabelsVisible?this._getLabelValueFromIndex(p):n}i._autoPositionHandleLabels(this.get("moveables"))}),this.handlesVisible||(m.set(x,"display","none"),m.set(g,"display","none")),L)})),this.moveables=e,i._autoPositionHandleLabels(this.get("moveables"))},_reset:function(){r.forEach(this.moveables,h.hitch(this,function(e){e&&e.parentElement.removeChild(e)})),this.moveables=[]},_getHandleStyleString:function(e){var t=this.get("minimum"),i=this.get("maximum"),a=(e-t)/(i-t),s=Math.round((1-a)*this._sliderHeight),l=this._isLTR?0:this._sliderNodeWidth_RTL,o="left: "+l+"px;",n="top: "+s+"px;",r=n+" "+o;return r},_generateHandleTicks:function(e,t){var i=this._css,a=i.handlerTick+" "+i.handlerTickTop,s=i.handlerTick+" "+i.handlerTickBottom,l=0===t?s:a;"HeatmapSlider"===this.type&&(l+=i.heatmapTick),e.tick=u.create("div",{className:l},e)},_updateLabels:function(){this._updateMinMaxLabels(),this._updateRoundedLabels()},_resetLabelPositions:function(){r.forEach(this.moveables,function(e){if(e){var t=e.labelNode;t&&(m.set(t,"top","3px"),e.labelNode._autoPositioned=!1)}})},_generateHandleLabel:function(e,t){var i,a;return i=u.create("div",{className:this._css.handlerLabel},e),a=u.create("span",{className:this._css.handlerLabelSpan,innerHTML:this._getLabelValueFromIndex(t)},i),i.spanNode=a,e.labelNode=i,c(i,"click",h.hitch(this,function(){this._generateHandleLabelEditor(e,t)})),i},_updateMinMaxLabels:function(){var e,t,i,a,s,l,o=this.minimum,n=this.maximum,h=this.labelsVisible,d=this.minLabel,u=this.maxLabel,m=this._topNodeSpan,b=this._bottomNodeSpan,c=this._isZoomed,_=this._maxZoomLabel,p=this._minZoomLabel,L=this.ratioLabelsVisible,x=this._maxRatioLabel,N=this._minRatioLabel,g=this._roundedDataLabels;h===!1||"object"==typeof h&&-1===r.indexOf(h,"data")?(m.innerHTML="",b.innerHTML=""):c?L?(m.innerHTML=x,b.innerHTML=N):(m.innerHTML=this._formatValue(_),b.innerHTML=this._formatValue(p)):L?(m.innerHTML=x,b.innerHTML=N):(e=isNaN(d)?d:this._roundValue([d,u])[0],t=isNaN(u)?u:this._roundValue([d,u])[1],i=isNaN(e)||null===e?d:this._formatValue(e),a=isNaN(t)||null===t?u:this._formatValue(t),s=this._formatValue(g[0])||this._formatValue(o),l=this._formatValue(g[1])||this._formatValue(n),m.innerHTML=a||l,b.innerHTML=i||s)},_formatValue:function(e){return"string"==typeof e&&(e=Number(e)),this.isDate?l.formatDate(new Date(e),l.timelineDateFormatOptions):a.format(e)},_roundValue:function(e){return this.isDate?e.slice(0):a.round(e)},_updateRoundedLabels:function(){switch(this._roundedDataLabels=this._roundValue([this.minimum,this.maximum]),this.type){case"SizeSlider":case"ClassedSizeSlider":case"ClassedColorSlider":case"UnivariateColorSizeSlider":this._roundedHandleLabels=this._roundValue(this.values);break;case"ColorSlider":case"OpacitySlider":this._roundedHandleLabels=this._roundValue(this._getValuesFromObject(this.values))}this._updateRatioLabels()},_updateRatioLabels:function(){var e,t,i=this.get("ratioLabelsVisible"),a=this.get("minimum"),s=this.get("maximum"),l=this._getValuesFromObject(this.values),o=[];if(i){if("percent"!==i&&"percentTotal"!==i)return void(i=null);"percent"===i?(r.forEach(l,function(e){o.push(this._getRatioFromValue(e))},this),e=this._formatValue(this._getRatioFromValue(a).toFixed(2)),t=this._formatValue(this._getRatioFromValue(s).toFixed(2))):"percentTotal"===i&&(r.forEach(l,function(e){o.push(this._getRatioFromValue(e))},this),e=this._formatValue(this._getRatioFromValue(a).toFixed(2)),t=this._formatValue(this._getRatioFromValue(s).toFixed(2))),this._ratioLabels=o,this._minRatioLabel=e+"%",this._maxRatioLabel=t+"%"}},_generateMinMaxEditors:function(){!this.labelsVisible||"object"==typeof this.labelsVisible&&-1===r.indexOf(this.labelsVisible,"data")||"HeatmapSlider"===this.type?(b.remove(this._topNode,this._css.topLabelNodeHover),b.remove(this._botNode,this._css.bottomLabelNodeHover)):(c(this._topNode,"click",h.hitch(this,this._generateMaxEditor)),c(this._botNode,"click",h.hitch(this,this._generateMinEditor)))},_generateMaxEditor:function(){if(!(this._maximumNumberEditor&&this._topLabelNode||this._isZoomed)){var e,i,a=this.get("minLabel"),s=this.get("maxLabel"),l=this.get("maximum"),o=this.handles;if(this._topNodeSpan.innerHTML="",this._topLabelNode=u.create("input",{type:"text"},this._topNode),e=o&&o.length>0?this.values[o[o.length-1]]:this.values[this.values.length-1],"object"==typeof e&&(e=e.value),this.ratioLabelsVisible&&(e=this._getLabelValueFromIndex(this.values.length-1,!0).replace("%",""),l=Number(this._maxRatioLabel.replace("%",""))),this.isDate){i=new t({date:new Date(Number(l)),required:!0,constraints:{min:new Date(e),max:null}},this._topLabelNode);var r={editor:i,editorPropName:"_maximumNumberEditor",spanNode:this._topNodeSpan,operator:"<"};i.on("keydown",h.hitch(this,this._minMaxKeydownDateHandler,r)),i.on("blur",h.hitch(this,this._minMaxBlurDateValue,r)),i.watch("date",h.hitch(this,this._minMaxUpdateDateValue,r))}else{i=new n({value:Number(l),required:!0,constraints:{min:e,max:"percentTotal"===this.ratioLabelsVisible?100:null,places:"0,20"}},this._topLabelNode);var d=!1;c(i,"keydown",h.hitch(this,this._keydownHandler,{editor:i,originalValidate:d})),c(i,"blur",h.hitch(this,this._minMaxBlurHandler,{editor:i,editorPropName:"_maximumNumberEditor",label:s,current:l,spanNode:this._topNodeSpan,index:1,minLabel:a,maxLabel:s,ratioLabel:this._maxRatioLabel})),c(i,"change",h.hitch(this,this._minMaxChangeHandler,{label:s,current:l,spanNode:this._topNodeSpan,index:1,minLabel:a,maxLabel:s,ratioLabel:this._maxRatioLabel,handleValue:e,operator:"<"}))}this._maximumNumberEditor=i,i.startup(),i.focus(),i.textbox.select()}},_generateMinEditor:function(){if(!(this._minimumNumberEditor&&this._botLabelNode||this._isZoomed)){var e,i,a=this.minLabel,s=this.maxLabel,l=this.minimum,o=this.handles;if(this._bottomNodeSpan.innerHTML="",this._botLabelNode=u.create("input",{type:"text"},this._botNode),e=o&&o.length>0?this.values[o[0]]:this.values[0],"object"==typeof e&&(e=e.value),this.ratioLabelsVisible&&(console.log("TEST",this._getLabelValueFromIndex(0,!0)),e=String(this._getLabelValueFromIndex(0,!0)).replace("%",""),l=Number(this._minRatioLabel.replace("%",""))),this.isDate){i=new t({date:new Date(Number(l)),required:!0,constraints:{min:null,max:new Date(e)}},this._botLabelNode);var r={editor:i,editorPropName:"_minimumNumberEditor",spanNode:this._bottomNodeSpan,operator:">"};i.on("keydown",h.hitch(this,this._minMaxKeydownDateHandler,r)),i.on("blur",h.hitch(this,this._minMaxBlurDateValue,r)),i.watch("date",h.hitch(this,this._minMaxUpdateDateValue,r))}else{i=new n({value:Number(l),required:!0,constraints:{max:e,min:"percentTotal"===this.ratioLabelsVisible?0:null,places:"0,20"}},this._botLabelNode);var d=!1;c(i,"keydown",h.hitch(this,this._keydownHandler,{editor:i,originalValidate:d})),c(i,"blur",h.hitch(this,this._minMaxBlurHandler,{editor:i,editorPropName:"_minimumNumberEditor",label:a,current:l,spanNode:this._bottomNodeSpan,index:0,minLabel:a,maxLabel:s,ratioLabel:this._minRatioLabel})),c(i,"change",h.hitch(this,this._minMaxChangeHandler,{label:a,current:l,spanNode:this._bottomNodeSpan,index:0,minLabel:a,maxLabel:s,ratioLabel:this._minRatioLabel,handleValue:e,operator:">"}))}this._minimumNumberEditor=i,i.startup(),i.focus(),i.textbox.select()}},_minMaxBlurHandler:function(e,t){var i=e.editor,a=e.editorPropName,s=e.label,l=e.current,o=e.spanNode,n=e.index,h=e.minLabel,d=e.maxLabel,u=e.ratioLabel,m=isNaN(s)?s:this._roundValue([h,d])[n],b=isNaN(m)||null===m?s:this._formatValue(m),c=this._formatValue(this._roundedDataLabels[n])||this._formatValue(l);this.labelsVisible||"object"==typeof this.labelsVisible&&-1!==r.indexOf(this.labelsVisible,"data")?this.ratioLabelsVisible?o.innerHTML=u:o.innerHTML=b||c:o.innerHTML="",i.destroy(),this[a]=null},_minMaxChangeHandler:function(e,t){var i,a,s,l,o=e.label,n=e.current,r=e.spanNode,d=e.index,u=e.minLabel,m=e.maxLabel,b=e.ratioLabel,c=e.handleValue,_=e.operator;return("<"===_?t<Number(c):t>Number(c))||isNaN(t)||void 0===t?(i=isNaN(o)?o:this._roundValue([u,m])[d],a=isNaN(i)||null===i?o:this._formatValue(i),s=this._formatValue(this._roundedDataLabels[d])||this._formatValue(n),void(this.ratioLabelsVisible?r.innerHTML=b:r.innerHTML=a||s)):(l=this.ratioLabelsVisible?this._getValueFromPercent(t):t,r.innerHTML=this.ratioLabelsVisible?l:this._formatValue(t),this.set("<"===_?"maximum":"minimum",l),this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),void this.emit("data-value-change",{min:this.minimum,max:this.maximum,values:h.clone(this.values)}))},_minMaxKeydownDateHandler:function(e,t){13===t.keyCode&&e.editor.isValid()&&setTimeout(h.hitch(this,this._destroyMinMaxHandleEditor,e),0)},_minMaxBlurDateValue:function(e,t){setTimeout(h.hitch(this,this._destroyMinMaxHandleEditor,e),0)},_destroyMinMaxHandleEditor:function(e){var t="<"===e.operator?"maximum":"minimum";e.spanNode.innerHTML=this._formatValue(this.get(t)),e.editor.destroy(),this[e.editorPropName]=null},_minMaxUpdateDateValue:function(e){var t=e.editor,i=e.spanNode,a=e.operator,s=t.get("date"),l="<"===a?"maximum":"minimum",o=this.get(l);s=s&&s.getTime();var n=o!==s;n&&(i.innerHTML=this._formatValue(s),this.set(l,s)),this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),n&&this.emit("data-value-change",{min:this.minimum,max:this.maximum,values:h.clone(this.values)})},_generateHandleLabelEditor:function(e,i){if(!e._numberEditor){var a,s,l,o,d,m,b,_,p=this.get("handles"),L=this.get("maximum"),x=this.get("minimum"),N=this._isZoomed,g=this.get("values"),v=g[i],f=r.indexOf(p,i),V=e.labelNode,M=!1;if("object"==typeof v&&(v=v.value),V.spanNode.innerHTML="",b=u.create("input",{type:"text"},V),p&&p.length>0?(a=null!==p[f-1]?p[f-1]:null,s=null!==p[f+1]?p[f+1]:null,l=g[a],o=g[s],"object"==typeof l&&(l=l.value),"object"==typeof o&&(o=o.value)):(l=g[i-1],o=g[i+1],"object"==typeof l&&(l=l.value),"object"==typeof o&&(o=o.value)),d=void 0!==l&&null!==l?l:N&&!isNaN(this._minZoomLabel)?this._minZoomLabel:x,m=void 0!==o&&null!==o?o:N&&!isNaN(this._maxZoomLabel)?this._maxZoomLabel:L,this.ratioLabelsVisible&&(v=this._getLabelValueFromIndex(i).replace("%",""),d="undefined"!=typeof l?Number(String(this._getLabelValueFromIndex(a,!0)).replace("%","")):Number(this._minRatioLabel.replace("%",""))||Number(this._getRatioFromValue(this.minimum)),m="undefined"!=typeof o?Number(String(this._getLabelValueFromIndex(s,!0)).replace("%","")):Number(this._maxRatioLabel.replace("%",""))||Number(this._getRatioFromValue(this.maximum))),this.isDate){_=new t({date:new Date(v),required:!0,constraints:{min:new Date(d),max:new Date(m)}},b);var H={editor:_,editorPropName:"_numberEditor",min:x,max:L,index:i,zoomed:N,spanNode:V.spanNode,moveable:e};_.on("keydown",h.hitch(this,this._stopKeydownDateHandler,H)),_.on("blur",h.hitch(this,this._stopBlurDateHandler,H)),_.watch("date",h.hitch(this,this._stopUpdateDateValue,H))}else _=new n({value:v,constraints:{min:d,max:m,places:"0,20"}},b),c(_,"keydown",h.hitch(this,this._keydownHandler,{editor:_,originalValidate:M})),c(_,"blur",h.hitch(this,this._blurHandler,{editor:_,editorPropName:"_numberEditor",updatedValue:v,min:x,max:L,index:i,zoomed:N,spanNode:V.spanNode,moveable:e})),c(_,"change",h.hitch(this,this._changeHandler,{editor:_,index:i,spanNode:V.spanNode}));e._numberEditor=_,_.focus(),_.textbox.select()}},_keydownHandler:function(e,t){var i=e.originalValidate,a=e.editor;if(i!==!1&&(a.validate=i),13===t.keyCode){var s=a.get("value");void 0===s&&(s=a.get("displayedValue")),s<=a.constraints.max&&s>=a.constraints.min?a.focusNode.blur():(i=a.validate,a.validate(!1),a.validate=function(){return!1})}},_blurHandler:function(e,t){var i=e.editor,a=e.editorPropName,s=e.updatedValue,l=e.min,o=e.max,n=e.index,r=e.zoomed,h=e.spanNode,d=e.moveable;isNaN(i.get("value"))&&i.set("value",s),r&&(i.get("value")>o||i.get("value")<l)&&(this._isZoomed=!1,this.emit("zoom-out")),h.innerHTML=this._getLabelValueFromIndex(n),i.destroy(),d[a]=null},_changeHandler:function(e,t){var i=e.editor,a=e.index,s=e.spanNode,l=t;return t>i.constraints.max||t<i.constraints.min||isNaN(t)||void 0===t?void(s.innerHTML=this._getLabelValueFromIndex(a)):(this.ratioLabelsVisible&&(l=this._getValueFromPercent(t)),"object"==typeof this.values[a]?this.values[a].value=l:this.values[a]=l,this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),void this.emit("handle-value-change",{values:this.values}))},_stopKeydownDateHandler:function(e,t){13===t.keyCode&&e.editor.isValid()&&setTimeout(h.hitch(this,this._destroyHandleEditor,e),0)},_stopBlurDateHandler:function(e,t){setTimeout(h.hitch(this,this._destroyHandleEditor,e),0)},_destroyHandleEditor:function(e){e.spanNode.innerHTML=this._getLabelValueFromIndex(e.index),e.editor.destroy(),e.moveable[e.editorPropName]=null},_stopUpdateDateValue:function(e){var t=e.editor,i=e.min,a=e.max,s=e.index,l=e.zoomed,o=e.spanNode,n=t.get("date");n=n&&n.getTime(),l&&(n>a||i>n)&&(this._isZoomed=!1,this.emit("zoom-out"));var r="object"==typeof this.values[s]?this.values[s].value:this.values[s],h=r!==n;h&&("object"==typeof this.values[s]?this.values[s].value=n:this.values[s]=n),o.innerHTML=this._getLabelValueFromIndex(s),this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),h&&this.emit("handle-value-change",{values:this.values})},_getRatioFromValue:function(e){var t=this.get("ratioLabelsVisible");return"percent"===t?100*e:"percentTotal"===t?e/(1+e)*100:null},_getValueFromPercent:function(e){var t=this.get("ratioLabelsVisible");return"percent"===t?e/100:"percentTotal"===t?e>=100?100:e/(100-e):void 0},_getLabelValueFromIndex:function(e,t){return this.ratioLabelsVisible&&this._ratioLabels[e]?t===!0?parseFloat(this._ratioLabels[e].toFixed(2))+"%":this._formatValue(parseFloat(this._ratioLabels[e].toFixed(2)))+"%":t===!0?this._roundedHandleLabels[e]:this._formatValue(this._roundedHandleLabels[e])},_getValuesFromObject:function(e){var t=[];return r.forEach(e,function(e){t.push(e.value)}),t},_getDecimalPlaces:function(e){return a.format(e,{places:"0,20",round:-1}).replace(/^-?\d*\.?|0+$/g,"").length},_collisionCheck:function(e,t){return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)},_generateCtrlKeyListener:function(){},_valuesChange:function(){this.emit("data-change",{values:this.get("values")})}});return p});