// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","./../math/vec2","./../math/mat2d","dojo/text!./webgl/stencil.vs.glsl","dojo/text!./webgl/stencil.fs.glsl","./webgl/BitBlitRenderer","../../support/screenshotUtils","../../../core/promiseUtils","../math/common","./Container","../../webgl/RenderingContext","../../webgl/FramebufferObject","../../webgl/webgl-utils","../../webgl/Program","../../webgl/VertexArrayObject","../../webgl/BufferObject"],function(e,t,i,r,a,h,n,s,l,d,o,c,p,g,_,m,u,f){function w(e){return{budget:e.budget,state:e.state,devicePixelRatio:e.devicePixelRatio,stationary:e.stationary}}var v={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},R=function(e){function t(){e.apply(this,arguments),this._clipData=new Float32Array(8),this._upperLeft=r.create(),this._upperRight=r.create(),this._lowerLeft=r.create(),this._lowerRight=r.create(),this._mat2=a.create(),this._clipRendererInitialized=!1}return i(t,e),t.prototype.createElement=function(){var e=document.createElement("canvas");return e.setAttribute("class","esri-display-object"),e},t.prototype.setElement=function(e){this.element=e},t.prototype.attach=function(t){this._resizeCanvas(t);var i={alpha:!0,antialias:!1,depth:!0,stencil:!0},r=_.setupWebGL(this.element,i);return this._renderingContext=new p(r[0]),this.attached=!0,this._cachedRenderParams=w(t),e.prototype.attach.call(this,t)},t.prototype.detach=function(t){e.prototype.detach.call(this,t),this._renderingContext=null,this._cachedRenderParams=null},t.prototype.beforeRenderChildren=function(e,t){var i=e.state,h=i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable);if(!h)return void(this._clipFrame=!1);var n=i.width,s=i.height,l=i.rotation,d=this._renderingContext;n*=e.devicePixelRatio,s*=e.devicePixelRatio;var c=o.toRadian(l),p=Math.abs(Math.cos(c)),_=Math.abs(Math.sin(c)),m=Math.round(n*p+s*_),u=Math.round(i.worldScreenWidth);if(u>=m)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===n&&this._clipFBO.height===s||(this._clipFBO=new g(d,{colorTarget:0,depthStencilTarget:3,width:n,height:s}));var f=.5*n,w=.5*s,v=1/n,R=1/s,b=n*_+s*p,y=.5*u*e.devicePixelRatio,C=.5*b,x=this._upperLeft,F=this._upperRight,B=this._lowerLeft,E=this._lowerRight;r.set(x,-y,-C),r.set(F,y,-C),r.set(B,-y,C),r.set(E,y,C),a.identity(this._mat2),a.translate(this._mat2,this._mat2,[f,w]),0!==l&&a.rotate(this._mat2,this._mat2,c),r.transformMat2d(x,x,this._mat2),r.transformMat2d(F,F,this._mat2),r.transformMat2d(B,B,this._mat2),r.transformMat2d(E,E,this._mat2);var P=this._clipData;P.set([2*B[0]*v-1,2*(s-B[1])*R-1,2*E[0]*v-1,2*(s-E[1])*R-1,2*x[0]*v-1,2*(s-x[1])*R-1,2*F[0]*v-1,2*(s-F[1])*R-1]),this._clipRendererInitialized||this._initializeClipRenderer(d),this._clipVBO.setData(P),d.bindFramebuffer(this._clipFBO),d.setDepthWriteEnabled(!0),d.setStencilWriteMask(255),d.setClearColor(0,0,0,0),d.setClearDepth(1),d.setClearStencil(0),d.clear(d.gl.COLOR_BUFFER_BIT|d.gl.DEPTH_BUFFER_BIT|d.gl.STENCIL_BUFFER_BIT),this._clipFrame=!0},t.prototype.afterRenderChildren=function(e,t){if(this._clipFrame&&this._clipRendererInitialized){var i=this._renderingContext;i.bindFramebuffer(),i.bindVAO(this._clipVAO),i.bindProgram(this._clipStencilProgram),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setStencilTestEnabled(!0),i.setBlendingEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setStencilOp(7680,7680,7681),i.setStencilWriteMask(255),i.setStencilFunction(519,1,255),i.drawElements(4,6,5123,0),i.bindVAO(),i.setColorMask(!0,!0,!0,!0),i.setBlendingEnabled(!0),i.setStencilWriteMask(255),i.setStencilFunction(514,1,255),this._blitRenderer.render(i,this._clipFBO.colorTexture,9728,1),i.setStencilTestEnabled(!1)}},t.prototype.render=function(t){var i=this.element.style;return this.visible?(i.display="block",i.opacity=""+this.opacity,this._resizeCanvas(t),e.prototype.render.call(this,t),void(this._cachedRenderParams=w(t))):void(i.display="none")},t.prototype.takeScreenshot=function(e){var t=this._cachedRenderParams.devicePixelRatio,i=t*this._cachedRenderParams.state.width,r=t*this._cachedRenderParams.state.height,a={x:0,y:0,width:i,height:r},h={x:0,y:0,width:i,height:r},n=e.area;if(n&&(a.x=t*n.x,a.y=t*n.y,a.width=t*n.width,a.height=t*n.height),void 0!==e.width&&void 0!==e.height){var s=e.width/e.height;if(a.height*s<a.width){var o=a.height*s;a.x+=Math.floor((a.width-o)/2),a.width=Math.floor(o)}else{var c=a.width/s;a.y+=Math.floor((a.height-c)/2),a.height=Math.floor(c)}h.width=e.width,h.height=e.height}else h.width=a.width,h.height=a.height;var p=document.createElement("canvas");p.width=h.width,p.height=h.height;var _=p.getContext("2d"),m=new Uint8Array(a.width*a.height*4),u=this._renderingContext,f=g.create(u,{colorTarget:1,depthStencilTarget:3,width:i,height:r});u.bindFramebuffer(f),u.setViewport(0,0,i,r),this._cachedRenderParams.budget&&this._cachedRenderParams.budget.reset(Number.MAX_VALUE);var w=this._cachedRenderParams,R=this._renderingContext.gl;this._renderingContext.setClearColor(1,1,1,1),this._renderingContext.setClearDepth(1),this._renderingContext.setClearStencil(0),this._renderingContext.clear(R.COLOR_BUFFER_BIT|R.DEPTH_BUFFER_BIT|R.STENCIL_BUFFER_BIT),w.context=this._renderingContext,this.renderChildren(w),f.readPixels(a.x,r-(a.y+a.height),a.width,a.height,6408,5121,m),u.bindFramebuffer();var b=_.getImageData(h.x,h.y,h.width,h.height);if(0!==a.x||0!==a.y||a.width!==i||a.height!==r||0!==h.x||0!==h.y||h.width!==i||h.height!==r)l.resampleHermite(m,a.width,a.height,b.data,h.width,h.height,!0);else{for(var y=a.height-1,C=0,x=4*a.width,F=void 0,B=void 0,E=void 0,P=void 0,T=void 0,O=void 0,S=void 0;y>C;){for(O=C*x,S=y*x,F=0;x>F;F+=4)B=m[O+F],E=m[O+F+1],P=m[O+F+2],T=m[O+F+3],m[O+F]=m[S+F],m[O+F+1]=m[S+F+1],m[O+F+2]=m[S+F+2],m[O+F+3]=m[S+F+3],m[S+F]=B,m[S+F+1]=E,m[S+F+2]=P,m[S+F+3]=T;C++,y--}for(var M=b.data,I=0,D=m.length;D>I;I++)M[I]=m[I]}_.putImageData(b,h.x,h.y);var U=v[e.format?e.format.toLowerCase():"png"],L=1;void 0!==e.quality&&(L=e.quality/100);var W=p.toDataURL(U,L);return d.resolve({dataURL:W,x:h.x,y:h.y,width:h.width,height:h.height})},t.prototype.prepareChildrenRenderParameters=function(e){if(!this.attached||!this._renderingContext)return null;var t=e,i=this._renderingContext,r=i.gl;return i.setDepthWriteEnabled(!0),i.setStencilWriteMask(255),i.setClearColor(0,0,0,0),i.setClearDepth(1),i.setClearStencil(0),i.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT),i.setViewport(0,0,this.element.width,this.element.height),i.setDepthWriteEnabled(!1),t.context=i,t},t.prototype.attachChild=function(e,t){return e.attach(t)},t.prototype.detachChild=function(e,t){return e.detach(t)},t.prototype.renderChild=function(e,t){return e.render(t)},t.prototype._resizeCanvas=function(e){var t=this.element,i=t.style,r=e.state,a=e.devicePixelRatio,h=r.width*a,n=r.height*a;(t.width!==h||t.height!==n)&&(t.width=h,t.height=n,i.width=r.width+"px",i.height=r.height+"px")},t.prototype._initializeClipRenderer=function(e){if(this._clipRendererInitialized)return!0;this._blitRenderer=new s;var t={a_pos:0},i=new m(e,h,n,t);if(!i)return!1;var r=f.createVertex(e,35040,32),a=new Uint16Array([0,1,2,2,1,3]),l=f.createIndex(e,35044,a),d={geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},o=new u(e,t,d,{geometry:r},l);return this._clipStencilProgram=i,this._clipVBO=r,this._clipVAO=o,this._clipRendererInitialized=!0,!0},t}(c);return R});