// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojox/gfx/matrix","dojox/gfx/_base","dojo/_base/lang","dojo/_base/Color","dojo/dom","dojo/dom-attr","./svg"],function(t,e,r,i,o,s,a,n,l){var h=function(){function t(){this.clip=null,this.rawNode=null,this.shape=null,this.matrix=null,this.fillStyle=null,this.strokeStyle=null,this.bbox=null,this.parent=null,this.parentMatrix=null}return t.prototype.destroy=function(){if(this.fillStyle&&"type"in this.fillStyle){var t=this.rawNode.getAttribute("fill"),e=l.getRef(t);e&&e.parentNode.removeChild(e)}if(this.clip){var r=this.rawNode.getAttribute("clip-path");if(r){var i=a.byId(r.match(/gfx_clip[\d]+/)[0]);i&&i.parentNode.removeChild(i)}}this.rawNode&&"__gfxObject__"in this.rawNode&&(this.rawNode.__gfxObject__=null),this.rawNode=null},t.prototype.getNode=function(){return this.rawNode},t.prototype.getShape=function(){return this.shape},t.prototype.getTransform=function(){return this.matrix},t.prototype.getFill=function(){return this.fillStyle},t.prototype.getStroke=function(){return this.strokeStyle},t.prototype.getParent=function(){return this.parent},t.prototype.getBoundingBox=function(){return this.bbox},t.prototype.getTransformedBoundingBox=function(){var t=this.getBoundingBox();if(!t)return null;var e=this._getRealMatrix(),i=r;return[i.multiplyPoint(e,t.x,t.y),i.multiplyPoint(e,t.x+t.width,t.y),i.multiplyPoint(e,t.x+t.width,t.y+t.height),i.multiplyPoint(e,t.x,t.y+t.height)]},t.prototype.getEventSource=function(){return this.rawNode},t.prototype.getClip=function(){return this.clip},t.prototype.setTransform=function(t){return this.matrix=r.clone(t?r.normalize(t):r.identity),this._applyTransform()},t.prototype.setFill=function(t){if(!t)return this.fillStyle=null,this.rawNode.setAttribute("fill","none"),this.rawNode.setAttribute("fill-opacity",0),this;var e;if("object"==typeof t&&"type"in t){switch(t.type){case"linear":e=i.makeParameters(i.defaultLinearGradient,t);var r=this._setFillObject(e,"linearGradient");r.setAttribute("x1",e.x1.toFixed(8)),r.setAttribute("y1",e.y1.toFixed(8)),r.setAttribute("x2",e.x2.toFixed(8)),r.setAttribute("y2",e.y2.toFixed(8));break;case"radial":e=i.makeParameters(i.defaultRadialGradient,t);var o=this._setFillObject(e,"radialGradient");o.setAttribute("cx",e.cx.toFixed(8)),o.setAttribute("cy",e.cy.toFixed(8)),o.setAttribute("r",e.r.toFixed(8));break;case"pattern":e=i.makeParameters(i.defaultPattern,t);var s=this._setFillObject(e,"pattern");s.setAttribute("x",e.x.toFixed(8)),s.setAttribute("y",e.y.toFixed(8)),s.setAttribute("width",e.width.toFixed(8)),s.setAttribute("height",e.height.toFixed(8))}return this.fillStyle=e,this}return e=i.normalizeColor(t),this.fillStyle=e,this.rawNode.setAttribute("fill",e.toCss()),this.rawNode.setAttribute("fill-opacity",e.a),this.rawNode.setAttribute("fill-rule","evenodd"),this},t.prototype.setStroke=function(t){var e=this.rawNode;if(!t)return this.strokeStyle=null,e.setAttribute("stroke","none"),e.setAttribute("stroke-opacity",0),this;("string"==typeof t||o.isArray(t)||t instanceof s)&&(t={color:t});var r=this.strokeStyle=i.makeParameters(i.defaultStroke,t);if(r.color=i.normalizeColor(r.color),r){var a=r.width<0?0:r.width;e.setAttribute("stroke",r.color.toCss()),e.setAttribute("stroke-opacity",r.color.a),e.setAttribute("stroke-width",a),e.setAttribute("stroke-linecap",r.cap),"number"==typeof r.join?(e.setAttribute("stroke-linejoin","miter"),e.setAttribute("stroke-miterlimit",r.join)):e.setAttribute("stroke-linejoin",r.join);var n=r.style.toLowerCase();if(n in l.dasharray&&(n=l.dasharray[n]),n instanceof Array){n=o._toArray(n);for(var h=0;h<n.length;++h)n[h]*=a;if("butt"!==r.cap){for(var h=0;h<n.length;h+=2)n[h]-=a,n[h]<1&&(n[h]=1);for(var h=1;h<n.length;h+=2)n[h]+=a}n=n.join(",")}e.setAttribute("stroke-dasharray",n),e.setAttribute("dojoGfxStrokeStyle",r.style)}return this},t.prototype._getParentSurface=function(){for(var t=this.parent;t&&!(t instanceof i.Surface);t=t.parent);return t},t.prototype._setFillObject=function(t,e){var r=l.xmlns.svg;this.fillStyle=t;var o=this._getParentSurface(),s=o.defNode,a=this.rawNode.getAttribute("fill"),n=l.getRef(a);if(n)if(a=n,a.tagName.toLowerCase()!==e.toLowerCase()){var h=a.id;a.parentNode.removeChild(a),a=l._createElementNS(r,e),a.setAttribute("id",h),s.appendChild(a)}else for(;a.childNodes.length;)a.removeChild(a.lastChild);else a=l._createElementNS(r,e),a.setAttribute("id",i._base._getUniqueId()),s.appendChild(a);if("pattern"===e){a.setAttribute("patternUnits","userSpaceOnUse");var u=l._createElementNS(r,"image");u.setAttribute("x",0),u.setAttribute("y",0),u.setAttribute("width",(t.width<0?0:t.width).toFixed(8)),u.setAttribute("height",(t.height<0?0:t.height).toFixed(8)),l._setAttributeNS(u,l.xmlns.xlink,"xlink:href",t.src),a.appendChild(u)}else{a.setAttribute("gradientUnits","userSpaceOnUse");for(var p=0;p<t.colors.length;++p){var d=t.colors[p],f=l._createElementNS(r,"stop"),c=d.color=i.normalizeColor(d.color);f.setAttribute("offset",d.offset.toFixed(8)),f.setAttribute("stop-color",c.toCss()),f.setAttribute("stop-opacity",c.a),a.appendChild(f)}}return this.rawNode.setAttribute("fill","url(#"+a.getAttribute("id")+")"),this.rawNode.removeAttribute("fill-opacity"),this.rawNode.setAttribute("fill-rule","evenodd"),a},t.prototype._applyTransform=function(){var t=this.matrix;if(t){var e=this.matrix;this.rawNode.setAttribute("transform","matrix("+e.xx.toFixed(8)+","+e.yx.toFixed(8)+","+e.xy.toFixed(8)+","+e.yy.toFixed(8)+","+e.dx.toFixed(8)+","+e.dy.toFixed(8)+")")}else this.rawNode.removeAttribute("transform");return this},t.prototype.setRawNode=function(t){var e=this.rawNode=t;"image"!==this.shape.type&&e.setAttribute("fill","none"),e.setAttribute("fill-opacity",0),e.setAttribute("stroke","none"),e.setAttribute("stroke-opacity",0),e.setAttribute("stroke-width",1),e.setAttribute("stroke-linecap","butt"),e.setAttribute("stroke-linejoin","miter"),e.setAttribute("stroke-miterlimit",4),e.__gfxObject__=this},t.prototype.setShape=function(t){this.shape=i.makeParameters(this.shape,t);for(var e in this.shape)if("type"!==e){var r=this.shape[e];("width"===e||"height"===e)&&(r=0>r?0:r),this.rawNode.setAttribute(e,r)}return this.bbox=null,this},t.prototype._moveToFront=function(){return this.rawNode.parentNode.appendChild(this.rawNode),this},t.prototype._moveToBack=function(){return this.rawNode.parentNode.insertBefore(this.rawNode,this.rawNode.parentNode.firstChild),this},t.prototype.setClip=function(t){},t.prototype._removeClipNode=function(){var t,e=n.get(this.rawNode,"clip-path");return e&&(t=a.byId(e.match(/gfx_clip[\d]+/)[0]),t&&t.parentNode.removeChild(t)),t},t.prototype.moveToFront=function(){var t=this.getParent();return t&&(t._moveChildToFront(this),this._moveToFront()),this},t.prototype.moveToBack=function(){var t=this.getParent();return t&&(t._moveChildToBack(this),this._moveToBack()),this},t.prototype.applyRightTransform=function(t){return t?this.setTransform([this.matrix,t]):this},t.prototype.applyLeftTransform=function(t){return t?this.setTransform([t,this.matrix]):this},t.prototype.applyTransform=function(t){return t?this.setTransform([this.matrix,t]):this},t.prototype.removeShape=function(t){return this.parent&&this.parent.remove(this,t),this},t.prototype._setParent=function(t,e){return this.parent=t,this._updateParentMatrix(e)},t.prototype._updateParentMatrix=function(t){return this.parentMatrix=t?r.clone(t):null,this._applyTransform()},t.prototype._getRealMatrix=function(){for(var t=this.matrix,e=this.parent;e;)e.matrix&&(t=r.multiply(e.matrix,t)),e=e.parent;return t},t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=h});