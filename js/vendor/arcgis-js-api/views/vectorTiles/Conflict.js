// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./Geometry","./GeometryUtils"],function(r,o,n,t){var e=function(){function r(r,o,n,t){this.left=r,this.top=o,this.right=n,this.bottom=t}return r.prototype.clone=function(){return new r(this.left,this.top,this.right,this.bottom)},r.prototype.move=function(r,o){this.left+=r,this.top+=o,this.right+=r,this.bottom+=o},r.prototype.rotate=function(r,o){var n=this.left,t=this.right,e=this.top,c=this.bottom,s=n*r-e*o,i=n*o+e*r,a=t*r-e*o,h=t*o+e*r,x=n*r-c*o,m=n*o+c*r,y=t*r-c*o,f=t*o+c*r;this.left=Math.min(s,a,x,y),this.top=Math.min(i,h,m,f),this.right=Math.max(s,a,x,y),this.bottom=Math.max(i,h,m,f)},r.overlaps=function(r,o){return r.right>o.left&&r.left<o.right&&r.bottom>o.top&&r.top<o.bottom},r}();o.Box=e;var c=function(){function r(r,o,n,t){this.anchor=r,this.corners=o,this.minzoom=n,this.maxzoom=t}return r.prototype.left=function(){return this.corners[0].x},r.prototype.right=function(){return this.corners[2].x},r.prototype.top=function(){return this.corners[1].y},r.prototype.bottom=function(){return this.corners[3].y},r}();o.Obstacle=c;var s=function(){function r(r,o,n){this.obstacles=[],this.mapAngle=r,this.padding=o,this.isScreenAligned=n,this.minzoom=i}return r.prototype.addBox=function(r,o,t,e,s,i){var a=o.left*t-this.padding,h=o.top*t-this.padding,x=o.right*t+this.padding,m=o.bottom*t+this.padding,y=[new n.Point(a,h),new n.Point(x,h),new n.Point(x,m),new n.Point(a,m)];if(0!==this.mapAngle){var f=Math.cos(this.mapAngle),p=Math.sin(this.mapAngle);r=r.clone(),r.rotate(f,p)}if(this.isScreenAligned||(e+=this.mapAngle),0!==e){var f=Math.cos(e),p=Math.sin(e);y[0].rotate(f,p),y[1].rotate(f,p),y[2].rotate(f,p),y[3].rotate(f,p);for(var l=0,u=1;4>u;u++)y[u].x<y[l].x?l=u:y[u].x===y[l].x&&y[u].y<y[l].y&&(l=u);if(l){for(var g=[],u=0;4>u;u++)g.push(y[(u+l)%4]);y=g}}this.obstacles.push(new c(r,y,s,i))},r}();o.Footprint=s;var i=.5,a=2,h=function(){function r(r){this._grid=[],this._angle=r,this._c=Math.cos(r),this._s=Math.sin(r)}return r.prototype.add=function(o){for(var n=this._grid,t=0,e=o.obstacles;t<e.length;t++)for(var c=e[t],s=c.anchor,i=r._gridClamp(Math.min(c.left()+s.x,s.x)),a=r._gridClamp(Math.max(c.right()+s.x,s.x)),h=r._gridClamp(Math.min(c.top()+s.y,s.y)),x=r._gridClamp(Math.max(c.bottom()+s.y,s.y)),m=h;x>=m;m++)for(var y=i;a>=y;y++){var f=n[16*m+y];f||(f=n[16*m+y]=[]),f.push(c)}},r.prototype.getMinZoom=function(o,n,e,c){if(0===o.obstacles.length)return t.C_INFINITY;for(var s=n,i=this._grid,h=0,x=o.obstacles;h<x.length;h++)for(var m=x[h],y=m.anchor,f=r._gridClamp(Math.min(m.left()+y.x,y.x)),p=r._gridClamp(Math.max(m.right()+y.x,y.x)),l=r._gridClamp(Math.min(m.top()+y.y,y.y)),u=r._gridClamp(Math.max(m.bottom()+y.y,y.y)),g=l;u>=g;g++)for(var v=f;p>=v;v++){var d=i[16*g+v];if(d)for(var _=0,b=d;_<b.length;_++){var M=b[_];if(!(m.minzoom>=M.maxzoom||M.minzoom>=m.maxzoom)&&(s=r._calcPlacementZoom(m,M,s),s>=a))return t.C_INFINITY}}return a>s?s:t.C_INFINITY},r._gridClamp=function(r){return t.clamp(r>>9,-7,8)},r._calcPlacementZoom=function(o,n,e){var c=n.anchor.x-o.anchor.x;if(0===c&&(o.right()<n.left()||n.right()<o.left()))return e;var s=n.anchor.y-o.anchor.y;if(0===s&&(o.bottom()<n.top()||n.bottom()<o.top()))return e;var i=t.C_INFINITY;if(0!==c){var a=c>0?o.right()-n.left():o.left()-n.right(),h=a/c;i>h&&(i=h);var x=c>0?r._calcExtZoomX(o,n,h):r._calcExtZoomX(n,o,h);i>x&&(i=x)}if(0!==s){var m=s>0?o.bottom()-n.top():o.top()-n.bottom(),y=m/s;i>y&&(i=y);var f=s>0?r._calcExtZoomY(o,n,y):r._calcExtZoomY(n,o,y);i>f&&(i=f)}return i<o.minzoom||i<n.minzoom?e:(i=Math.min(i,o.maxzoom,n.maxzoom),e>i&&(i=e),i)},r._calcExtZoomX=function(r,o,n){var t,e,c,s,i=r.anchor.y+r.corners[2].y/n,a=o.anchor.y+o.corners[0].y/n;if(a>i){var h=r.corners[2].x-r.corners[3].x,x=r.corners[2].y-r.corners[3].y,m=o.corners[1].x-o.corners[0].x,y=o.corners[1].y-o.corners[0].y,f=h*y-x*m;f>=0?r.anchor.y+r.corners[3].y/n<o.anchor.y+o.corners[0].y/n?(t=r.corners[3],e=o.corners[0],c=o.corners[1],s=1):(t=o.corners[0],e=r.corners[3],c=r.corners[2],s=-1):r.anchor.y+r.corners[2].y/n>o.anchor.y+o.corners[1].y/n?(t=r.corners[2],e=o.corners[0],c=o.corners[1],s=1):(t=o.corners[1],e=r.corners[3],c=r.corners[2],s=-1)}else{var h=r.corners[2].x-r.corners[1].x,x=r.corners[2].y-r.corners[1].y,m=o.corners[3].x-o.corners[0].x,y=o.corners[3].y-o.corners[0].y,f=h*y-x*m;0>f?r.anchor.y+r.corners[1].y/n>o.anchor.y+o.corners[0].y/n?(t=r.corners[1],e=o.corners[0],c=o.corners[3],s=1):(t=o.corners[0],e=r.corners[1],c=r.corners[2],s=-1):r.anchor.y+r.corners[2].y/n<o.anchor.y+o.corners[3].y/n?(t=r.corners[2],e=o.corners[0],c=o.corners[3],s=1):(t=o.corners[3],e=r.corners[1],c=r.corners[2],s=-1)}var p=c.x-e.x,l=c.y-e.y;return s*((t.y-e.y)*p-(t.x-e.x)*l)/((r.anchor.x-o.anchor.x)*l-(r.anchor.y-o.anchor.y)*p)},r._calcExtZoomY=function(r,o,n){var t,e,c,s,i=r.anchor.x+r.corners[3].x/n,a=o.anchor.x+o.corners[1].x/n;if(a>i){var h=r.corners[3].x-r.corners[2].x,x=r.corners[3].y-r.corners[2].y,m=o.corners[0].x-o.corners[1].x,y=o.corners[0].y-o.corners[1].y,f=h*y-x*m;0>f?r.anchor.x+r.corners[2].x/n<o.anchor.x+o.corners[1].x/n?(t=r.corners[2],e=o.corners[1],c=o.corners[0],s=1):(t=o.corners[1],e=r.corners[2],c=r.corners[3],s=-1):r.anchor.x+r.corners[3].x/n>o.anchor.x+o.corners[0].x/n?(t=r.corners[3],e=o.corners[1],c=o.corners[0],s=1):(t=o.corners[0],e=r.corners[2],c=r.corners[3],s=-1)}else{var h=r.corners[3].x-r.corners[0].x,x=r.corners[3].y-r.corners[0].y,m=o.corners[2].x-o.corners[1].x,y=o.corners[2].y-o.corners[1].y,f=h*y-x*m;f>0?r.anchor.x+r.corners[0].x/n>o.anchor.x+o.corners[1].x/n?(t=r.corners[0],e=o.corners[1],c=o.corners[2],s=1):(t=o.corners[1],e=r.corners[0],c=r.corners[3],s=-1):r.anchor.x+r.corners[3].x/n<o.anchor.x+o.corners[2].x/n?(t=r.corners[3],e=o.corners[1],c=o.corners[2],s=1):(t=o.corners[2],e=r.corners[0],c=r.corners[3],s=-1)}var p=c.x-e.x,l=c.y-e.y;return s*((t.y-e.y)*p-(t.x-e.x)*l)/((r.anchor.x-o.anchor.x)*l-(r.anchor.y-o.anchor.y)*p)},r}();o.ConflictEngine=h});