// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../webgl/BufferObject","../2d/engine/DisplayObject","../../core/libs/gl-matrix/vec2","../../core/libs/gl-matrix/mat4","./RenderBucket"],function(e,t,r,i,s,n,a,l){var o=function(e){function t(t,r,i,s,l,o,f,u,h,c,x){e.call(this),this._renderBuckets=[],this._vectorTileData=null,this._symbolUpdateData=null,this.topLeft=[0,0],this.bottomRight=[0,0],this.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]},this.stencilData={mask:0,reference:0},this.key=t,this.refKey=r,this.topLeft[0]=i[0],this.topLeft[1]=i[1],this.bottomRight[0]=i[2],this.bottomRight[1]=i[3],this.widthInPixels=s,this.coordRange=l,this.rotation=o,this._vectorTileData=f,this.styleLayers=u,this._glyphsMosaic=h,this.workerID=c,this._connection=x,this.id=t.id,this.status=3,this.tileTransform.transform=a.create(),this.tileTransform.displayCoord=n.create()}return r(t,e),t.prototype.updateSymbolData=function(e){e&&(this._symbolUpdateData=e,this.requestRender())},t.prototype.dispose=function(){-1!==this.workerID&&this._connection&&6!==this.status&&7!==this.status&&this._connection.broadcast("destructTileData",{key:this.id,worker:this.workerID},[]),this.polygonTrianglesVertexArrayObject&&(this.polygonTrianglesVertexArrayObject.dispose(),this.polygonTrianglesVertexArrayObject=null),this.polygonOutlineVertexArrayObject&&(this.polygonOutlineVertexArrayObject.dispose(),this.polygonOutlineVertexArrayObject=null),this.lineTrianglesVertexArrayObject&&(this.lineTrianglesVertexArrayObject.dispose(),this.lineTrianglesVertexArrayObject=null),this.lineJoinsVertexArrayObject&&(this.lineJoinsVertexArrayObject.dispose(),this.lineJoinsVertexArrayObject=null),this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this.polygonTrianglesVertexBuffer&&(this.polygonTrianglesVertexBuffer.dispose(),this.polygonTrianglesVertexBuffer=null),this.polygonTrianglesIndexBuffer&&(this.polygonTrianglesIndexBuffer.dispose(),this.polygonTrianglesIndexBuffer=null),this.polygonOutlinesVertexBuffer&&(this.polygonOutlinesVertexBuffer.dispose(),this.polygonOutlinesVertexBuffer=null),this.polygonOutlinesIndexBuffer&&(this.polygonOutlinesIndexBuffer.dispose(),this.polygonOutlinesIndexBuffer=null),this.lineVertexBuffer&&(this.lineVertexBuffer.dispose(),this.lineVertexBuffer=null),this.lineTrianglesIndexBuffer&&(this.lineTrianglesIndexBuffer.dispose(),this.lineTrianglesIndexBuffer=null),this.lineJoinVertexBuffer&&(this.lineJoinVertexBuffer.dispose(),this.lineJoinVertexBuffer=null),this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this._renderBuckets=[],this.status=7},t.prototype.attach=function(e){if(this.status=3,!this._vectorTileData)return!1;if(0===this._renderBuckets.length)for(var t=new Uint32Array(this._vectorTileData.bucketDataInfo),r=t.length,s=0;r>s;){var n=t[s],a=t[s+1];if(0===a){var o=new l.BackgroundRenderBucket;o.layerID=n,this._renderBuckets.push(o),s+=2}else if(1===a){var f=new l.FillRenderBucket;f.layerID=n,f.triangleElementStart=t[s+2],f.triangleElementCount=t[s+3],f.outlineElementStart=t[s+4],f.outlineElementCount=t[s+5],this._renderBuckets.push(f),s+=6}else if(2===a){var u=new l.LineRenderBucket;u.layerID=n,u.triangleElementStart=t[s+2],u.triangleElementCount=t[s+3],u.joinStart=t[s+4],u.joinCount=t[s+5],this._renderBuckets.push(u),s+=6}else if(3===a){var h=new l.SymbolRenderBucket;h.layerID=n,h.markerElementStart=t[s+2],h.marketElementCount=t[s+3],h.textElementStart=t[s+4],h.textElementCount=t[s+5],h.isSDF=0!==t[s+6],this._renderBuckets.push(h),s+=7}else console.error("Bad bucket type!")}for(var c=e.context,x=e.budget,d=new Uint32Array(this._vectorTileData.bufferDataInfo),y=d.length,p=0,B=0;y>B;B+=2,p++){var b=d[B],g=d[B+1];if(!(0>=g||0===this._vectorTileData.bufferData[p].byteLength)){if(x&&x.done)return!1;switch(b){case 2:this.polygonTrianglesVertexBuffer||(this.polygonTrianglesVertexBuffer=i.createVertex(c,35044,this._vectorTileData.bufferData[p]));break;case 6:this.polygonTrianglesIndexBuffer||(this.polygonTrianglesIndexBuffer=i.createIndex(c,35044,new Uint32Array(this._vectorTileData.bufferData[p],0,g/4)));break;case 3:this.polygonOutlinesVertexBuffer||(this.polygonOutlinesVertexBuffer=i.createVertex(c,35044,this._vectorTileData.bufferData[p]));break;case 7:this.polygonOutlinesIndexBuffer||(this.polygonOutlinesIndexBuffer=i.createIndex(c,35044,new Uint32Array(this._vectorTileData.bufferData[p],0,g/4)));break;case 0:this.lineVertexBuffer||(this.lineVertexBuffer=i.createVertex(c,35044,this._vectorTileData.bufferData[p]));break;case 8:this.lineTrianglesIndexBuffer||(this.lineTrianglesIndexBuffer=i.createIndex(c,35044,this._vectorTileData.bufferData[p]));break;case 1:this.lineJoinVertexBuffer||(this.lineJoinVertexBuffer=i.createVertex(c,35044,this._vectorTileData.bufferData[p]));break;case 4:this.iconVertexBuffer||(this.iconVertexBuffer=i.createVertex(c,35044,this._vectorTileData.bufferData[p]));break;case 9:this.iconIndexBuffer||(this.iconIndexBuffer=i.createIndex(c,35044,new Uint32Array(this._vectorTileData.bufferData[p],0,g/4)));break;case 5:this.textVertexBuffer||(this.textVertexBuffer=i.createVertex(c,35044,this._vectorTileData.bufferData[p]));break;case 10:this.textIndexBuffer||(this.textIndexBuffer=i.createIndex(c,35044,new Uint32Array(this._vectorTileData.bufferData[p],0,g/4)))}}}return this.status=4,!0},t.prototype.detach=function(e){},t.prototype.render=function(e){if(this.visible&&4===this.status){var t=e.context,r=e.renderer;if(t&&r){var i=e.drawphase;this._symbolUpdateData&&this._updateSymbolData(e),t.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var s=this.styleLayers,n=void 0!==e.layerOpacity?e.layerOpacity:1;if(0!==n){var a,l=this._renderBuckets.length,o=0;if(0===i)for(o=l-1;o>=0;o--)a=this._renderBuckets[o],3!==a.type&&a.hasData()&&r.renderBucket(t,a,e.displayLevel,e.requiredLevel,i,this,s.layers[a.layerID],n);else for(o=0;l>o;o++)a=this._renderBuckets[o],a.hasData()&&r.renderBucket(t,a,e.displayLevel,e.requiredLevel,i,this,s.layers[a.layerID],n)}}}},t.prototype._updateSymbolData=function(e){var t=new Uint32Array(this._symbolUpdateData.bucketDataInfo),r=t.length;if(0===r)return this._symbolUpdateData=null,!0;if(e.budget.remaining<1)return this.requestRender(),!1;var s=e.context;s.bindVAO(null);for(var n=new Uint32Array(this._symbolUpdateData.bufferDataInfo),a=n.length,o=0,f=0;a>f;f+=2,o++){var u=n[f],h=n[f+1];if(!(0>=h||0===this._symbolUpdateData.bufferData[o].byteLength))switch(u){case 4:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconVertexBuffer=i.createVertex(s,35044,this._symbolUpdateData.bufferData[o]);break;case 9:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.iconIndexBuffer=i.createIndex(s,35044,new Uint32Array(this._symbolUpdateData.bufferData[o],0,h/4));break;case 5:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textVertexBuffer=i.createVertex(s,35044,this._symbolUpdateData.bufferData[o]);break;case 10:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=i.createIndex(s,35044,new Uint32Array(this._symbolUpdateData.bufferData[o],0,h/4))}}for(var c=0,x=this._renderBuckets.length;x>c;c++){var d=this._renderBuckets[c];if(d instanceof l.SymbolRenderBucket){var y=this._renderBuckets[c];y.markerElementStart=0,y.marketElementCount=0,y.textElementStart=0,y.textElementCount=0}}for(var p,B,b=0;r>b;){var g=t[b];B=-1;for(var c=0,x=this._renderBuckets.length;x>c;c++)if(this._renderBuckets[c].layerID===g){B=c;break}-1===B&&console.log("bucket not found"),p=this._renderBuckets[B],p?(p.markerElementStart=t[b+2],p.marketElementCount=t[b+3],p.textElementStart=t[b+4],p.textElementCount=t[b+5],b+=7):b+=7}return this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this._symbolUpdateData=null,!0},t}(s);return o});