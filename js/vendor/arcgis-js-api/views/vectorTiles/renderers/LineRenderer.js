// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix/mat4","../../../core/libs/gl-matrix/vec4","../../../core/libs/gl-matrix/vec3","../../../core/libs/gl-matrix/vec2","dojo/text!./shaders/lineShader.vs.glsl","dojo/text!./shaders/lineShader.fs.glsl","dojo/text!./shaders/patternLineShader.vs.glsl","dojo/text!./shaders/patternLineShader.fs.glsl","dojo/text!./shaders/lineJoinShader.vs.glsl","dojo/text!./shaders/lineJoinShader.fs.glsl","../../webgl/Program","../../webgl/VertexArrayObject","../GeometryUtils"],function(t,r,e,i,n,a,o,s,l,_,f,h,m,g,u){var d=function(){function t(){this._joinAttributeLocations={a_pos:0,a_vertexOffset:1},this._triangleAttributeLocations={a_pos:0,a_offset:1,a_accumulatedDistance:2},this._initialized=!1,this._viewProjMat=e.create(),this._offsetVector=n.create(),this._screenSize=a.create(),this._color=i.create(),this._dashArray=a.create()}return t.prototype.render=function(t,r,i,n,a,o,s,l,_,f){if(0!==r.triangleElementCount){this._initialized||this._initialize(t);var h=a.tileTransform.transform,m=512,g=a.coordRange/m,d=o.getPaintValue("line-translate",i);if(0!==d[0]||0!==d[1]){e.copy(this._viewProjMat,a.tileTransform.transform);var c=d[0],P=d[1],p=0,v=0,x=(1<<a.key.level)/Math.pow(2,i)*g,b=n.rotation,j=o.getPaintValue("line-translate-anchor",i);if(1===j){var y=Math.sin(u.C_DEG_TO_RAD*-b),V=Math.cos(u.C_DEG_TO_RAD*-b);p=x*(c*V-P*y),v=x*(c*y+P*V)}else p=x*c,v=x*P;this._offsetVector[0]=p,this._offsetVector[1]=v,this._offsetVector[2]=0,e.translate(this._viewProjMat,this._viewProjMat,this._offsetVector),h=this._viewProjMat}var A=o.getPaintValue("line-pattern",i),U=void 0!==A,z=1/_,L=o.getPaintValue("line-blur",i)+z,O=o.getPaintValue("line-width",i),M=.5*(O+z),w=f*o.getPaintValue("line-opacity",i),T=o.getPaintValue("line-color",i),S=T[3]*w;this._color[0]=S*T[0],this._color[1]=S*T[1],this._color[2]=S*T[2],this._color[3]=S;var C=M>1&&r.joinCount>0&&!U;if(C){this._screenSize[0]=.5*n.width,this._screenSize[1]=.5*n.height;var J=Math.ceil(2*M),D=M-.25,E=this._getJoinsVAO(t,a);if(E){t.bindVAO(E),t.bindProgram(this._joinProgram);var R=1/(_>0?_:1);this._joinProgram.setUniformMatrix4fv("u_transformMatrix",h),this._joinProgram.setUniform2fv("u_normalized_origin",a.tileTransform.displayCoord),this._joinProgram.setUniform1f("u_depth",o.z),this._joinProgram.setUniform2fv("u_screen",this._screenSize),this._joinProgram.setUniform1f("u_size",J),this._joinProgram.setUniform4fv("u_color",this._color),this._joinProgram.setUniform1f("u_lineHalfWidth",D),this._joinProgram.setUniform1f("u_pixelRatio",_),this._joinProgram.setUniform1f("u_oneOverPixelRatio",R),t.drawArrays(0,r.joinStart,r.joinCount),t.bindVAO()}}var B=this._getTrianglesVAO(t,a);if(B){if(t.bindVAO(B),U){var G=s.getMosaicItemPosition(A,!0);G&&(s.bind(t,9729,0),t.bindProgram(this._patternLineProgram),this._patternLineProgram.setUniformMatrix4fv("u_transformMatrix",h),this._patternLineProgram.setUniformMatrix4fv("u_extrudeMatrix",l),this._patternLineProgram.setUniform2fv("u_normalized_origin",a.tileTransform.displayCoord),this._patternLineProgram.setUniform1f("u_depth",o.z),this._patternLineProgram.setUniform1f("u_lineHalfWidth",M),this._patternLineProgram.setUniform1f("u_blur",L),this._patternLineProgram.setUniform1f("u_opacity",w),this._patternLineProgram.setUniform2f("u_pattern_tl",G.tl[0],G.tl[1]),this._patternLineProgram.setUniform2f("u_pattern_br",G.br[0],G.br[1]),this._patternLineProgram.setUniform2f("u_spriteSize",g*G.size[0],G.size[1]),this._patternLineProgram.setUniform1i("u_texture",0))}else{var H=o.getPaintValue("line-dasharray",i);H.length<2&&(H=[1,-1]);var W=O*g;this._dashArray[0]=W*H[0],this._dashArray[1]=W*H[1],t.bindProgram(this._triangleslProgram),this._triangleslProgram.setUniformMatrix4fv("u_transformMatrix",h),this._triangleslProgram.setUniformMatrix4fv("u_extrudeMatrix",l),this._triangleslProgram.setUniform2fv("u_normalized_origin",a.tileTransform.displayCoord),this._triangleslProgram.setUniform1f("u_depth",o.z),this._triangleslProgram.setUniform4fv("u_color",this._color),this._triangleslProgram.setUniform1f("u_lineHalfWidth",M),this._triangleslProgram.setUniform2fv("u_dasharray",this._dashArray),this._triangleslProgram.setUniform1f("u_blur",L)}t.drawElements(4,r.triangleElementCount,5125,12*r.triangleElementStart),t.bindVAO()}}},t.prototype._initialize=function(t){if(this._initialized)return!0;var r=new m(t,o,s,this._triangleAttributeLocations),e={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5122,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:2,type:5122,offset:8,stride:12,normalized:!1,divisor:0}]},i=new m(t,l,_,this._triangleAttributeLocations),n=new m(t,f,h,this._joinAttributeLocations),a={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]};return this._triangleslProgram=r,this._patternLineProgram=i,this._trianglesVertexAttributes=e,this._joinProgram=n,this._joinVertexAttributes=a,this._initialized=!0,!0},t.prototype._getTrianglesVAO=function(t,r){if(r.lineTrianglesVertexArrayObject)return r.lineTrianglesVertexArrayObject;var e=r.lineVertexBuffer,i=r.lineTrianglesIndexBuffer;return e&&i?(r.lineTrianglesVertexArrayObject=new g(t,this._triangleAttributeLocations,this._trianglesVertexAttributes,{geometry:e},i),r.lineTrianglesVertexArrayObject):null},t.prototype._getJoinsVAO=function(t,r){if(r.lineJoinsVertexArrayObject)return r.lineJoinsVertexArrayObject;var e=r.lineJoinVertexBuffer;return e?(r.lineJoinsVertexArrayObject=new g(t,this._joinAttributeLocations,this._joinVertexAttributes,{geometry:e}),r.lineJoinsVertexArrayObject):null},t}();return d});