// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../../core/Accessor","../../../../core/watchUtils","../../../../geometry/Point","../../support/mathUtils","../../lib/glMatrix","../../constraints/SceneViewAltitudeConstraint","../../webgl-engine/lib/Camera","../../webgl-engine/lib/IntervalUtilities","../../webgl-engine/lib/Selector"],function(t,e,i,n,a,r,s,o,l){function h(t){return t&&t.spatialReference}function d(t){return new D.Tilt({min:function(){return.01},max:function(){return n.deg2rad(t.tilt.max)}})}function c(t){return new D.Altitude({min:function(){return t.altitude.min},max:function(){return t.altitude.max}})}function u(t){return new D.Collision(t.collision.enabled)}var C=2,_=4,g=5,m=.02,p=a.vec3d,v=a.mat4d,f=new i,E=p.create(),y=p.create(),T=v.create(),H=p.create(),M=p.create(),U=p.create(),x=new s,A=p.create(),b={tilt:0,distance:0},F={distance:0,maxFarNearRatio:0},D=t.createSubclass([],{declaredClass:"esri.views.3d.navigation.mixins.ConstraintsMixin",properties:{userConstraints:{set:function(t){this._disconnectUserConstraints(),this._connectUserConstraints(t),this._set("userConstraints",t)}},elevationProvider:{value:null,set:function(t){null!==this._elevationChangeHandle&&(this._elevationChangeHandle.remove(),this._elevationChangeHandle=null),null!==this._elevationChangeTileHandle&&(this._elevationChangeTileHandle.remove(),this._elevationChangeTileHandle=null),null!==t&&(this._elevationChangeHandle=t.on("elevation-change",this._elevationChangeHandler.bind(this)),this._elevationChangeTileHandle=t.on("elevation-change-tile",this._elevationChangeTileHandler.bind(this))),this._set("elevationProvider",t)}},minPoiDist:{get:function(){return this._minPoiDistInMeters/this.renderUnitInMeters},dependsOn:["renderUnitInMeters"]},cameraElevationMargin:{get:function(){return this._cameraElevationMarginInMeters/this.renderUnitInMeters},dependsOn:["renderUnitInMeters"]},minNearDistance:{get:function(){return this._minNearDistanceInMeters/this.renderUnitInMeters},dependsOn:["renderUnitInMeters"]},renderUnitInMeters:{},constraintsEnabled:{value:!0}},constructor:function(){this._userConstraints=null,this._userConstraintsHandles=[],this._clipDistanceHandles=[],this._tiltHandles=[],this._altitudeHandles=[],this.constraints={tilt:this.defaultConstraints.tilt,altitude:this.defaultConstraints.altitude,collision:this.defaultConstraints.collision},this._tiltModeHandler=this._tiltModeHandler.bind(this),this._tiltMaxHandler=this._tiltMaxHandler.bind(this),this._altitudeModeHandler=this._altitudeModeHandler.bind(this),this._altitudeMinMaxHandler=this._altitudeMinMaxHandler.bind(this),this._clipDistanceModeHandler=this._clipDistanceModeHandler.bind(this),this._clipDistanceNearFarHandler=this._clipDistanceNearFarHandler.bind(this),this._collisionEnabledHandler=this._collisionEnabledHandler.bind(this),this.enableElevationUpdates=!0,this.updateTargetByElevationUpdates=D.UPDATE_TARGET_BY_ELEVATION_UPDATES_DEFAULT,this._recomputeTargetCenterForElevationChange=!1,this._recomputeTargetEyeForElevationChange=!1,this._elevationChangeHandle=null,this._elevationChangeTileHandle=null,this._autoAltitudeConstraints={min:r.MIN_DEFAULT,max:r.MAX_DEFAULT},this.maxFarNearRatio=2e4,this._minNearDistanceInMeters=C,this._minPoiDistInMeters=_,this._cameraElevationMarginInMeters=g,this._intersectTerrainSelector=new l,this._intersectTerrainSelector.enableInvisibleTerrain=!0},initialize:function(){this._targetCameraBeforeElevationUpdate=this.cameras.current.copy(),this._targetCameraChangedByElevationUpdate=!1,this._sceneExtentChangeHandle=this.view.watch("dataExtent",function(t){this._dataExtentChanged()}.bind(this))},_dataExtentChanged:function(){this.view.ready&&(this._updateAltitudeConstraintFromExtent(this.view.dataExtent),this._reapplyConstraints(),this._camerasChanged())},_updateAutoAltitudeConstraints:function(t){},updateRenderCoordsHelper:function(t,e){this.inherited(arguments),this._userConstraints&&"auto"!==this._userConstraints.altitude.mode||(this.constraints.altitude=D.Altitude.scale(this.defaultConstraints.altitude,t.unitInMeters)),this._userConstraints&&"auto"!==this._userConstraints.tilt.mode||(this.constraints.tilt=D.Tilt.scale(this.defaultConstraints.tilt,t.unitInMeters)),this._updateAltitudeConstraintFromExtent(this.view.dataExtent),this._reapplyConstraints(),this._camerasChanged()},_updateAltitudeConstraintFromExtent:function(t){t.xmax-t.xmin>0&&(this._updateAutoAltitudeConstraints(t),this._userConstraints&&"auto"!==this._userConstraints.altitude.mode||this._autoUpdateAltitudeConstraint())},destroy:function(){this._disconnectUserConstraints(),this._sceneExtentChangeHandle.remove()},_updateTargetCenterForElevation:function(t){if(this._recomputeTargetCenterForElevationChange=!1,t||this.enableElevationUpdates&&this.updateTargetByElevationUpdates){var e;this._targetCameraChangedByElevationUpdate?e=this._targetCameraBeforeElevationUpdate:(e=this.cameras.target,this._targetCameraBeforeElevationUpdate.copyFrom(e));var i=this.getCameraIntersectTerrain(e.eye,e.center,e.up,m);if(i&&!i.equals(this.cameras.target))return this.setCamera(i,{internalUpdate:!0}),this._targetCameraChangedByElevationUpdate=!0,!0}return!1},_updateTargetCenterForElevationWhenIdle:function(){var t=this.pan&&this.pan.continuous&&this.pan.continuous.active,e=t||this.pan.active||this.zoom.active||this.rotate.active,i=this.isAnimating,n=!1;if(!e&&!i&&this._recomputeTargetCenterForElevationChange){var a=this._targetCameraChangedByElevationUpdate;this._updateTargetCenterForElevation()&&(n=!0),this._targetCameraChangedByElevationUpdate=a}return!i&&this._recomputeTargetEyeForElevationChange&&this._updateTargetEyeForElevationChange()&&(n=!0),n},step:function(){this._updateTargetCenterForElevationWhenIdle(),this.inherited(arguments)},applyConstraints:function(t,e){if(!this.constraintsEnabled)return!1;var i=this._cameraElevationAngle(t,b),n=this.constraints.tilt.min(i.distance),a=this.constraints.tilt.max(i.distance),r=0;!e&&i.tilt>a?r=i.tilt-a:i.tilt<n&&(r=i.tilt-n);var s=!1;Math.abs(r)>.01&&(p.cross(E,t.up,y),v.identity(T),v.rotate(T,r,y),v.multiplyVec3(T,E),p.add(t.center,E,t.eye),v.multiplyVec3(T,t.up),s=!0),p.subtract(t.center,t.eye,H);var o=t.distance,l=this.limitAltitude(o,t.center,H,o);return o!==l&&(p.scale(H,-l/o),p.add(t.center,H,t.eye),s=!0),this._autoUpdateTiltConstraint(a),s},limitTiltByConstraints:function(t,e,i,n){if(!this.constraintsEnabled)return t;var a=this.constraints.tilt.min(i),r=this.constraints.tilt.max(i);return(void 0===n||n>0)&&t>=r?t=r:(void 0===n||0>n)&&a>=t&&(t=a),t=this.limitTiltByAltitudeConstraints(t,e,i,n),this._autoUpdateTiltConstraint(r),t},_autoUpdateAltitudeConstraint:function(){var t=this._userConstraints&&this._userConstraints.altitude;t&&"auto"===t.mode&&t.autoUpdate(this.constraints.altitude.min(this),this.constraints.altitude.max(this))},_autoUpdateTiltConstraint:function(t){var e=this._userConstraints&&this._userConstraints.tilt;void 0===t&&(t=this.constraints.tilt.max(this.cameras.target.distance)),e&&"auto"===e.mode&&e.autoUpdate(n.rad2deg(t))},_disconnectUserConstraints:function(){if(this._userConstraints){this._userConstraintsHandles.forEach(function(t){t.remove()}),this._userConstraints=null,this._userConstraintsHandles.length=0;var t=this.renderUnitInMeters;this.constraints.tilt=D.Tilt.scale(this.defaultConstraints.tilt,t),this.constraints.altitude=D.Altitude.scale(this.defaultConstraints.altitude,t)}},_connectUserConstraints:function(t){t&&(this._userConstraints=t,this._userConstraintsHandles.push(e.init(t,"tilt.mode",this._tiltModeHandler),e.init(t,"clipDistance.mode",this._clipDistanceModeHandler),e.init(t,"altitude.mode",this._altitudeModeHandler),e.init(t,"collision.enabled",this._collisionEnabledHandler)))},_camerasChanged:function(){var t=this._targetCameraChangedByElevationUpdate;this.targetChanged(),this._targetCameraChangedByElevationUpdate=t,this.currentChanged(),this.currentHasReachedTarget()&&this.currentReachedTarget()},_reapplyConstraints:function(){var t=!1;this.applyConstraints(this.cameras.current)&&(t=!0),this.applyConstraints(this.cameras.target)&&(t=!0),t&&this._camerasChanged()},_userConstraintsChanged:function(){this._reapplyConstraints()},_altitudeMinMaxHandler:function(t,e,i){this._userConstraintsChanged()},_tiltMaxHandler:function(t,e,i){this._userConstraintsChanged()},_tiltModeHandler:function(t){this._tiltHandles.forEach(function(t){t.remove()}),this._tiltHandles.length=0,"auto"===t?this.constraints.tilt=D.Tilt.scale(this.defaultConstraints.tilt,this.renderUnitInMeters):(this._tiltHandles.push(this._userConstraints.watch("tilt.max",this._tiltMaxHandler)),this.constraints.tilt=d(this._userConstraints)),this._tiltMaxHandler()},_altitudeModeHandler:function(t){this._altitudeHandles.forEach(function(t){t.remove()}),this._altitudeHandles.length=0,"auto"===t?(this.constraints.altitude=D.Altitude.scale(this.defaultConstraints.altitude,this.renderUnitInMeters),this._autoUpdateAltitudeConstraint()):(this._altitudeHandles.push(this._userConstraints.watch("altitude.min",this._altitudeMinMaxHandler),this._userConstraints.watch("altitude.max",this._altitudeMinMaxHandler)),this.constraints.altitude=c(this._userConstraints)),this._altitudeMinMaxHandler()},_collisionEnabledHandler:function(t,e,i){this.constraints.collision=u(this._userConstraints),this._userConstraintsChanged()},_clipDistanceNearFarHandler:function(t,e,i){"auto"!==this._userConstraints.clipDistance.mode&&(this.cameras.target.near=this._userConstraints.clipDistance.near,this.cameras.target.far=this._userConstraints.clipDistance.far,this.cameras.current.near=this._userConstraints.clipDistance.near,this.cameras.current.far=this._userConstraints.clipDistance.far),this._camerasChanged()},_clipDistanceModeHandler:function(t){this._clipDistanceHandles.forEach(function(t){t.remove()}),this._clipDistanceHandles.length=0,"auto"!==t&&this._clipDistanceHandles.push(this._userConstraints.watch(["clipDistance.near","clipDistance.far"],this._clipDistanceNearFarHandler)),this._clipDistanceNearFarHandler()},_updateAutoNearFar:function(t){var e=this._userConstraints&&this._userConstraints.clipDistance;if(!e||"auto"===e.mode){var i=this.renderUnitInMeters,n=this.distanceToSilhouette(t,this.view.dataExtent,i,this._getTerrainElevationBelowCamera(t),F);t.far=n.distance/i,t.far/n.maxFarNearRatio>this.minNearDistance?t.near=t.far/n.maxFarNearRatio:(t.near=this.minNearDistance,t.far=t.near*n.maxFarNearRatio),e&&t===this.cameras.current&&e.autoUpdate(t.near,t.far)}},constrainTargetEyeByElevation:function(){var t=!1;if(h(this.elevationProvider)){var e=this.cameras.target,i=this._getTerrainElevationBelowCamera(e),n=this.cameraElevationMargin;t=this._applyElevationConstraint(e.eye,i,n)}return t},constrainTargetEyeByElevationAndMoveLookAt:function(){p.set(this.cameras.target.eye,U),this.constrainTargetEyeByElevation()&&(p.subtract(U,this.cameras.target.eye),p.subtract(this.cameras.target.center,U))},targetChanged:function(t){this.inherited(arguments),this._targetCameraChangedByElevationUpdate=!1,this._updateAutoNearFar(this.cameras.target),this.currentHasReachedTarget()&&this.currentReachedTarget()},currentChanged:function(){this._updateAutoNearFar(this.cameras.current),this.inherited(arguments)},_applyElevationConstraint:function(t,e,i){if(!this.constraintsEnabled)return!1;var n=this.renderCoordsHelper,a=n.getAltitude(t),r=this.constraints.collision.enabled;return r&&i>a-e?(n.setAltitude(e+i,t,0),!0):!1},_cameraElevationAngle:function(t,e){e=e||{tilt:0,distance:0},this.renderCoordsHelper.worldUpAtPosition(t.center,M),p.subtract(t.eye,t.center,E);var i=p.length(E),n=Math.acos(p.dot(E,M)/i/p.length(M));return e.tilt=n,e.distance=i,e},_elevationChangeTileHandler:function(t){if(this.enableElevationUpdates&&this._targetCameraChangedByElevationUpdate&&this.constraintsEnabled){var e=this.renderCoordsHelper,i=!1,n=t.tile.extent,a=this._targetCameraBeforeElevationUpdate.eye,r=e.fromRenderCoords(a,f,t.spatialReference);n[0]<=r.x&&n[1]<=r.y&&n[2]>r.x&&n[3]>r.y&&(x.copyFrom(this.cameras.target),this.cameras.target.copyFrom(this._targetCameraBeforeElevationUpdate),this.constrainTargetEyeByElevation(),this.applyConstraints(this.cameras.target),i=!x.equals(this.cameras.target)),i&&(this.isAnimating?this.targetChanged():this.targetAnimatedChanged(!1,{internalUpdate:!0}),this._targetCameraChangedByElevationUpdate=!0)}},_elevationChangeHandler:function(t){var e=this.renderCoordsHelper,i=t.extent,n=t.spatialReference,a=e.fromRenderCoords(this.cameras.target.eye,n);this._deferredUpdateTargetEyeForElevationChange(i,a,n),this._deferredUpdateTargetCenterForElevationChange(i,a,n)},_isPositionWithinExtent:function(t,e){return e[0]<=t.x&&e[1]<=t.y&&e[2]>t.x&&e[3]>t.y},_deferredUpdateTargetEyeForElevationChange:function(t,e){return this.enableElevationUpdates&&this.constraintsEnabled&&this._isPositionWithinExtent(e,t)?this.isAnimating?void(this._recomputeTargetEyeForElevationChange=!0):void this._updateTargetEyeForElevationChange():void 0},_updateTargetEyeForElevationChange:function(){this._recomputeTargetEyeForElevationChange=!1;var t=this.cameras.target;this._targetCameraChangedByElevationUpdate||this._targetCameraBeforeElevationUpdate.copyFrom(t);var e=this._getTerrainElevationBelowCamera(t),i=this.cameraElevationMargin,n=this._applyElevationConstraint(t.eye,e,i);return n&&(this.isAnimating?this.targetChanged():this.targetAnimatedChanged(!1,{internalUpdate:!0}),this._targetCameraChangedByElevationUpdate=!0),n},_deferredUpdateTargetCenterForElevationChange:function(t,e,i){if(this.enableElevationUpdates&&!this._recomputeTargetCenterForElevationChange){var n=this.renderCoordsHelper,a=n.fromRenderCoords(this.cameras.target.center,i),r=Math.max(a.x,e.x),s=Math.min(a.x,e.x),l=Math.max(a.y,e.y),h=Math.min(a.y,e.y),d=o.intersectIntervals([[s,r]],[[t[0],t[2]]]),c=o.intersectIntervals([[h,l]],[[t[1],t[3]]]);d.length>0&&c.length>0&&(this._recomputeTargetCenterForElevationChange=!0)}},_getTerrainElevationBelowCamera:function(t){if(h(this.elevationProvider)){var e=this.elevationProvider.spatialReference,i=this.renderCoordsHelper.fromRenderCoords(t.eye,e);return this.elevationProvider.getElevation(i)||0}return 0},getCenterIntersectTerrain:function(t,e,i){i||(i=p.create()),p.set(e,i);var n=this.picker.pickAlongRay(t,i,null,null,null,!1,this._intersectTerrainSelector);return this.picker.pickedIntersectionPoint(n,i)||this.getCenterIntersectManifold(t,e,i)||this.getFallbackCenterAlongViewDirection(t,e,i),i},getCenterIntersectManifold:function(t,e,i){return p.subtract(e,t,E),this.intersectManifold(t,E,0,i)},getCameraIntersectTerrain:function(t,e,i,n){var a=this.cameras.current.copy();if(t&&(a.eye=t),e&&(a.center=e),i&&(a.up=i),this.getCenterIntersectTerrain(a.eye,a.center,A),p.dist2(a.eye,A)<this.minPoiDist&&this.constraintsEnabled){var r=this.constraints.collision.enabled;p.set(a.viewForward,E),p.scale(E,this.minPoiDist),r?p.subtract(A,E,a.eye):p.add(a.eye,E,A);var s=this.renderCoordsHelper,o=s.getAltitude(a.eye);r&&o<this.cameraElevationMargin&&(p.subtract(A,a.eye,E),s.setAltitude(this.cameraElevationMargin,a.eye),p.add(a.eye,E,A)),a.markViewDirty()}if(n>0){var l=p.dist(a.eye,a.center),h=p.dist(A,a.center);h>l*n&&(a.center=A)}else a.center=A;return a}});return D.UPDATE_TARGET_BY_ELEVATION_UPDATES_DEFAULT=!0,D.Tilt=function(t){this.min=t.min,this.max=t.max},D.Tilt.scale=function(t,e){return 1===e?t:new D.Tilt({min:function(i){return t.min(i*e)},max:function(i){return t.max(i*e)}})},D.Tilt.prototype.apply=function(t,e){return n.clamp(t,this.min(e),this.max(e))},D.Altitude=function(t){this.min=t.min,this.max=t.max},D.Altitude.scale=function(t,e){return 1===e?t:new D.Altitude({min:function(i){return t.min(i)/e},max:function(i){return t.max(i)/e}})},D.Altitude.prototype.apply=function(t,e){return n.clamp(e,this.min(t),this.max(t))},D.Collision=function(t){this.enabled=null!=t?t:!0},D});