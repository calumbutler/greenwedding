// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../lib/IdGen","../../lib/gl-matrix","../../parts/Model","../../lib/Util","../../../../webgl/Util"],function(e,t,r,i,n){var a=t.vec3d,o=t.mat4d,f=t.mat4,u=i.VertexAttrConstants,s={};s.__Material_idGen=new e,s.__GLMaterial_id=0,s.IDENTITY=o.identity();var d=function(e,t,r,i,n){var a=e[t],o=e[t+1],f=e[t+2];r[i]=n[0]*a+n[4]*o+n[8]*f+n[12],r[i+1]=n[1]*a+n[5]*o+n[9]*f+n[13],r[i+2]=n[2]*a+n[6]*o+n[10]*f+n[14]};s.fill=function(e,t,r,i,n,a){if(void 0===n||3!==a)for(var o=0;a>o;++o)r[i+o]=e[t+o];else d(e,t,r,i,n);return a};var c=function(e,t,r,i,n,a){for(var o=e.length,f=0;o>f;++f){var u=3*e[f],s=t[u],d=t[u+1],c=t[u+2];i[n]=r[0]*s+r[4]*d+r[8]*c+r[12],i[n+1]=r[1]*s+r[5]*d+r[9]*c+r[13],i[n+2]=r[2]*s+r[6]*d+r[10]*c+r[14],n+=a}},l=function(e,t,r,i,n,a){for(var o=e.length,f=0;o>f;++f){for(var u=r*e[f],s=0;r>s;++s)i[n+s]=t[u+s];n+=a}},v=function(e,t,r,i,n,a){i=new Uint8Array(i.buffer),n*=4,a*=4;for(var o=e.length,f=0;o>f;++f){var u,s=r*e[f];for(u=0;r>u;++u)i[n+u]=t[s+u];4>u&&(i[n+3]=255),n+=a}},g=function(e,t,r,i,n,a,o){n=new Uint8Array(n.buffer),a*=4,o*=4;for(var f=e.length,u=0;f>u;++u){var s,d=i*e[u];for(s=0;i>s;++s)n[a+s]=t[d+s]*r[s];4>s&&(n[a+3]=255*r[3]),a+=o}},x=function(e,t,r,i,n,a){i=new Uint16Array(i.buffer),n*=2,a*=2;for(var o=e.length,f=0;o>f;++f){var u,s=r*e[f];for(u=0;r>u;++u)i[n+u]=t[s+u];n+=a}};s.fillInterleaved=function(e,t,r,i,a,o,f,s){for(var d=n.getStride(a)/4,T=0;T<a.length;T++){var b=a[T],h=f+b.offset/4,y=b.name;if(null==s||null!=s[y]){var I;switch(y){case"uv0":I=e.vertexAttr[y],null!=I&&l(e.faces.indices[y],I.data,I.size,o,h,d);break;case"region":I=e.vertexAttr[y],x(e.faces.indices[y],I.data,I.size,o,h,d);break;case"color":I=e.vertexAttr[y],i&&i.color?g(e.faces.indices[y],I.data,i.color,I.size,o,h,d):v(e.faces.indices[y],I.data,I.size,o,h,d);break;default:I=e.vertexAttr[y];var m=y===u.POSITION?t:y===u.NORMAL?r:void 0;void 0!==m&&3===I.size?c(e.faces.indices[y],I.data,m,o,h,d):l(e.faces.indices[y],I.data,I.size,o,h,d)}}}},s.triangleVertexArrayToWireframeLines=function(e,t,r,i){for(var n=Math.floor(r/3),a=n-1;a>=0;a--){var o=t+3*a*i,f=t+3*a*2*i+5*i;this.fill(e,o,e,f,null,i),f-=i,this.fill(e,o+i,e,f,null,i),f-=i,this.fill(e,o+i,e,f,null,i),f-=i,this.fill(e,o+2*i,e,f,null,i),f-=i,this.fill(e,o+2*i,e,f,null,i),f-=i,this.fill(e,o,e,f,null,i)}};var T=a.create(),b=a.create(),h=a.create(),y=a.create(),I=function(e,t,r,i,n){var o=T,f=e.getCenter();a.project(f,t,r,o);var u=a.dist2(o,f),s=e.getBSRadius();if(s*s>u){var d=e.getPrimitiveIndices(),c=e.getIndices(),l=e.getPosition(),v=d?d.length:c.length/3;if(v>1e4){var g=e.getChildren();if(void 0!==g){for(var x=0;8>x;++x)void 0!==g[x]&&I(g[x],t,r,i,n);return}}for(var m=l.size,A=l.data,M=t[0],G=t[1],U=t[2],w=r[0],L=r[1],P=r[2],_=w-M,C=L-G,p=P-U,z=0;v>z;++z){var S=d?d[z]:z,R=m*c[3*S],V=m*c[3*S+1],D=m*c[3*S+2],N=A[R],O=A[R+1],k=A[R+2],q=A[V],B=A[V+1],E=A[V+2],j=A[D],F=A[D+1],W=A[D+2],Y=q-N,H=B-O,J=E-k,K=j-N,Q=F-O,X=W-k,Z=C*X-Q*p,$=p*K-X*_,ee=_*Q-K*C,te=Y*Z+H*$+J*ee;if(!(te>-i&&i>te)){var re=1/te,ie=M-N,ne=G-O,ae=U-k,oe=re*(ie*Z+ne*$+ae*ee);if(!(0>oe||oe>1)){var fe=ne*J-H*ae,ue=ae*Y-J*ie,se=ie*H-Y*ne,de=re*(_*fe+C*ue+p*se);if(!(0>de||oe+de>1)){var ce=re*(K*fe+Q*ue+X*se);if(ce>=0){var le=b,ve=h,ge=y;a.set3(N,O,k,le),a.set3(q,B,E,ve),a.set3(j,F,W,ge),a.subtract(ve,le,ve),a.subtract(ge,le,ge),a.normalize(a.cross(ve,ge,le)),n(ce,le,S)}}}}}}};s.intersectTriangleGeometry=function(e,t,r,n,a,o,f){i.assert("triangle"===e.getData().getFaces()[t].type),I(e.getBoundingInfo(t),a,o,n.tolerance,f)},s.basicMaterialConstructor=function(e,t){var n=!0,a=0,o=s.__Material_idGen.gen(t);e.getId=function(){return o};var f;e.getParentStage=function(){return f},e.addParentStage=function(e){i.assert(void 0===f,"Material can only be added to a single Stage"),f=e},e.removeParentStage=function(e){f=void 0},e.setVisible=function(t){n!==t&&(n=t,e.notifyDirty("matChanged"))},e.isVisible=function(){return n},e.notifyDirty=function(t){f&&f.notifyDirty(r.ContentType.MATERIAL,e,t)},e.setRenderPriority=function(e){a=e,this.notifyDirty("matChanged")},e.getRenderPriority=function(){return a}};var m=s.aquireIfNotUndefined=function(e,t,r,i){return void 0!==e?r.aquire(e,t,i):void 0},A=s.releaseIfNotUndefined=function(e,t){void 0!==e&&t.release(e)},M=f.create();return s.bindView=function(e,t,r){f.translate(t,e,M),r.setUniformMatrix4fv("view",M)},s.bindCamPos=function(e,t,r){r.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])},s.basicGLMaterialConstructor=function(e,t){var r=s.__GLMaterial_id++;e.getId=function(){return r},e.getMaterialId=function(){return t.getId()},e.isVisible=function(){return t.isVisible()},e.getRenderPriority=function(){return t.getRenderPriority()}},s.singleTextureGLMaterialConstructor=function(e,t,r,i){var n=m(r.textureId,r.initTexture,t,i);e.updateTexture=function(e){r.textureId!==e&&(A(r.textureId,t),r.textureId=e,n=m(r.textureId,r.initTexture,t,i))},e.renderTexture=function(e){var i=t.getTexture(r.textureId);i&&i.dirty&&i.redraw&&i.redraw()},e.bindTexture=function(e,t){void 0!==n&&(t.setUniform1i("tex",0),e.bindTexture(n.getGLTexture()))},e.bindTextureSize=function(e,t){if(void 0!==n){var r=n.getGLTexture();t.setUniform2f("texSize",r.descriptor.width,r.descriptor.height)}},e.dispose=function(){A(r.textureId,t)}},s.multiTextureGLMaterialConstructor=function(e,t,r,i){for(var n=i.length,a=new Array(n),o=0;n>o;o++)a[o]=m(r[i[o][0]],r[i[o][1]],t);e.updateTextures=function(e){for(var o=0;n>o;o++){var f=r[i[o][0]],u=e[i[o][0]];f!==u&&(A(f,t),r[i[o][0]]=u,a[o]=m(u,r[i[o][1]],t))}},e.bindTextures=function(e,t){for(var r=0;n>r;r++)void 0!==a[r]&&(t.setUniform1i(i[r][2],r),e.bindTexture(a[r].getGLTexture(),r));e.setActiveTexture(0)},e.bindOneTexture=function(e,t,r){t.setUniform1i(i[r][2],r),e.bindTexture(a[r].getGLTexture(),r),e.setActiveTexture(0)},e.disposeTextures=function(){for(var e=0;n>e;e++)A(r[i[e][0]],t)}},s});