// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./ModelContentType","./ModelDirtyTypesTs","./Util"],function(e,t,r,o,i){var d=i.objectEmpty,n=i.assert,s=function(){function e(e){this._residentGeomRecords={},this._dirtyGeomRecords={},this._dirtyMaterials={},this._model=e}return e.prototype._getResidentGeometryRecords=function(){return this._residentGeomRecords},e.prototype._getDirtyGeometryRecords=function(){return this._dirtyGeomRecords},e.prototype.getDirtyMaterials=function(){return d(this._dirtyMaterials)?null:this._dirtyMaterials},e.prototype.clearDirtyMaterials=function(){this._dirtyMaterials={}},e.prototype.hasDirtyGeometryRecords=function(){for(var e in this._dirtyGeomRecords)for(var t in this._dirtyGeomRecords[e]){var r=this._dirtyGeomRecords[e][t];if(r&&!d(r))return!0}return!1},e.prototype.handleUpdate=function(e,t,r){return n(this[t],"ModelDirtySet doesn't know how to process "+t),this[t](e,r)},e.prototype.getAddRemoveUpdateList=function(e){return this.getAddRemoveUpdateListFilteredByLayers(Object.keys(this._dirtyGeomRecords),e)},e.prototype.getAddRemoveUpdateListFilteredByLayers=function(e,t){for(var o=[],i=[],d=[],s=0;s<e.length;s++){var a=e[s];if(a in this._dirtyGeomRecords)for(var y in this._dirtyGeomRecords[a]){var c=this._dirtyGeomRecords[a][y];if(c){var p=this._createObjectRecordObjIfNonexistent(this._residentGeomRecords,a,y);for(var f in c){var h=c[f],m=h[0],R=h[1],u=h[2],l=2&R&&1&u;if(4&R||l){var v=p[f];v?i.push.apply(i,v[1]):4===R&&n(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove"),t&&v&&delete p[f]}if(1&R||l){var g=[m,[]],_=this._model.get(r.OBJECT,y);this._model.getGeometryRenderGeometries(_,m,g[1]),o.push.apply(o,g[1]),t&&(p[f]=g)}if(2&R&&!l){var v=p[f],_=this._model.get(r.OBJECT,y);if(v){var G=v[1],b=G.length;if(2&u)for(var j=_.getVisibleIndexRanges(m),O=0;b>O;O++){var D=G[O];j?D.displayedIndexRange=j[D.componentIdx]:D.displayedIndexRange=void 0}if(16&u)for(var O=0;b>O;O++){var D=G[O];_.getCombinedStaticTransformation(m,D.transformation),D.updateTransformation(D.transformation)}for(var O=0;b>O;O++){var D=G[O];d.push({renderGeometry:D,updateType:u})}}else n(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}}}}t&&delete this._dirtyGeomRecords[a]}return[o,i,d]},e.prototype.getResidentRenderGeometries=function(){return this.getResidentRenderGeometriesFilteredByLayers(Object.keys(this._residentGeomRecords))},e.prototype.getResidentRenderGeometriesFilteredByLayers=function(e){for(var t=[],r=0;r<e.length;r++){var o=e[r];if(o in this._residentGeomRecords)for(var i in this._residentGeomRecords[o]){var d=this._residentGeomRecords[o][i];if(d)for(var n in d)t.push.apply(t,d[n][1])}}return t},e.prototype.hideFaceRange=function(e,t,r){r=r||this._getParentLayerId(e),this._updateOrCreateDirtyRecord(e,t,r,2,0,0,2,5,2)},e.prototype.unhideAllFaceRange=function(e,t){for(var r=0;r<e.getGeometryRecords().length;r++)this._updateOrCreateDirtyRecord(e,e.getGeometryRecords()[r],t,2,0,0,2,5,2)},e.prototype.vertexAttrsUpdated=function(e,t,r){this._updateOrCreateDirtyRecord(e,t,r,2,0,0,2,5,4)},e.prototype.colorAttrsUpdated=function(e,t,r){this._updateOrCreateDirtyRecord(e,t,r,2,0,0,2,5,8)},e.prototype.matChanged=function(e){this._dirtyMaterials[e.getId()]=!0},e.prototype.layerAdded=function(e){for(var t=e.getObjects(),r=0;r<t.length;r++)this.layObjectAdded(e,t[r])},e.prototype.layerRemoved=function(e){for(var t=e.getObjects(),r=0;r<t.length;r++)this.layObjectRemoved(e,t[r])},e.prototype.layObjectAdded=function(e,t){for(var r=e.getId(),o=t.getGeometryRecords(),i=0;i<o.length;i++)this.objGeometryAdded(t,o[i],r)},e.prototype.layObjectRemoved=function(e,t){for(var r=e.getId(),o=t.getGeometryRecords(),i=0;i<o.length;i++)this.objGeometryRemoved(t,o[i],r)},e.prototype.layObjectReplaced=function(e,t){this.layObjectRemoved(e,t[0]),this.layObjectAdded(e,t[1])},e.prototype.objDirty=function(e,t){t=t||this._getParentLayerId(e);var r=e.getId(),o=this._createObjectRecordObjIfNonexistent(this._residentGeomRecords,t,r);for(var i in o)this._updateOrCreateDirtyRecord(e,o[i][0],t,2,0,2,0,5,1)},e.prototype.objTransformation=function(e,t){t=t||this._getParentLayerId(e);var r=e.getId(),o=this._createObjectRecordObjIfNonexistent(this._residentGeomRecords,t,r);for(var i in o)this._updateOrCreateDirtyRecord(e,o[i][0],t,2,0,0,2,5,16)},e.prototype.objGeometryAdded=function(e,t,r){this._updateOrCreateDirtyRecord(e,t,r,1,4,0,0,0)},e.prototype.objGeometryRemoved=function(e,t,r){this._updateOrCreateDirtyRecord(e,t,r,4,1,2,0,0)},e.prototype.objGeometryReplaced=function(e,t){this.objGeometryRemoved(e,t[0]),this.objGeometryAdded(e,t[1])},e.prototype.objGeometryTransformation=function(e,t){this.objGeometryReplaced(e,t)},e.prototype._updateOrCreateDirtyRecord=function(e,t,r,o,i,d,s,a,y){r=r||this._getParentLayerId(e);var c=e.getId(),p=t.getId(),f=this._createObjectRecordObjIfNonexistent(this._dirtyGeomRecords,r,c),h=f[p];if(h){var m=h[1];m&i?delete f[p]:m&d?(h[1]=o,h[2]=y):m&s?h[2]|=y:m&a||n(!1,"ModelDirtySet.objGeometryAdded: inconsistent state")}else f[p]=[t,o,y]},e.prototype._createObjectRecordObjIfNonexistent=function(e,t,r){return e[t]||(e[t]={}),e[t][r]||(e[t][r]={}),e[t][r]},e.prototype._getParentLayerId=function(e){return e.parentLayer.id},e.prototype.formatDebugInfo=function(e){var t=["ADD","UPD",void 0,"REM"];if(e)return"";var r="";for(var o in this._dirtyGeomRecords)for(var i in this._dirtyGeomRecords[o]){var d=this._dirtyGeomRecords[o][i];if(d){r.length>0&&(r+="\n"),r+=o+"."+i;var n=[];for(var s in d){var a=d[s][1];n[a]||(n[a]=[]),n[a].push(d[s][0].geometry.id)}for(var y=0;y<n.length;y++)if(n[y]){r+=" "+t[y-1]+": ";for(var c=0;c<n[y].length;c++)r+=n[y][c]+", "}}}return r},e}();return s});