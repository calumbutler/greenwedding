// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./Util","./gl-matrix"],function(e,t,r,i){var n=i.vec3d,a=i.vec4d,s=i.mat4d,o=function(){function e(){this._context={content:[],near:[],far:[],nearSpecial:[],farSpecial:[],bestNear:0,bestFar:0,bestNear2:0,bestFar2:0},this._boundingInfoHelper=new h}return e.prototype._resetContext=function(){var e=this._context;return e.content.length=0,e.near.length=0,e.far.length=0,e.nearSpecial.length=0,e.farSpecial.length=0,e.bestNear=Number.MAX_VALUE,e.bestFar=-Number.MAX_VALUE,this._context},e.prototype.calculateSceneNearFar=function(e,t,r){var i=this._resetContext(),n=e.viewMatrix,a=n[2],s=n[6],o=n[10],h=n[14],l=0;for(var c in t){var p=t[c];if((null==p.displayedIndexRange||0!==p.displayedIndexRange.length)&&p.castShadow&&r.get(p.idx)){var _=p.bsRadius,f=p.center,u=a*f[0]+s*f[1]+o*f[2]+h,v=u-_,b=u+_;i.content[l]=p,i.near[l]=-b,i.far[l]=-v,++l}}if(0===l)return[i.bestNear,i.bestFar];for(var d=0;l>d;++d)i.near[d]>i.bestFar&&(i.bestFar=i.near[d]),i.near[d]>2&&i.far[d]<i.bestNear&&(i.bestNear=i.far[d]);i.bestNear2=Math.max(.5*i.bestNear,2),i.bestFar2=2*i.bestFar;for(var g=0,x=0,d=0;l>d;++d)i.near[d]<i.bestNear&&(i.near[d]>=i.bestNear2?i.bestNear=i.near[d]:i.nearSpecial[g++]=d),i.far[d]>i.bestFar&&(i.far[d]<=i.bestFar2?i.bestFar=i.far[d]:i.farSpecial[x++]=d);if(0===g&&0===x)return[i.bestNear,i.bestFar];i.nearSpecial.length=g,i.farSpecial.length=x,i.nearSpecial.sort(function(e,t){return i.near[e]<i.near[t]?-1:i.near[e]>i.near[t]?1:0}),i.farSpecial.sort(function(e,t){return i.far[e]<i.far[t]?1:i.far[e]>i.far[t]?-1:0}),this._boundingInfoHelper.init(e,i);for(var d=0;g>d;++d)if(i.near[i.nearSpecial[d]]<i.bestNear){var p=i.content[i.nearSpecial[d]],F=p.boundingInfo;this._boundingInfoHelper.includeNearBoundingInfoRec(F,p.transformation)}for(var d=0;x>d;++d)if(i.far[i.farSpecial[d]]>i.bestFar){var p=i.content[i.farSpecial[d]],F=p.boundingInfo;this._boundingInfoHelper.includeFarBoundingInfoRec(F,p.transformation)}return[i.bestNear,i.bestFar]},e}(),h=function(){function e(){this._clippingHelper=new l,this._planes=[a.create(),a.create(),a.create(),a.create(),a.create(),a.create()],this._viewProj=s.create(),this._view=s.create()}return e.prototype.init=function(e,t){this._context=t,s.set(e.viewMatrix,this._view),s.multiply(e.projectionMatrix,this._view,this._viewProj),e.copyFrustumPlanes(this._planes),this._clippingHelper.init(t)},e.prototype.includeNearBoundingInfoRec=function(e,t){var r=e.getBSRadius(),i=e.getCenter();s.multiplyVec3(t,i,p);var n=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],a=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],o=t[2]*t[2]+t[6]*t[6]+t[10]*t[10],h=Math.sqrt(Math.max(Math.max(n,a),o)),l=p[0],c=p[1],_=p[2];if(r*=h,!(this._planes[0][0]*l+this._planes[0][1]*c+this._planes[0][2]*_+this._planes[0][3]>r||this._planes[1][0]*l+this._planes[1][1]*c+this._planes[1][2]*_+this._planes[1][3]>r||this._planes[2][0]*l+this._planes[2][1]*c+this._planes[2][2]*_+this._planes[2][3]>r||this._planes[3][0]*l+this._planes[3][1]*c+this._planes[3][2]*_+this._planes[3][3]>r)){var f=this._view[2]*l+this._view[6]*c+this._view[10]*_+this._view[14],u=f-r,v=f+r;if(!(2>-u||-v>=this._context.bestNear)){if(-v>this._context.bestNear2)return void(this._context.bestNear=-v);if(r>100){var b=e.getChildren();if(void 0!==b){for(var d=0;8>d;++d)void 0!==b[d]&&this.includeNearBoundingInfoRec(b[d],t);return}}this._clippingHelper.intersectFrustumAABB(this._viewProj,t,e.getBBMin(),e.getBBMax())}}},e.prototype.includeFarBoundingInfoRec=function(e,t){var r=e.getBSRadius(),i=e.getCenter();s.multiplyVec3(t,i,p);var n=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],a=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],o=t[2]*t[2]+t[6]*t[6]+t[10]*t[10],h=Math.sqrt(Math.max(Math.max(n,a),o)),l=p[0],c=p[1],_=p[2];if(r*=h,!(this._planes[0][0]*l+this._planes[0][1]*c+this._planes[0][2]*_+this._planes[0][3]>r||this._planes[1][0]*l+this._planes[1][1]*c+this._planes[1][2]*_+this._planes[1][3]>r||this._planes[2][0]*l+this._planes[2][1]*c+this._planes[2][2]*_+this._planes[2][3]>r||this._planes[3][0]*l+this._planes[3][1]*c+this._planes[3][2]*_+this._planes[3][3]>r)){var f=this._view[2]*l+this._view[6]*c+this._view[10]*_+this._view[14],u=f-r;if(!(-u<=this._context.bestFar)){if(-u<this._context.bestFar2)return void(this._context.bestFar=-u);if(r>100){var v=e.getChildren();if(void 0!==v){for(var b=0;8>b;++b)void 0!==v[b]&&this.includeFarBoundingInfoRec(v[b],t);return}}this._clippingHelper.intersectFrustumAABB(this._viewProj,t,e.getBBMin(),e.getBBMax())}}},e}(),l=function(){function e(){this._clipP=new Array(8);for(var e=0;8>e;++e)this._clipP[e]=a.create()}return e.prototype.init=function(e){this._context=e},e.prototype.intersectFrustumAABB=function(e,t,r,i){s.multiply(e,t,_);for(var n=0;8>n;++n){var a=this._clipP[n],o=0===n||3===n||4===n||7===n?r[0]:i[0],h=0===n||1===n||4===n||5===n?r[1]:i[1],l=4>n?r[2]:i[2];a[0]=_[0]*o+_[4]*h+_[8]*l+_[12],a[1]=_[1]*o+_[5]*h+_[9]*l+_[13],a[2]=_[2]*o+_[6]*h+_[10]*l+_[14],a[3]=_[3]*o+_[7]*h+_[11]*l+_[15]}for(var n=0;12>n;++n){for(var p=this._clipP[c[n][0]],f=this._clipP[c[n][1]],u=this._clipP[c[n][2]],v=this._clipTriangle(p,f,u),b=!0,d=0;d<v.length;++d){var g=v[d][3];if(g>=2){b=!1;break}}if(!b)for(var d=0;d<v.length;++d){var g=v[d][3];g<this._context.bestNear&&(this._context.bestNear=g),g>this._context.bestFar&&(this._context.bestFar=g)}}},e.prototype._inside=function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void r.assert(!1)},e.prototype._intersect=function(e,t,r){var i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),a.lerp(e,t,i,a.create())},e.prototype._clipTriangle=function(e,t,r){for(var i=[e,t,r],n=0;4>n;++n){var a=i;i=[];for(var s=0;s<a.length;++s){var o=a[s],h=a[(s+1)%a.length];this._inside(h,n)?(this._inside(o,n)||i.push(this._intersect(o,h,n)),i.push(h)):this._inside(o,n)&&i.push(this._intersect(o,h,n))}}return i},e}(),c=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],p=n.create(),_=s.create();return o});