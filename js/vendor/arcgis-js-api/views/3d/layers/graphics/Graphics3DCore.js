// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../core/watchUtils","../../../../core/arrayUtils","../../../../core/Error","../../../../core/Logger","../../../../core/promiseUtils","../../support/projectionUtils","../../../../renderers/support/rendererConversion","../../../../renderers/support/diffUtils","../../../../geometry/Point","../../../../geometry/Extent","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/Layer","../../webgl-engine/lib/FloatingBoxLocalOriginFactory","../../../../symbols/WebStyleSymbol","../../../../symbols/support/symbolConversion","../../lib/glMatrix","./Graphics3DGraphic","./Graphics3DSymbol","./Graphics3DWebStyleSymbol","./graphicUtils","./Graphics3DOwner","../../support/aaBoundingBox","../../support/mathUtils","dojo/Deferred"],function(e,i,t,a,r,s,n,l,o,h,p,c,y,d,u,g,f,b,m,v,w,D,C,G,S,V,x){function R(e){return"point"===e.type}function I(e){return"polygon"===e.type||"polyline"===e.type||"multipoint"===e.type}var E=m.vec3d,L=!1,F=!1,B=500,U="VISIBILITY_GRAPHIC",A=new p,H=E.create(),T=s.getLogger("esri.views.3d.LayerView3D"),O=function(){function e(){this.graphics={},this.graphicsDrapedIds={},this.graphicsBySymbol={},this.graphicsKeys=[],this.symbols={},this.graphicsWithoutSymbol={},this.computedExtent=null,this.symbolCreationContext=new G.Graphics3DSymbolCreationContext,this.hasDraped=!1,this.updatingGraphicIds={},this.lastFastUpdate=null,this.tilingSchemeHandle=null,this.stageLayer=null,this.labelStageLayer=null,this.stage=null,this.onComputedExtentChange=null,this.graphicTransformFunc=null,this.eventHandles=[],this.viewSR=null,this.layerView=null,this.layer=null,this.elevation=null,this.scaleVisibility=null,this.spatialIndex=null,this.labeling=null,this.whenGraphics3DGraphicRequests={}}return e.prototype.initialize=function(i,a,r,s,n,l,o,h,p){var c=this;this.layerView=i,this.layer=a,this.viewSR=i.view.spatialReference,this.elevation=r,this.scaleVisibility=s,this.spatialIndex=n,this.labeling=l,this.onComputedExtentChange=o,this.graphicTransformFunc=h,this.initializeStage(this.layerView.view,this.layer.id),this.symbolCreationContext.sharedResources=this.layerView.view.sharedSymbolResources,this.symbolCreationContext.renderer=this.layer.renderer,this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataSupplier=this.layerView.view.sharedSymbolResources.streamDataSupplier,this.symbolCreationContext.renderSpatialReference=this.layerView.view.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=this.layerView.view.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.layerView,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=e.createLocalOriginFactory(),this.symbolCreationContext.elevationProvider=p,this.tilingSchemeHandle=t.when(p,"tilingScheme",function(e){e.spatialReference.equals(c.symbolCreationContext.overlaySR)||(c.symbolCreationContext.overlaySR=p.spatialReference,c.recreateAllGraphics())}),this.eventHandles.push(this.layerView.watch("suspended",function(){return c.suspendedChange()})),this.eventHandles.push(t.on(i,"loadedGraphics","change",function(e){return c.graphicsCollectionChanged(e)},function(){c.clearSymbolsAndGraphics(),c.graphicsCollectionChanged({added:c.layerView.loadedGraphics.toArray(),removed:[]})})),this.validateRenderer(this.layer.renderer)},e.prototype.destroy=function(){var e=this;if(this.clear(),this.stage){var i=[this.stageLayer.getId()];this.labelStageLayer&&i.push(this.labelStageLayer.getId()),this.stage.removeFromViewContent(i),i.forEach(function(i){return e.stage.remove(y.ModelContentType.LAYER,i)}),this.stageLayer=null,this.labelStageLayer=null,this.stage=null}this.tilingSchemeHandle&&(this.tilingSchemeHandle.remove(),this.tilingSchemeHandle=null),this.eventHandles.forEach(function(e){return e.remove()}),this.eventHandles=null,this.onComputedExtentChange=null,this.viewSR=null,this.scaleVisibility=null,this.labeling=null,this.layerView=null;for(var t in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[t].reject(new r("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null},e.prototype.clear=function(){var e=!1;for(var i in this.graphics){var t=this.graphics[i];t&&(e=e||t.isDraped(),t.destroy())}this.graphics={},this.graphicsKeys=null;for(var a in this.symbols){var r=this.symbols[a];r&&r.destroy()}this.symbols={},this.graphicsBySymbol={},this.graphicsWithoutSymbol={},this.hasDraped=!1,e&&this.layerView._notifyDrapedDataChange()},e.prototype.initializeStage=function(e,i){this.stage=e._stage,this.stageLayer=new u(i,{state:this.layerView.suspended?"HIDDEN":"VISIBLE"},i),this.stage.add(y.ModelContentType.LAYER,this.stageLayer);var t=[this.stageLayer.getId()];this.labeling&&(this.labelStageLayer=new u(i,{state:this.layerView.suspended?"HIDDEN":"IGNORED"},i+"_labels"),this.stage.add(y.ModelContentType.LAYER,this.labelStageLayer),t.push(this.labelStageLayer.getId())),this.stage.addToViewContent(t)},e.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var i={},t={};for(var a in this.graphics){var r=this.graphics[a];r&&r.setDrawOrder(e,i,t)}for(var s in t){var n=this.symbols[s];n&&n.setDrawOrder(e,i)}d.objectEmpty(i)||(this.stage.getTextureGraphicsRenderer().updateRenderOrder(i),this.layerView._notifyDrapedDataChange())},e.prototype.suspendedChange=function(){this.layerView.suspended===!0?(this.stageLayer.setState("HIDDEN"),this.labelStageLayer&&this.labelStageLayer.setState("HIDDEN"),this.hideAllGraphics()):this.layerView.suspended===!1&&(this.stageLayer.setState("VISIBLE"),this.labelStageLayer&&this.labelStageLayer.setState("IGNORED"),this.updateAllGraphicsVisibility())},e.prototype.getGraphics3DGraphics=function(){return this.graphics},e.prototype.getGraphics3DGraphicById=function(e){return this.graphics[e]},e.prototype.getGraphics3DGraphicsKeys=function(){return null===this.graphicsKeys&&(this.graphicsKeys=Object.keys(this.graphics)),this.graphicsKeys},e.prototype.numNodesUpdating=function(){return Object.keys(this.updatingGraphicIds).length},e.prototype.needsIdleUpdate=function(){return this.lastFastUpdate&&performance.now()-this.lastFastUpdate>B},e.prototype.idleUpdate=function(e){e.done()||(this.lastFastUpdate&&(this.labeling&&this.labeling.updateLabelingInfo(),this.lastFastUpdate=null),this.layerView._evaluateUpdatingState())},e.prototype.whenGraphics3DGraphic=function(e){var i=this.graphics[e.uid];if(i)return n.resolve(i);var t=this.whenGraphics3DGraphicRequests[e.uid];return t||(t=new x,this.whenGraphics3DGraphicRequests[e.uid]=t),t.promise},e.prototype.boundsForGraphics3DGraphic=function(e,i){void 0===i&&(i=S.create());var t=this.layerView.view.spatialReference,a=this.layerView.view.renderSpatialReference,r=this.layerView.view.basemapTerrain.spatialReference,s=function(e,i,r){return l.bufferToBuffer(e,a,i,e,t,i,r)},n=function(e,i,a){return l.bufferToBuffer(e,r,i,e,t,i,a)},o=e.getProjectedBoundingBox(s,n,i);if(!o)return null;var h=e.isDraped(),p=this.symbolCreationContext.elevationProvider;if(h&&p){S.center(o,H),A.x=H[0],A.y=H[1],A.z=void 0,A.spatialReference=t;var c=p.getElevation(A)||0;o[2]=Math.min(o[2],c),o[5]=Math.max(o[5],c)}return o},e.prototype.whenGraphicBounds=function(e){var i=this;return t.whenOnce(this.layerView,"loadedGraphics").then(function(){if(i.layerView.loadedGraphics.some(function(i){return i===e}))return i.whenGraphics3DGraphic(e);throw new r("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return i.boundsForGraphics3DGraphic(e)})},e.prototype.graphicsCollectionChanged=function(e){var i=this.graphicTransformFunc?this.graphicTransformFunc(e.added):e.added;this.add(i),this.remove(e.removed)},e.prototype.graphicUpdateHandler=function(e){var i=this.graphics[e.graphic.uid];if(i)switch(e.property){case"visible":var t=i.setVisibilityFlag(U,e.newValue);t&&(i.isDraped()&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.labelManager.setDirty())}},e.prototype.beginGraphicUpdate=function(e){this.updatingGraphicIds[e.uid]=!0,this.layerView.get("symbols-updating")||this.layerView.set("symbols-updating",!0),this.layerView._evaluateUpdatingState()},e.prototype.endGraphicUpdate=function(e){e&&delete this.updatingGraphicIds[e.uid],this.layerView.get("symbols-updating")&&d.objectEmpty(this.updatingGraphicIds)&&(this.layerView.view.flushDisplayModifications(),this.layerView.set("symbols-updating",!1)),this.layerView._evaluateUpdatingState()},e.prototype.expandComputedExtent=function(i){var t,a,r,s,n,o;if(R(i))t=a=i.x,r=s=i.y,i.z&&(n=o=i.z);else if(I(i)){var h=i.extent;if(!h)return;t=h.xmin,a=h.xmax,r=h.ymin,s=h.ymax,n=h.zmin,o=h.zmax}var p=this.viewSR,y=e.tmpVec;if(!i.spatialReference.equals(p))if(l.xyzToVector(t,r,0,i.spatialReference,y,p))t=y[0],r=y[1],l.xyzToVector(a,s,0,i.spatialReference,y,p),a=y[0],s=y[1];else if(L)throw new Error("Geometry has incompatible spatial reference");if(V.isFinite(t)&&V.isFinite(a)&&V.isFinite(r)&&V.isFinite(s)){var d=this.computedExtent;d?(d.xmin=Math.min(t,d.xmin),d.xmax=Math.max(a,d.xmax),d.ymin=Math.min(r,d.ymin),d.ymax=Math.max(s,d.ymax)):(d=new c(t,r,a,s,i.spatialReference),this.computedExtent=d),V.isFinite(n)&&!V.isFinite(o)&&(d.zmin=null!=d.zmin?Math.min(n,d.zmin):n,d.zmax=null!=d.zmax?Math.max(o,d.zmax):o),this.onComputedExtentChange&&this.onComputedExtentChange()}},e.prototype.updateHasDraped=function(){this.hasDraped=!1;for(var e in this.graphicsDrapedIds)if(this.graphicsDrapedIds.hasOwnProperty(e)){this.hasDraped=!0;break}},e.prototype.elevationInfoChange=function(){this.labeling&&this.labeling.elevationInfoChange();for(var e in this.graphicsBySymbol){var i=this.symbols[e],t=this.graphicsBySymbol[e];if(i&&i.layerPropertyChanged("elevationInfo",t))for(var a in t)for(var r=t[a],s=r.graphic,n=r._labelGraphics,l=0;l<n.length;l++){var o=n[l],h=o.graphics3DSymbolLayer;h.updateGraphicElevationInfo(s,o)}else F&&T.warn("Could not apply elevation change to symbol "+e),this.recreateSymbol(e)}},e.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.elevation&&this.elevation.clear(),this.labeling&&this.labeling.clear()},e.prototype.recreateAllGraphics=function(){F&&T.warn("Recreating all graphics"),this.clearSymbolsAndGraphics(),this.computedExtent=null,this.onComputedExtentChange&&this.onComputedExtentChange(),this.layerView.loadedGraphics&&this.layerView.view.basemapTerrain.tilingScheme&&this.add(this.layerView.loadedGraphics.toArray())},e.prototype.recreateSymbol=function(e){F&&T.warn("Recreating symbol "+e);var i=this.graphicsBySymbol[e],t=[],a=!1;for(var r in i){var s=i[r],n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],a=!0),t.push(s.graphic),s.destroy(),this.graphics[r]=null}this.graphicsBySymbol[e]={};var l=this.symbols[e];l&&l.destroy(),this.symbols[e]=void 0,this.updateHasDraped(),a&&this.layerView._notifyDrapedDataChange(),this.add(t)},e.prototype.add=function(e){if(this.layerView.view.basemapTerrain&&this.layerView.view.basemapTerrain.tilingScheme){for(var i=e.length,t=new Array(i),a=new Array(i),r=new Array(i),s=0;i>s;s++){var n=e[s],l=n.geometry;if(l){this.expandComputedExtent(l);var o=this.layerView.getRenderingInfo?this.layerView.getRenderingInfo(n):{symbol:n.symbol};if(o&&o.symbol){a[s]=o.symbol,r[s]=o;var h=this.getOrCreateGraphics3DSymbol(a[s],o.renderer);h?(t[s]=h,this.beginGraphicUpdate(n)):(F&&T.warn("Graphics3DGraphic for graphic "+n.uid+" not created - could not create Graphics3DSymbol for symbol "+a[s].id),this.graphicsWithoutSymbol[n.uid]=!0)}else F&&T.warn("Graphics3DGraphic for graphic "+n.uid+" not created - graphic has no symbol"),this.graphicsWithoutSymbol[n.uid]=!0}}for(var s=0;i>s;s++)this.waitForSymbol(t[s],a[s],e[s],r[s])}},e.prototype.waitForSymbol=function(e,i,t,a){var r=this;e&&e.then(function(){r.graphicsBySymbol[i.id]||(r.graphicsBySymbol[i.id]={}),r.createGraphics3DGraphic(e,t,a),r.endGraphicUpdate(t),r.labeling&&r.layerView.view.labelManager.setDirty()},function(){F&&T.warn("Graphics3DGraphic for graphic "+t.uid+" not created - Graphics3DSymbol for symbol "+i.id+" rejected"),r.endGraphicUpdate(t)})},e.prototype.remove=function(e){for(var i=!1,t=e.length,a=0;t>a;a++){var r=e[a].uid,s=this.graphics[r];if(s){var n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],i=!0);var l=s.graphics3DSymbol.symbol.id;s.destroy(),delete this.graphics[r],delete this.graphicsBySymbol[l][r],delete this.graphicsWithoutSymbol[r],this.graphicsKeys=null}}this.updateHasDraped(),i&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.labelManager.setDirty()},e.prototype.createGraphics3DSymbol=function(e,i){var t=b.to3D(e,!0,!1);if(t.symbol){var a=void 0;if(i&&i.backgroundFillSymbol){var r=b.to3D(i.backgroundFillSymbol,!1,!0);r.symbol&&(a=r.symbol.symbolLayers)}return new w(t.symbol,this.symbolCreationContext,a)}return F&&T.warn("Graphics3DSymbol for symbol "+e.id+" not created - could not convert symbol"),null},e.prototype.getOrCreateGraphics3DSymbol=function(e,i){var t=this,a=this.symbols[e.id];return void 0===a&&(a=e instanceof f?new D(e,function(e){return t.createGraphics3DSymbol(e,i)}):this.createGraphics3DSymbol(e,i),this.symbols[e.id]=a),a},e.prototype.createGraphics3DGraphic=function(e,i,t){if(!this.graphics[i.uid]){var a=e.createGraphics3DGraphic(i,t);this.labeling&&this.labeling.layerLabelsEnabled()&&this.labeling.createLabelsForGraphic(i,a),this.graphics[i.uid]=a,this.graphicsKeys=null,this.graphicsBySymbol[e.symbol.id][i.uid]=a,a.initialize(this.stageLayer,this.stage);var r=a.isDraped();r&&(this.graphicsDrapedIds[i.uid]=!0,this.hasDraped=!0,this.layerView._notifyDrapedDataChange()),a.centroid=null,"point"!==i.geometry.type&&a instanceof v&&(a.centroid=C.computeCentroid(i.geometry,this.viewSR));var s=this.scaleVisibility&&this.scaleVisibility.scaleRangeActive();this.spatialIndex&&this.spatialIndex.shouldAddToSpatialIndex(i,a,s)&&this.spatialIndex.addGraphicToSpatialIndex(i,a),s&&this.scaleVisibility.updateGraphicScaleVisibility(i,a),a.setVisibilityFlag(U,i.visible&&!this.layerView.suspended);var n=this.whenGraphics3DGraphicRequests[i.uid];n&&(n.resolve(a),delete this.whenGraphics3DGraphicRequests[i.uid])}},e.prototype.rendererChange=function(e){var i=this.symbolCreationContext.renderer;this.validateRenderer(e),this.symbolCreationContext.renderer=e;var t=h.diff(i,e);if(!t)return void(F&&T.warn("Renderer change: no diff, change ignored"));if("complete"===t.type)F&&T.warn("Renderer change: complete diff, recreating all graphics"),this.recreateAllGraphics();else if("partial"===t.type){if(!this.applyRendererDiff(t,e))return F&&T.warn("Renderer change: could not apply partial diff, recreating all graphics"),void this.recreateAllGraphics();F&&T.warn("Renderer change: applied partial diff (fast update)"),this.volatileGraphicsUpdated()}},e.prototype.diffHasSymbolChange=function(e){for(var i in e.diff)switch(i){case"visualVariables":break;default:return!0}return!1},e.prototype.applyRendererDiff=function(e,i){var t=!1;if(this.diffHasSymbolChange(e))return F&&T.warn("Could not apply renderer diff - diff could lead to graphics changing symbols"),!1;for(var a in this.graphicsBySymbol){var r=this.symbols[a];if(r){var s=this.graphicsBySymbol[a];if(!r.applyRendererDiff(e,i,s))return!1;if(!t)for(var n in s)if(s[n].isDraped()){this.layerView._notifyDrapedDataChange(),t=!0;break}}}return!0},e.prototype.opacityChange=function(){var e=!1;for(var i in this.graphicsBySymbol){var t=this.symbols[i];if(t){var a=this.graphicsBySymbol[i];if(t.layerPropertyChanged("opacity"),!e)for(var r in a)if(a[r].isDraped()){this.layerView._notifyDrapedDataChange(),e=!0;break}}}},e.prototype.setClippingExtent=function(e,i){var t=this.symbolCreationContext.clippingExtent,r=[];return l.extentToBoundingRect(e,r,i)?this.symbolCreationContext.clippingExtent=[r[0],r[1],-(1/0),r[2],r[3],1/0]:this.symbolCreationContext.clippingExtent=null,!a.equals(this.symbolCreationContext.clippingExtent,t)},e.prototype.updateAllGraphicsVisibility=function(){var e=this;if(this.layerView.loadedGraphics){var i=!1;this.layerView.loadedGraphics.forEach(function(t){var a=e.getGraphics3DGraphicById(t.uid);if(a){var r=a.setVisibilityFlag(U,t.visible);if(e.scaleVisibility){var s=e.scaleVisibility.updateGraphicScaleVisibility(t,a);r=r||s}r&&a.isDraped()&&(i=!0)}}),i&&this.layerView._notifyDrapedDataChange(),this.layerView.view.labelManager.setDirty()}},e.prototype.hideAllGraphics=function(){var e=this;if(this.layerView.loadedGraphics){var i=!1;this.layerView.loadedGraphics.forEach(function(t){var a=e.getGraphics3DGraphicById(t.uid);if(a){var r=a.setVisibilityFlag(U,!1);r&&a.isDraped()&&(i=!0)}}),i&&this.layerView._notifyDrapedDataChange(),this.layerView.view.labelManager.setDirty()}},e.prototype.validateRenderer=function(e){var i=o.validateTo3D(e);if(i){var t="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";T.warn(t,i.message)}},e.prototype.volatileGraphicsUpdated=function(){this.labeling&&(this.lastFastUpdate=performance.now()),this.stageLayer.invalidateSpatialQueryAccelerator(),this.layerView._evaluateUpdatingState()},e.createLocalOriginFactory=function(){return new g(5e6,16)},e.tmpVec=m.vec3d.create(),e}();return O});