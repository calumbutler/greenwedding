// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../../core/declare","../../../../core/screenUtils","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./lineUtils","./graphicUtils","../../../../geometry/Polygon","../../../../Color","../../lib/glMatrix","../../support/aaBoundingBox","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/ColorMaterial","../../webgl-engine/lib/Util","./earcut/earcut"],function(e,t,i,r,a,n,o,l,s,u,h,c,_,g,d,p,m,y,v,f,O){var x=f.VertexAttrConstants,E=c.vec3d,M=c.mat4d,D=e([i],{_prepareResources:function(){this._prepareFillResources(),this._prepareOutlineResources(),this.resolve()},_prepareFillResources:function(){var e=this._getStageIdHint(),t=this._getMaterialOpacityAndColor(),i={color:t,transparent:t[3]<1||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0};this._material=new v(i,e+"_colormat"),this._context.stage.add(g.ModelContentType.MATERIAL,this._material)},_prepareOutlineResources:function(){var e=this.symbol.outline;if(this._hasOutline=!!(e&&e.size&&e.color),this._hasOutline){var i={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:t.pt2px(this.symbol.outline.size)};i.width>2?(this._outlineMaterial=l.createRibbonMaterial(i),this._isOutlineNativeLineMaterial=!1):(this._outlineMaterial=l.createNativeMaterial(i),this._isOutlineNativeLineMaterial=!0),this._context.stage.add(g.ModelContentType.MATERIAL,this._outlineMaterial)}},destroy:function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(g.ModelContentType.MATERIAL,this._material.getId()),this._material=null),this._outlineMaterial&&(this._context.stage.remove(g.ModelContentType.MATERIAL,this._outlineMaterial.getId()),this._outlineMaterial=null)},createGraphics3DGraphic:function(e,t){var i=e.geometry;if("polyline"!==i.type&&"polygon"!==i.type&&"extent"!==i.type)return this._logWarning("unsupported geometry type for fill symbol: "+i.type),null;var r="graphic"+e.uid,a=this._getVertexOpacityAndColor(t,Uint8Array,255),n=this._getGraphicElevationInfo(e);return n.mode===o.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(e,a,n,r):this._createAs3DShape(e,a,n,r,e.uid)},layerPropertyChanged:function(e,t,i){if("opacity"===e){var r=this._material.getColor();if(r[3]=this._getMaterialOpacity(),this._material.setColor(r),this._material.setTransparent(r[3]<1),this._outlineMaterial)if(this._isOutlineNativeLineMaterial){var a=this._outlineMaterial.getColor();a[3]=this._getOutlineOpacity(),this._outlineMaterial.setColor(a)}else{var l=this._outlineMaterial.getParameterValues();l.color[3]=this._getOutlineOpacity(),this._outlineMaterial.setParameterValues({color:l.color})}return!0}if("elevationInfo"===e){var s=this._elevationInfo.mode;this._updateElevationInfo();var u=this._elevationInfo.mode;if(null==s||null==u)return!1;var h=o.ELEV_MODES;if(s===h.ON_THE_GROUND&&u===h.ON_THE_GROUND)return!0;if(s!==u&&(s===h.ON_THE_GROUND||u===h.ON_THE_GROUND))return!1;var c=u===h.RELATIVE_TO_GROUND?n.perVertexElevationAligner:null,_=this._context.elevationProvider,g=this._context.renderCoordsHelper;for(var d in t){var p=t[d],m=p._graphics[i];if(m){var y=p.graphic;m.elevationAligner=c,m.elevationInfo.set(this._getGraphicElevationInfo(y)),n.perVertexElevationAligner(m,_,g)}}return!0}return!1},setDrawOrder:function(e,t,i){this._material&&(this._material.setRenderPriority(e+t/2),i[this._material.getId()]=!0),this._outlineMaterial&&(this._outlineMaterial.setRenderPriority(e),i[this._outlineMaterial.getId()]=!0)},_createAs3DShape:function(e,t,i,a,l){var s,u=this._getPolyGeometry(e),h=u.hasZ,c=!1;if(null!=u.rings?(c=!0,s=u.rings):s=u.paths,0===s.length)return this._logWarning("no paths found for line symbol"),null;var _=this._getOutlineGeometry(u,s),g=o.getGeometryVertexData3D(_,h,u.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,i);A.idHint=a,A.color=t,A.isRings=c,A.data=g;var p;if(this._hasOutline&&(p=new g.vertexData.constructor(g.vertexData)),A.outNum=0,A.outGeometries=[],A.outTransforms=[],A.outMaterials=[],this._createAs3DShapeFill(A),A.data.vertexData=p,this._createAs3DShapeOutline(A),0===A.outNum)return null;var m=this._context.layer.id,y=new d({geometries:A.outGeometries,materials:A.outMaterials,transformations:A.outTransforms,castShadow:!1,metadata:{layerId:m,graphicId:l},idHint:a}),v=null;return i.mode===o.ELEV_MODES.RELATIVE_TO_GROUND&&(v=n.perVertexElevationAligner),new r(this,y,A.outGeometries,null,null,v,i)},_createAs3DShapeFill:function(e){for(var t=e.data.geometryData.polygons,i=e.data.eleVertexData,r=e.data.vertexData,a=0;a<t.length;++a){var n=t[a],l=n.count,s=n.index;if(!this._context.clippingExtent||(o.computeBoundingBox(i,s,l,G),!o.boundingBoxClipped(G,this._context.clippingExtent))){var u=new Float64Array(i.buffer,3*s*i.BYTES_PER_ELEMENT,3*l),h=new Float64Array(r.buffer,3*s*r.BYTES_PER_ELEMENT,3*l),c=n.holeIndices.map(function(e){return e-s}),_=O(u,c,3);if(0!==_.length){o.chooseOrigin(r,s,l,R),o.subtractCoordinates(r,s,l,R);var g=this._createFillGeometry(_,0,h,u,e.color,!1),d=new p(g,e.idHint);d.singleUse=!0;var m=M.identity();M.translate(m,R,m),e.outGeometries.push(d),e.outMaterials.push([this._material]),e.outTransforms.push(m),e.outNum++}}}},_createAs3DShapeOutline:function(e){if(this._hasOutline)for(var t=e.data.geometryData.outlines,i=e.data.eleVertexData,r=e.data.vertexData,a=0;a<t.length;++a){var n=t[a],s=n.index,u=n.count;if(!this._context.clippingExtent||(o.computeBoundingBox(i,s,u,G),!o.boundingBoxClipped(G,this._context.clippingExtent))){o.chooseOrigin(r,s,u,R),o.subtractCoordinates(r,s,u,R);var h=new Float64Array(i.buffer,3*s*i.BYTES_PER_ELEMENT,3*u),c=new Float64Array(r.buffer,3*s*r.BYTES_PER_ELEMENT,3*u),_=l.createPolylineGeometry(c,h,e.isRings,b,0,!1),g=new p(_,e.idHint+"outline"+a);g.singleUse=!0;var d=M.identity();M.translate(d,R,d),e.outGeometries.push(g),e.outMaterials.push([this._outlineMaterial]),e.outTransforms.push(d),e.outNum++}}},_createAsOverlay:function(e,t,i,r){var n,l=this._getPolyGeometry(e),s=!1;null!=l.rings?(s=!0,n=l.rings):n=l.paths;var u=this._getOutlineGeometry(l,n);if(0===u.length)return null;this._material.setRenderPriority(this._symbolLayerOrder+this._symbolLayerOrderDelta/2),this._hasOutline&&this._outlineMaterial.setRenderPriority(this._symbolLayerOrder);var h=o.getGeometryVertexDataDraped(u,l.spatialReference,this._context.overlaySR);A.idHint=r,A.color=t,A.isRings=s,A.data=h;var c;return this._hasOutline&&(c=new h.vertexData.constructor(h.vertexData)),A.outNum=0,A.outGeometries=[],A.outBoundingBox=_.create(_.NEGATIVE_INFINITY),this._createAsOverlayFill(A),A.data.vertexData=c,this._createAsOverlayOutline(A),A.outNum>0?new a(this,A.outGeometries,null,null,A.outBoundingBox):null},_createAsOverlayFill:function(e){for(var t=e.data.vertexData,i=e.data.geometryData.polygons,r=0;r<i.length;++r){var a=i[r],n=a.count,l=a.index,s=new Float64Array(t.buffer,3*l*t.BYTES_PER_ELEMENT,3*n),u=a.holeIndices.map(function(e){return e-l}),h=O(s,u,3);if(0!==h.length&&(o.computeBoundingBox(t,l,n,G),!o.boundingBoxClipped(G,this._context.clippingExtent))){_.expand(e.outBoundingBox,G),o.chooseOrigin(t,l,n,R),o.subtractCoordinates(t,l,n,R),o.setZ(t,l,n,this._getDrapedZ());var c=M.identity();M.translate(c,R,c);var g=this._createFillGeometry(h,l,t,null,e.color,!0),d=new y(g);d.material=this._material;var p=G;d.center=[.5*(p[0]+p[3]),.5*(p[1]+p[4]),0],d.bsRadius=.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1])),d.transformation=c,d.name=e.idHint,d.uniqueName=e.idHint+"#"+g.id,e.outGeometries.push(d),e.outNum++}}},_createAsOverlayOutline:function(e){if(this._hasOutline)for(var t=e.data.vertexData,i=e.data.geometryData.outlines,r=0;r<i.length;++r){var a=i[r],n=a.index,s=a.count;if(o.computeBoundingBox(t,n,s,G),!o.boundingBoxClipped(G,this._context.clippingExtent)){_.expand(e.outBoundingBox,G),o.chooseOrigin(t,n,s,R),o.subtractCoordinates(t,n,s,R),o.setZ(t,n,s,this._getDrapedZ());var u=new Float64Array(t.buffer,3*n*t.BYTES_PER_ELEMENT,3*s),h=M.identity();M.translate(h,R,h);var c=l.createPolylineGeometry(u,null,e.isRings,b,0,!0),g=new y(c);g.material=this._outlineMaterial;var d=G;g.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0],g.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1])),g.transformation=h,g.name=e.idHint+"outline",g.uniqueName=e.idHint+"outline#"+c.id,e.outGeometries.push(g),e.outNum++}}},_getOutlineGeometry:function(e,t){return e._outlineSegments?l.createOutlineGeometryFromSegments(t,e._outlineSegments):t},_getOutlineOpacity:function(){var e=this._getLayerOpacity(),t=this.symbol.outline.color;return e*t.a},_getOutlineColor:function(){var e=this.symbol.outline.color,t=this._getOutlineOpacity();return s.mixinColorAndOpacity(h.toUnitRGB(e),t)},_getPolyGeometry:function(e){var t=e.geometry;return"extent"===t.type&&(t=u.fromExtent(t)),t},_createFillGeometry:function(e,t,i,r,a,n){for(var o=e.length,l=new Uint32Array(o),s=new Uint32Array(o),u=0;o>u;u++)l[u]=e[u]+t,s[u]=0;var h={},c={};h[x.POSITION]=l,h[x.COLOR]=s,c[x.POSITION]={size:3,data:i},c[x.COLOR]={size:4,data:a},r&&(c.mapPos={size:3,data:r},h.mapPos=l);var _=[{type:"triangle",indices:h,positionKey:x.POSITION}];return n?{faces:_[0],vertexAttr:c,id:m.getNewId().toString()}:new m(_,c)}}),G=_.create(),R=E.create(),b=new Float32Array([255,255,255,255]),A={idHint:null,color:null,isRings:!1,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return D});