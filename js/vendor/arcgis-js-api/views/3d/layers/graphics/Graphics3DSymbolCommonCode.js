// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../../geometry/Point","../../../../geometry/support/mathUtils","./graphicUtils","./ElevationInfo","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/lib/Object3D"],function(e,t,n,r,o,a,i){var c=a.mat4d,l=a.vec3d.create(),u=c.identity(),f={x:0,y:0,z:0,spatialReference:null},s={createStageObjectForPoint:function(e,t,n,r,o,a,c,f,v,p,g){var h=t?t.length:0,D=this._context.clippingExtent;if(s.reprojectPoint(e,l,this._context.elevationProvider.spatialReference),D&&!s.pointInBox2D(l,D))return null;s.reprojectPoint(e,l,this._context.renderSpatialReference);var E=this._context.localOriginFactory.getOrigin(l);p=void 0===p?!1:p;for(var d=new i({castShadow:!1,metadata:{layerId:f,graphicId:v,usesVerticalDistanceToGround:p},idHint:c}),y=0;h>y;y++){var x=r?r[y]:u;d.addGeometry(t[y],n[y],x,o,E,g)}return s.setObjectElevation(d,e,a,this._context.renderSpatialReference,this._context.elevationProvider),d},extendPointGraphicElevationInfo:function(e,t,n){var r=e.elevationInfo,o=n.spatialReference;s.reprojectPoint(t,l,o),r.centerPointInElevationSR={x:l[0],y:l[1],z:t.hasZ?l[2]:void 0,spatialReference:o}},placePointOnPolyline:function(n){var r=n.paths[0],o=t.getPointOnPath(r,t.getPathLength(r)/2);return new e(o[0],o[1],o[2],n.spatialReference)},placePointOnPolygon:function(e){return n.computeCentroid(e)},computeElevation:function(e,t,n,o){var a=0,i=t.z||0,c=0,l=n.mode,u=n.offset||0;return l===r.MODES.ON_THE_GROUND?(c=e.getElevation(t)||0,a=c,o&&(o.verticalDistanceToGround=0)):l===r.MODES.RELATIVE_TO_GROUND?(c=e.getElevation(t)||0,a=u,null==n.featureExpression&&(a+=i),o&&(o.verticalDistanceToGround=a),a+=c):l===r.MODES.ABSOLUTE_HEIGHT&&(a=i+u,o&&(c=e.getElevation(t)||0,o.verticalDistanceToGround=a-c)),a},applyElevation:function(e,t,n,o,a,i,c){var l=c.mode,u=c.offset,s=0,v=0;f.spatialReference=e.spatialReference,n*=3,a*=3;for(var p=0;i>p;++p)f.x=t[n+0],f.y=t[n+1],f.z=t[n+2],l===r.MODES.ON_THE_GROUND?(s=e.getElevation(f)||0,v=s):l===r.MODES.RELATIVE_TO_GROUND?(s=e.getElevation(f)||0,v=s+u,null==c.featureExpression&&(v+=f.z)):l===r.MODES.ABSOLUTE_HEIGHT&&(v=f.z+u),o[a+0]=t[n+0],o[a+1]=t[n+1],o[a+2]=v,n+=3,a+=3},setObjectElevation:function(e,t,r,a,i){var c=0;if(e.metadata.usesVerticalDistanceToGround){var u={verticalDistanceToGround:0};c=s.computeElevation(i,t,r,u),n.updateVertexAttributeAuxpos1w(e,u.verticalDistanceToGround)}else c=s.computeElevation(i,t,r);var f=e.getObjectTransformation();l[0]=t.x,l[1]=t.y,l[2]=c,o.computeLinearTransformation(t.spatialReference,l,f,a)?e.setObjectTransformation(f):console.warn("Could not locate symbol object properly, it might be misplaced")},getSingleSizeDriver:function(e){return isFinite(e[0])?e[0]:null},isCounterClockwise:function(e){for(var t=0,n=e.length-1,r=0;n>r;r++)t+=e[r][0]*e[r+1][1]-e[r+1][0]*e[r][1];return t>=0},copyPointData:function(e,t,n,r,o,a){r*=3;for(var i=0;o>i;++i){var c=e[t++];n[r++]=c[0],n[r++]=c[1],n[r++]=a?c[2]:0}return r/3},copyPathData:function(e,t){for(var n=e.length,r=new Array(n),o=new Array(n),a=new Array(n),i=0,c=0,l=0,u=0,f=0;n>f;++f)u+=e[f].length;for(var v=new Float64Array(3*u),p=0,g=n-1;g>=0;g--){var h=e[g];if(s.isCounterClockwise(h))r[i++]=h;else{var D=h.length;for(f=0;i>f;++f)D+=r[f].length;var E={index:p,pathLengths:new Array(i+1),count:D,holeIndices:new Array(i)};E.pathLengths[0]=h.length,h.length>0&&(a[l++]={index:p,count:h.length}),p=s.copyPointData(h,0,v,p,h.length,t);for(var d=0;i>d;++d){var y=r[d];E.holeIndices[d]=p,E.pathLengths[d+1]=y.length,y.length>0&&(a[l++]={index:p,count:y.length}),p=s.copyPointData(y,0,v,p,y.length,t)}i=0,E.count>0&&(o[c++]=E)}}for(d=0;i>d;++d)y=r[d],y.length>0&&(a[l++]={index:p,count:y.length}),p=s.copyPointData(y,0,v,p,y.length,t);return n>c&&(o.length=c),n>l&&(a.length=l),{vertexData:v,polygons:o,outlines:a}},copyVertices:function(e,t,n,r,o){t*=3,r*=3;for(var a=0;o>a;++a)n[r++]=e[t++],n[r++]=e[t++],n[r++]=e[t++]},chooseOrigin:function(e,t,n,r){var o=Math.floor(t+(n-1)/2);r[0]=e[3*o+0],r[1]=e[3*o+1],r[2]=e[3*o+2]},subtractCoordinates:function(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t++]-=r[0],e[t++]-=r[1],e[t++]-=r[2]},setZ:function(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t+2]=r,t+=3},offsetZ:function(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t+2]+=r,t+=3},scaleZ:function(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t+2]*=r,t+=3},flatArrayToArrayOfArrays:function(e,t,n){var r=[];t*=3;for(var o=0;n>o;++o)r.push([e[t++],e[t++],e[t++]]);return r},reproject:function(e,t,n,r,a,i,c){o.bufferToBuffer(e,n,t,r,i,a,c)},reprojectPoint:function(e,t,n){o.pointToVector(e,t,n)},getGeometryVertexData3D:function(e,t,n,r,o,a){var i=o.spatialReference,c=s.copyPathData(e,t),l=c.vertexData,u=l.length/3,f=new Float64Array(l.length);return n.equals(i)?s.copyVertices(l,0,f,0,l.length):s.reproject(l,0,n,f,0,i,u),s.applyElevation(o,f,0,l,0,u,a),i.equals(r)||s.reproject(l,0,i,l,0,r,u),{geometryData:c,vertexData:l,eleVertexData:f}},getGeometryVertexDataDraped:function(e,t,n){var r=s.copyPathData(e,!1),a=r.vertexData,i=a.length/3;return t.equals(n)||o.bufferToBuffer(a,t,0,a,n,0,i),{geometryData:r,vertexData:a}},computeBoundingBox:function(e,t,n,r){r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE,r[3]=-Number.MAX_VALUE,r[4]=-Number.MAX_VALUE,r[5]=-Number.MAX_VALUE,t*=3;for(var o=0;n>o;++o){var a=e[t++],i=e[t++],c=e[t++];a<r[0]&&(r[0]=a),i<r[1]&&(r[1]=i),c<r[2]&&(r[2]=c),a>r[3]&&(r[3]=a),i>r[4]&&(r[4]=i),c>r[5]&&(r[5]=c)}return r},pointInBox2D:function(e,t){return!(e[0]>t[3]||e[0]<t[0]||e[1]>t[4]||e[1]<t[1])},boxesIntersect2D:function(e,t){return!(t[0]>e[3]||t[3]<e[0]||t[1]>e[4]||t[4]<e[1])},boundingBoxClipped:function(e,t){return t?!s.boxesIntersect2D(e,t):!1},ELEV_MODES:r.MODES};return s});