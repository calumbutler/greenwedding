// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../../core/declare","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DSymbolCommonCode","../../../../geometry/Polygon","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/materials/Material","../../webgl-engine/lib/Util","./earcut/earcut"],function(e,t,r,a,n,i,o,s,l,c,h,p,g,u){function d(e,t,r,a,n,i,o,s,l,c,h,p,g,u){var d=r.length/3,f=0,_=!0;_&&(h+=2*a.count),y(e,t,a.index,a.count,r,0,d,n,i,o,s,l,c,h,p,g,u),l+=2*a.count,h+=2*d,_&&(h-=2*a.count+2*d),v(n,i,s,o,f,a.pathLengths[0],a.count,l,c,h,p),l+=4*a.pathLengths[0],h+=2*a.pathLengths[0],f+=a.pathLengths[0];for(var m=1;m<a.pathLengths.length;++m)v(n,i,s,o,f,a.pathLengths[m],a.count,l,c,h,p),l+=4*a.pathLengths[m],h+=2*a.pathLengths[m],f+=a.pathLengths[m]}function y(e,t,r,a,n,i,o,s,l,c,h,p,g,u,d,y,f){E.set(y,A);for(var v=d>0?1:-1,_=3*r,m=p,x=3*m,b=p+a,w=3*b,L=0;a>L;++L)f&&(A[0]=e[_+0],A[1]=e[_+1],A[2]=e[_+2],E.normalize(A)),s[x+0]=e[_+0],s[x+1]=e[_+1],s[x+2]=e[_+2],l[x+0]=t[_+0],l[x+1]=t[_+1],l[x+2]=t[_+2],c[x+0]=-v*A[0],c[x+1]=-v*A[1],c[x+2]=-v*A[2],h[m]=0,s[w+0]=e[_+0]+d*A[0],s[w+1]=e[_+1]+d*A[1],s[w+2]=e[_+2]+d*A[2],l[w+0]=t[_+0],l[w+1]=t[_+1],l[w+2]=t[_+2],c[w+0]=v*A[0],c[w+1]=v*A[1],c[w+2]=v*A[2],h[b]=d,x+=3,w+=3,_+=3,m+=1,b+=1;_=3*i,x=3*u,w=3*(u+o);var O=!1;O===!1&&(x=3*(u+o),w=3*u);var M=S,T=I;for(0>d&&(M=I,T=S),L=0;o>L;++L)g[x+0]=n[_+M[0]],g[x+1]=n[_+M[1]],g[x+2]=n[_+M[2]],g[w+0]=n[_+T[0]]+a,g[w+1]=n[_+T[1]]+a,g[w+2]=n[_+T[2]]+a,x+=3,w+=3,_+=3}function f(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function v(e,t,r,a,n,i,o,s,l,c,h){var p=n,g=n+1,u=n+o,d=n+o+1,y=s,v=s+1,m=s+2*i,E=s+2*i+1;0>h&&(p=n+o+1,d=n),c*=3;for(var x=0;i>x;++x)x===i-1&&(h>0?(g=n,d=n+o):(g=n,p=n+o)),_(e,p,g,u,O),f(e,t,a,r,O,y,p),f(e,t,a,r,O,v,g),f(e,t,a,r,O,m,u),f(e,t,a,r,O,E,d),l[c++]=y,l[c++]=m,l[c++]=E,l[c++]=y,l[c++]=E,l[c++]=v,p++,g++,u++,d++,y+=2,v+=2,m+=2,E+=2}function _(e,t,r,a,n){t*=3,r*=3,a*=3,E.set3(e[t++],e[t++],e[t++],M),E.set3(e[r++],e[r++],e[r++],T),E.set3(e[a++],e[a++],e[a++],P),E.subtract(T,M,D),E.subtract(P,M,R),E.cross(R,D,n),E.normalize(n,n)}var m=g.VertexAttrConstants,E=o.vec3d,x=o.mat4d,b=E.create(),A=E.create(),S=[0,2,1],I=[0,1,2],w={},L=e([t],{_prepareResources:function(){var e=this._getStageIdHint(),t=this._getMaterialOpacityAndColor(),r=E.create(t),a=t[3],n={diffuse:r,ambient:r,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new p(n,e+"_3dlinemat"),this._context.stage.add(s.ModelContentType.MATERIAL,this._material),this.resolve()},destroy:function(){this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(s.ModelContentType.MATERIAL,this._material.getId())},createGraphics3DGraphic:function(e,t){var r=e.geometry;if("polygon"!==r.type&&"extent"!==r.type)return this._logWarning("unsupported geometry type for extrude symbol: "+r.type),null;var a="polygon"===r.type||"extent"===r.type?"rings":"paths",n="graphic"+e.uid,i=this._getVertexOpacityAndColor(t,Float32Array,255),o=this._getGraphicElevationInfo(e);return this._createAs3DShape(e,a,t,i,o,n,e.uid)},layerPropertyChanged:function(e,t,r){if("opacity"===e){var n=this._getMaterialOpacity(),i=1>n||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:n,transparent:i}),!0}if("elevationInfo"===e){this._updateElevationInfo();var o=this._context.elevationProvider,s=this._context.renderCoordsHelper,l=a.ELEV_MODES.ABSOLUTE_HEIGHT;for(var c in t){var h=t[c],p=h._graphics[r];if(p){var g=h.graphic,u=this._getGraphicElevationInfo(g);p.elevationAligner=u.mode!==l?G:null,p.elevationInfo.set(u),G(p,o,s)}}return!0}return!1},_getExtrusionSize:function(e,t){var r=e.size&&this._isPropertyDriven("size")?a.getSingleSizeDriver(e.size):this.symbol.size||1;return r/=this._context.renderCoordsHelper.unitInMeters},_createAs3DShape:function(e,t,o,s,h,p,g){var y=e.geometry;"extent"===y.type&&(y=n.fromExtent(y));var f=y[t],v=y.hasZ,_=f.length;if(_>0){var m=[],b=[],A=[],S=E.create(),I=new Array(6),w=this._context.renderSpatialReference===i.SphericalRenderSpatialReference,L=this._getExtrusionSize(o,this.symbol.size),O=E.create();w||this._context.renderCoordsHelper.worldUpAtPosition(null,O);for(var M=a.getGeometryVertexData3D(f,v,y.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,h),T=M.geometryData.polygons,P=M.eleVertexData,D=M.vertexData,R=D.length/3,z=new Float64Array(3*R*6),C=new Float64Array(3*R*6),N=new Float64Array(3*R*6),B=new Float64Array(1*R*6),F=0,H=0;H<T.length;++H){var U=T[H],V=U.count,Y=U.index;if(!this._context.clippingExtent||(a.computeBoundingBox(P,Y,V,I),!a.boundingBoxClipped(I,this._context.clippingExtent))){var j=new Float64Array(P.buffer,3*Y*z.BYTES_PER_ELEMENT,3*V),Z=U.holeIndices.map(function(e){return e-Y}),W=u(j,Z,3);if(W.length>0){a.chooseOrigin(D,Y,V,S);var K=3*V*2+2*W.length,k=new Uint32Array(K),q=6*V,J=new Float64Array(z.buffer,3*F*z.BYTES_PER_ELEMENT,3*q),Q=new Float64Array(C.buffer,3*F*C.BYTES_PER_ELEMENT,3*q),X=new Float64Array(N.buffer,3*F*N.BYTES_PER_ELEMENT,3*q),$=new Float64Array(B.buffer,1*F*B.BYTES_PER_ELEMENT,1*q);d(D,P,W,U,J,X,Q,$,0,k,0,L,O,w),a.subtractCoordinates(J,0,q,S),F+=6*V;var ee=this._createExtrudeGeometry(k,{positions:J,elevation:X,normals:Q,heights:$},s,!1),te=new c(ee,p+"path"+H);te.singleUse=!0,m.push(te),b.push([this._material]);var re=x.identity();x.translate(re,S,re),A.push(re)}}}if(m.length>0){var ae=this._context.layer.id,ne=new l({geometries:m,materials:b,transformations:A,castShadow:!0,metadata:{layerId:ae,graphicId:g},idHint:p}),ie=null;return h.mode!==a.ELEV_MODES.ABSOLUTE_HEIGHT&&(ie=G),new r(this,ne,m,null,null,ie,h)}return null}return this._logWarning("no paths found for extrusion symbol"),null},_createExtrudeGeometry:function(e,t,r,a){for(var n=e.length,i=e,o=new Uint32Array(n),s=0;n>s;s++)o[s]=0;var l={},c={};l[m.POSITION]=i,l[m.NORMAL]=i,l[m.COLOR]=o,c[m.POSITION]={size:3,data:t.positions},c[m.NORMAL]={size:3,data:t.normals},c[m.COLOR]={size:4,data:r},c[m.SIZE]={size:1,data:t.heights},t.elevation&&(c.mapPos={size:3,data:t.elevation},l.mapPos=i);var p=[{type:"triangle",indices:l,positionKey:m.POSITION}];return a?{faces:p[0],vertexAttr:c,id:h.getNewId().toString()}:new h(p,c)}}),O=E.create(),M=E.create(),T=E.create(),P=E.create(),D=E.create(),R=E.create(),z=E.create(),C=E.create(),G=function(e,t,r){var n=e.stageObject,i=e.elevationInfo,o=r.setAltitude;w.spatialReference=t.spatialReference;for(var s=n.getGeometryRecords(),l=s.length,c=0;l>c;c++){var h=s[c].geometry,p=s[c].transformation;C[0]=p[12],C[1]=p[13],C[2]=p[14],h.invalidateBoundingInfo();for(var g=h.getData().getVertexAttr(),u=g[m.POSITION].data,d=g[m.SIZE].data,y=g.mapPos.data,f=u.length/3,v=0,_=0,E=!1,x=0;f>x;x++){w.x=y[_],w.y=y[_+1],w.z=y[_+2],z[0]=u[v],z[1]=u[v+1],z[2]=u[v+2];var A=a.computeElevation(t,w,i);b[0]=u[v]+C[0],b[1]=u[v+1]+C[1],b[2]=u[v+2]+C[2],o(A+d[v/3],b,0),u[v]=b[0]-C[0],u[v+1]=b[1]-C[1],u[v+2]=b[2]-C[2];var S=.01/r.unitInMeters;(Math.abs(z[0]-u[v])>S||Math.abs(z[1]-u[v+1])>S||Math.abs(z[2]-u[v+2])>S)&&(E=!0),_+=3,v+=3}E&&n.geometryVertexAttrsUpdated(c)}};return L});