// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../lib/glMatrix","../../support/earthUtils","../../support/projectionUtils","../../../../core/requireUtils","../../../../core/promiseUtils","../../../../core/Error","../../../../core/urlUtils","../../../../geometry/support/webMercatorUtils","dojo/_base/lang","dojo/promise/all","../../../../request","../../../../geometry/SpatialReference","../../webgl-engine/Stage","../../webgl-engine/materials/Material","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Layer","../../webgl-engine/lib/Util","./I3SBinaryReader"],function(e,r,t,n,a,i,o,s,l,u,d,c,f,p,g,h,m,v,b,y,w,R){function T(e){return"/"!==e[e.length-1]&&(e+="/"),e}function S(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function M(e){var r=new p(S(e.store.indexCRS||e.store.geographicCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function C(e){var r=new p(S(e.store.vertexCRS||e.store.projectedCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function I(e,r,t){var n=M(e),a=C(e);E(n,r,t),E(a,r,t)}function E(e,r,t){if(!u.canProject(e,r))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===t&&e.isGeographic)throw new s("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function O(e,r,t){switch(r){case"none":G(e);break;case"east-north-up":break;case"earth-centered":var n=a.SphericalRenderSpatialReference;t(e.normals,n);break;case"vertex-reference-frame":break;default:throw new Error("Received unexpected normalReferenceFrame: "+r)}}function G(e){var r=e.normals,t=e.positions,n=e.normalInd,a=e.positionInd;Y(e.normalInd.length===e.positionInd.length);for(var i=W.create(),o=W.create(),s=0;s<a.length;s+=3){var l=3*a[s],u=t[l],d=t[l+1],c=t[l+2];l=3*a[s+1],i[0]=t[l]-u,i[1]=t[l+1]-d,i[2]=t[l+2]-c,l=3*a[s+2],o[0]=t[l]-u,o[1]=t[l+1]-d,o[2]=t[l+2]-c,W.cross(i,o,i),W.normalize(i);for(var f=0;3>f;f++){var p=3*n[s+f];r[p]=i[0],r[p+1]=i[1],r[p+2]=i[2]}}}function x(e,t){if(Array.isArray(e)){if(t){var n=e.indexOf(r.DDS_ENCODING_STRING);if(n>-1)return n}for(var a=0;a<e.length;a++)if(r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[a])>-1)return a;throw new Error("Could not find appropriate texture encoding (among "+e.toString()+")")}return-1}function A(e,r,t,n,i,o){if(null!=t){var s=H;if(a.mbsToMbs(t.mbs,n,s,r),0!==_(e,s)){o.push(t);for(var l=null!=t.children?t.children.length:0,u=0;l>u;u++){var d=i[t.children[u].id];A(e,r,d,n,i,o)}}}}function _(e,r){var t=r[0],n=r[1],a=r[2],i=r[3],o=0;if(t<e[0]){var s=e[0]-t;o+=s*s}if(n<e[1]){var s=e[1]-n;o+=s*s}if(a<e[2]){var s=e[2]-a;o+=s*s}if(t>e[3]){var s=t-e[3];o+=s*s}if(n>e[4]){var s=n-e[4];o+=s*s}if(a>e[5]){var s=a-e[5];o+=s*s}if(o>i*i)return 0;if(o>0)return 1;var l=1/0;return t-e[0]<l&&(l=t-e[0]),n-e[1]<l&&(l=n-e[1]),a-e[2]<l&&(l=a-e[2]),e[3]-t<l&&(l=e[3]-t),e[4]-n<l&&(l=e[4]-n),e[5]-a<l&&(l=e[5]-a),l>i?2:1}function j(e,r,t){function i(e){return{ambient:e,diffuse:[0,0,0],transparent:!0,opacity:.5,blendModeOneOne:!1}}var o=new m(v.createCylinderGeometry(1,1,64,[0,0,1],[0,0,0],!1),"debugCylinder"),s=new m(v.createSphereGeometry(1),"debugSphere"),l={red:new h(i([.8,0,0]),"debugMaterialRed"),grey:new h(i([.4,.4,.4]),"debugMaterialGrey"),brown:new h(i([.2,.1,0]),"debugMaterialBrown"),green:new h(i([0,.8,0]),"debugMaterialGreen"),blue:new h(i([0,0,.8]),"debugMaterialBlue"),yellow:new h(i([.8,.8,0]),"debugMaterialYellow"),magenta:new h(i([.8,0,.8]),"debugMaterialMagenta")};for(var u in l)e.add(g.ModelContentType.MATERIAL,l[u]);e.add(g.ModelContentType.GEOMETRY,o);var d=new y(t+"_debug",{interaction:"IGNORED"},t+"_debug");e.add(g.ModelContentType.LAYER,d),e.addToViewContent([d.getId()]);var c=W.create(),f=V.create();return{engineLayer:d,added:{},show:function(e,t,i){var s=e.computedMbs;s||(s=F.create(),a.mbsToMbs(e.mbs,t,s,r.spatialReference));var u="node"+e.id+"dbg";W.set(s,c);var d=s[3];if(d>n.earthRadius/10&&r.spatialReference===a.SphericalRenderSpatialReference){this.showWS(c,Math.max(.01*d,1e4),i,u+"_center");var p=W.length(c),g=n.earthRadius;if(g+d>p){var h=(p*p+g*g-d*d)/(2*p);W.scale(c,h/p),d=Math.sqrt(g*g-h*h)}}V.identity(f),V.scale(f,[d,d,.05*d]);var m=l[i];Y(m);var v=new b({name:u,geometries:[o],materials:[[m]],transformations:[f],castShadow:!1,idHint:u});a.computeLinearTransformation(t,e.mbs,f,r.spatialReference),null!=c&&(f[12]=c[0],f[13]=c[1],f[14]=c[2]),v.setObjectTransformation(f),this._addToStage(v,u)},showWS:function(e,r,t,n){var a=V.identity();V.scale(a,[r,r,r]);var i=l[t];Y(i);var o=new b({name:n,geometries:[s],materials:[[i]],transformations:[a],castShadow:!1,idHint:n}),u=V.identity();V.translate(u,e),o.setObjectTransformation(u),this._addToStage(o,n)},_addToStage:function(r,t){e.add(g.ModelContentType.OBJECT,r),this.engineLayer.addObject(r);var n=this.added[t];void 0!==n&&(e.remove(g.ModelContentType.OBJECT,n.getId()),this.engineLayer.removeObject(n)),this.added[t]=r},clear:function(){for(var r in this.added){var t=this.added[r];e.remove(g.ModelContentType.OBJECT,t.getId()),this.engineLayer.removeObject(t)}this.added={}},dispose:function(){this.clear();for(var r in l)e.remove(g.ModelContentType.MATERIAL,l[r].getId());e.remove(g.ModelContentType.GEOMETRY,o.getId()),e.remove(g.ModelContentType.LAYER,this.engineLayer.getId())}}}function k(e,r,t){var n=new XMLHttpRequest;n.open("PUT","/put.php"+e,!0),n.setRequestHeader("Content-type",t),n.send(r)}function N(e,r,t,n,a){var i=n.filter(function(e){return!r.attributes.hasOwnProperty(e)});if(0===i.length)return o.resolve(r);var s=function(e){return d.mixin(r.attributes,e),r},l=e.companionFeatureLayer,u=e.attributeStorageInfo;if(l)return D(l,t,i).then(s);if(u){var c=a();if(null!=c)return L(u,c.node,c.index,i,e.token).then(s)}return o.reject()}function D(r,t,n){return void 0===n&&(n=["*"]),r?i.when(e,["../../../../tasks/support/Query","../../../../tasks/QueryTask"]).then(function(e){var a=e[0],i=e[1],o=new a({objectIds:[t],outFields:n}),s=new i(r.parsedUrl.path);return s.execute(o)}).then(function(e){return e&&e.features&&e.features.length>0?e.features[0].attributes:o.reject(new Error("Feature not found in companion feature layer."))}):o.reject(new Error("Companion feature layer not present."))}function L(e,r,t,n,a){void 0===n&&(n=["*"]);var i=n.some(function(e){return"*"===e});return c(r.attributeData.map(function(t,s){if(!i&&!n.some(function(r){return e[s].name===r}))return o.resolve(null);var u=l.makeAbsolute(t.href,r.baseUrl);return f(u,{query:{token:a},responseType:"array-buffer"}).then(function(r){return R.readBinaryAttribute(e[s],r.data)}).otherwise(function(){return null})})).then(function(r){for(var n={},a=0;a<r.length;a++)null!=r[a]&&(n[e[a].name]=r[a][t]);return n})}function U(e,r){for(var t=0,n=e.length-1;n>t;){var a=t+(n-t>>1);r>e[a]?t=a+1:n=a}return r===e[t]?t:~t}function q(e){return null==e.geometryType||"points"!==e.geometryType?!1:null!=e.topology&&"PerAttributeArray"!==e.topology?!1:null!=e.encoding&&""!==e.encoding&&"lepcc-xyz"!==e.encoding?!1:null==e.vertexAttributes||null==e.vertexAttributes.position?!1:!0}function B(e){if(null==e.store||null==e.store.defaultGeometrySchema||!q(e.store.defaultGeometrySchema))throw new s("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function P(e,r){E(e.spatialReference,r.spatialReference,r.viewingMode)}var F=t.vec4d,W=t.vec3d,V=t.mat4d,Y=w.assert,H=F.create();r.DDS_ENCODING_STRING="image/vnd-ms.dds",r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],r.addTrailingSlash=T,r.extractWkid=S,r.getIndexCrs=M,r.getVertexCrs=C,r.checkSpatialReferences=I,r.checkSpatialReference=E,r.processNormals=O,r.getAppropriateTextureEncoding=x,r.findIntersectingNodes=A,r.intersectBoundingBoxWithMbs=_,r.makeNodeDebugVisualizer=j,r.postData=k,r.whenGraphicAttributes=N,r.queryAttributesFromFeatureLayer=D,r.queryAttributesFromCachedAttributes=L,r.binaryIndexOf=U,r.checkPointCloudLayerValid=B,r.checkPointCloudCompatibleWithView=P});