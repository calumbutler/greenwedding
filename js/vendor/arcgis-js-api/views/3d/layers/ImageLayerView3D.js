// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../core/HandleRegistry","../../../core/promiseUtils","../../layers/LayerView","../../../geometry/Extent","../lib/glMatrix","../webgl-engine/Stage","../webgl-engine/lib/Texture","../webgl-engine/lib/RenderGeometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/GeometryUtil","../webgl-engine/materials/Material","../webgl-engine/lib/Util"],function(e,t,a,i,r,n,s,l,d,h,g,o){var m=o.assert,c=r.mat4d,u=o.VertexAttrConstants,p=function(){var e=new Float32Array([0,0,1]);return function(t,a,i){for(var r=[t[1]-a[1],t[3]-t[1],a[3]-t[3],123456],n=[t[0]-a[0],t[2]-t[0],a[2]-t[2],123456],s=a[2]-a[0],l=a[3]-a[1],h=n[0]>0&&n[2]>0?3:2,g=r[0]>0&&r[2]>0?3:2,o=(g+1)*(h+1),m=new Float32Array(3*o),c=new Float32Array(2*o),p=new Uint32Array(6*(g*h-1)),y=0,f=0,v=0,w=0,_=0,x=0;4>x;x++){var b=r[x];if(!(0>=b)){for(var I=0,R=0;4>R;R++){var O=n[R];0>=O||(m[f++]=a[0]+I,m[f++]=a[1]+y,m[f++]=i,c[v++]=I/s,c[v++]=y/l,3>R&&3>x&&(1!==R||1!==x)&&(p[_++]=w,p[_++]=w+1,p[_++]=w+h+1,p[_++]=w+1,p[_++]=w+h+2,p[_++]=w+h+1),w++,I+=O)}y+=b}}var S={};S[u.POSITION]={size:3,data:m},S[u.NORMAL]={size:3,data:e},S[u.UV0]={size:2,data:c};for(var E={},T=new Uint32Array(p.length),A=0;A<T.length;A++)T[A]=0;return E[u.POSITION]=p,E[u.NORMAL]=T,E[u.UV0]=p,{faces:{type:"triangle",indices:E,positionKey:u.POSITION},vertexAttr:S,id:d.getNewId().toString()}}}(),y=a.createSubclass({declaredClass:"esri.views.3d.layers.ImageLayerView3D",properties:{suspended:{dependsOn:["view.scale","layer.minScale","layer.maxScale"]}},constructor:function(){this._extents=[],this._images=[],this._handles=new e},initialize:function(){this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._handles.add(this.watch("suspended",function(e){if(e)this.clear(),this.emit("draped-data-change");else for(var t=this._extents.length,a=0;t>a;a++)this._fetch(a)}.bind(this))),this._handles.add([this.watch("fullOpacity",this._opacityChangeHandler.bind(this)),this.layer.watch("exportImageParameters.version",this._layerExportParametersChangeHandler.bind(this)),this.layer.on("redraw",this._layerRedrawHandler.bind(this))],"layer")},destroy:function(){this.clear(),this._handles.destroy()},_handles:null,_images:null,supportsDraping:!0,hasDraped:!0,drawingOrder:0,_drawingOrderSetter:function(e){var t=this._get("drawingOrder");if(e!==t){var a={};this._images.forEach(function(t){t&&t.material&&(t.material.setRenderPriority(e),a[t.material.getId()]=!0)}),o.objectEmpty(a)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(a),this.emit("draped-data-change"))}this._set("drawingOrder",e)},canResume:function(){if(!this.inherited(arguments))return!1;var e=this.layer.minScale,t=this.layer.maxScale;if(e>0||t>0){var a=this.view.scale;if(t>a||e>0&&a>e)return!1}return!0},setDrapingExtent:function(e,t,a,i){var r,n=(t[2]-t[0])/(t[3]-t[1]);r=n>1.0001?[i,i/n]:.9999>n?[i*n,i]:[i,i],this._extents[e]={extent:t,spatialReference:a,imageSize:r},this.suspended||this._fetch(e)},getGraphicsFromStageObject:function(e,a){return t.reject()},clear:function(){for(var e in this._images)this._clearImage(e)},_fetch:function(e){var t=this._extents[e],a=t.extent,r=new i(a[0],a[1],a[2],a[3],t.spatialReference),n=this._images[e];n||(n=this._images[e]={texture:null,material:null,rendergeometry:null,canvas:null,pixelData:null,worldExtent:a,loading:!0}),n.promise&&n.promise.cancel(),n.loading=!0,n.promise=this.layer.fetchImage({extent:r,width:t.imageSize[0],height:t.imageSize[1]}).then(function(t){n.canvas=document.createElement("canvas"),n.pixelData=t.pixelData,n.worldExtent=a;var i=n.canvas,r=i.getContext("2d"),s=this.layer.applyFilter(n.pixelData),l=s.pixelBlock;i.width=l.width,i.height=l.height;var d=r.createImageData(l.width,l.height),h=l.getAsRGBA();d.data.set(h),r.putImageData(d,0,0),this._createStageObjects(e,i),0===e&&this._images[1]&&this._images[1].rendergeometry&&this._createStageObjects(1,null),this._evaluateUpdatingState(),this.emit("draped-data-change")}.bind(this)).always(function(){n.loading=!1,n.promise=null})},_updateImage:function(e){var t=this._images[e];if(t&&t.pixelData){var a=t.canvas,i=a.getContext("2d"),r=this.layer.applyFilter(t.pixelData),n=r.pixelBlock,s=i.createImageData(n.width,n.height),l=n.getAsRGBA();a.width=n.width,a.height=n.height,s.data.set(l),i.putImageData(s,0,0),this._createStageObjects(e,t.canvas)}this.emit("draped-data-change")},_clearImage:function(e){var t=this._images[e],a=this.view._stage;t&&(t.rendergeometry&&a.getTextureGraphicsRenderer().removeRenderGeometries([t.rendergeometry]),t.texture&&a.remove(n.ModelContentType.TEXTURE,t.texture.getId()),t.material&&a.remove(n.ModelContentType.MATERIAL,t.material.getId()),t.rendergeometry=t.texture=t.material=t.pixelData=t.canvas=t.loading=!1)},_layerRedrawHandler:function(){for(var e=0;e<this._images.length;e++)this._updateImage(e)},_layerExportParametersChangeHandler:function(){for(var e=0;e<this._extents.length;e++)this._extents[e]&&this._fetch(e)},_opacityChangeHandler:function(e){this._images.forEach(function(t){t&&t.material&&t.material.setParameterValues({opacity:e})}.bind(this)),this.emit("draped-data-change")},_evaluateUpdatingState:function(){this.notifyChange("updating")},isUpdating:function(){var e=!1;for(var t in this._images){var a=this._images[t];if(a.loading){e=!0;break}}return e},_createStageObjects:function(e,t){var a=this.view._stage,i=a.getTextureGraphicsRenderer(),r=this._images[e];t?(r.texture&&a.remove(n.ModelContentType.TEXTURE,r.texture.getId()),r.texture=new s(t,"imageLayer",{width:t.width,height:t.height}),a.add(n.ModelContentType.TEXTURE,r.texture)):m(r.texture),r.material?t&&r.material.setParameterValues({textureId:r.texture.getId()}):(r.material=new g({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:r.texture.getId()},"imageLayer"),r.material.setRenderPriority(this.drawingOrder),a.add(n.ModelContentType.MATERIAL,r.material));var d,o=-1;if(0===e){var u=r.worldExtent,y=[[u[0],u[1],o],[u[2],u[1],o],[u[2],u[3],o],[u[0],u[3],o]];d=h.createSquareGeometry(y,!0)}else{m(1===e);var f=this._images[0].worldExtent;if(!f)return;d=p(f,r.worldExtent,o)}var v=new l(d);v.material=r.material,v.origin={vec3:[0,0,0],id:"0_0"},v.transformation=c.identity(),v.name="imageLayer",v.uniqueName="imageLayer#"+d.id,i.addRenderGeometries([v]),r.rendergeometry&&i.removeRenderGeometries([r.rendergeometry]),r.rendergeometry=v}});return y});