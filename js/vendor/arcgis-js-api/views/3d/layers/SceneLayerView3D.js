// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../core/watchUtils","../../../core/promiseUtils","../../../core/Logger","../../../core/lang","dojo/_base/lang","dojox/color/_base","dojo/has","../../layers/LayerView","../../../Graphic","../../../symbols/Symbol3D","../../../geometry/Extent","./i3s/I3SUtil","./i3s/I3SBinaryReader","./i3s/I3SProjectionUtil","./i3s/I3SQueryEngine","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../support/intersectionUtils","../support/projectionUtils","../support/aaBoundingBox","../webgl-engine/Stage","../webgl-engine/lib/Layer","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/Object3D","../webgl-engine/lib/Texture","../webgl-engine/materials/Material","../webgl-engine/lib/Util","../webgl-engine/lib/base64Binary","../lib/glMatrix","../../../layers/IntegratedMeshLayer"],function(e,t,r,i,n,a,o,s,d,l,u,c,h,g,p,f,y,m,v,_,b,I,x,M,O,T,A,E,w,D,R,C,L,j,F,P){function B(e){return e.getMetadata()}function S(){return h}function V(e,t,r,i){var n,a=!1;t.encoding===y.DDS_ENCODING_STRING?n=R.DDS_ENCODING:a=!(k(e.width)&&k(e.height));var o=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),s=o||t.atlas,d=(r||!s)&&!a,l=s||!t.wrap,u=s&&d&&i;return{mipmap:d,wrapClamp:l,disableAnisotropy:u,encoding:n,noUnpackFlip:!0}}function U(e){return null!=e.featureIds?e.featureIds.length:1}function N(e,t){for(var r=t.toLowerCase(),i=0,n=Object.keys(e);i<n.length;i++){var a=n[i];if(a.toLowerCase()===r)return e[a]}return null}var G=s.getLogger("esri.layers.SceneService"),z=L.assert,q=L.clamp,k=L.isPowerOfTwo,X=L.fallbackIfUndefined,H=L.objectEmpty,Q=L.VertexAttrConstants,Y=!1,J=!1,K=!0,W=!1,Z=!1,$=!1,ee=!1,te=[1,1,1,1],re=T.ModelContentType,ie=[.8,.8,.8],ne=[.5,.5,.5],ae=64,oe=9,se=1,de=null,le=function(e){function t(){e.apply(this,arguments),this._queryEngine=null,this._featuresChangedEventScheduled=!1,this._featuresChangedEvent=null}return r(t,e),t.prototype.initialize=function(){var e=this;y.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);var t=this.layer.version,r=!c("trident")||t.major>1||1===t.major&&t.minor>3;this.useCompressedTextures=this.view.has("s3tc")&&r,this._enableAtlasMipMaps=this.view.has("standardDerivatives"),this._disableAtlasAnisotropy=this._enableAtlasMipMaps&&!this.view.has("shaderTextureLOD"),this._initGraphicsController(),this.dbg=!1,this.maxGpuMemory=1e3,this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._colorOverride=null;for(var i=new Uint8Array(256),n=0;n<i.length;n++)i[n]=255;this._whiteTexture=new R(i,"white",{width:8,height:8}),this._stage.add(T.ModelContentType.TEXTURE,this._whiteTexture),this._layerEventHandles=[a.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),a.watch(this,"fullOpacity",function(t){return e._opacityChange(t)}),a.init(this.layer,"objectIdFilter",function(){return e._objectIdFilterChange()}),a.init(this.view,"clippingArea",function(){return e._clippingAreaChanged()})],this._addThisLayerToStage(),this.setVisibility(!this.suspended),this.debugNodeVis=J,this.debugLODVis=!1},t.prototype.destroy=function(){this._stage.remove(T.ModelContentType.TEXTURE,this._whiteTexture.getId()),this._removeThisLayerFromStage();var e=function(e){e.remove()};this._layerEventHandles.forEach(e),this._stage=null,null!=this._controller&&(this._controller.destroy(),this._controller=null),this._matId2Meta=null,this._texId2Meta=null,this._nodeId2Meta=null},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._controller&&this._controller.updating},t.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t},t.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isBundleAlreadyAddedToStage=function(e,t){var r=!1,i=!1;if(null!=this._nodeId2Meta[e.id]&&this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[t]){i=!0;for(var n=this._nodeId2Meta[e.id].engineObjectsPerBundle[t],a=0;a<n.length;a++){var o=n[a];if(r=o.isPartiallyHidden())break}}return{wasPartiallyHidden:r,alreadyLoaded:i}},t.prototype._initGraphicsController=function(){var e=this,t={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:this.isBundleAlreadyAddedToStage.bind(this),isOverMemory:this.isOverMemory.bind(this),removeNodeData:this._removeNodeDataFromStage.bind(this),removeFeatures:this._removeFeatures.bind(this),getAddedFeatures:this._getAddedFeatures.bind(this),getAddedNodeIDs:this._getAddedNodeIDs.bind(this),areAllBundlesLoaded:this._areAllBundlesLoaded.bind(this),wholeNodeSwitchEnabled:!0},r={additionalStartNodeLoadingHandler:this._startNodeLoading.bind(this),additionalCancelNodeLoadingHandler:this.cancelNodeLoading.bind(this),getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:e._calcDesiredTextureLOD.bind(e),_imageIsPartOfTextureBundle:e._imageIsPartOfTextureBundle.bind(e),_matId2Meta:e._matId2Meta,_texId2Meta:e._texId2Meta,useCompressedTextures:function(){return e.useCompressedTextures}}},_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:this._setPolygonOffset.bind(this),traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},getLoadedAttributes:this.getLoadedAttributes.bind(this),setAttributeData:this.setAttributeData.bind(this)};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})})},t.prototype.setMaxGpuMemory=function(e){this.maxGpuMemory=e},t.prototype.setVisibility=function(e){if(this._stage&&this._engineLayer){var t=this._engineLayer.getId(),r=this._stage.getViewContent(),i=r.indexOf(t)>=0;if(!!e===i)return;var n=[t];null!=this._nodeDebugVisualizer&&n.push(this._nodeDebugVisualizer.engineLayer.getId()),e?this._stage.addToViewContent(n):this._stage.removeFromViewContent(n)}},t.prototype.getEngineLayer=function(){return this._engineLayer},t.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,activeMaterials:0};if(!this._controller)return e;for(var t=0,r=Object.keys(this._controller.nodeIndex);t<r.length;t++){var i=r[t];e.nodesInIndex++;var n=this._controller.nodeIndex[i];null!=n.features&&(e.knownFeatures+=n.features.length)}return e.activeMaterials=Object.keys(this._matId2Meta).length,e},t.prototype._addThisLayerToStage=function(){var e=this._stage;this._initTexture=new R(null,"i3sInitTexture"),e.add(re.TEXTURE,this._initTexture);var t=this.layer.id,r=new A(t,{},t);this._engineLayer=r,e.add(re.LAYER,r),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),J&&(this._nodeDebugVisualizer=y.makeNodeDebugVisualizer(e,this.view.renderCoordsHelper,t),window._nodeDebugVisualizer=this._nodeDebugVisualizer)},t.prototype._removeThisLayerFromStage=function(){if(this.cancelNodeLoading(),null!=this._engineLayer){var e=this._stage;if(e.remove(re.TEXTURE,this._initTexture.getId()),null!=this._controller)for(var t in this._controller.nodeIndex)if(this._controller.nodeIndex.hasOwnProperty(t)){var r=this._controller.nodeIndex[t];this._removeNodeDataFromStage(r),delete this._controller.nodeIndex[t]}z(H(this._nodeId2Meta)),z(H(this._matId2Meta)),z(H(this._texId2Meta)),e.remove(re.LAYER,this._engineLayer.getId()),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=void 0,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._engineLayer=void 0,this.gpuMemoryEstimate=0}},t.prototype._startNodeLoading=function(){this._updateAllTextureLOD()},t.prototype.cancelNodeLoading=function(){null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear(),this._requestedTexImageIds={}},t.prototype._isAllHidden=function(e){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0;r<t.length;r++)if(!t[r].isAllHidden())return!1;return!0},t.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta[e.id];return t&&1===t.engineObjects.length?B(t.engineObjects[0]).loadedAttributes:void 0},t.prototype.setAttributeData=function(e,t,r){var i=this._nodeId2Meta[e.id];if(i&&1===i.engineObjects.length){var n=i.engineObjects[0],a=B(n);a.loadedAttributes=t,a.attributeData=r,this._setObjectSymbology(n)}},t.prototype._createUnitTestData=function(e){var t=this.view.navigation.targetCamera,r=[],i={viewParams:{eye:t.eye,center:t.center,up:t.up,viewMatrix:t.viewMatrix,projectionMatrix:t.projectionMatrix,fovX:t.fovX,viewport:t.viewport,perPixelRatio:t.perPixelRatio},visibleObjects:r},n=e.getAll("objects");for(var a in n){var o=n[a];if(o.getParentLayer()===this._engineLayer){var s=B(o),d=s.features,l=s.i3sNode,u=d.map(function(e){return e.id});u.sort();var c={featureIDs:u,nodeId:l};i.visibleObjects.push(c)}}return console.debug(""+i.visibleObjects.length),JSON.stringify(i)},t.prototype.isOverMemory=function(){return this.gpuMemoryEstimate>this.maxGpuMemory?(G.warn("over memory: "+this.gpuMemoryEstimate+" tex "+this.texMemoryEstimate+" geom "+this.geoMemoryEstimate),!0):!1},t.prototype._getAddedFeatures=function(e){var t=this._nodeId2Meta[e];if(null==t)return null;for(var r=[],i=this._nodeId2Meta[e].engineObjects,n=0;n<i.length;n++){var a=i[n];r=r.concat(B(a).features)}return r},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)},t.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var i=this.fullOpacity,n=1-q(X(t.transparency,0),0,1),a=i*n,o=1>a||e&&d.endsWith(e.channels,"a")||t.useVertexColorAlpha===!0||r;return{opacity:a,transparent:o}},t.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null!=e.doubleSided?e.doubleSided:!0},t.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},t.prototype._createEngineMaterial=function(e,t,r,i,n,a){var o,s;null!=e&&(s=this._texId2Meta[t],o=s&&s.engineTex?s.engineTex.getId():this._initTexture.getId());var d,u,c=r.params,h=X(c.diffuse,ie);null!=e&&(u=y.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures),d=u>-1?e.encoding[u]:e.encoding),"standard"!==r.type&&G.warn("Unknown material type '"+r.type+"', must be 'standard'"),void 0===c.reflectivity&&G.warn("Material parameter 'reflectivity' is missing.");var g=this.layer instanceof P,p={ambient:this._colorOverride||h,diffuse:this._colorOverride||h,specular:X(c.specular,ne),shininess:X(c.shininess,ae),atlasRegions:c.vertexRegions,textureId:o&&this._colorOverride?this._whiteTexture.getId():o,vertexColors:!0,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(c),cullFace:this._calcEngineMaterialCullFaceParams(c),writeStencil:g,receiveSSAO:!g};if(!g){var f=this._calcEngineMaterialTransparencyParams(e,c);l.mixin(p,f)}var m=new C(p,i);if(m.metadata={i3sMatId:i,i3sTexId:t,i3sTex:e,i3sMatParams:c},null!=e){s?s.usedByEngineMats.push(m):(s={id:t,featureMBS:{},usedByEngineMats:[m],images:e.images,encoding:d,encodingIdx:u,atlas:e.atlas===!0,wrap:"none"!==e.wrap[0]||"none"!==e.wrap[1]},this._texId2Meta[t]=s);for(var v=0;v<n.length;v++){var _=n[v];s.featureMBS[_.id]=_.engineMBS}if(void 0!==a[t]){if(null==s.engineTex){var b=a[t],I=b.data,x=V(I,s,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);s.engineTex=new R(I,s.id,x),this._stage.add(re.TEXTURE,s.engineTex),s.desiredLOD=a[t].desiredLOD,s.curLOD=s.desiredLOD,this.memEstimateTextureAdded(s.engineTex)}for(var M=s.engineTex.getId(),O=0;O<s.usedByEngineMats.length;O++){var T=s.usedByEngineMats[O];null==this._colorOverride&&T.setParameterValues({textureId:M}),T.metadata.originalTextureId=M}a[t].createdTextureForDomImage(),delete a[t]}else this._updateTextureLOD(s)}return this._matId2Meta[i]||(this._matId2Meta[i]={}),this._matId2Meta[i][t]={engineMat:m,refCount:1},W&&console.debug("new mat "+m.getId()),m},t.prototype._createVertexAndIndexArrays=function(e,t,r){var i,n=!0,a=e.params.vertexAttributes,o={};for(var s in a)if(a.hasOwnProperty(s)){if("classification"===s)continue;var d=a[s];i=m.valueType2TypedArrayClassMap[d.valueType],z(null!=i,"unsupported vertex attribute value type: "+d.valueType),o[s]={data:new i(t,d.byteOffset,d.count*d.valuesPerElement),size:d.valuesPerElement}}if(n&&null==o[Q.COLOR]){i=m.valueType2TypedArrayClassMap.UInt8,o[Q.COLOR]={data:new i(4*a.position.count),size:4};for(var l=0;l<o[Q.COLOR].data.length;l++)o[Q.COLOR].data[l]=l%3===0?255:0}var u=!1;null==o[Q.NORMAL]&&(u=!0,i=m.valueType2TypedArrayClassMap.Float32,o[Q.NORMAL]={data:new i(3*a.position.count),size:3});var c,h=[],g=e.params.faces;if(null!=g&&"PerAttributeArray"!==e.params.topology){var p={};for(var f in g)if(g.hasOwnProperty(f)){var y=g[f];z(y.count%3===0),z(y.count===g.position.count),z("UInt32"===y.valueType),p[f]=y.byteOffset}var v=e.params.components.length;c=new Array(v);for(var _=g.position.componentIndices||[0],b=0;v>b;b++){var I=e.params.components[b],x=v-1>b?_[b+1]-_[b]:g.position.count-_[b],M={type:"triangle",positionKey:"position",indices:{},componentRange:[_[b],_[b]+x]};for(var O in g)g.hasOwnProperty(O)&&(M.indices[O]=new Uint32Array(t,p[O],x),p[O]+=4*x);if(n&&null==M.indices[Q.COLOR]){M.indices[Q.COLOR]=new Uint32Array(x);for(var l=0;x>l;l++)M.indices[Q.COLOR][l]=l}if(u&&null==M.indices[Q.NORMAL]){M.indices[Q.NORMAL]=new Uint32Array(x);for(var l=0;x>l;l++)M.indices[Q.NORMAL][l]=l}c[b]=M;var T=I.textureID||"none",A=void 0;if("none"!==T&&(A=r.textureDefinitions[T],z(void 0!==A,"geometry wants unknown texture "+T)),A&&A.atlas===!0&&null!=A.regions){z(A.regions.length>0,"texture marked as atlas carries no region definition");var E=A.regions[I.regionID].subimageRegion,w=[65536*E[0],65536*(E[2]-E[0]),65536*(1-E[3]),65536*(E[3]-E[1])];h=h.concat(w);for(var D=new Uint32Array(x),R=0;x>R;R++)D[R]=h.length/4-1;M.indices[Q.REGION]=D}}}else{var M={type:"triangle",positionKey:"position",indices:{}},C=o.position.data.length/o.position.size;if(C>se||null==de){for(;C>se;)se*=2;de=new Uint32Array(se);for(var l=0;se>l;l++)de[l]=l}var L=new Uint32Array(de.buffer,0,C);for(var j in o)M.indices[j]=L;var F=M.indices[M.positionKey];M.componentRange=[0,null!=F?F.length-1:0],c=[M]}if(h.length>0){var P=new Uint16Array(h);o[Q.REGION]={data:P,size:4}}return{indexArrays:c,vertexArrays:o}},t.prototype._createEngineMats=function(e,t,r,i,n){for(var a=e.params.components.length,o=new Array(a),s=0;a>s;s++){var d=e.params.components[s],l=d.materialID,u=r.materialDefinitions[l];null!=u.href&&(u=i[u.hrefConcat].materialDefinitions[l]),z(void 0!==u,"geometry wants unknown material "+l);var c=d.textureID||"none",h=void 0;"none"!==c&&((null==r.textureDefinitions||null==r.textureDefinitions[c])&&G.warn("textureDefinitions missing in shared resource"),h=r.textureDefinitions[c]);var g=void 0;if(this._matId2Meta[l]&&this._matId2Meta[l][c]){var p=this._matId2Meta[l][c];g=p.engineMat,p.refCount++,W&&console.debug("reused mat "+g.getId()+", increased refcount "+p.refCount)}else g=this._createEngineMaterial(h,c,u,l,t,n);o[s]=g}return o},t.prototype._areAllBundlesLoaded=function(e,t){if(null==this._nodeId2Meta[e.id]||null==this._nodeId2Meta[e.id].engineObjectsPerBundle)return!1;for(var r=0;r<e.featureData.length;r++){if(null==this._nodeId2Meta[e.id].engineObjectsPerBundle[r])return!1;if(!t)for(var i=this._nodeId2Meta[e.id].engineObjectsPerBundle[r],n=0;n<i.length;n++)if(i[n].isPartiallyHidden())return!1}return!0},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphic=function(e){for(var t=N(e.attributes,this._getObjectIdField()),r=0,i=Object.keys(this._nodeId2Meta);r<i.length;r++)for(var n=i[r],a=this._nodeId2Meta[n].engineObjects,o=0;o<a.length;o++){var s=a[o],d=B(s),l=d.featureIds.indexOf(t);if(-1!==l)return{node:this._controller.nodeIndex[n],nodeId:n,bundleNr:o,index:l}}return null},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphic(e);if(null!=t){var r=this._nodeId2Meta[t.nodeId].engineObjects[t.bundleNr],i=B(r),n=i.faceRanges[t.index],a=new Float64Array(24);if(this._boundingBoxCornerPoints(n,r,a),M.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8)){var s=O.create(O.NEGATIVE_INFINITY);return O.expandBuffer(s,a,0,8),o.resolve(s)}}return o.reject()},t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=N(e.attributes,this._getObjectIdField()),n=function(){return r._findGraphic(e)};return y.whenGraphicAttributes(this.layer,e,i,t,n)},t.prototype.getGraphicsFromStageObject=function(e,t){if(this.layer instanceof P)return o.reject();var r=B(e),i=e.getFaceRangeIndexFromTriangleNr(t);if(null!=i&&null!=r.featureIds&&i<r.featureIds.length){var n=this._createGraphic(i,r);return o.resolve(n)}return o.reject()},t.prototype._addBundle=function(e,t,r,i,n,a,o){if(this.debugNodeVis===!0&&null!=this._nodeDebugVisualizer){var s="grey";switch(e.level){case 1:s="red";break;case 2:s="green";break;case 3:s="blue";break;case 4:s="yellow";break;case 5:s="magenta";break;case 6:s="brown"}this._nodeDebugVisualizer.show(e,this._controller.crsIndex,s)}var d=this._stage,l={};l[re.OBJECT]={},l[re.GEOMETRY]={},l[re.MATERIAL]={},l[re.TEXTURE]={};var u=this._engineLayer,c=u.getId(),h=i[e.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[o])return this._applyFilters(e),void(null!=n&&n.done());if(!this.isOverMemory()){if(null==this._nodeId2Meta[e.id]&&(this._nodeId2Meta[e.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[e.id].engineObjectsPerBundle[o]=[],$&&null==this.allUnitTestData&&(this.allUnitTestData={}),null==t)return void(null!=n&&n.done());for(var g=0,p=0;p<t.length;p++){var f=t[p].geometries,m=t[p].features,_=i[e.geometryData[o].hrefConcat];z(_ instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer"),null==_._isReprojected&&(_._isReprojected={});for(var b=e.id+"|"+m[0].id.toString(),I=[],x=[],M=[],O=void 0,T=function(t){var r=f[t];W&&console.debug("adding geometry "+t);var n=A._createVertexAndIndexArrays(r,_,h);if(K&&0===n.indexArrays.length)return"continue";var o=A._createEngineMats(r,m,h,i,a),s=void 0;$&&(s={},s.inputPositions=j.encode(new Uint8Array(n.vertexArrays.position.data.buffer)));var d=_._isReprojected[r.id],u=A._controller.crsIndex,c=A.view.renderSpatialReference,g=A._controller.isMeshPyramid?v.ReprojectionTypes.PER_VERTEX:v.ReprojectionTypes.BOUNDINGBOX;if(O=v.reprojectPoints(g,n.vertexArrays.position.data,e.mbs,d,u,A._controller.crsVertex,c),_._isReprojected[r.id]=!0,A._controller.isMeshPyramid){var p={normals:n.vertexArrays.normal.data,positions:n.vertexArrays.position.data,normalInd:n.indexArrays[0].indices.normal,positionInd:n.indexArrays[0].indices.position},T=A.layer.normalReferenceFrame||"none",D=function(t,r){var i=e.mbs;v.reprojectNormalsPerVertex(t,i,u,r,c)};y.processNormals(p,T,D)}$&&(s.perVertexReprojectedPositions=j.encode(new Uint8Array(n.vertexArrays.position.data.buffer)),s.matrices=O,s.mbs=e.mbs,s.crsIndex=A._controller.crsIndex,s.crsVertex=A._controller.crsVertex,s.crsEngine=A.view.renderSpatialReference);var R=O.localTrafo;null!=r.transformation&&(R=F.mat4d.create(r.transformation),F.mat4d.multiply(O.localTrafo,R,R));for(var C=0;C<o.length;C++){var L=o[C];l[re.MATERIAL][L.getId()]=L}var P=new E(new w(n.indexArrays,n.vertexArrays),b+"_"+t);A.memEstimateGeometryAdded(P.getData()),l[re.GEOMETRY][P.getId()]=P,I[t]=P,x[t]=R,M[t]=o,$&&(A.allUnitTestData[P.getId()]=s)},A=this,R=0;R<f.length;++R)T(R);var C={i3sNode:e.id,ceLayer:c,features:m,faceRanges:t[p].faceRanges,featureIds:t[p].featureIds,attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null,layerId:this.layer.id};g+=U(C);var L=new D({idHint:e.id,name:b,geometries:I,materials:M,transformations:x,castShadow:!0,metadata:C}),P=F.mat4d.create();F.mat4d.identity(P),F.mat4d.multiply(P,O.globalTrafo,P),L.setObjectTransformation(P),this._nodeId2Meta[e.id].engineObjectsPerBundle[o].push(L),this._nodeId2Meta[e.id].engineObjects.push(L),l[re.OBJECT][L.getId()]=L,this._setObjectSymbology(L),this._applyFilters(e)}if(Z){for(var m="",S=this._nodeId2Meta[e.id].engineObjectsPerBundle[o],V=0;V<S.length;V++)for(var N=B(S[V]).features,G=0;G<N.length;G++)m+="f "+N[G].id+" rf "+N[G].rootFeature+", ";console.debug("_addNodeDataToStage node "+e.id+" bundle "+o+" features "+m)}if(Y){var q=function(e){return Object.keys(e).length};console.log("objs: "+q(l[re.OBJECT])+" geoms: "+q(l[re.GEOMETRY])+" mats: "+q(l[re.MATERIAL])+" texts: "+q(l[re.TEXTURE]))}d.beginMod();var k=l[re.OBJECT];for(var X in k)k.hasOwnProperty(X)&&u.addObject(k[X]);for(var H in l)if(l.hasOwnProperty(H)){var Q=l[H];for(var J in Q)if(Q.hasOwnProperty(J)){if(null!=d.get(H,J))continue;d.add(H,Q[J])}}d.endMod(),null!=n&&n.done(),this._notifyFeaturesChanged(g,0)}},t.prototype._clippingAreaChanged=function(){var e=this,t=[];if(M.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._controller){var r=this._controller.nodeIndex;r&&Object.keys(this._nodeId2Meta).forEach(function(t){return e._applyFilters(r[t])}),this._controller.updateClippingArea(this.view.clippingArea)}},t.prototype._objectIdFilterChange=function(){var e=this;if(this._updateFilters(),this._controller){var t=this._controller.nodeIndex;t&&Object.keys(this._nodeId2Meta).forEach(function(r){return e._applyFilters(t[r])})}},t.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),i="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,n){return e._objectIdFilter(r,i,n)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},t.prototype._objectIdFilter=function(e,t,r){for(var i=0;i<r.length;){var n=y.binaryIndexOf(e,r[i])>=0;n===t?i++:r.splice(i,1)}},t.prototype._boundingboxFilter=function(e,t,r){var i=[0,0,0,0];M.mbsToMbs(e.mbs,this._controller.crsIndex,i,this.view.renderSpatialReference);var n=null!=t?y.intersectBoundingBoxWithMbs(t,i):2;if(2!==n)for(var a=0,o=this._nodeId2Meta[e.id].engineObjects,s=0;s<o.length;s++){var d=o[s],l=B(d).featureIds;if(0!==n){var u=d.getObjectTransformation(),c=d.getGeometryRecords()[0].getShaderTransformation();if(F.mat4d.multiply(u,c),0===u[1]&&0===u[2]&&0===u[3]&&0===u[4]&&0===u[6]&&0===u[7]&&0===u[8]&&0===u[9]&&0===u[11]&&1===u[15])for(var h=(t[0]-u[12])/u[0],g=(t[1]-u[13])/u[5],p=(t[2]-u[14])/u[10],f=(t[3]-u[12])/u[0],m=(t[4]-u[13])/u[5],v=(t[5]-u[14])/u[10],_=d.getGeometryRecords()[0].geometry.getData(),b=_.getFaces()[0].indices.position,I=_.getVertexAttr().position.data,x=B(d).faceRanges,O=void 0,T=void 0,A=void 0,E=void 0,w=void 0,D=void 0,R=0;R<x.length&&a<r.length;R+=1)if(r[a]===l[R]){var C=x[R],L=C[0],j=C[1];O=T=A=Number.MAX_VALUE,E=w=D=-Number.MAX_VALUE;for(var P=L;j>=P;P+=1)for(var S=0;3>S;S+=1){var V=3*b[3*P+S],U=I[V],N=I[V+1],G=I[V+2];O=Math.min(U,O),T=Math.min(N,T),A=Math.min(G,A),E=Math.max(U,E),w=Math.max(N,w),D=Math.max(G,D)}var z=O>f||h>E||T>m||g>w||A>v||p>D;z?r.splice(a,1):a++}}else{for(var q=0,R=0;R<l.length&&a+q<r.length;R+=1)r[a+q]===l[R]&&q++;r.splice(a,q)}}},t.prototype._applyFilters=function(e){if(this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0;r<t.length;r++)t[r].unhideAllFaceRange();if(0!==this._filters.length){for(var i=[],r=0;r<t.length;r++){var n=t[r];i=i.concat(B(n).featureIds)}for(var a=i.length,o=0;o<this._filters.length;o++)this._filters[o](e,i);if(i.length!==a)for(var s=0,r=0;r<t.length;r++){for(var n=t[r],d=[],l=B(n).faceRanges,u=B(n).featureIds,c=0;c<u.length;c+=1){var h=u[c],g=l[c];s>=i.length||i[s]!==h?d.push(g):s++}d.length>0&&(ee?(this._setObjectSymbology(n),n.setFacerangeColors(d.map(function(e){return{faceRanges:e,color:[0,0,0,0]}}),"replace")):n.hideFaceRange(n.getGeometryRecords()[0],d))}}}},t.prototype._hideFeatures=function(e,t){for(var r=this._nodeId2Meta[e.id].engineObjects,i=0;i<r.length;i++){for(var n=r[i],a=[],o=B(n).features,s=n.getMetadata().faceRanges,d=0;d<t.length;d++)for(var l=t[d],u=0;u<o.length;u++)l===o[u].id&&(null!=s&&1===n.getGeometryRecords().length?a.push(s[u]):n.hideAllFaceRanges());a.length>0&&n.hideFaceRange(n.getGeometryRecords()[0],a)}},t.prototype._removeFeatures=function(e,t){null!=this._nodeId2Meta[e.id]&&(this._hideFeatures(e,t),this._isAllHidden(e)===!0&&(Z&&console.debug("all hidden for node "+e.id+". removing."),this._removeNodeDataFromStage(e)))},t.prototype._removeNodeDataFromStage=function(e){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._stage,r=this._engineLayer,i=0,n=this._nodeId2Meta[e.id].engineObjects,a=0;a<n.length;++a){var o=n[a];i+=U(B(o)),r.removeObject(o);for(var s=o.getGeometryRecords(),d=0;d<s.length;d++){var l=s[d];this.memEstimateGeometryRemoved(l.geometry.getData()),t.remove(re.GEOMETRY,l.geometry.getId());for(var u=0;u<l.materials.length;u++){var c=l.materials[u],h=c.getId(),g=c.metadata.i3sMatId,p=c.metadata.i3sTexId||"none",f=this._matId2Meta[g][p];z(f.refCount>0),f.refCount--,W&&console.debug("decreased refcount material "+h+" "+("geometry "+d+", count "+f.refCount)),0===f.refCount&&this._removeMaterial(h,p,g,c,t)}}t.remove(re.OBJECT,o.getId())}delete this._nodeId2Meta[e.id],this._notifyFeaturesChanged(0,i)}},t.prototype._emitFeaturesChangedEvent=function(){this.emit("features-changed",this._featuresChangedEvent),this._featuresChangedEvent=null,this._featuresChangedEventScheduled=!1},t.prototype._cancelFeaturesChangedEvent=function(){this._featuresChangedEventScheduled=!1},t.prototype._notifyFeaturesChanged=function(e,t){var r=this;null==this._featuresChangedEvent&&(this._featuresChangedEvent={addedCount:0,removedCount:0}),this._featuresChangedEvent.addedCount+=e,this._featuresChangedEvent.removedCount+=t,this._featuresChangedEventScheduled||null==this._controller||(this._featuresChangedEventScheduled=!0,this._controller.queueAnimationFrameFunctionCall(function(){return r._emitFeaturesChangedEvent()},null,null,function(){return r._cancelFeaturesChangedEvent()},null))},t.prototype._removeMaterial=function(e,t,r,i,n){if(n.remove(re.MATERIAL,e),"none"!==t){var a=this._texId2Meta[t],o=a.usedByEngineMats,s=o.indexOf(i);if(z(s>-1),o[s]=o[o.length-1],o.pop(),o.length<1){var d=a.engineTex;d&&d!==this._initTexture&&(this.memEstimateTextureRemoved(d),n.remove(re.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,a.desiredLOD=-1,a.curLOD=-1,delete this._texId2Meta[t]}}delete this._matId2Meta[r][t],H(this._matId2Meta[r])&&delete this._matId2Meta[r]},t.prototype._updateAllTextureLOD=function(){for(var e in this._texId2Meta)if(this._texId2Meta.hasOwnProperty(e)){var t=this._texId2Meta[e];this._updateTextureLOD(t)}},t.prototype._calcDesiredTextureLOD=function(e,t){for(var r,i=0,n=0,a=Object.keys(e);n<a.length;n++){var o=a[n],s=e[o],d=F.vec3.dist(s,this._controller.camPos),l=2*s[3],u=l/d*this._controller.screenSizeFactor;u>i&&(i=u)}for(i/=oe,r=t.length-1;r>0&&t[r].size<i;)r--;return r},t.prototype._updateTextureLOD=function(e){var t=this;e.desiredLOD=this._calcDesiredTextureLOD(e.featureMBS,e.images);var r=e.curLOD!==e.desiredLOD&&(e.curLOD<0||!e.curLOD||0===e.desiredLOD||e.desiredLOD>e.curLOD||e.desiredLOD<e.curLOD-1);if(r){if(0===e.images.length)return;var i=e.images[e.desiredLOD],n=e.encodingIdx>-1?i.hrefConcat[e.encodingIdx]:i.hrefConcat;if(!this._requestedTexImageIds[i.id]){var a={metadata:{texMeta:e,image:i}};this._requestedTexImageIds[i.id]=!0,this._imageIsPartOfTextureBundle(i)?this._controller.streamDataSupplier.request(n,"binary",a).then(this._extractTextureImageFromBlob.bind(this)):this._controller.streamDataSupplier.request(n,"image",a).then(function(e,r,i,n){t._textureImageLoaded(e,r,n.image,n.texMeta)})}}if(e.engineTex||(e.engineTex=this._initTexture,e.curLOD=-1),this.debugLODVis)for(var o=u.fromHsv(e.desiredLOD/e.images.length*270,100,100).toRgb().map(function(e){return e/255}),s=0;s<e.usedByEngineMats.length;s++){var d=e.usedByEngineMats[s],l={ambient:o,diffuse:o};d.setParameterValues(l)}},t.prototype._extractTextureImageFromBlob=function(e,t,r,i){var n=i.texMeta;if(n.desiredLOD<0||i.image.size>n.images[n.desiredLOD].size)return void delete this._requestedTexImageIds[i.image.id];var a=this;z("binary"===r);var o="";try{var s=0,d=0;n.encodingIdx>-1?(s=i.image.byteOffset[n.encodingIdx],d=i.image.length[n.encodingIdx]):(s=i.image.byteOffset,d=i.image.length);var l=new Uint8Array(t,s,d),u=new Blob([l],{type:n.encoding});o=window.URL.createObjectURL(u)}catch(c){o="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII=",G.error("error loading texture "+e+" "+c)}var h=new Image;h.onerror=function(){window.URL.revokeObjectURL(o),h.src="",h.onerror=void 0,h.onload=void 0},h.onload=function(){a._controller.queueAnimationFrameFunctionCall(a._textureImageLoaded,a,[e,h,i.image,i.texMeta,o],void 0,1),window.URL.revokeObjectURL(o),h.src="",h.onerror=void 0,h.onload=void 0},h.src=o},t.prototype._textureImageLoaded=function(e,t,r,i){if(delete this._requestedTexImageIds[r.id],!(i.desiredLOD<0)){var n=i.images[i.desiredLOD],a=i.images[i.curLOD];if((!this.isOverMemory()||!(null==a||r.size>a.size))&&(!a||r.size>a.size&&r.size<=n.size||r.size<a.size&&r.size>=n.size)){var o=i.engineTex;o&&o!==this._initTexture&&(this.memEstimateTextureRemoved(o),this._stage.remove(re.TEXTURE,i.engineTex.getId()));var s=V(t,i,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);i.engineTex=new R(t,i.id,s),this._stage.add(re.TEXTURE,i.engineTex),i.curLOD=i.desiredLOD,this.memEstimateTextureAdded(i.engineTex);for(var d=i.engineTex.getId(),l=0;l<i.usedByEngineMats.length;l++){var u=i.usedByEngineMats[l];null==this._colorOverride&&u.setParameterValues({textureId:d}),u.metadata.originalTextureId=d}if(r!==n&&(i.curLOD=i.images.indexOf(r),z(i.curLOD>-1),!this._requestedTexImageIds[n.id])){var c={metadata:{texMeta:i,image:n}};this._requestedTexImageIds[n.id]=!0,this._controller.streamDataSupplier.request(n.hrefConcat,"binary",c).then(this._extractTextureImageFromBlob.bind(this))}}}},t.prototype._imageIsPartOfTextureBundle=function(e){return!this._controller.isMeshPyramid},t.prototype._setPolygonOffset=function(e,t){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle)for(var r={polygonOffset:t},i=0;i<this._nodeId2Meta[e.id].engineObjectsPerBundle.length;i++)for(var n=this._nodeId2Meta[e.id].engineObjectsPerBundle[i],a=0;a<n.length;a++)for(var o=n[a].getGeometryRecords(),s=0;s<o.length;s++)for(var d=o[s].materials,l=0;l<d.length;l++)d[l].setParameterValues(r)},t.prototype._rendererChange=function(e){this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&G.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")},t.prototype._getRenderingInfo=function(e){var t=this._currentRenderer,r=t&&t.getSymbol(e);if(!(r&&r instanceof p))return null;var i,n,a={symbol:r};if(t&&t.visualVariables)for(var o=t.getVisualVariableValues(e),s=0;s<o.length;s++){var d=o[s],l=d.variable.type;"color"===l?i=d.value:"opacity"===l&&(n=d.value)}return i&&(a.color=[i.r/255,i.g/255,i.b/255]),
null!=n?a.opacity=n:i&&null!=i.a&&(a.opacity=i.a),a},t.prototype._getSymbolFillColor=function(e){for(var t=e.symbolLayers,r=0;r<t.length;r++){var i=t.getItemAt(r);if("Fill"===i.type&&i.material&&i.material.color){var n=i.material.color;return[n.r/255,n.g/255,n.b/255,n.a]}}},t.prototype._setObjectSymbology=function(e){if(!(this.layer instanceof P)){for(var t=B(e),r=[],i=!1,n=t.faceRanges?t.faceRanges.length:1,a={attributes:{}},o=this.layer.objectIdField,s=this._currentRenderer&&this._currentRenderer.requiredFields,d=0;n>d;d++){if(null!=o&&null!=t.featureIds&&(a.attributes[o]=t.featureIds[d]),null!=s&&null!=t.attributeData)for(var l=0,u=s;l<u.length;l++){var c=u[l];t.attributeData[c]&&(a.attributes[c]=t.attributeData[c][d])}var h=this._getRenderingInfo(a),g=null!=t.faceRanges?t.faceRanges[d]:null;if(h){var p=h.color,f=h.opacity;if(null==p||null==f){var y=this._getSymbolFillColor(h.symbol);p=b.overrideColor(p,f,y,y&&y[3],te)}else p=b.overrideColor(p,f,null,null,te);p[3]<1&&(i=!0),r.push({faceRanges:g,color:p})}else r.push({faceRanges:g,color:void 0})}this.layer.cachedDrawingInfo.color?e.setFacerangeColors(r,"replace"):e.setFacerangeColors(r,"blend");for(var m=e.getGeometryRecords(),v=0;v<m.length;v++)for(var _=m[v],I=0;I<_.materials.length;I++){var x=_.materials[I],M=x.getParams().transparent,O=x.getParams().opacity;x.metadata.symbolIsTransparent=i;var T=this._calcEngineMaterialTransparencyParams(x.metadata.i3sTex,x.metadata.i3sMatParams,x.metadata.symbolIsTransparent);(M!==T.transparent||O!==T.opacity)&&x.setParameterValues({transparent:T.transparent,opacity:T.opacity})}}},t.prototype._opacityChange=function(e){for(var t in this._matId2Meta)for(var r in this._matId2Meta[t]){var i=this._matId2Meta[t][r].engineMat,n=i.getParams().transparent,a=i.getParams().opacity,o=this._calcEngineMaterialTransparencyParams(i.metadata.i3sTex,i.metadata.i3sMatParams,i.metadata.symbolIsTransparent);(n!==o.transparent||a!==o.opacity)&&i.setParameterValues({transparent:o.transparent,opacity:o.opacity})}},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new _({forAll:function(r){var i=function(i,n,a){t.id=i,t.index=n,t.object=a;var o=B(t.object),s=o.faceRanges[t.index];e._boundingBoxCornerPoints(s,t.object,t.bbCorners),r(t)};e._forAllFeatures(i)},createGraphic:function(t,r){var i=e._createGraphic(t.index,B(t.object));return r&&r.length?e.whenGraphicAttributes(i,r):o.resolve(i)},createExtentBuilder:function(){return e._createExtentBuilder()},createVisibilityFilter:function(){return e._createVisibilityFilter()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField,addVisibilityFilter:!0})},t.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=O.create(O.NEGATIVE_INFINITY),i=new Float64Array(24);return{add:function(n){M.bufferToBuffer(n.bbCorners,e,0,i,t,0,8)&&O.expandBuffer(r,i,0,8)},getExtent:function(){return new f({xmin:r[0],ymin:r[1],zmin:r[2],xmax:r[3],ymax:r[4],zmax:r[5],spatialReference:t})}}},t.prototype._createVisibilityFilter=function(){var e=this.view._stage.getCamera().frustumPlanes,t=0;return function(r){var i=x.conservativeFrustumConvexBuffer(e,r.bbCorners,0,8,t);return i>=0?(t=i,!1):!0}},t.prototype._forAllFeatures=function(e){for(var t=0,r=Object.keys(this._nodeId2Meta);t<r.length;t++)for(var i=r[t],n=this._nodeId2Meta[i].engineObjects,a=0;a<n.length;a++)for(var o=n[a],s=B(o).featureIds,d=0;d<s.length;d++){var l=s[d];e(l,d,o)}},t.prototype._createGraphic=function(e,t){var r={};r[this._getObjectIdField()]=t.featureIds[e];for(var i=0,n=Object.keys(t.attributeData);i<n.length;i++){var a=n[i];r[a]=t.attributeData[a][e]}var o=new g(null,null,r);return o.layer=this.layer,o},t.prototype._boundingBoxCornerPoints=function(e,t,r){for(var i=t.geometries[0].calculateAABB(0,e),n=0;8>n;++n){var a=[1&n?i[0]:i[3],2&n?i[1]:i[4],4&n?i[2]:i[5]];F.mat4d.multiplyVec3(t.objectTransformation,a),r[3*n]=a[0],r[3*n+1]=a[1],r[3*n+2]=a[2]}return r},i([n.property()],t.prototype,"layer",void 0),i([n.property()],t.prototype,"view",void 0),i([n.property()],t.prototype,"_controller",void 0),i([n.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),i([n.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),t=i([n.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(n.declared(S(),I));return le});