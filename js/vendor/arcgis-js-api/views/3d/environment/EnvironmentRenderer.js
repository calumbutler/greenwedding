// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../core/watchUtils","../support/ExternalRenderer","./PanoramicAtmosphere","./RealisticAtmosphere","./SimpleAtmosphere","./Stars","../webgl-engine/lib/RenderSlot"],function(e,s,t,i,r,n,a){var h=s.createSubclass({declaredClass:"esri.views.3d.environment.EnvironmentRenderer",properties:{view:{},viewingMode:{dependsOn:["view.viewingMode"],get:function(){return this.get("view.viewingMode")||"global"}},atmosphereQuality:{dependsOn:["view.environment.atmosphereEnabled","view.environment.atmosphere.quality"],get:function(){return this.get("view.environment.atmosphereEnabled")?this.get("view.environment.atmosphere.quality")||"none":"none"}},starsEnabled:{dependsOn:["view.environment.starsEnabled"],get:function(){return this.get("view.environment.starsEnabled")||!1}},transparent:{dependsOn:["view.basemapTerrain.opacity","view.basemapTerrain.wireframe"],get:function(){var e=this.get("view.basemapTerrain");return e&&e._renderer.isTransparent()}},_atmosphere:{},_stars:{},needsRender:{dependsOn:["_stars.needsRender","_atmosphere.needsRender"],get:function(){return!!(this._needsRender||this._atmosphere&&this._atmosphere.needsRender||this._stars&&this._stars.needsRender)}}},constructor:function(){this._STANDARD_SLOT=a.BACKGROUND,this._SPECIAL_SLOT=a.POSTPROCESSING_ATMOSPHERE,this._slots=[this._STANDARD_SLOT,this._SPECIAL_SLOT],this._AtmosphereClass=null,this._atmosphereReadyPromise=null,this._atmosphere=null,this._stars=null,this._needsRender=!0,this.notifyChange("needsRender")},initialize:function(){this.view._stage.addExternalRenderer(this._slots,this),this._basemapTerrainHandle=e.when(this.view,"basemapTerrain",this._updateBasemapTerrain.bind(this))},destroy:function(){this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=null),this._stars&&(this._stars.destroy(),this._stars=null),this._basemapTerrainHandle&&this._basemapTerrainHandle.remove(),this.view&&(this.view._stage.removeExternalRenderer(this),this.view=null)},setup:function(e){this.watch("viewingMode,atmosphereQuality,transparent,visible",this._updateAtmosphere.bind(this)),this._updateAtmosphere(),this.watch("starsEnabled,transparent,visible",this._updateStars.bind(this)),this._updateStars(),this.watch("view.basemapTerrain.loaded",function(){this._needsRender=!0,this.notifyChange("needsRender")}.bind(this))},resetNeedsRender:function(){this._atmosphere&&(this._atmosphere.resetNeedsRender?this._atmosphere.resetNeedsRender():this._atmosphere.didRender&&(this._atmosphere.needsRender=!1,this._atmosphere.didRender=!1)),this._stars&&(this._stars.resetNeedsRender?this._stars.resetNeedsRender():this._stars.didRender&&(this._stars.needsRender=!1,this._stars.didRender=!1)),this.didRender&&(this._needsRender=!1,this.didRender=!1,this.notifyChange("needsRender"))},render:function(e){return this.get("view.basemapTerrain.loaded")||"global"!==this.viewingMode?this._stars||this._atmosphere?(this._stars&&this._stars.render(e),this._atmosphere&&this._atmosphere.render(e),this._stars&&this._stars.didRender||this._atmosphere&&this._atmosphere.didRender):!0:!1},_updateStars:function(){var e=this._getAtmosphereSlot();this.starsEnabled&&!this._stars?(this._stars=new n({view:this.view,slot:e}),this._stars.initializeRenderContext(this.renderContext)):!this.starsEnabled&&this._stars?(this._stars.destroy(),this._stars=null):this._stars&&(this._stars.slot=e),this._needsRender=!0,this.notifyChange("needsRender")},_updateAtmosphere:function(){var e=this._getAtmosphereSlot();if(this._atmosphere&&(this._atmosphere.slot=e),this._updateAtmosphereClass(this.renderContext)){this._needsRender=!0,this.notifyChange("needsRender");var s=function(){this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=null)}.bind(this);if(!this._AtmosphereClass)return s(),void this._updateBasemapTerrain();this._atmosphereReadyPromise&&(this._atmosphereReadyPromise.cancel(),this._atmosphereReadyPromise=null);var t=new this._AtmosphereClass({view:this.view,slot:e});t.initializeRenderContext(this.renderContext),this._atmosphere?this._atmosphereReadyPromise=t.then(function(){s(),this._atmosphereReadyPromise=null,this._atmosphere=t}.bind(this)):this._atmosphere=t,t.then(function(){this._updateBasemapTerrain()}.bind(this))}},_updateAtmosphereClass:function(e){var s=this._AtmosphereClass;return"none"===this.atmosphereQuality?this._AtmosphereClass=null:"high"===this.atmosphereQuality&&!this.transparent&&i.isSupported(e)?"local"===this.viewingMode?this._AtmosphereClass=t:this._AtmosphereClass=i:"local"===this.viewingMode?this._AtmosphereClass=t:this._AtmosphereClass=r,this._AtmosphereClass!==s},_getAtmosphereSlot:function(){return this.transparent&&"global"===this.viewingMode?this._SPECIAL_SLOT:this._STANDARD_SLOT},_updateBasemapTerrain:function(){var e=this.get("view.basemapTerrain");e&&(e.velvetOverground=!(!this._AtmosphereClass||this._AtmosphereClass===i))}});return h});