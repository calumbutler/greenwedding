// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../core/declare","../../../request","../../../core/urlUtils","./PromiseLightweight","./AsyncQuotaRoundRobinQueue","../webgl-engine/lib/Util"],function(e,a,r,i,t,n){var l=n.assert,o=!1,s={QUEUED:1,DOWNLOADING:2,CANCELLED:4},u=e(null,{constructor:function(e){this.alreadyLoading={},this.loadQueue=new t(m,this._doneLoadingCallback,this,e),this._urlInfo={hasSameOrigin:{},canUseXhr:{}}},destroy:function(){for(var e in this.alreadyLoading){for(var a=this.alreadyLoading[e],r=0;r<a.clientPromises.length;r++){var i=a.clientPromises[r];i.isRejected()||i.reject(a.url.url,null,a.docType,a.clientMetadata[r])}this._cancelTask(a)}this.loadQueue.clear(),this.loadQueue=null,this.alreadyLoading=null},request:function(e,a,r,t,n){o&&console.log("request "+e),t=t||{};var l=new i.Promise;l.requestURL=e;var u=this.alreadyLoading[e];return u?(u.clientPromises.push(l),u.clientMetadata.push(t.metadata)):(u={url:{url:null,normalized:null,normalizedWithToken:null,hasSameOrigin:!1,canUseXhr:!1},docType:a,clientType:r,status:s.QUEUED,clientMetadata:[t.metadata],clientPromises:[l],downloadObj:null,_cancelledInQueue:!1},this._prepareUrl(u,e,n),this.alreadyLoading[e]=u,this.loadQueue.push(u)),l},isRequested:function(e){return void 0!==this.alreadyLoading[e]},cancel:function(e){var a=e.requestURL;o&&console.log("cancel "+a);var r=this.alreadyLoading[a];r&&this._removeRequestPromiseFromTask(r,e)},hasPendingDownloads:function(){return!n.objectEmpty(this.alreadyLoading)},_prepareUrl:function(e,a,i){if(e.url.url=a,e.url.isData=r.isDataProtocol(a),e.url.isData||"image"!==e.docType)return e.url.normalized=a,void(!e.url.isData&&i&&(e.url.normalizedWithToken=i(a)));a=r.normalize(a),e.url.normalized=a;var t=r.getOrigin(a);i&&(e.url.normalizedWithToken=i(a));var n=this._urlInfo.hasSameOrigin[t];if(void 0!==n?e.url.hasSameOrigin=n:(e.url.hasSameOrigin=r.hasSameOrigin(t,window.location.href),this._urlInfo.hasSameOrigin[t]=e.url.hasSameOrigin),!e.url.hasSameOrigin){var l=this._urlInfo.canUseXhr[t];void 0!==l?e.url.canUseXhr=l:(e.url.canUseXhr=r.canUseXhr(t),this._urlInfo.canUseXhr[t]=e.url.canUseXhr)}},_removeRequestPromiseFromTask:function(e,a){var r=e.clientPromises.length;if(r>1){var i=e.clientPromises.indexOf(a);l(i>-1,"request to be cancelled is already cancelled or invalid"),e.clientPromises[i]=e.clientPromises[r-1],e.clientPromises.pop(),e.clientMetadata[i]=e.clientMetadata[r-1],e.clientMetadata.pop()}else l(e.clientPromises[0]===a,"request to be cancelled is already cancelled or invalid"),this._cancelTask(e)},_cancelTask:function(e){if(e.status===s.DOWNLOADING){if(this.loadQueue.workerCancelled(e),c(e)){var a=e.downloadObj;a.removeAttribute("onload"),a.removeAttribute("onerror"),a.removeAttribute("src")}else e.status=s.CANCELLED,e.downloadObj.cancel();e.downloadObj=null}e.status=s.CANCELLED,e.clientPromise=void 0,e.metadata=void 0,delete this.alreadyLoading[e.url.url]},_doneLoadingCallback:function(e,a){var r;if(l(e.status===s.DOWNLOADING),delete this.alreadyLoading[e.url.url],a)for(r=0;r<e.clientPromises.length;r++)e.clientPromises[r].isRejected()||e.clientPromises[r].reject(e.url.url,a,e.docType,e.clientMetadata[r]);else for(o&&console.log("done "+e.url.url),r=0;r<e.clientPromises.length;r++)e.clientPromises[r].done(e.url.url,e.result,e.docType,e.clientMetadata[r])}}),d=function(e,a,r){e.onload=function(){a.status!==s.CANCELLED&&(a.result=e,e.removeAttribute("onload"),e.removeAttribute("onerror"),r(a))},e.onerror=function(){a.status!==s.CANCELLED&&(e.removeAttribute("onload"),e.removeAttribute("onerror"),r(a,{status:404}))}},c=function(e){return"image"===e.docType&&e.url.isData},m=function(e,r){if(e.status===s.CANCELLED)return!1;if(e.status=s.DOWNLOADING,c(e)){var i=new Image;return d(i,e,r),i.src=e.url.normalized,e.downloadObj=i,!0}var t,l;switch(e.docType){case"binary":l="array-buffer",t=0;break;case"image":l="image";break;default:l="json"}return e.downloadObj=a(e.url.normalizedWithToken||e.url.normalized,{responseType:l,timeout:t,failOk:!0,crossOrigin:!e.url.hasSameOrigin||e.url.canUseXhr,allowImageDataAccess:"image"===e.docType}),e.downloadObj.then(function(a){e.duration=n.performance.now()-e.startTime,e.size=0,e.result=a.data,r(e)},function(a){e.downloadObj.isCanceled()||r(e,a)}),!0};return u.TaskStatus=s,u});