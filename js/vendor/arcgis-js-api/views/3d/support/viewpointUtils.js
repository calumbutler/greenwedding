// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../geometry/SpatialReference","../../../geometry/Geometry","../../../geometry/Point","../../../geometry/Extent","../../../geometry/support/webMercatorUtils","../../../core/Error","../../../core/promiseUtils","../../../Camera","../../../Viewpoint","../../../Graphic","../lib/glMatrix","./mathUtils","./projectionUtils","./cameraUtils","./aaBoundingBox","./aaBoundingRect","./intersectionUtils"],function(e,t,n,r,a,i,o,c,l,s,u,m,f,g,p,d,v){function y(e){return 360-m.cyclicalDeg.normalize(e)}function h(e){return m.cyclicalDeg.normalize(360-e)}function x(t,r,i){var o;if(!r)return null;var l,s=t.spatialReference||e.WGS84;if(r.camera){if(l=r.get("camera.position.spatialReference"),!a.canProject(l,s))return null;if(o=r.camera.clone(),!l.equals(s)){var u=a.project(o.position,s);o.position=u}return o}if(l=r.get("targetGeometry.spatialReference"),l&&!a.canProject(l,s))return null;var m=t.navigation.currentCamera;v=g.internalToExternal(t,m);var p={noReset:!1};if(null!=r.rotation&&(v.heading=y(r.rotation),p.noReset=!0),null!=i&&(v.tilt=i),r.targetGeometry instanceof n){var d,v,h=r.targetGeometry,x=r.targetGeometry.clone();d=null!=r.scale?g.scaleToDistance(t,r.scale,h.latitude):m.distance,o=g.eyeHeadingTiltForCenterPointAtDistance(t,v.heading,v.tilt,x,d,p);var T=f.vectorToPoint(o.eye,t.renderSpatialReference,s);return new c(T,o.heading,o.tilt,v.fov)}var R=r.targetGeometry.extent;return g.fromExtent(t,R,v,p)}function T(e,t,n){return null!=e[t]?e[t]:null!=n?"function"==typeof n?n():n:void 0}function R(e,t,n,r){var a=n.scale;return null==a&&null!=n.zoom&&(a=g.zoomToScale(e,n.zoom)),null==a&&null!=n.distance&&(t=t.center||t,a=g.distanceToScale(e,n.distance,t.latitude)),null==a&&r&&(a="function"==typeof r?r():r),a}function G(e,t,n){var r=t.heading;return null==r&&null!=t.rotation&&(r=y(t.rotation)),null==r&&n&&(r="function"==typeof n?n():n),r}function w(t,r,a,i,o){if(!(r&&a.position||r&&a.direction||a.position&&a.direction))return!1;var c=t.spatialReference||e.WGS84,l=t.renderSpatialReference,s=a.direction;if(r&&a.position&&(s=null),a.position&&f.pointToVector(a.position,q,l),r&&f.pointToVector(r,L,l),s){var u=a.position||r,m=new n(u);m.x+=s[0],m.y+=s[1],s.length>2&&(m.z+=s[2]),f.pointToVector(m,O,l),N.subtract(O,a.position?q:L)}if(a.position&&s)o.camera.position=new n(a.position),g.directionToHeadingTilt(t,q,O,i.up,o.camera),N.add(q,O,L),t.navigation.getCenterIntersectTerrain(q,L,L),o.targetGeometry=f.vectorToPoint(L,l,c),o.scale=g.distanceToScale(t,N.dist(q,L),o.targetGeometry.latitude);else if(r&&s){o.targetGeometry=new n(r),o.scale=R(t,o.targetGeometry,a,function(){return g.computeScale(t,i)});var p=g.scaleToDistance(t,o.scale,r.latitude);N.scale(O,p/N.length(O),q),N.add(q,L),o.camera.position=f.vectorToPoint(q,l,c),g.directionToHeadingTilt(t,q,O,i.up,o.camera)}else o.targetGeometry=new n(r),o.camera.position=new n(a.position),N.subtract(L,q,O),g.directionToHeadingTilt(t,q,O,i.up,o.camera),o.scale=g.distanceToScale(t,N.dist(q,L),o.targetGeometry.latitude);return o.rotation=h(o.camera.heading),!0}function E(e,t){var n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=y(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function S(t,n,r){var a=t.spatialReference||e.WGS84;return n=n||g.externalToInternal(t,r.camera),r.targetGeometry=f.vectorToPoint(n.center,t.renderSpatialReference,a),r.scale=g.computeScale(t,n),r.rotation=h(r.camera.heading),r}function z(e,t,n){return n||(n=new l({camera:new c})),g.internalToExternal(e,t,n.camera),S(e,t,n)}function b(e,t,n){return n||(n=new l),n.camera=t.clone(),S(e,null,n)}function C(e,t,r){if(t){var a=[];if(!t.hasZ&&e.basemapTerrain){var i;i=t.isInstanceOf(n)?t:t.centroid||t.center,i?X[2]=e.basemapTerrain.getElevation(i)||0:X[2]=0}te[t.declaredClass](t,function(e){a.push(e[0],e[1],e[2])},X);var o=a.length/3;if(0!==o){var c=new Array(a.length);if(f.bufferToBuffer(a,t.spatialReference,0,c,e.spatialReference,0,o)){t.hasZ&&(r.hasZ=!0);for(var l=0;l<c.length;l+=3)t.hasZ?(X[0]=c[l+0],X[1]=c[l+1],X[2]=c[l+2]):(X[0]=c[l+0],X[1]=c[l+1]),p.expand(r.boundingBox,X)}}}}function P(e,t,n){var r=e.whenViewForGraphic(t);return r.then(function(e){return e&&e.whenGraphicBounds?e.whenGraphicBounds(t):void 0}).then(function(e){p.expand(n.boundingBox,e),isFinite(e[2])&&(n.hasZ=!0)}).otherwise(function(){C(e,t.geometry,n)})}function I(n,r,a){if(Array.isArray(r)&&2===r.length&&"number"==typeof r[0]&&"number"==typeof r[1])$.x=r[0],$.y=r[1],$.z=void 0,$.spatialReference=e.WGS84,C(n,$,a);else{if(r&&r.forEach){var i=o.resolve();return r.forEach(function(e){i=i.then(function(){return I(n,e,a)})}),i}if(r instanceof t)C(n,r,a);else if(r instanceof s)return P(n,r,a)}return o.resolve()}function A(e,t,n,r){if(t.camera)return B(e,n,t.camera,r);r.scale=t.scale,r.rotation=t.rotation,r.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,r.camera=null,null!=n.heading?r.rotation=h(n.heading):null!=n.rotation&&(r.rotation=n.rotation);var a=R(e,r.targetGeometry,n);return null!=a&&(r.scale=a),r.camera=x(e,r,n.tilt),r}function B(e,t,n,r){r.camera=n.clone(),r.camera.fov=e.camera.fov;var i=e.spatialReference,o=r.camera.position.spatialReference;if(!a.canProject(o,i))return null;if(!o.equals(i)){var c=a.project(r.camera.position,i);r.camera.position=c}return S(e,null,r)}function F(e,t,n,r){if(!n)return null;r.targetGeometry=n.clone();var a=e.navigation.getCameraIntersectTerrain();if(w(e,r.targetGeometry,t,a,r))return r;g.internalToExternal(e,a,r.camera);var i={noReset:!1};return E(r.camera,t)&&(i.noReset=!0),r.scale=R(e,r.targetGeometry,t),null==r.scale&&(f.pointToVector(n,X,e.renderSpatialReference),v.frustumPoint(a.frustumPlanes,X)?r.scale=g.distanceToScale(e,N.dist(a.eye,X),n.latitude):r.scale=g.computeScale(e,a)),g.fromCenterScale(e,r.targetGeometry,r.scale,r.camera,i,r.camera)?r:null}function M(e,t,r){var a=e.navigation.getCameraIntersectTerrain();if(w(e,null,t,a,r))return r;if(t.position)return N.set(a.viewForward,O),g.directionToHeadingTilt(e,a.eye,O,a.up,Y),r.camera.position=new n(t.position),r.camera.heading=G(e,t,Y.heading),r.camera.tilt=T(t,"tilt",Y.tilt),S(e,null,r);var i=f.vectorToPoint(a.center,e.renderSpatialReference,$,e.spatialReference);return F(e,t,i,r)}function Z(e,t,n,r){r.targetGeometry=n.clone();var a=e.navigation.getCameraIntersectTerrain();g.internalToExternal(e,a,r.camera);var i={noReset:!1};return E(r.camera,t)&&(i.noReset=!0),g.fromExtent(e,n,r.camera,i,r.camera)?r:null}function V(e,t,n,r,a){var i=0;n.hasZ?i=n.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(n)),N.set3(n.x,n.y,i,X),f.computeLinearTransformation(e.spatialReference,X,k,e.renderSpatialReference),W.toMat3(k,J),_.transpose(J),p.set(K,p.NEGATIVE_INFINITY);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var l=o[c],s=r[l[2]];isFinite(s)||(s=i),N.set3(r[l[0]],r[l[1]],s,X),f.vectorToVector(X,e.spatialReference,X,e.renderSpatialReference),p.expand(K,_.multiplyVec3(J,X))}var u=p.width(K),m=p.height(K),g=p.depth(K),d=1/Math.tan(t.fovX/2),v=1/Math.tan(t.fovY/2),y=Math.sqrt(u*u+g*g),h=.5*y*Math.max(v,d)+.5*m,x=.5*m*v+.5*Math.max(u,g),T=Math.max(h,x);return T/a}function U(e,t,n,r,a,i){i.targetGeometry=n.clone();var o=e.navigation.getCameraIntersectTerrain(),c=V(e,o,n,r,a);g.internalToExternal(e,o,i.camera);var l={noReset:!1};return E(i.camera,t)&&(l.noReset=!0),i.scale=g.distanceToScale(e,c,i.targetGeometry.latitude),g.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,l,i.camera)?i:null}function j(e,t){if(!t||!e.spatialReference)return null;var n={};if(null!=t.declaredClass||Array.isArray(t))n.target=t;else{for(var r in t)n[r]=t[r];t.center&&!n.target&&(n.target=t.center)}return n}function D(e){return e&&(e.rotation=h(e.camera.heading)),o.resolve(e)}function H(e,t){var n=j(e,t);if(!n)return o.reject(new i("viewpointutils-create:no-target","Missing target for creating viewpoint"));var a=new l({camera:new c({fov:e.camera.fov})}),s=null!=n.scale||null!=n.zoom||null!=n.distance;if(n.target instanceof l)return D(A(e,n.target,n,a));if(n.target instanceof c)return D(B(e,n,n.target,a));if(n.target instanceof r){var u=n.target.xmin===n.target.xmax||n.target.ymin===n.target.ymax;return D(s||u?F(e,n,n.target.center,a):Z(e,n,n.target,a))}var m={boundingBox:p.create(p.NEGATIVE_INFINITY),spatialReference:e.spatialReference,hasZ:!1};return I(e,n.target,m).then(function(){if(isFinite(m.boundingBox[0])){p.center(m.boundingBox,X),$.x=X[0],$.y=X[1],$.z=X[2],$.spatialReference=e.spatialReference;var t;return isFinite($.z)&&m.hasZ?t=p.isPoint(m.boundingBox):($.z=void 0,t=d.isPoint(p.toRect(m.boundingBox,Q))),s||t?F(e,n,$,a):U(e,n,$,m.boundingBox,ne.DEFAULT_FRAME_COVERAGE,a)}return M(e,n,a)}).then(function(e){return D(e)})}var N=u.vec3d,_=u.mat3d,W=u.mat4d,q=N.create(),L=N.create(),O=N.create(),Y={heading:0,tilt:0},X=N.create(),k=W.create(),J=_.create(),K=p.create(),Q=d.create(),$=new n,ee=function(e,t,n){for(var r=e.hasZ,a=0;a<e.rings.length;a++)for(var i=e.rings[a],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],r&&(n[2]=i[o][2]),t(n)},te={"esri.geometry.Point":function(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},"esri.geometry.Polygon":ee,"esri.geometry.Circle":ee,"esri.geometry.Polyline":function(e,t,n){for(var r=e.hasZ,a=0;a<e.paths.length;a++)for(var i=e.paths[a],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],r&&(n[2]=i[o][2]),t(n)},"esri.geometry.Multipoint":function(e,t,n){for(var r=e.points,a=e.hasZ,i=0;i<r.length;i++)n[0]=r[i][0],n[1]=r[i][1],a&&(n[2]=r[i][2]),t(n)},"esri.geometry.Extent":function(e,t,n){e.hasZ?(t(N.set3(e.xmin,e.ymin,e.zmin,n)),t(N.set3(e.xmax,e.ymin,e.zmin,n)),t(N.set3(e.xmin,e.ymax,e.zmin,n)),t(N.set3(e.xmax,e.ymax,e.zmin,n)),t(N.set3(e.xmin,e.ymin,e.zmax,n)),t(N.set3(e.xmax,e.ymin,e.zmax,n)),t(N.set3(e.xmin,e.ymax,e.zmax,n)),t(N.set3(e.xmax,e.ymax,e.zmax,n))):(t(N.set3(e.xmin,e.ymin,n[2],n)),t(N.set3(e.xmax,e.ymin,n[2],n)),t(N.set3(e.xmin,e.ymax,n[2],n)),t(N.set3(e.xmax,e.ymax,n[2],n)))}},ne={create:H,rotationToHeading:y,headingToRotation:h,toCamera:x,fromCamera:b,fromInternalCamera:z,DEFAULT_FRAME_COVERAGE:.66};return ne});