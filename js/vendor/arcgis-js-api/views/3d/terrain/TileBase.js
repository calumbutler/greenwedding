// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["./terrainUtils","./TileUtils","./TerrainConst","./TileGeometryFactory","./UpsampleInfo","./ElevationData","./TilePerLayerInfo","../support/mathUtils","../lib/glMatrix","../../../core/arrayUtils"],function(e,t,i,n,a,r,s,l,o,h){var p=o.vec3d,d=o.vec2d,u=o.vec4d,g=o.mat4d,f=e.weakAssert,c=p.create(),y=u.create(),v=u.create(),A=.1,E=p.create(),m={},T=i.LayerClass.LAYER_CLASS_COUNT,L=i.LayerClass.MAP,I=i.LayerClass.ELEVATION,U=i.TileUpdateTypes,S=function(e,t,i){this.lij=[0,0,0],this.extent=u.create(),this.extentWGS84Rad=u.create(),this.centerAtSeaLevel=p.create(),this.center=p.create(),this.tileUp=E,this.elevationBounds=d.create(),this.children=[null,null,null,null],this.layerInfo=new Array(T),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this._maxTesselation=0};return S.prototype.init=function(e,t,n,a){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],a.getExtent(e[0],e[1],e[2],this.extent,this.extentWGS84Rad),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this.edgeLen=0,this.radius=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?d.set(t.elevationBounds,this.elevationBounds):d.set2(0,0,this.elevationBounds),this.parent=t;for(var r=0;4>r;r++)this.children[r]=null;this.pendingUpdates=0,this.renderData=null,this.screenDepth=0,this.renderOrder=0,this.visible=!1,this.parentSurface=n;for(var l=0;T>l;l++)if(n){var o,h=n.numLayers(l);this.layerInfo[l]?(o=this.layerInfo[l],o.length=h):(o=new Array(h),this.layerInfo[l]=o);for(var p=0;h>p;p++)o[p]=s.makeEmptyLayerInfo(l,o[p]),l==I&&this.findElevationBoundsForLayer(p,-1)}else this.layerInfo[l]=null;this.computeElevationBounds(),this._maxTesselation=Math.min(a.pixelSize[0],i.MAX_TILE_TESSELATION)},S.prototype.dispose=function(){for(var e=0;T>e;e++)for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.upsampleFromTile&&(a.Pool.release(n.upsampleFromTile),n.upsampleFromTile=null)}},S.prototype.releaseLayerResources=function(){for(var e=this.layerInfo[i.LayerClass.MAP],t=0;t<e.length;t++){var n=e[t];n.releaseResources()}},S.prototype.updateScreenDepth=function(e){p.set(this.center,v),v[3]=1,g.multiplyVec4(e,v,v),this.screenDepth=v[2]/v[3]},S.prototype.shouldSplit=function(e,t){var i=this.lij[0];if(1>i)return U.SPLIT;p.subtract(this.center,t,c);var n=p.length(c),a=e[0],r=e[2],s=a*n*2,o=r*n*2,h=this.edgeLen/s,d=this.edgeLen/o,u=e[1],g=e[3],f=e[4],v=e[5];if(u>h)return this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],U.VSPLITMERGE):U.NONE;if(i>=f){var E=i+Math.ceil(-l.log2(u/h));return E!==this.vlevel?(this.vlevel=E,U.VSPLITMERGE):U.NONE}if(i>6&&(p.scale(this.tileUp,p.dot(this.tileUp,c),y),p.subtract(y,c),p.length2(y)>this.radius*this.radius)){p.scale(y,this.radius/p.length(y)),p.add(y,this.center),p.subtract(t,y,y);var m=this.elevationBounds[1]-this.elevationBounds[0],T=Math.min(1,(Math.abs(p.dot(y,this.tileUp))+.5*m+this.curvatureHeight)/p.length(y)),L=A/v;if(L*g>T*d)return U.NONE}return U.SPLIT},S.prototype.createElevationDataFromLERC=function(e){var t;try{t=r.createFromLERC(this.lij,this.extent,e,{noDataValue:i.ELEVATION_NODATA_VALUE})}catch(n){console.warn("Error decoding %s: %s",e.url,n.message)}return t},S.prototype.getWGS84Extent=function(){return this.extentWGS84Rad.map(l.rad2deg)},S.prototype.load=function(e){for(var t=0;T>t;t++)this.layerInfo[t]&&this._createOrUpdateAgents(0,t);e.loadTile(this)},S.prototype.unload=function(e){this.renderData&&e.unloadTile(this);for(var t=0;T>t;t++)for(var n=this.layerInfo[t],a=0;a<n.length;a++){var r=n[a];if(r.loadingAgent&&r.loadingAgent!==m){r.loadingAgent.dispose();var s=this.parentSurface.agentTypeByLayerIndex(a,t);s.Pool.release(r.loadingAgent),r.loadingAgent=null}r.pendingUpdates=0}this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_GEOMETRY,this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_TEXTURE},S.prototype.updateClippingStatus=function(e){h.equals(e,this.clippingArea)||(e?(this.intersectsClippingArea=this.intersectsExtent(e),this.isWithinClippingArea=this.isWithinExtent(e)):(this.intersectsClippingArea=!0,this.isWithinClippingArea=!0),this.clippingArea=e,this.renderData&&this.updateGeometry())},S.prototype.updateVisibility=function(e,t,i){var n=i||this.isVisible(e,t)&&this.intersectsClippingArea;if(n!==this.visible){this.visible=n;for(var a=0,r=this.layerInfo[a],s=0;s<r.length;s++){var l=r[s];l.loadingAgent&&l.loadingAgent!==m&&l.loadingAgent.setSuspension(!n)}}return n},S.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},S.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return i&&i.data},S.prototype.tileDataAvailable=function(e,t,i){var n=this.layerInfo[i][t].tilemap;return n?"unavailable"!==n.getAvailability(e.lij[1],e.lij[2]):!0},S.prototype.requestLayerData=function(e,t,n){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var a=this.layerInfo[t][e];if(a.waitingAgents.indexOf(n)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),!0;if(a.data)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),a.waitingAgents.push(n),setTimeout(n.dataArrived.bind(n,this),0),!0;if(a.pendingUpdates&U.DECODE_LERC)return a.waitingAgents.push(n),!0;if(a.waitingAgents.push(n),!a.requestPromise){var r=this.parentSurface.requestTileData(this,e,t),s=function(){a.requestPromise===r&&(a.requestPromise=null)};a.requestPromise=r,r.then(s,s)}return a.requestPromise?!0:!1},S.prototype.descendants=function(e){e||(e=[]);for(var t=0;4>t;t++){var i=this.children[t];i&&(i.descendants(e),e.unshift(this.children[t]))}return e},S.prototype.isLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]==e[2]},S.prototype.findByLij=function(e){if(this.isLij(e))return this;for(var t=0;4>t;t++){var i=this.children[t];if(i){var n=i.findByLij(e);if(n)return n}}return null},S.prototype.unrequestLayerData=function(t,n,a,r){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),n,t,a.tile.lij.toString());var s=this.layerInfo[n][t],l=s.waitingAgents,o=l.indexOf(a);if(f(o>-1,"agent has not requested this piece of map data"),l[o]=l[l.length-1],l.length--,l.length<1){if(n===L){var h=r?r[t]:this.parentSurface.layerViewByIndex(t,L);if(e.isVectorTileLayerView(h))return void(s.requestPromise&&s.requestPromise.cancel("cancel"))}f(s.requestPromise||s.rawData,"no pending operations on layerInfo that agents were waiting for"),s.requestPromise&&(this.parentSurface.cancelRequest(s.requestPromise),s.requestPromise=null),i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),n,t)}},S.prototype.dataArrived=function(e,t,i){var n=this.layerInfo[t][e];n.data=i;for(var a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataArrived(this);n.waitingAgents.length=0},S.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),t,e);for(var n=this.layerInfo[t][e],a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataMissing(this);n.waitingAgents.length=0},S.prototype.updateTexture=function(e){this.renderData&&(e?this.parentSurface._renderer.updateTileTexture(this):(this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface._pendingUpdates=!0))},S.prototype.computeElevationBounds=function(){d.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var e=this.layerInfo[I],t=!1,i=0;i<e.length;i++){var n=e[i];n.elevationBounds&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],n.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],n.elevationBounds[1]),t=!0)}t||d.set2(0,0,this.elevationBounds),this.updateRadiusAndCenter()},S.prototype.updateRadiusAndCenter=function(){var e=.5*(this.elevationBounds[0]+this.elevationBounds[1]);p.scale(this.tileUp,e,y),p.add(this.centerAtSeaLevel,y,this.center)},S.prototype.findElevationBoundsForLayer=function(e,n){var a=this.layerInfo[I][e];if(!a.elevationBounds||a.elevationBounds[2]<n){var r=this.parentSurface.layerViewByIndex(e,I);if(t.fallsWithinLayer(this,r,!1)){var s=y,l=!1;if(a.data)d.set(a.data.bounds,s),s[2]=this.lij[0],l=!0;else{for(var o=this.parent,h=0,u=null,g=a.data;o&&(!g||h<i.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(h=this.vlevel-o.lij[0],u=g||u,g=o.layerInfo[I][e].data,!(!g&&u&&h>=i.ELEVATION_DESIRED_RESOLUTION_LEVEL));)o=o.parent;g=g||u,g&&(g.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],s),s[0]!==1/0&&(s[2]=g.level,l=!0))}l&&(a.elevationBounds?p.set(s,a.elevationBounds):a.elevationBounds=[s[0],s[1],s[2]])}}},S.prototype.updateGeometry=function(){this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_GEOMETRY,this.parentSurface._pendingUpdates=!0},S.prototype.modifyLayers=function(e,t,i,n){for(var a=t.length,r=this.layerInfo[i],l=new Array(a),o=0;o<r.length;o++){var h=r[o];if(h.loadingAgent&&h.loadingAgent!==m){h.loadingAgent.dispose(n);var p=this.parentSurface.agentTypeByLayerIndex(o,i);p.Pool.release(h.loadingAgent),h.loadingAgent=null}h.waitingAgents.length=0}if(i===L)for(var d=0;d<r.length;d++)if(void 0===e[d]){var u=r[d];u.releaseResources()}for(o=0;a>o;o++){var g=t[o];l[o]=g>-1?r[g]:s.makeEmptyLayerInfo(i)}this.layerInfo[i]=l},S.prototype.restartAgents=function(e){if(this.renderData)if(this._createOrUpdateAgents(0,e),e===I){this.updateGeometry();for(var t=this.layerInfo[e],n=0;n<t.length;n++)t[n].pendingUpdates|=i.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=!0}else this.updateTexture(!0)},S.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.loadingAgent===m&&(n.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},S.prototype.agentDone=function(e,t){var i=this.layerInfo[t],n=i[e];n.loadingAgent=m,n.data||n.upsampleFromTile||e<i.length-1&&this._createOrUpdateAgents(e+1,t)},S.prototype._createOrUpdateAgents=function(e,i){var n;n=i===I?!1:!this.visible;for(var a=e,r=this.layerInfo[i];a<r.length;){var s=r[a],l=!1,o=this.parentSurface.layerViewByIndex(a,i);if(null!==s.loadingAgent&&s.loadingAgent!==m)l=s.loadingAgent.update();else if(s.loadingAgent!==m&&t.fallsWithinLayer(this,o,!1)){var h=this.parentSurface.agentTypeByLayerIndex(a,i),p=h.Pool.acquire();l=p.init(this,a,i,n),l?s.loadingAgent=p:(h.Pool.release(p),s.loadingAgent=m)}if(l&&!o.isTransparent)break;a++}},S.prototype.geometryState=function(e){var t,a,r,s=this._getElevationInfo(e?e.samplerData:null),o=this.lij[0],p=!1;if(s.samplerData){t=this.vlevel-o,a=Math.max(o-s.maxTileLevel,i.ELEVATION_DESIRED_RESOLUTION_LEVEL-t);var d=this._maxTesselation;r=l.clamp((d>>a)+1,2,d+1)}else r=8>o?this._numSubdivisionsAtLevel[o]+1:2;r=n.supportedNumVertsPerRow(r);var u=this.clippingArea;return(!this.intersectsClippingArea||this.isWithinClippingArea)&&(u=null),e?(e.numVertsPerRow!==r&&(e.numVertsPerRow=r,p=!0),s.changed&&(e.samplerData=s.samplerData,p=!0),h.equals(e.clippingArea,u)||(e.clippingArea=u,p=!0),e.needsUpdate=p):e={numVertsPerRow:r,samplerData:s.samplerData,needsUpdate:!0,clippingArea:u},e},S.prototype._getElevationInfo=function(e){for(var i=this.layerInfo[I],n=i.length,a=new Array(n),r=0,s=0,l=!1,o=0;n>o;o++){var h=i[o];if(h.upsampleFromTile){var p=h.upsampleFromTile.tile,d=p.layerInfo[I][o].data;e&&e[r]===d.samplerData||(l=!0),a[r++]=d.samplerData,s=Math.max(s,p.lij[0])}else if(h.data){var u=this.parentSurface.layerViewByIndex(o,I);t.fallsWithinLayer(this,u,!1)&&(e&&e[r]===h.data.samplerData||(l=!0),a[r++]=h.data.samplerData,s=this.lij[0])}}return e&&e.length!==r&&(l=!0),r>0?a.length=r:a=null,{changed:l,samplerData:a,maxTileLevel:s}},S.prototype.isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},S.prototype.intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},S});