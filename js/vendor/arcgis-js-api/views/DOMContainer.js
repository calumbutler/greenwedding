// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/_base/lang","dojo/on","dojo/dom","dojo/dom-construct","../core/Accessor","../core/HandleRegistry","../core/Scheduler","../core/watchUtils","../widgets/Popup","./PopupManager","./ui/DefaultUI","../core/accessorSupport/decorators"],function(e,t,i,r,o,s,n,p,a,u,d,l,h,c,y,f){function v(e){var t=e.ownerDocument||window.document,i=t.defaultView,r=e.getBoundingClientRect();return g[0]=r.left+i.pageXOffset,g[1]=r.top+i.pageYOffset,g}var g=[0,0],m=16,w=750,_=512,b=2,O=function(e){function t(){var t=this;e.call(this),this.height=0,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.width=0,Object.defineProperty(this,"_measureInfo",{enumerable:!1,writable:!1,value:{task:null,freq:m,time:w}}),this._domHandles=new u,this.watch("interacting",function(e){var i=t.surface;i&&i.setAttribute("data-interacting",e.toString())})}return i(t,e),t.prototype.getDefaults=function(){return o.mixin(this.inherited(arguments),{popup:{},ui:{}})},t.prototype.initialize=function(){var e=this,t=this._measureInfo,i=null;l.init(this,"container",function(r,o,n,p){if(null!=r||null!=o){i&&(i.remove(),i=null,t.freq=m,t.time=w),t.task&&(t.task.remove(),t.task=null),r?(i=s(window,"resize",function(){t.freq=m,t.time=w}),t.task=d.addFrameTask({prepare:function(t){var i=e._measureInfo;if(i.time+=t.deltaTime,!(i.time<i.freq)){i.time=0;var r=e._measure();r?(i.freq=m,e._set("resizing",!0)):(i.freq=Math.min(w,i.freq*b),i.freq>=_&&e._set("resizing",!1))}}})):e._set("resizing",!1),e._measure();var a=e.root,u=e.surface,l=e.width,h=e.height;a&&u&&l&&h&&(a.style.width=u.style.width=l+"px",a.style.height=u.style.height=h+"px")}})},t.prototype.destroy=function(){this.ui.destroy(),this.popup&&this.popup.destroy(),this.container=null},Object.defineProperty(t.prototype,"container",{set:function(e){var t=this._get("container");if(t!==e){if(t&&(t.classList.remove("esri-view"),this.popupManager.destroy(),this.popupManager=null,p.destroy(this.root),this._set("root",null)),e){e.classList.add("esri-view");var i=document.createElement("div");i.className="esri-view-root",e.insertBefore(i,e.firstChild),this._set("root",i);var r=document.createElement("div");r.className="esri-view-surface",n.setSelectable(r,!1),i.appendChild(r),this._set("surface",r),this._forceReadyCycle(),this.popupManager=new c({enabled:!0,view:this})}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null);this._set("container",e)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"popup",{set:function(e){var t=this._get("popup");e!==t&&(this._domHandles.remove("view-popup"),t&&t.destroy(),e&&(e.viewModel.view=this,e._started||e.startup(),this._domHandles.add([l.init(this,"root",function(t,i){var r=e.domNode;n.isDescendant(r.parentNode,i)&&r.parentNode.removeChild(r),t&&!r.parentNode&&e.placeAt(t)})],"view-popup")),this._set("popup",e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return[this.width,this.height]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ui",{set:function(e){var t=this._get("ui");e!==t&&(this._domHandles.remove("ui"),t&&t.destroy(),e&&(e.view=this,this._domHandles.add([l.init(this,"root",function(t){e.container=t?p.create("div",null,t):null})],"ui")),this._set("ui",e))},enumerable:!0,configurable:!0}),t.prototype.pageToContainer=function(e,t,i){var r=this.position;return e-=r[0],t-=r[1],i?(i[0]=e,i[1]=t):i=[e,t],i},t.prototype.containerToPage=function(e,t,i){var r=this.position;return e+=r[0],t+=r[1],i?(i[0]=e,i[1]=t):i=[e,t],i},t.prototype._measure=function(){var e=this.container,t=e?e.clientWidth:0,i=e?e.clientHeight:0;if(0===t||0===i||"hidden"===window.getComputedStyle(e).visibility)return this._set("suspended",!0),!1;var r=this.root,o=this.surface,s=this.width,n=this.height,p=this.position;if(t===s&&i===n)return this._set("suspended",!1),!1;r&&o&&(r.style.width=o.style.width=t+"px",r.style.height=o.style.height=i+"px"),this._set("width",t),this._set("height",i),this._set("suspended",!1);var a=v(e);return p&&a[0]===p[0]&&a[1]===p[1]||this._set("position",a.slice()),this.emit("resize",{oldWidth:s,oldHeight:n,width:t,height:i}),!0},r([f.property({value:null,cast:function(e){return n.byId(e)}})],t.prototype,"container",null),r([f.property({readOnly:!0})],t.prototype,"height",void 0),r([f.property({type:h})],t.prototype,"popup",null),r([f.property({readOnly:!0})],t.prototype,"position",void 0),r([f.property({readOnly:!0})],t.prototype,"resizing",void 0),r([f.property({readOnly:!0})],t.prototype,"root",void 0),r([f.property({value:null,dependsOn:["width","height"],readOnly:!0})],t.prototype,"size",null),r([f.property({readOnly:!0})],t.prototype,"surface",void 0),r([f.property({readOnly:!0})],t.prototype,"suspended",void 0),r([f.property({type:y})],t.prototype,"ui",null),r([f.property({readOnly:!0})],t.prototype,"width",void 0),t=r([f.subclass("esri.views.DOMContainer")],t)}(f.declared(a));return O});